<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Jenkins, hot backup - ✌yesplease&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="yesplease" />
  <meta name="description" content="jenkins 数据热备 rsync : 增量备份 inotify： 实时通知 理论 一、rsync 与传统的 cp、tar 备份方式相比，rsync 具有安全性高、备份迅速、支持增量" />

  <meta name="keywords" content="yesplease, blog, technology" />






<meta name="generator" content="Hugo 0.93.0-DEV" />


<link rel="canonical" href="http://cugbtang.github.io/post/devops/series-jenkins-3/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="Jenkins, hot backup" />
<meta property="og:description" content="jenkins 数据热备 rsync : 增量备份 inotify： 实时通知 理论 一、rsync 与传统的 cp、tar 备份方式相比，rsync 具有安全性高、备份迅速、支持增量" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://cugbtang.github.io/post/devops/series-jenkins-3/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-01T16:01:23+08:00" />
<meta property="article:modified_time" content="2022-02-01T16:01:23+08:00" />

<meta itemprop="name" content="Jenkins, hot backup">
<meta itemprop="description" content="jenkins 数据热备 rsync : 增量备份 inotify： 实时通知 理论 一、rsync 与传统的 cp、tar 备份方式相比，rsync 具有安全性高、备份迅速、支持增量"><meta itemprop="datePublished" content="2022-02-01T16:01:23+08:00" />
<meta itemprop="dateModified" content="2022-02-01T16:01:23+08:00" />
<meta itemprop="wordCount" content="4100">
<meta itemprop="keywords" content="cicd,jenkins,backup," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Jenkins, hot backup"/>
<meta name="twitter:description" content="jenkins 数据热备 rsync : 增量备份 inotify： 实时通知 理论 一、rsync 与传统的 cp、tar 备份方式相比，rsync 具有安全性高、备份迅速、支持增量"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">yesplease</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/">This is Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/cugbtang" rel="noopener" target="_blank">
              github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      yesplease
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/">This is Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/cugbtang" rel="noopener" target="_blank">
              github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">Jenkins, hot backup</h1>
      
      <div class="post-meta">
        <time datetime="2022-02-01" class="post-time">
          2022-02-01
        </time>
        <div class="post-category">
            <a href="http://cugbtang.github.io/categories/devops/"> devops </a>
            <a href="http://cugbtang.github.io/categories/cloudnative/"> cloudnative </a>
            
          </div>
        <span class="more-meta"> 4100 words </span>
          <span class="more-meta"> 9 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#jenkins-数据热备">jenkins 数据热备</a></li>
    <li><a href="#理论">理论</a>
      <ul>
        <li><a href="#一rsync">一、rsync</a></li>
        <li><a href="#二rsyncinotify">二、rsync+inotify</a></li>
        <li><a href="#三rsyncsersync">三、rsync+sersync</a></li>
      </ul>
    </li>
    <li><a href="#四小结">四、小结：</a></li>
    <li><a href="#实践">实践</a>
      <ul>
        <li><a href="#方案一同机热备到不同的文件目录">方案一、同机热备到不同的文件目录</a></li>
        <li><a href="#方案二不同机器热备-rsyncinotify-tools-架构2">方案二、不同机器热备 rsync+Inotify-tools 架构</a></li>
        <li><a href="#方案三不同机器热备-rsyncinotify-tools-架构3">方案三、不同机器热备 rsync+Inotify-tools 架构</a></li>
        <li><a href="#排错4">排错</a></li>
      </ul>
    </li>
    <li><a href="#文献">文献</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="jenkins-数据热备">jenkins 数据热备</h2>
<blockquote>
<p>rsync : 增量备份</p>
<p>inotify： 实时通知</p>
</blockquote>
<h2 id="理论">理论</h2>
<h3 id="一rsync">一、rsync</h3>
<blockquote>
<p>与传统的 cp、tar 备份方式相比，rsync 具有安全性高、备份迅速、支持<strong>增量备份</strong>等优点，通过 rsync 可以解决对实时性要求不高的数据备份需求，例如定期的备份文件服务器数据到远端服务器，对本地磁盘定期做数据镜像等，随着应用系统规模的不断扩大，对数据的安全性和可靠性也提出的更好的要求。</p>
<p>rsync 在高端业务系统中也逐渐暴露出了很多不足：</p>
<p>​		首先，rsync 同步数据时，需要扫描所有文件后进行比对，进行差量传输。如果<strong>文件数量</strong>达到了百万甚至千万量级，扫描所有文件将是非常耗时的。而且正在发生变化的往往是其中很少的一部分，这是非常低效的方式。</p>
<p>​		其次，rsync <strong>不能实时</strong>的去监测、同步数据，虽然它可以通过 linux 守护进程的方式进行触发同步，但是两次触发动作一定会有时间差，这样就导致了服务端和客户端数据可能出现不一致，无法在应用故障时完全的恢复数据。基于以上原因，rsync+inotify 组合出现了！</p>
</blockquote>
<h3 id="二rsyncinotify">二、rsync+inotify</h3>
<blockquote>
<p>Inotify 是一种强大的、细粒度的、异步的文件系统<strong>事件监控</strong>机制，linux 内核从 2.6.13 起，加入了 Inotify支持，通过 Inotify 可以监控文件系统中添加、删除，修改、移动等各种细微事件，利用这个内核接口，第三方软件就可以监控文件系统下文件的各种变化情况，而 inotify-tools 就是这样的一个第三方软件。 inotify 可以监控文件系统的各种变化，当文件有任何变动时，就触发rsync 同步，这样刚好解决了同步数据的实时性问题。</p>
</blockquote>
<h3 id="三rsyncsersync">三、rsync+sersync</h3>
<blockquote>
<p>1、sersync是基于Inotify开发的，类似于Inotify-tools的工具</p>
<p>2、sersync可以记录下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字，然后使用rsync同步的时候，只同步发生变化的这个文件或者这个目录。</p>
</blockquote>
<h2 id="四小结">四、小结：</h2>
<ul>
<li>rsync+inotify-tools与rsync+sersync这两种架构有什么区别？</li>
</ul>
<ol>
<li>
<p>rsync+Inotify-tools</p>
<ul>
<li>
<p>Inotify-tools只能记录下被监听的目录发生了变化（包括增加、删除、修改），并<strong>没有把具体</strong>是哪个文件或者哪个目录发生了变化<strong>记录</strong>下来；</p>
</li>
<li>
<p>rsync 在同步的时候，并不知道具体是哪个文件或者哪个目录发生了变化，每次都是对整个目录进行同步(应该是扫描)<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>，当数据量很大时，整个目录同步非常耗时（rsync要对整个目录遍历查找对比文件），因此，效率很低。</p>
</li>
</ul>
</li>
<li>
<p>rsync+sersync</p>
<ul>
<li>
<p>sersync可以<strong>记录</strong>下被监听目录中发生变化的（包括增加、删除、修改）具体某一个文件或某一个目录的名字；</p>
<ul>
<li>rsync在同步的时候，只同步发生变化的这个文件或者这个目录（每次发生变化的数据相对整个同步目录数据来说是很小的，rsync在遍历查找比对文件时，速度很快），因此，效率很高。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>​	当同步的目录数据量不大时，<strong>建议</strong>使用 rsync+Inotify-tools；当数据量很大（几百G甚至1T以上）、文件很多时，建议使用 rsync+sersync。</p>
<h2 id="实践">实践</h2>
<blockquote>
<p>说明：</p>
<p>操作系统：CentOS 7.x</p>
</blockquote>
<blockquote>
<p>源服务器：36.111.140.109 （Sersync+web）</p>
<p>目标服务器： 36.111.140.99、(Rsync+web)</p>
<p>目的：把源服务器上/home/Sync目录实时同步到目标服务器的/home/Sync下</p>
</blockquote>
<h3 id="方案一同机热备到不同的文件目录">方案一、同机热备到不同的文件目录</h3>
<blockquote>
<p>Rsync+Inotify-tools 架构</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/cugbtang/image-repo/master/PicGo/20220318111839.png" alt="image-20220318111831407"></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">yum install -y rsync inotify-tools

vim /usr/bin/inotify2rsync


<span class="c1">#!/bin/bash</span>
<span class="c1"># 运行脚本的用户对相关路径有读写权限就行</span>
<span class="nv">src</span><span class="o">=</span>/jenkins/jenkins_job      
<span class="nv">dst</span><span class="o">=</span>/jenkins1/jenkins_job  
      
/usr/bin/inotifywait -mrq --timefmt  <span class="s1">&#39;%d/%m/%y %H:%M&#39;</span>  --format  <span class="s1">&#39;%T %w%f%e&#39;</span>  -e modify,delete,create,attrib <span class="nv">$src</span> <span class="p">|</span>  <span class="k">while</span>  <span class="nb">read</span> files

         
         <span class="k">do</span>

         
                 <span class="c1">#/usr/bin/rsync -vzrtopg --delete --progress --password-file=/etc/rsyncd.secrects $src $dst</span>
                 rsync -av --exclude  lost+found/ --exclude  backup/  <span class="nv">$src</span> <span class="nv">$dst</span>

         
                 <span class="nb">echo</span>  <span class="s2">&#34;</span><span class="si">${</span><span class="nv">files</span><span class="si">}</span><span class="s2"> was rsynced&#34;</span>  &gt;&gt; /var/log/rsync.log  <span class="m">2</span> &gt;<span class="p">&amp;</span> <span class="m">1</span>

         
         <span class="k">done</span>

         
<span class="nb">exit</span>  <span class="m">0</span>


</code></pre></td></tr></table>
</div>
</div><h3 id="方案二不同机器热备-rsyncinotify-tools-架构2">方案二、不同机器热备 rsync+Inotify-tools 架构<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup></h3>
<blockquote>
<p>jenkins 主节点无法高可用（官方说的），针对两套主 jenkins 的<strong>互备方案</strong>，强调磁盘是为了一定要热备到ssd上，保证性能</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/cugbtang/image-repo/master/PicGo/20220318113041.png" alt="image-20220318113041057"></p>
<blockquote>
<p>rsync 的解决方案解析：</p>
<ul>
<li>左边是<strong>原来的</strong>，一般的rsync的cs架构（client &amp; server）同步模式，数据源服务器上安装rsync server，由server统一控制可以传输的数据的内容，例如权限，目录，文件数等，发起传输的是rsync client，即看起来就是将数据从源服务器拉取到备份服务器。</li>
<li>右边的是加上inotify-tools的<strong>同步模式</strong>，在数据源服务器上安装rsync client，在备份源服务器上安装rsync server，也是由server统一控制传输的数据内容，但是这里是数据源服务器作为了client端，因为发起传输的是rsync client，所以这里看起来就是将数据从源服务器推送到备份服务器。</li>
<li>从逻辑上cs的架构 c 和 s 变成了相反位置，但是传输的模式依然是从 s 传输到 c 。</li>
</ul>
</blockquote>
<p><img src="https://raw.githubusercontent.com/cugbtang/image-repo/master/PicGo/20220317144123.jpeg" alt="blog_rsync_(bs)_introduce_20150206.jpg"></p>
<p>目标服务器（热备服务器 == rsync服务端）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">sudo yum install -y rsync

<span class="c1"># 设置开机启动</span>
<span class="nb">echo</span> <span class="s1">&#39;/usr/bin/rsync --daemon --config=/etc/rsyncd.conf&#39;</span> &gt;&gt; /etc/rc.d/rc.local


cat <span class="s">&lt;&lt;EOF | sudo tee /etc/rsyncd.conf
</span><span class="s">
</span><span class="s">#同步目录的所属用户，有权限操作的都可以
</span><span class="s">uid = Sync
</span><span class="s">#同步目录的所属组
</span><span class="s">gid = Sync
</span><span class="s">#不打开chroot
</span><span class="s">use chroot = no
</span><span class="s">#超时时间
</span><span class="s">timeout = 800 
</span><span class="s">#日志文件位置，启动rsync后自动产生这个文件，无需提前创建
</span><span class="s">log file =/var/log/rsyncd.log 
</span><span class="s">#pid文件的存放位置
</span><span class="s">pid file =/var/run/rsyncd.pid
</span><span class="s">#支持max connections参数的锁文件
</span><span class="s">lock file =/var/run/rsync.lock
</span><span class="s">#rsync启动时欢迎信息页面文件位置（文件内容自定义）
</span><span class="s">motd file =/etc/rsyncd.Motd
</span><span class="s">#默认端口
</span><span class="s">port = 873  
</span><span class="s">#设置rsync服务端文件为读写权限
</span><span class="s">read only =no  
</span><span class="s">#不显示rsync服务端资源列表
</span><span class="s">list = no
</span><span class="s">#最大连接数
</span><span class="s">max connections = 200
</span><span class="s">#执行数据同步的用户名，可以设置多个，用英文状态下逗号隔开
</span><span class="s">auth users = Sync
</span><span class="s">#允许进行数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开
</span><span class="s">hosts allow = 2.2.2.2
</span><span class="s">#禁止数据同步的客户端IP地址，可以设置多个，用英文状态下逗号隔开
</span><span class="s">hosts deny = *
</span><span class="s">#用户认证配置文件，里面保存用户名称和密码，后面会创建这个文件
</span><span class="s">secrets file = /etc/rsync.pass
</span><span class="s">
</span><span class="s">#定义模块
</span><span class="s">[Sync]
</span><span class="s">    #rsync服务端数据目录路径
</span><span class="s">    path = /jenkins1/jenkins_job/
</span><span class="s">    #模块描述
</span><span class="s">    comment = Sync
</span><span class="s">EOF</span>

 <span class="c1">#配置文件，添加以下内容，添加允许传输用户和密码</span>
 <span class="c1">#格式，用户名:密码，可以设置多个，每行一个用户名:密码</span>
cat <span class="s">&lt;&lt;EOF | sudo tee /etc/rsync.pass
</span><span class="s">Sync:THW7DLBQ82tBKfIf  
</span><span class="s">
</span><span class="s">#设置文件所有者读取、写入权限
</span><span class="s">chmod 600 /etc/rsyncd.conf 
</span><span class="s">#设置文件所有者读取、写入权限
</span><span class="s">#这个密码文件只能是这个权限，服务端会做检测
</span><span class="s">chmod 600 /etc/rsync.pass  
</span><span class="s">
</span><span class="s">#启动
</span><span class="s">systemctl enable rsyncd
</span><span class="s">systemctl restart rsyncd 
</span><span class="s">
</span><span class="s"># 服务端的rsync开启873端口
</span><span class="s">#vi /etc/sysconfig/iptables  #编辑防火墙配置文件
</span><span class="s">-A RH-Firewall-1-INPUT -m state --state NE</span>W -m tcp -ptcp --dport <span class="m">873</span> -j ACCEPT
</code></pre></td></tr></table>
</div>
</div><p>源服务器（主服务器 == rsync客户端）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 客户端的Rsync可以不用开启873端口</span>

yum install -y rsync inotify-tools

<span class="c1">#设置文件权限，只设置文件所有者具有读取、写入权限即可</span>
touch /jenkins/rsync.passwd
<span class="nb">echo</span> <span class="s1">&#39;THW7DLBQ82tBKfIf&#39;</span> &gt; /jenkins/rsync.passwd
chmod <span class="m">600</span> /jenkins/rsync.passwd

<span class="c1"># 测试</span>
mkdir -p /jenkins/ceshi 
<span class="c1">#在源服务器上创建测试文件夹，然后在源服务器运行下面1行命令</span>
<span class="c1"># /jenkins/ceshi 最后带不带/有很大区别</span>
rsync -avH --port<span class="o">=</span><span class="m">873</span> --progress--delete  /jenkins/ceshi Sync@2.2.2.2::Sync --password-file<span class="o">=</span>/jenkins/rsync.passwd


<span class="c1">#!/bin/bash</span>

<span class="nv">src</span><span class="o">=</span><span class="s1">&#39;/jenkins/jenkins_job&#39;</span>
<span class="nv">passwordfile</span><span class="o">=</span><span class="s1">&#39;/jenkins/rsync.passwd&#39;</span>
<span class="nv">user</span><span class="o">=</span><span class="s1">&#39;root&#39;</span>
<span class="nv">host</span><span class="o">=</span><span class="s1">&#39;2.2.2.2&#39;</span>
<span class="nv">rsync_module</span><span class="o">=</span><span class="s1">&#39;Sync&#39;</span>

/usr/bin/inotifywait -mrq --timefmt <span class="s1">&#39;%d/%m/%y %H:%M&#39;</span> --format <span class="s1">&#39;%T %w %f&#39;</span> -e modify,delete,create,attrib <span class="si">${</span><span class="nv">src</span><span class="si">}</span> <span class="p">|</span> <span class="k">while</span> <span class="nb">read</span> DATE TIME DIR file
<span class="k">do</span>
	/usr/bin/rsync -vzrtopg --delete --progress <span class="si">${</span><span class="nv">src</span><span class="si">}</span> <span class="si">${</span><span class="nv">user</span><span class="si">}</span>@<span class="si">${</span><span class="nv">host</span><span class="si">}</span>::<span class="si">${</span><span class="nv">rsync_module</span><span class="si">}</span> --password-file<span class="o">=</span><span class="si">${</span><span class="nv">passwordfile</span><span class="si">}</span>
	
	<span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">file</span><span class="si">}</span><span class="s2"> was rsynced at </span><span class="si">${</span><span class="nv">DATE</span><span class="si">}</span><span class="s2">_</span><span class="si">${</span><span class="nv">TIME</span><span class="si">}</span><span class="s2"> in </span><span class="si">${</span><span class="nv">DIR</span><span class="si">}</span><span class="s2">&#34;</span> &gt;&gt; /var/log/rsync.log 2&gt;<span class="p">&amp;</span><span class="m">1</span>
<span class="k">done</span>

</code></pre></td></tr></table>
</div>
</div><h3 id="方案三不同机器热备-rsyncinotify-tools-架构3">方案三、不同机器热备 rsync+Inotify-tools 架构<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></h3>
<ol>
<li>服务器A（主服务器）</li>
<li>服务器B（从服务器/备份服务器）</li>
</ol>
<ul>
<li>服务器B</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#在服务器B上安装rsync</span>
<span class="nb">cd</span> /app/local
wget  http://rsync.samba.org/ftp/rsync/src/rsync-3.1.1.tar.gz
tar zxf rsync-3.1.1.tar.gz
<span class="nb">cd</span> rsync-3.1.1
./configure
make <span class="o">&amp;&amp;</span> make install

<span class="c1">#设置rsync的配置文件</span>
vi /etc/rsyncd.conf

<span class="c1">#服务器B上的rsyncd.conf文件内容</span>
<span class="nv">uid</span><span class="o">=</span>root
<span class="nv">gid</span><span class="o">=</span>root
<span class="c1">#最大连接数</span>
max <span class="nv">connections</span><span class="o">=</span><span class="m">36000</span>
<span class="c1">#默认为true，修改为no，增加对目录文件软连接的备份 </span>
use <span class="nv">chroot</span><span class="o">=</span>no
<span class="c1">#定义日志存放位置</span>
log <span class="nv">file</span><span class="o">=</span>/var/log/rsyncd.log
<span class="c1">#忽略无关错误</span>
ignore <span class="nv">errors</span> <span class="o">=</span> yes
<span class="c1">#设置rsync服务端文件为读写权限</span>
<span class="nb">read</span> <span class="nv">only</span> <span class="o">=</span> no 
<span class="c1">#认证的用户名与系统帐户无关在认证文件做配置，如果没有这行则表明是匿名</span>
auth <span class="nv">users</span> <span class="o">=</span> rsync
<span class="c1">#密码认证文件，格式(虚拟用户名:密码）</span>
secrets <span class="nv">file</span> <span class="o">=</span> /etc/rsync.pass
<span class="c1">#这里是认证的模块名，在client端需要指定，可以设置多个模块和路径</span>
<span class="o">[</span>rsync<span class="o">]</span>
    <span class="c1">#自定义注释</span>
    <span class="nv">comment</span>  <span class="o">=</span> rsync
    <span class="c1">#同步到B服务器的文件存放的路径</span>
    <span class="nv">path</span><span class="o">=</span>/app/data/site/
<span class="o">[</span>img<span class="o">]</span>
    <span class="nv">comment</span>  <span class="o">=</span> img
    <span class="nv">path</span><span class="o">=</span>/app/data/site/img

<span class="c1">#创建rsync认证文件  可以设置多个，每行一个用户名:密码，注意中间以“:”分割</span>
<span class="nb">echo</span> <span class="s2">&#34;rsync:rsync&#34;</span> &gt; /etc/rsync.pass

<span class="c1">#设置文件所有者读取、写入权限</span>
chmod <span class="m">600</span> /etc/rsyncd.conf  
chmod <span class="m">600</span> /etc/rsync.pass  

<span class="c1">#启动服务器B上的rsync服务</span>
<span class="c1">#rsync --daemon -v</span>
rsync --daemon

<span class="c1">#监听端口873</span>
netstat -an <span class="p">|</span> grep <span class="m">873</span>
lsof -i tcp:873

COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
rsync   <span class="m">31445</span> root    4u  IPv4 <span class="m">443872</span>      0t0  TCP *:rsync <span class="o">(</span>LISTEN<span class="o">)</span>
rsync   <span class="m">31445</span> root    5u  IPv6 <span class="m">443873</span>      0t0  TCP *:rsync <span class="o">(</span>LISTEN<span class="o">)</span>


<span class="c1">#设置rsync为服务启动项（可选）</span>
<span class="nb">echo</span> <span class="s2">&#34;/usr/local/bin/rsync --daemon&#34;</span> &gt;&gt; /etc/rc.local

<span class="c1">#要 Kill rsync 进程，不要用 kill -HUP {PID} 的方式重启进程，以下3种方式任选</span>
<span class="c1">#ps -ef|grep rsync|grep -v grep|awk &#39;{print $2}&#39;|xargs kill -9</span>
<span class="c1">#cat /var/run/rsyncd.pid | xargs kill -9</span>
pkill rsync
<span class="c1">#再次启动</span>
/usr/local/bin/rsync --daemon


</code></pre></td></tr></table>
</div>
</div><ul>
<li>服务器A</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#安装rsync</span>
<span class="nb">cd</span> /app/local
wget  http://rsync.samba.org/ftp/rsync/src/rsync-3.1.1.tar.gz
tar zxf rsync-3.1.1.tar.gz
<span class="nb">cd</span> rsync-3.1.1
./configure
make <span class="o">&amp;&amp;</span> make install

<span class="c1">#安装inotify-tools</span>
<span class="nb">cd</span> /app/local
wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz
tar zxf inotify-tools-3.14.tar.gz
<span class="nb">cd</span> inotify-tools-3.14
./configure --prefix<span class="o">=</span>/app/local/inotify 
make <span class="o">&amp;&amp;</span> make install

<span class="c1">#安装sersync</span>
<span class="nb">cd</span> /app/local
wget https://sersync.googlecode.com/files/sersync2.5.4_64bit_binary_stable_final.tar.gz
tar zxf sersync2.5.4_64bit_binary_stable_final.tar.gz
mv /app/local/GNU-Linux-x86/ /app/local/sersync
<span class="nb">cd</span> /app/local/sersync
<span class="c1">#配置下密码文件，因为这个密码是要访问服务器B需要的密码和上面服务器B的密码必须一致</span>
<span class="nb">echo</span> <span class="s2">&#34;rsync&#34;</span> &gt; /app/local/sersync/user.pass
<span class="c1">#修改权限</span>
chmod <span class="m">600</span> /app/local/sersync/user.pass
<span class="c1">#修改confxml.conf</span>
vi /app/local/sersync/confxml.xml

</code></pre></td></tr></table>
</div>
</div><p>修改配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml">
<span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;ISO-8859-1&#34;?&gt;</span>
<span class="nt">&lt;head</span> <span class="na">version=</span><span class="s">&#34;2.5&#34;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;host</span> <span class="na">hostip=</span><span class="s">&#34;localhost&#34;</span> <span class="na">port=</span><span class="s">&#34;8008&#34;</span><span class="nt">&gt;&lt;/host&gt;</span>
 <span class="nt">&lt;debug</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;fileSystem</span> <span class="na">xfs=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;filter</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;exclude</span> <span class="na">expression=</span><span class="s">&#34;(.*)\.php&#34;</span><span class="nt">&gt;&lt;/exclude&gt;</span>
 <span class="nt">&lt;exclude</span> <span class="na">expression=</span><span class="s">&#34;^data/*&#34;</span><span class="nt">&gt;&lt;/exclude&gt;</span>
 <span class="nt">&lt;/filter&gt;</span>
 <span class="nt">&lt;inotify&gt;</span>
 <span class="nt">&lt;delete</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;createFolder</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;createFile</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;closeWrite</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;moveFrom</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;moveTo</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;attrib</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;modify</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/inotify&gt;</span>
 
 <span class="nt">&lt;sersync&gt;</span>
 <span class="nt">&lt;localpath</span> <span class="na">watch=</span><span class="s">&#34;/home/&#34;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- 这里填写服务器A要同步的文件夹路径--&gt;</span>
 <span class="nt">&lt;remote</span> <span class="na">ip=</span><span class="s">&#34;8.8.8.8&#34;</span> <span class="na">name=</span><span class="s">&#34;rsync&#34;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- 这里填写服务器B的IP地址和模块名--&gt;</span>
 <span class="nt">&lt;/localpath&gt;</span>
 <span class="nt">&lt;rsync&gt;</span>
 <span class="nt">&lt;commonParams</span> <span class="na">params=</span><span class="s">&#34;-artuz&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;auth</span> <span class="na">start=</span><span class="s">&#34;true&#34;</span> <span class="na">users=</span><span class="s">&#34;rsync&#34;</span> <span class="na">passwordfile=</span><span class="s">&#34;/app/local/sersync/user.pass&#34;</span><span class="nt">/&gt;</span> <span class="c">&lt;!-- rsync+密码文件 这里填写服务器B的认证信息--&gt;</span>
 <span class="nt">&lt;userDefinedPort</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span> <span class="na">port=</span><span class="s">&#34;874&#34;</span><span class="nt">/&gt;</span><span class="c">&lt;!-- port=874 --&gt;</span>
 <span class="nt">&lt;timeout</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span> <span class="na">time=</span><span class="s">&#34;100&#34;</span><span class="nt">/&gt;</span><span class="c">&lt;!-- timeout=100 --&gt;</span>
 <span class="nt">&lt;ssh</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/rsync&gt;</span>
 <span class="nt">&lt;failLog</span> <span class="na">path=</span><span class="s">&#34;/tmp/rsync_fail_log.sh&#34;</span> <span class="na">timeToExecute=</span><span class="s">&#34;60&#34;</span><span class="nt">/&gt;</span><span class="c">&lt;!--default every 60mins execute once--&gt;&lt;!-- 修改失败日志记录（可选）--&gt;</span>
 <span class="nt">&lt;crontab</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span> <span class="na">schedule=</span><span class="s">&#34;600&#34;</span><span class="nt">&gt;</span><span class="c">&lt;!--600mins--&gt;</span>
 <span class="nt">&lt;crontabfilter</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
 <span class="nt">&lt;/crontabfilter&gt;</span>
 <span class="nt">&lt;/crontab&gt;</span>
 <span class="nt">&lt;plugin</span> <span class="na">start=</span><span class="s">&#34;false&#34;</span> <span class="na">name=</span><span class="s">&#34;command&#34;</span><span class="nt">/&gt;</span>
 <span class="nt">&lt;/sersync&gt;</span>

<span class="nt">&lt;/head&gt;</span>

</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#运行sersync</span>
nohup /app/local/sersync/sersync2 -r -d -o /app/local/sersync/confxml.xml &gt;/app/local/sersync/rsync.log 2&gt;<span class="p">&amp;</span><span class="m">1</span> <span class="p">&amp;</span>

-d:启用守护进程模式
-r:在监控前，将监控目录与远程主机用rsync命令推送一遍
-n: 指定开启守护线程的数量，默认为10个
-o:指定配置文件，默认使用confxml.xml文件
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 添加一个保障</span>
<span class="c1"># vi  /home/crontab/check_sersync.sh</span>

<span class="c1">#!/bin/sh</span>

<span class="nv">sersync</span><span class="o">=</span><span class="s2">&#34;/usr/local/sersync/sersync2&#34;</span>

<span class="nv">confxml</span><span class="o">=</span><span class="s2">&#34;/usr/local/sersync/confxml.xml&#34;</span>

<span class="nv">status</span><span class="o">=</span><span class="k">$(</span>ps aux <span class="p">|</span>grep <span class="s1">&#39;sersync2&#39;</span><span class="p">|</span>grep -v <span class="s1">&#39;grep&#39;</span><span class="p">|</span>wc -l<span class="k">)</span>

<span class="k">if</span> <span class="o">[</span><span class="nv">$status</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span>

<span class="k">then</span>

<span class="nv">$sersync</span> -d-r -o <span class="nv">$confxml</span> <span class="p">&amp;</span>

<span class="k">else</span>

<span class="nb">exit</span> 0<span class="p">;</span>

<span class="k">fi</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="排错4">排错<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></h3>
<h2 id="文献">文献</h2>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://blog.51cto.com/canonind/1843994">CentOS7下Rsync+sersync实现数据实时同步</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p>[<a href="https://segmentfault.com/a/1190000002558330">关于rsync+inotify-tools实时同步模式</a>](<a href="https://segmentfault.com/a/1190000002558330">https://segmentfault.com/a/1190000002558330</a>)&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3" role="doc-endnote">
<p><a href="https://hub.fastgit.xyz/wsgzao/sersync">sersync</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4" role="doc-endnote">
<p><a href="https://blog.51cto.com/wjw7702/1148808">Rsync常见错误及命令详细参数</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">yesplease</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-02-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://cugbtang.github.io/tags/cicd/">cicd</a>
          <a href="http://cugbtang.github.io/tags/jenkins/">jenkins</a>
          <a href="http://cugbtang.github.io/tags/backup/">backup</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/go/series-go-1/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">Go, how to play?</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/devops/series-jenkins-2/">
            <span class="next-text nav-default">Jenkins, Q&amp;A</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="http://cugbtang.github.io" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://cugbtang.github.io" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="http://cugbtang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        cugbtang
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
