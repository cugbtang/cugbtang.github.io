<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>namespace &amp;&amp; cgroups  - ✌yesplease&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="yesplease" />
  <meta name="description" content="namespace 定义 ​ namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespa" />

  <meta name="keywords" content="yesplease, blog, technology" />






<meta name="generator" content="Hugo 0.93.0-DEV" />


<link rel="canonical" href="http://cugbtang.github.io/post/kubernetes/series-kubernetes-7/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="namespace &amp;&amp; cgroups " />
<meta property="og:description" content="namespace 定义 ​ namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespa" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://cugbtang.github.io/post/kubernetes/series-kubernetes-7/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-06-01T16:01:23+08:00" />
<meta property="article:modified_time" content="2022-06-01T16:01:23+08:00" />

<meta itemprop="name" content="namespace &amp;&amp; cgroups ">
<meta itemprop="description" content="namespace 定义 ​ namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespa"><meta itemprop="datePublished" content="2022-06-01T16:01:23+08:00" />
<meta itemprop="dateModified" content="2022-06-01T16:01:23+08:00" />
<meta itemprop="wordCount" content="2840">
<meta itemprop="keywords" content="kubernetes,term," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="namespace &amp;&amp; cgroups "/>
<meta name="twitter:description" content="namespace 定义 ​ namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespa"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">yesplease</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/">This is Home</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/post/">Archives</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/tags/">Tags</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/categories/">Categories</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/about/">About</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/cugbtang" rel="noopener" target="_blank">
              github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      yesplease
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/">This is Home</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/post/">Archives</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/tags/">Tags</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/categories/">Categories</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://cugbtang.github.io/about/">About</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://github.com/cugbtang" rel="noopener" target="_blank">
              github
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">namespace &amp;&amp; cgroups </h1>
      
      <div class="post-meta">
        <time datetime="2022-06-01" class="post-time">
          2022-06-01
        </time>
        <div class="post-category">
            <a href="http://cugbtang.github.io/categories/kubernetes/"> kubernetes </a>
            <a href="http://cugbtang.github.io/categories/cloudnative/"> cloudnative </a>
            
          </div>
        <span class="more-meta"> 2840 words </span>
          <span class="more-meta"> 6 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#namespace">namespace</a></li>
    <li><a href="#mount-namespace">Mount Namespace</a></li>
    <li><a href="#pid-namespace">PID Namespace</a></li>
    <li><a href="#uts-namespace">UTS Namespace</a></li>
    <li><a href="#ipc-namespace">IPC Namespace</a></li>
    <li><a href="#user-namespace">User Namespace</a></li>
    <li><a href="#net-namespace">Net Namespace</a></li>
    <li><a href="#为什么-docker-需要-namespace">为什么 docker 需要 namespace?</a></li>
  </ul>

  <ul>
    <li><a href="#subsystem">subsystem</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h2 id="namespace">namespace</h2>
<ul>
<li>
<p>定义</p>
<blockquote>
<p>​		namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespace 的工作方式通过为一组资源和进程设置相同的 namespace 而起作用，但是这些 namespace 引用了不同的资源。资源可能存在于多个 namespace 中。这些资源可以是进程ID、主机名、用户ID、文件名、与网络访问相关的名称和进程间通信。</p>
</blockquote>
</li>
<li>
<p>特征</p>
<blockquote>
<p>​        可以实现在同一主机系统中对进程ID、主机名、用户名ID、文件名、网络和进程间通信等资源的隔离</p>
</blockquote>
</li>
<li>
<p>类型</p>
</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">namespace</th>
<th style="text-align:center">summary</th>
<th style="text-align:center">kernel</th>
<th>describe</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Mount(mnt)</td>
<td style="text-align:center">隔离挂载点</td>
<td style="text-align:center">2.4.19</td>
<td>隔离不同的进程或进程组看到的挂载点，实现容器内只能看到自己的挂在信息，在容器内的挂载操作不会影响主机的挂载目录</td>
</tr>
<tr>
<td style="text-align:center">Process ID(pid)</td>
<td style="text-align:center">隔离进程 ID</td>
<td style="text-align:center">2.6.24</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Network(net)</td>
<td style="text-align:center">隔离网络设备，端口号等</td>
<td style="text-align:center">2.6.29</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Interprocess Communication(ipc)</td>
<td style="text-align:center">隔离 System VIPC 和 POSIX message queues</td>
<td style="text-align:center">2.6.19</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">UTS Namespace(uts)</td>
<td style="text-align:center">隔离主机名和域名</td>
<td style="text-align:center">2.6.19</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">User Namespace(user)</td>
<td style="text-align:center">隔离用户和用户组</td>
<td style="text-align:center">3.8</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Control group(cgroup) Namespce</td>
<td style="text-align:center">隔离 Cgroups 根目录</td>
<td style="text-align:center">4.6</td>
<td></td>
</tr>
<tr>
<td style="text-align:center">Time Namespace</td>
<td style="text-align:center">隔离系统时间</td>
<td style="text-align:center">5.6</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="mount-namespace">Mount Namespace</h2>
<blockquote>
<p>使用 unshare 命令可以新建 Mount Namespace，并且在新建的 Mount Namespace 内 mount 是和外部完全隔离的。</p>
</blockquote>
<ul>
<li>
<p>创建一个bash 进程并且新建一个 Mount Namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>vagrant@localhost ~<span class="o">]</span>$ sudo unshare --mount --fork /bin/bash
<span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>验证在独立的 namespce 内挂载文件，不影响别的</p>
<p>在 /tmp 目录下创建一个目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># mkdir /tmp/tmpfs</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 mount 命令挂载一个 tmpfs 类型的目录</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># mount -t tmpfs -o size=20m tmpfs /tmp/tmpfs</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 df 命令查看已经挂载的目录信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># df -h</span>
Filesystem                                                                          Size  Used Avail Use% Mounted on
/dev/sda1                                                                            40G  3.8G   37G  10% /
devtmpfs                                                                            457M     <span class="m">0</span>  457M   0% /dev
tmpfs                                                                               464M     <span class="m">0</span>  464M   0% /dev/shm
tmpfs                                                                               464M     <span class="m">0</span>  464M   0% /sys/fs/cgroup
tmpfs                                                                               464M   13M  451M   3% /run
tmpfs                                                                                93M     <span class="m">0</span>   93M   0% /run/user/1000
//172.29.0.1/vgt-2469b42ebff188de622646551002b263-6ad5fdbcbf2eaa93bd62f92333a2e6e5  466G  171G  295G  37% /vagrant
tmpfs                                                                                20M     <span class="m">0</span>   20M   0% /tmp/tmpfs
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新打开一个命令窗口，执行 df 命令查看主机的挂载信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="o">[</span>vagrant@localhost ~<span class="o">]</span>$ df -h
Filesystem                                                                          Size  Used Avail Use% Mounted on
devtmpfs                                                                            457M     <span class="m">0</span>  457M   0% /dev
tmpfs                                                                               464M     <span class="m">0</span>  464M   0% /dev/shm
tmpfs                                                                               464M   13M  451M   3% /run
tmpfs                                                                               464M     <span class="m">0</span>  464M   0% /sys/fs/cgroup
/dev/sda1                                                                            40G  3.8G   37G  10% /
//172.29.0.1/vgt-2469b42ebff188de622646551002b263-6ad5fdbcbf2eaa93bd62f92333a2e6e5  466G  171G  295G  37% /vagrant
tmpfs                                                                                93M     <span class="m">0</span>   93M   0% /run/user/1000
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>基本验证完毕。接着我们查看新的mount namespace 信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># ls -l /proc/self/ns/</span>
total <span class="m">0</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 ipc -&gt; ipc:<span class="o">[</span>4026531839<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 mnt -&gt; mnt:<span class="o">[</span>4026532117<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 net -&gt; net:<span class="o">[</span>4026531956<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 pid -&gt; pid:<span class="o">[</span>4026531836<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 user -&gt; user:<span class="o">[</span>4026531837<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 09:56 uts -&gt; uts:<span class="o">[</span>4026531838<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新打开一个命令窗口，使用相同的命令查看主机上的 namespace 信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@localhost ~<span class="o">]</span>$ ls -l /proc/self/ns/
total <span class="m">0</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 ipc -&gt; ipc:<span class="o">[</span>4026531839<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 mnt -&gt; mnt:<span class="o">[</span>4026531840<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 net -&gt; net:<span class="o">[</span>4026531956<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 pid -&gt; pid:<span class="o">[</span>4026531836<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 user -&gt; user:<span class="o">[</span>4026531837<span class="o">]</span>
lrwxrwxrwx. <span class="m">1</span> vagrant vagrant <span class="m">0</span> Feb <span class="m">26</span> 09:57 uts -&gt; uts:<span class="o">[</span>4026531838<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="pid-namespace">PID Namespace</h2>
<blockquote>
<p>用来隔离进程，在不同的namespace内可以拥有相同的进程号</p>
</blockquote>
<ul>
<li>
<p>创建一个 bash 进程，并且新建一个 PID Namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@localhost ~<span class="o">]</span>$ sudo unshare --pid --fork --mount-proc /bin/bash
<span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在当前的命令行窗口使用 ps aux 命令查看进程信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># ps aux</span>
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         <span class="m">1</span>  0.0  0.2  <span class="m">15792</span>  <span class="m">2616</span> pts/3    S    13:59   0:00 /bin/bash
root        <span class="m">16</span>  0.0  0.1  <span class="m">55192</span>  <span class="m">1844</span> pts/3    R+   14:02   0:00 ps aux
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="uts-namespace">UTS Namespace</h2>
<blockquote>
<p>它允许每个UTS Namespace 拥有一个独立的主机名</p>
</blockquote>
<ul>
<li>
<p>使用 unshare 命令创建一个 UTS Namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@localhost ~<span class="o">]</span>$ sudo unshare --uts --fork /bin/bash
<span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 hostname 命令设置主机</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># hostname -b docker</span>
<span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># hostname</span>
docker
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>新打开一个命令行窗口，使用相同的命令查看主机的hostname</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@localhost vagrant<span class="o">]</span><span class="c1"># localhost</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="ipc-namespace">IPC Namespace</h2>
<blockquote>
<p>主要用来隔离进程间通信的。PID Namespace 和 IPC Namespace一起使用可以实现同一 IPC Namespace 内的进程彼此可以通信，不同 IPC Namespace 的进程却不能通信。</p>
</blockquote>
<ul>
<li>
<p>使用 unshare 命令创建一个 IPC Namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ sudo unshare --ipc --fork /bin/bash
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>另起一个窗口，查看系统的通信进程</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ ipcs -q

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在新的ipc namespace下新建一个进程通信队列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@docker vagrant<span class="o">]</span><span class="c1"># ipcmk -Q</span>
Message queue id: <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>查看当前ipc namespace 下的系统通信队列列表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@docker vagrant<span class="o">]</span><span class="c1"># ipcs -q</span>

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
0x2ae315e9 <span class="m">0</span>          root       <span class="m">644</span>        <span class="m">0</span>            <span class="m">0</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>再次查看主机的系统通信队列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ ipcs -q

------ Message Queues --------
key        msqid      owner      perms      used-bytes   messages
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="user-namespace">User Namespace</h2>
<blockquote>
<p>主要用来隔离用户和用户组。可以实现进程在容器内拥有 root 权限， 而在主机上却只是普通用户。</p>
</blockquote>
<ul>
<li>
<p>以普通用户的身份创建一个 User Namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ unshare --user --fork /bin/bash
unshare: unshare failed: Invalid argument
<span class="c1"># 查看内核版本</span>
<span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ uname -a
Linux docker 3.10.0-1127.el7.x86_64 <span class="c1">#1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
<span class="c1"># 查阅资料</span>
<span class="c1"># max_user_namespaces文件记录了允许创建的user namespace数量，我的CentOS 7.5默认是0，修改之</span>
<span class="nb">echo</span> <span class="m">2147483647</span> &gt; /proc/sys/user/max_user_namespaces
<span class="c1"># 再次运行</span>
<span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ unshare --user -r /bin/bash
<span class="o">[</span>root@docker ~<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>执行 id 命令查看当前的用户信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@docker ~<span class="o">]</span><span class="c1"># id</span>
<span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,65534<span class="o">(</span>nfsnobody<span class="o">)</span> <span class="nv">context</span><span class="o">=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>在当前窗口执行 reboot 命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@docker ~<span class="o">]</span><span class="c1"># reboot</span>
Failed to open /dev/initctl: Permission denied
Failed to talk to init daemon.
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="net-namespace">Net Namespace</h2>
<blockquote>
<p>用来隔离网络设备、IP地址和端口等信息。</p>
<p>可以让每个进程拥有自己独立的IP地址，端口和网卡信息</p>
</blockquote>
<ul>
<li>
<p>首先查看主机上的ip 信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="m">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc mq state UP group default qlen <span class="m">1000</span>
    link/ether 00:15:5d:25:01:09 brd ff:ff:ff:ff:ff:ff
    inet 172.29.5.132/20 brd 172.29.15.255 scope global noprefixroute dynamic eth0
       valid_lft 82979sec preferred_lft 82979sec
    inet6 fe80::215:5dff:fe25:109/64 scope link
       valid_lft forever preferred_lft forever
3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span class="m">1500</span> qdisc noqueue state DOWN group default
    link/ether 02:42:f0:82:11:e0 brd ff:ff:ff:ff:ff:ff
    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
       valid_lft forever preferred_lft forever
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>创建 net namespace</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ sudo unshare --net --fork /bin/bash
<span class="o">[</span>root@docker vagrant<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>使用 ip a命令查看当前namespace的网络信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>root@docker vagrant<span class="o">]</span><span class="c1"># ip a</span>
1: lo: &lt;LOOPBACK&gt; mtu <span class="m">65536</span> qdisc noop state DOWN group default qlen <span class="m">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="为什么-docker-需要-namespace">为什么 docker 需要 namespace?</h2>
<p>Linux 内核从2002年2.4.19版本开始加入了 Mount Namspace</p>
<p>内核3.8版本加入了 User Namespace 为容器提供了足够的支持功能</p>
<p>当 docker 新建一个容器时</p>
<p>会创建这六种 namespace， 然后将容器中的进程加入这些 namespace之中</p>
<h1 id="cgroups">Cgroups</h1>
<ul>
<li>
<p>定义</p>
<p>全程是 control groups， 是Linux 内核的一个功能。可以实现限制进程或者进程组的资源（cpu、mem、磁盘IO等）</p>
</li>
<li>
<p>特征</p>
<p>资源限制：限制资源的使用量</p>
<p>优先级控制： 不同的组可以有不用的资源使用优先级</p>
<p>审计：计算控制组的资源使用情况</p>
<p>控制： 控制进程的挂起或恢复</p>
</li>
<li>
<p>核心</p>
<p>subsystem: 一个内核的组件，代表一类资源调度控制器</p>
<p>cgroup： 表示一组进程和一组带有参数的子系统的关联关系</p>
<p>hierarchy：由一些列的控制组按照树状结构排列组成的子控制组默认拥有父控制组的属性</p>
</li>
</ul>
<h2 id="subsystem">subsystem</h2>
<ul>
<li>
<p>查看当前主机使用了哪些子系统</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="o">[</span>vagrant@docker ~<span class="o">]</span>$ sudo mount -t cgroup
cgroup on /sys/fs/cgroup/systemd <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent<span class="o">=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span class="o">=</span>systemd<span class="o">)</span>
cgroup on /sys/fs/cgroup/cpuset <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,cpuset<span class="o">)</span>
cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,cpuacct,cpu<span class="o">)</span>
cgroup on /sys/fs/cgroup/perf_event <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,perf_event<span class="o">)</span>
cgroup on /sys/fs/cgroup/blkio <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,blkio<span class="o">)</span>
cgroup on /sys/fs/cgroup/memory <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,memory<span class="o">)</span>
cgroup on /sys/fs/cgroup/hugetlb <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,hugetlb<span class="o">)</span>
cgroup on /sys/fs/cgroup/freezer <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,freezer<span class="o">)</span>
cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,net_prio,net_cls<span class="o">)</span>
cgroup on /sys/fs/cgroup/devices <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,devices<span class="o">)</span>
cgroup on /sys/fs/cgroup/pids <span class="nb">type</span> cgroup <span class="o">(</span>rw,nosuid,nodev,noexec,relatime,seclabel,pids<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>以 cpu 子系统为例，演示 cgroups 如何限制进程的 cpu使用时间</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">#在cpu子系统下创建测试文件夹</span>
mkdir /sys/fs/cgroup/cpu/mydocker
<span class="c1">#查看</span>
<span class="o">[</span>root@docker vagrant<span class="o">]</span><span class="c1"># ls /sys/fs/cgroup/cpu/mydocker -l</span>
total <span class="m">0</span>
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cgroup.clone_children
--w--w--w-. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cgroup.event_control
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cgroup.procs
-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpuacct.stat
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpuacct.usage
-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpuacct.usage_percpu
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.cfs_period_us
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.cfs_quota_us
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.rt_period_us
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.rt_runtime_us
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.shares
-r--r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 cpu.stat
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 notify_on_release
-rw-r--r--. <span class="m">1</span> root root <span class="m">0</span> Feb <span class="m">26</span> 15:15 tasks
<span class="c1"># 将当前shell进程加入cgroup</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># echo $$&gt; tasks</span>
<span class="c1"># 查看tasks文件内容</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1">#</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>mem</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 在memory子系统下创建cgroup</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># mkdir /sys/fs/cgroup/memory/mydocker</span>

<span class="c1"># 查看新建目录中的内容</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># ls</span>
cgroup.clone_children
cgroup.event_control
cgroup.procs
memory.failcnt
memory.force_empty
memory.kmem.failcnt
memory.kmem.limit_in_bytes
memory.kmem.max_usage_in_bytes
memory.kmem.slabinfo
memory.kmem.tcp.failcnt
memory.kmem.tcp.limit_in_bytes
memory.kmem.tcp.max_usage_in_bytes
memory.kmem.tcp.usage_in_bytes
memory.kmem.usage_in_bytes
memory.limit_in_bytes
memory.max_usage_in_bytes
memory.memsw.failcnt
memory.memsw.limit_in_bytes
memory.memsw.max_usage_in_bytes
memory.memsw.usage_in_bytes
memory.move_charge_at_immigrate
memory.numa_stat
memory.oom_control
memory.pressure_level
memory.soft_limit_in_bytes
memory.stat
memory.swappiness
memory.usage_in_bytes
memory.use_hierarchy
notify_on_release
tasks

<span class="c1"># 限制内存使用</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># echo 1073741824 &gt; memory.limit_in_bytes</span>

<span class="c1"># 将当前shell写入tasks内</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># echo $$&gt;tasks</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># cat tasks</span>
<span class="m">3356</span>
<span class="m">3484</span>
<span class="c1"># 申请内存，当达到1G时 被杀死</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># memtester 1500M 1</span>
memtester version 4.3.0 <span class="o">(</span>64-bit<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> 2001-2012 Charles Cazabon.
Licensed under the GNU General Public License version <span class="m">2</span> <span class="o">(</span>only<span class="o">)</span>.

pagesize is <span class="m">4096</span>
pagesizemask is 0xfffffffffffff000
want 1500MB <span class="o">(</span><span class="m">1572864000</span> bytes<span class="o">)</span>
got  1500MB <span class="o">(</span><span class="m">1572864000</span> bytes<span class="o">)</span>, trying mlock ...Killed

<span class="c1"># 修改申请大小，完美</span>
<span class="o">[</span>root@docker mydocker<span class="o">]</span><span class="c1"># memtester 500M 1</span>
memtester version 4.3.0 <span class="o">(</span>64-bit<span class="o">)</span>
Copyright <span class="o">(</span>C<span class="o">)</span> 2001-2012 Charles Cazabon.
Licensed under the GNU General Public License version <span class="m">2</span> <span class="o">(</span>only<span class="o">)</span>.

pagesize is <span class="m">4096</span>
pagesizemask is 0xfffffffffffff000
want 500MB <span class="o">(</span><span class="m">524288000</span> bytes<span class="o">)</span>
got  500MB <span class="o">(</span><span class="m">524288000</span> bytes<span class="o">)</span>, trying mlock ...locked.
Loop 1/1:
  Stuck Address       : ok
  Random Value        : ok
  Compare XOR         : ok
  Compare SUB         : ok
  Compare MUL         : ok
  Compare DIV         : ok
  Compare OR          : ok
  Compare AND         : ok
  Sequential Increment: ok
  Solid Bits          : ok
  Block Sequential    : ok
  Checkerboard        : ok
  Bit Spread          : ok
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>docker 是如何使用cgroups的？</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">docker run -ti -m<span class="o">=</span>1g nginx
</code></pre></td></tr></table>
</div>
</div></li>
</ul>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">yesplease</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      2022-06-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://cugbtang.github.io/tags/kubernetes/">kubernetes</a>
          <a href="http://cugbtang.github.io/tags/term/">term</a>
          
        </div>

      
      <nav class="post-nav">
        
        
          <a class="next" href="/post/kubernetes/series-kubernetes-2/">
            <span class="next-text nav-default">kubeadm startup Kubernetes less than v1.20.0 (centos&#43;docker&#43;ipvs&#43;calico)</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="http://cugbtang.github.io" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="http://cugbtang.github.io" rel="me noopener" class="iconfont"
      title="bilibili"  target="_blank"
      >
      <svg
  class="icon" style="" viewBox="0 0 1024 1024" version="1.1" width="36"
  height="36" id="svg8">
  <path
      style=""
      d="M 744.60599,0.00486267 A 41.779915,41.779915 0 0 0 710.4184,18.673394 L 548.5048,255.32642 h -11.70046 a 41.779915,41.779915 0 0 0 -10.80295,-7.84928 L 235.66,97.084498 a 41.779915,41.779915 0 0 0 -20.07193,-4.960864 41.779915,41.779915 0 0 0 -18.3748,79.145436 L 359.4859,255.32642 H 128.16909 c -49.458302,0 -89.27932,39.82105 -89.27932,89.27932 v 508.65224 c 0,49.4583 39.821018,89.27934 89.27932,89.27934 h 19.48445 C 149.12802,984.5043 179.92773,1024 224.79179,1024 c 44.86407,0 75.66379,-39.4957 77.13826,-81.46268 H 719.98116 C 721.45559,984.5043 752.25533,1024 797.1194,1024 c 44.86406,0 75.6638,-39.4957 77.13824,-81.46268 h 21.57323 c 49.45831,0 89.27936,-39.82104 89.27936,-89.27934 V 344.60574 c 0,-49.45827 -39.82105,-89.27932 -89.27936,-89.27932 H 649.74567 L 779.38103,65.866924 A 41.779915,41.779915 0 0 0 744.60599,0.00486267 Z M 644.49108,418.70871 c 6.29985,0.21538 12.44451,2.01107 17.86888,5.22196 l 171.36218,98.10771 c 18.23417,10.21935 24.63334,33.34627 14.24614,51.48533 -10.38726,18.13909 -33.57344,24.32718 -51.61587,13.77296 L 624.9903,489.18895 c -15.21356,-8.41858 -22.66871,-26.1765 -18.03211,-42.93436 4.63664,-16.75784 20.15573,-28.14465 37.53289,-27.54588 z M 350.2006,432.31846 c 16.89952,0.0317 31.69582,11.33328 36.17844,27.62747 4.48262,16.2942 -2.44981,33.57765 -16.95507,42.24898 l -140.7157,86.91312 c -17.68528,11.18244 -41.09629,5.77692 -52.08912,-12.02686 -10.99282,-17.80373 -5.33855,-41.15658 12.58167,-51.95857 L 329.9002,438.2095 c 6.0643,-3.86439 13.10951,-5.90891 20.3004,-5.89104 z M 501.605,641.53985 c 3.75002,-0.15248 7.48645,0.53903 10.93349,2.0235 0.15842,0.0637 0.31618,0.12888 0.47325,0.19582 0.59328,0.27092 1.17574,0.56489 1.74609,0.88121 0.15868,0.0854 0.31643,0.17233 0.47325,0.2611 0.55694,0.32165 1.10131,0.66458 1.63185,1.02807 0.16455,0.1123 0.32777,0.2265 0.48956,0.34269 0.50382,0.36781 0.99371,0.75428 1.46868,1.15864 0.18724,0.15504 0.37218,0.31282 0.55484,0.47323 0.43271,0.38784 0.8518,0.79061 1.25653,1.20756 0.15449,0.16114 0.30679,0.32437 0.45693,0.48959 0.40798,0.44266 0.79989,0.89988 1.17494,1.37076 0.17799,0.22544 0.35205,0.45395 0.5222,0.68538 0.25932,0.34701 0.50964,0.70071 0.75064,1.06071 0.26712,0.39516 0.52286,0.79784 0.76699,1.20757 0.16907,0.29043 0.33231,0.58424 0.48957,0.88123 0.21836,0.41297 0.42513,0.83199 0.62009,1.25653 0.14836,0.32333 0.28983,0.64976 0.42429,0.97911 0.21319,0.51552 0.40915,1.03801 0.58747,1.5666 0.0677,0.19499 0.13296,0.39085 0.19582,0.58748 0.18652,0.60823 0.34984,1.22334 0.48957,1.84399 0.0397,0.16277 0.0779,0.32601 0.11423,0.48957 0.1436,0.69112 0.25788,1.38801 0.34269,2.08877 0.005,0.0381 0.0111,0.0761 0.0163,0.11424 0.0857,0.78056 0.13474,1.56471 0.14687,2.34988 0.005,0.0543 0.0111,0.10879 0.0163,0.1632 0,0 -0.008,1.12132 0,1.45234 0,0 -0.14697,17.84761 5.89102,34.12231 3.01902,8.13734 7.33278,15.10615 12.61433,19.61501 5.28157,4.50889 11.42894,7.62081 23.64572,7.62081 12.2168,0 18.36416,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.5953,-11.47767 12.6143,-19.61501 6.03799,-16.2747 5.89103,-34.12231 5.89103,-34.12231 -0.44885,-13.87045 10.45922,-25.46302 24.3311,-25.86506 13.87189,-0.40201 25.42828,10.53953 25.78348,24.41272 0,0 1.11929,25.7226 -9.00791,53.01927 -5.06359,13.64832 -13.1986,28.46036 -27.05631,40.29073 -13.85772,11.83039 -33.5454,19.63135 -56.20142,19.63135 -22.65603,0 -42.34371,-7.80096 -56.20141,-19.63135 -4.1801,-3.56856 -7.78733,-7.42433 -10.99878,-11.42303 -3.21235,4.00037 -6.81703,7.85309 -10.99876,11.42303 -13.85773,11.83039 -33.5454,19.63135 -56.20144,19.63135 -22.65601,0 -42.3437,-7.80096 -56.2014,-19.63135 -13.85775,-11.83037 -21.99272,-26.64241 -27.05632,-40.29073 -10.12725,-27.29667 -9.00789,-53.01928 -9.00789,-53.01927 0.20714,-13.83687 11.58744,-24.88848 25.42444,-24.69013 14.1263,0.19991 25.2971,12.0278 24.69011,26.14247 0,0 -0.14697,17.84761 5.89103,34.12231 3.01902,8.13734 7.31646,15.10615 12.598,19.61501 5.28155,4.50889 11.44526,7.62081 23.66203,7.62081 12.21681,0 18.36418,-3.11192 23.64573,-7.62081 5.28154,-4.50886 9.57899,-11.47767 12.598,-19.61501 5.76352,-15.53489 5.89112,-32.05691 5.89103,-33.56746 0.006,-0.37466 0.0111,-1.05336 0.0163,-1.20759 -0.0117,-0.74583 0.0105,-1.49177 0.0652,-2.23565 0.009,-0.15784 0.0204,-0.31561 0.0327,-0.47324 0.14204,-1.56859 0.43163,-3.12027 0.86487,-4.63449 0.0213,-0.0763 0.0433,-0.15244 0.0652,-0.22848 3.0335,-10.25748 12.24157,-17.46007 22.92769,-17.93417 z"
      id="rect824"/>
</svg>

    </a>


<a href="http://cugbtang.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2017 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        cugbtang
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.dee43230127a73d039a734510fa896c89c3c7ce0cf0be0c7a7433f8fd69b76dc.js" integrity="sha256-3uQyMBJ6c9A5pzRRD6iWyJw8fODPC&#43;DHp0M/j9abdtw=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
