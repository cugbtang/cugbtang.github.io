<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>æ·±åº¦å­¦ä¹  on âœŒyesplease's blog</title><link>http://localhost:1313/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/</link><description>Recent content in æ·±åº¦å­¦ä¹  on âœŒyesplease's blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><managingEditor>cugbtang@sina.com (yesplease)</managingEditor><webMaster>cugbtang@sina.com (yesplease)</webMaster><lastBuildDate>Tue, 23 Dec 2025 00:00:00 +0000</lastBuildDate><atom:link href="http://localhost:1313/categories/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/index.xml" rel="self" type="application/rss+xml"/><item><title>Hugging Face ä¸‰å‰‘å®¢ï¼šTransformersã€PEFTã€TRL å®Œå…¨æŒ‡å—</title><link>http://localhost:1313/post/llm/llm-4.2/</link><pubDate>Tue, 23 Dec 2025 00:00:00 +0000</pubDate><author>cugbtang@sina.com (yesplease)</author><guid>http://localhost:1313/post/llm/llm-4.2/</guid><description>&lt;h1 id="å¤§æ¨¡å‹è®­ç»ƒçš„æ ‡å‡†å·¥å…·ç®±"&gt;å¤§æ¨¡å‹è®­ç»ƒçš„â€œæ ‡å‡†å·¥å…·ç®±â€&lt;/h1&gt;
&lt;p&gt;å½“ç„¶å¯ä»¥ï¼ä½ æåˆ°çš„ &lt;strong&gt;transformers&lt;/strong&gt;ã€&lt;strong&gt;trl&lt;/strong&gt;ã€&lt;strong&gt;peft&lt;/strong&gt; æ˜¯å½“å‰å¤§æ¨¡å‹ï¼ˆå°¤å…¶æ˜¯å¤§è¯­è¨€æ¨¡å‹ï¼‰å¼€å‘å’Œè®­ç»ƒä¸­éå¸¸ä¸»æµçš„ä¸‰ä¸ªå¼€æº Python åº“ï¼Œç”± Hugging Face åŠå…¶ç¤¾åŒºä¸»å¯¼ã€‚å®ƒä»¬å„è‡ªè§£å†³ä¸åŒç¯èŠ‚çš„é—®é¢˜ï¼Œä¸”é«˜åº¦å…¼å®¹ã€å¯ç»„åˆä½¿ç”¨ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢æˆ‘ç”¨&lt;strong&gt;ç®€å•è§£é‡Š + å½¢è±¡æ¯”å–»&lt;/strong&gt;çš„æ–¹å¼å¸®ä½ ç†è§£ï¼š&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id="1-transformers"&gt;1. &lt;strong&gt;Transformers&lt;/strong&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¸“ä¸šè§£é‡Š&lt;/strong&gt;ï¼š&lt;br&gt;
Hugging Face æä¾›çš„æ ¸å¿ƒåº“ï¼Œå°è£…äº†å¤§é‡é¢„è®­ç»ƒæ¨¡å‹ï¼ˆå¦‚ BERTã€GPTã€Llamaã€Qwen ç­‰ï¼‰çš„æ¶æ„ã€åŠ è½½æ–¹å¼å’Œæ¨ç†æ¥å£ã€‚ä½ å¯ä»¥è½»æ¾ä¸‹è½½ã€ä½¿ç”¨æˆ–å¾®è°ƒè¿™äº›æ¨¡å‹ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ¯”å–»&lt;/strong&gt;ï¼š&lt;br&gt;
å°±åƒä¸€ä¸ªâ€œæ™ºèƒ½æœºå™¨äººè¶…å¸‚â€â€”â€”é‡Œé¢æ‘†æ»¡äº†å„ç§ç°æˆçš„æœºå™¨äººï¼ˆæ¨¡å‹ï¼‰ï¼Œæœ‰çš„ä¼šå†™è¯—ï¼Œæœ‰çš„ä¼šç¿»è¯‘ï¼Œæœ‰çš„ä¼šç¼–ç¨‹ã€‚ä½ ä¸ç”¨ä»èºä¸é’‰å¼€å§‹é€ ï¼Œç›´æ¥é€‰ä¸€ä¸ªå¸¦å›å®¶ï¼Œæ’ç”µå°±èƒ½ç”¨ï¼Œè¿˜èƒ½è‡ªå·±æ”¹è£…ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h3 id="2-peftparameter-efficient-fine-tuningå‚æ•°é«˜æ•ˆå¾®è°ƒ"&gt;2. &lt;strong&gt;PEFTï¼ˆParameter-Efficient Fine-Tuningï¼Œå‚æ•°é«˜æ•ˆå¾®è°ƒï¼‰&lt;/strong&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¸“ä¸šè§£é‡Š&lt;/strong&gt;ï¼š&lt;br&gt;
ä¸€ä¸ªä¸“æ³¨äº&lt;strong&gt;é«˜æ•ˆå¾®è°ƒ&lt;/strong&gt;çš„å·¥å…·åº“ï¼Œæ”¯æŒ LoRAã€Prefix Tuningã€Adapter ç­‰æŠ€æœ¯ã€‚å®ƒè®©ä½ åªè®­ç»ƒæ¨¡å‹çš„ä¸€å°éƒ¨åˆ†å‚æ•°ï¼ˆæ¯”å¦‚åŠ å‡ ä¸ªå°æ¨¡å—ï¼‰ï¼Œè€Œå†»ç»“åŸå§‹å¤§æ¨¡å‹ï¼Œå¤§å¹…èŠ‚çœæ˜¾å­˜å’Œç®—åŠ›ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ¯”å–»&lt;/strong&gt;ï¼š&lt;br&gt;
æƒ³ç»™ä¸€è¾†è±ªåè·‘è½¦ï¼ˆå¤§æ¨¡å‹ï¼‰åŠ è‡ªåŠ¨é©¾é©¶åŠŸèƒ½ã€‚ä¼ ç»Ÿæ–¹æ³•è¦æ‹†æ‰æ•´ä¸ªå¼•æ“é‡è£…ï¼ˆå…¨å‚æ•°å¾®è°ƒï¼‰ï¼Œè´¹æ—¶è´¹é’±ï¼›&lt;br&gt;
è€Œ PEFT å°±åƒåªåœ¨æ–¹å‘ç›˜ä¸ŠåŠ ä¸€ä¸ªâ€œæ™ºèƒ½è¾…åŠ©å¥—ä»¶â€ï¼ˆLoRA æ¨¡å—ï¼‰ï¼Œä¸åŠ¨åŸè½¦ç»“æ„ï¼Œä¾¿å®œåˆå¿«ï¼Œæ•ˆæœè¿˜ä¸å·®ï¼&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h3 id="3-trltransformer-reinforcement-learning"&gt;3. &lt;strong&gt;TRLï¼ˆTransformer Reinforcement Learningï¼‰&lt;/strong&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¸“ä¸šè§£é‡Š&lt;/strong&gt;ï¼š&lt;br&gt;
ä¸“ä¸º&lt;strong&gt;ç”¨å¼ºåŒ–å­¦ä¹ è®­ç»ƒè¯­è¨€æ¨¡å‹&lt;/strong&gt;è®¾è®¡çš„åº“ï¼Œæ”¯æŒ PPOã€DPOã€SPOã€GRPO ç­‰ç®—æ³•ï¼Œå¸¸ç”¨äº RLHF æˆ– RLAIF é˜¶æ®µã€‚å®ƒåŸºäº Transformers å’Œ PEFT æ„å»ºï¼Œèƒ½æ— ç¼å¯¹æ¥é¢„è®­ç»ƒæ¨¡å‹å’Œé«˜æ•ˆå¾®è°ƒã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ¯”å–»&lt;/strong&gt;ï¼š&lt;br&gt;
å¦‚æœè¯´ Transformers æ˜¯â€œæœºå™¨äººæœ¬ä½“â€ï¼ŒPEFT æ˜¯â€œå¯æ’æ‹”æŠ€èƒ½åŒ…â€ï¼Œé‚£ TRL å°±æ˜¯â€œAIæ•™ç»ƒç³»ç»Ÿâ€ã€‚&lt;br&gt;
å®ƒè®©æœºå™¨äººé€šè¿‡ä¸æ–­è¯•é”™ï¼ˆæ¯”å¦‚å†™å›ç­” â†’ è¢«æ‰“åˆ† â†’ æ”¹è¿›ï¼‰æ¥å˜å¾—è¶Šæ¥è¶Šæ‡‚äººç±»å–œå¥½ï¼Œå°±åƒè¯·äº†ä¸€ä½ä¸¥å‰ä½†é«˜æ•ˆçš„ç§æ•™ï¼Œä¸“é—¨è®­ç»ƒæœºå™¨äººâ€œå¯Ÿè¨€è§‚è‰²â€ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h3 id="-ä¸‰è€…å¦‚ä½•ååŒå·¥ä½œæ•´ä½“æ¯”å–»"&gt;ğŸ§© ä¸‰è€…å¦‚ä½•ååŒå·¥ä½œï¼Ÿï¼ˆæ•´ä½“æ¯”å–»ï¼‰&lt;/h3&gt;
&lt;p&gt;æƒ³è±¡ä½ è¦æ‰“é€ ä¸€ä¸ª&lt;strong&gt;ä¼šå†™å°è¯´çš„ AI ä½œå®¶&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Transformers&lt;/strong&gt;ï¼šä½ ä» Hugging Face ä¸‹è½½ä¸€ä¸ªå·²ç»è¯»è¿‡åƒä¸‡æœ¬ä¹¦çš„â€œæ–‡å­¦é’å¹´â€åŸºç¡€æ¨¡å‹ï¼›&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PEFTï¼ˆæ¯”å¦‚ LoRAï¼‰&lt;/strong&gt;ï¼šä½ ä¸æƒ³é‡è®­æ•´ä¸ªå¤§è„‘ï¼Œäºæ˜¯åªåœ¨ä»–â€œåˆ›æ„æ¨¡å—â€ä¸ŠåŠ ä¸€ä¸ªå°æ’ä»¶ï¼Œä¸“é—¨å­¦ä½ çš„å†™ä½œé£æ ¼ï¼›&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TRL&lt;/strong&gt;ï¼šä½ å†è¯·ä¸€ä½â€œAI ç¼–è¾‘â€ï¼ˆå¥–åŠ±æ¨¡å‹æˆ–åå¥½æ•°æ®ï¼‰ç»™ä»–æ¯ç¯‡è‰ç¨¿æ‰“åˆ†ï¼Œç”¨ PPO æˆ– SPO ç®—æ³•è®©ä»–è¶Šå†™è¶Šç¬¦åˆè¯»è€…å£å‘³ã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;blockquote&gt;
&lt;p&gt;è¿™ä¸‰ä¸ªå·¥å…·å°±åƒâ€œèº«ä½“ + æ’ä»¶ + æ•™ç»ƒâ€çš„é»„é‡‘ç»„åˆï¼Œæ—¢çœèµ„æºï¼Œåˆæ•ˆæœå¥½ï¼Œè€Œä¸”&lt;strong&gt;å®Œå…¨å…¼å®¹&lt;/strong&gt;â€”â€”Hugging Face ç”Ÿæ€çš„è®¾è®¡å“²å­¦å°±æ˜¯â€œä¹é«˜å¼æ‹¼è£…â€ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr&gt;
&lt;h3 id="-ä¸€å¥è¯æ€»ç»“"&gt;âœ… ä¸€å¥è¯æ€»ç»“ï¼š&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Transformers&lt;/strong&gt;ï¼šæä¾›ç°æˆçš„å¤§æ¨¡å‹â€œèº¯ä½“â€ï¼›&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PEFT&lt;/strong&gt;ï¼šç”¨æœ€å°ä»£ä»·ç»™èº¯ä½“åŠ â€œæ–°æŠ€èƒ½â€ï¼›&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;TRL&lt;/strong&gt;ï¼šç”¨å¼ºåŒ–å­¦ä¹ å½“â€œæ•™ç»ƒâ€ï¼Œè®© AI è¶Šç»ƒè¶Šèªæ˜ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å®ƒä»¬ä¸€èµ·æ„æˆäº†ç°ä»£å¤§æ¨¡å‹è®­ç»ƒçš„â€œæ ‡å‡†å·¥å…·ç®±â€ã€‚&lt;/p&gt;</description></item><item><title>æ·±åº¦å­¦ä¹ ä¸­çš„æ¢¯åº¦æ¶ˆå¤±ä¸çˆ†ç‚¸ï¼šä»æ•°å­¦åŸºç¡€åˆ°ç°ä»£è§£å†³æ–¹æ¡ˆ</title><link>http://localhost:1313/post/llm/llm-5/</link><pubDate>Mon, 18 Nov 2024 00:00:00 +0000</pubDate><author>cugbtang@sina.com (yesplease)</author><guid>http://localhost:1313/post/llm/llm-5/</guid><description>&lt;h1 id="æ·±åº¦å­¦ä¹ ä¸­çš„æ¢¯åº¦æ¶ˆå¤±ä¸çˆ†ç‚¸ä»æ•°å­¦åŸºç¡€åˆ°ç°ä»£è§£å†³æ–¹æ¡ˆ"&gt;æ·±åº¦å­¦ä¹ ä¸­çš„æ¢¯åº¦æ¶ˆå¤±ä¸çˆ†ç‚¸ï¼šä»æ•°å­¦åŸºç¡€åˆ°ç°ä»£è§£å†³æ–¹æ¡ˆ&lt;/h1&gt;
&lt;h2 id="ä¸€æ•°å­¦åŸºç¡€æ¢¯åº¦ä¸åå‘ä¼ æ’­"&gt;ä¸€ã€æ•°å­¦åŸºç¡€ï¼šæ¢¯åº¦ä¸åå‘ä¼ æ’­&lt;/h2&gt;
&lt;h3 id="11-æ¢¯åº¦çš„æ•°å­¦æœ¬è´¨"&gt;1.1 æ¢¯åº¦çš„æ•°å­¦æœ¬è´¨&lt;/h3&gt;
&lt;p&gt;åœ¨æ·±åº¦å­¦ä¹ ä¸­ï¼Œ&lt;strong&gt;æ¢¯åº¦&lt;/strong&gt;æ˜¯æŸå¤±å‡½æ•°å¯¹å‚æ•°çš„åå¯¼æ•°å‘é‡ï¼Œè¡¨ç¤ºäº†æŸå¤±å‡½æ•°åœ¨å‚æ•°ç©ºé—´ä¸­æœ€é™¡å³­çš„ä¸Šå‡æ–¹å‘ã€‚å¯¹äºç¥ç»ç½‘ç»œä¸­çš„å‚æ•° $\theta$ï¼Œæ¢¯åº¦å®šä¹‰ä¸ºï¼š&lt;/p&gt;
&lt;p&gt;$$\nabla_\theta \mathcal{L} = \left[ \frac{\partial \mathcal{L}}{\partial \theta_1}, \frac{\partial \mathcal{L}}{\partial \theta_2}, \ldots, \frac{\partial \mathcal{L}}{\partial \theta_n} \right]^T$$&lt;/p&gt;
&lt;p&gt;æ¢¯åº¦ä¸‹é™æ³•é€šè¿‡ä»¥ä¸‹è§„åˆ™æ›´æ–°å‚æ•°ï¼š&lt;/p&gt;
&lt;p&gt;$$\theta_{t+1} = \theta_t - \eta \cdot \nabla_\theta \mathcal{L}$$&lt;/p&gt;
&lt;p&gt;å…¶ä¸­ $\eta$ æ˜¯å­¦ä¹ ç‡ï¼Œæ§åˆ¶å‚æ•°æ›´æ–°çš„æ­¥é•¿ã€‚&lt;/p&gt;
&lt;h3 id="12-åå‘ä¼ æ’­çš„é“¾å¼æ³•åˆ™"&gt;1.2 åå‘ä¼ æ’­çš„é“¾å¼æ³•åˆ™&lt;/h3&gt;
&lt;p&gt;åå‘ä¼ æ’­ç®—æ³•çš„æ ¸å¿ƒæ˜¯&lt;strong&gt;é“¾å¼æ³•åˆ™&lt;/strong&gt;ã€‚å¯¹äºä¸€ä¸ªå¤åˆå‡½æ•° $f(g(x))$ï¼Œå…¶å¯¼æ•°ä¸ºï¼š&lt;/p&gt;
&lt;p&gt;$$\frac{df}{dx} = \frac{df}{dg} \cdot \frac{dg}{dx}$$&lt;/p&gt;
&lt;p&gt;åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œå¯¹äº $L$ å±‚çš„ç½‘ç»œï¼Œç¬¬ $l$ å±‚çš„æ¢¯åº¦è®¡ç®—éœ€è¦é“¾å¼ä¼ é€’æ‰€æœ‰åç»­å±‚çš„æ¢¯åº¦ï¼š&lt;/p&gt;
&lt;p&gt;$$\frac{\partial \mathcal{L}}{\partial W^{(l)}} = \frac{\partial \mathcal{L}}{\partial z^{(L)}} \cdot \frac{\partial z^{(L)}}{\partial z^{(L-1)}} \cdots \frac{\partial z^{(l+1)}}{\partial z^{(l)}} \cdot \frac{\partial z^{(l)}}{\partial W^{(l)}}$$&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªè¿ä¹˜è¿‡ç¨‹æ­£æ˜¯æ¢¯åº¦é—®é¢˜çš„æ ¹æºã€‚&lt;/p&gt;
&lt;h2 id="äºŒæ¢¯åº¦é—®é¢˜çš„æœ¬è´¨ç°è±¡ä¸æ•°å­¦åˆ†æ"&gt;äºŒã€æ¢¯åº¦é—®é¢˜çš„æœ¬è´¨ï¼šç°è±¡ä¸æ•°å­¦åˆ†æ&lt;/h2&gt;
&lt;h3 id="21-æ¢¯åº¦æ¶ˆå¤±vanishing-gradient"&gt;2.1 æ¢¯åº¦æ¶ˆå¤±ï¼ˆVanishing Gradientï¼‰&lt;/h3&gt;
&lt;h4 id="ç°è±¡å®šä¹‰"&gt;ç°è±¡å®šä¹‰&lt;/h4&gt;
&lt;p&gt;æ¢¯åº¦æ¶ˆå¤±æ˜¯æŒ‡åœ¨æ·±å±‚ç½‘ç»œæˆ–é•¿åºåˆ— RNN ä¸­ï¼Œ&lt;strong&gt;é è¿‘è¾“å…¥å±‚çš„æ¢¯åº¦å˜å¾—æå°&lt;/strong&gt;ï¼ˆè¶‹è¿‘äº 0ï¼‰çš„ç°è±¡ã€‚&lt;/p&gt;
&lt;h4 id="æ•°å­¦åˆ†æ"&gt;æ•°å­¦åˆ†æ&lt;/h4&gt;
&lt;p&gt;è€ƒè™‘ä¸€ä¸ªå…·æœ‰ $L$ å±‚çš„æ·±åº¦ç½‘ç»œï¼Œæ¯å±‚ä½¿ç”¨ç›¸åŒçš„æƒé‡çŸ©é˜µ $W$ å’Œæ¿€æ´»å‡½æ•° $\sigma$ã€‚ç¬¬ $l$ å±‚çš„æ¢¯åº¦å¯ä»¥è¡¨ç¤ºä¸ºï¼š&lt;/p&gt;
&lt;p&gt;$$\frac{\partial \mathcal{L}}{\partial W^{(l)}} = \delta^{(l)} \cdot a^{(l-1)^T}$$&lt;/p&gt;
&lt;p&gt;å…¶ä¸­è¯¯å·®é¡¹ $\delta^{(l)} = (W^{(l+1)})^T \delta^{(l+1)} \odot \sigma&amp;rsquo;(z^{(l)})$&lt;/p&gt;
&lt;p&gt;é€’å½’å±•å¼€åï¼š&lt;/p&gt;
&lt;p&gt;$$\delta^{(l)} = \left( \prod_{k=l}^{L-1} (W^{(k+1)})^T \cdot \text{diag}(\sigma&amp;rsquo;(z^{(k)})) \right) \delta^{(L)}$$&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®è§‚å¯Ÿ&lt;/strong&gt;ï¼šå¦‚æœ $|W| &amp;lt; 1$ ä¸” $|\sigma&amp;rsquo;(z)| &amp;lt; 1$ï¼Œé‚£ä¹ˆè¿ä¹˜é¡¹ $\prod_{k=l}^{L-1} W^T \cdot \text{diag}(\sigma&amp;rsquo;(z^{(k)}))$ ä¼šæŒ‡æ•°çº§è¡°å‡ã€‚&lt;/p&gt;
&lt;h4 id="å…¸å‹åœºæ™¯"&gt;å…¸å‹åœºæ™¯&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Sigmoid æ¿€æ´»å‡½æ•°&lt;/strong&gt;ï¼š$\sigma&amp;rsquo;(x) = \sigma(x)(1-\sigma(x)) \leq 0.25$&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Tanh æ¿€æ´»å‡½æ•°&lt;/strong&gt;ï¼š$\tanh&amp;rsquo;(x) = 1 - \tanh^2(x) \leq 1$ï¼Œä½†é€šå¸¸è¿œå°äº 1&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ·±å±‚ç½‘ç»œ&lt;/strong&gt;ï¼šéšç€å±‚æ•°å¢åŠ ï¼Œæ¢¯åº¦è¿ä¹˜é¡¹æŒ‡æ•°çº§å‡å°&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é•¿åºåˆ— RNN&lt;/strong&gt;ï¼šæ—¶é—´æ­¥é•¿å¢åŠ å¯¼è‡´æ¢¯åº¦è¿ä¹˜é¡¹ç´¯ç§¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="åæœ"&gt;åæœ&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;å‰é¢çš„å±‚å‡ ä¹ä¸æ›´æ–°å‚æ•°ï¼š$\Delta W^{(l)} = -\eta \frac{\partial \mathcal{L}}{\partial W^{(l)}} \approx 0$&lt;/li&gt;
&lt;li&gt;æ¨¡å‹æ— æ³•æœ‰æ•ˆå­¦ä¹ é•¿æœŸä¾èµ–å…³ç³»&lt;/li&gt;
&lt;li&gt;è®­ç»ƒæ—©æœŸé˜¶æ®µå°±é™·å…¥åœæ»&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="22-æ¢¯åº¦çˆ†ç‚¸exploding-gradient"&gt;2.2 æ¢¯åº¦çˆ†ç‚¸ï¼ˆExploding Gradientï¼‰&lt;/h3&gt;
&lt;h4 id="ç°è±¡å®šä¹‰-1"&gt;ç°è±¡å®šä¹‰&lt;/h4&gt;
&lt;p&gt;æ¢¯åº¦çˆ†ç‚¸æ˜¯æŒ‡æ¢¯åº¦åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­&lt;strong&gt;ä¸æ–­æ”¾å¤§&lt;/strong&gt;ï¼Œå˜å¾—éå¸¸å¤§ï¼ˆå¦‚ $1e10$ï¼‰çš„ç°è±¡ã€‚&lt;/p&gt;
&lt;h4 id="æ•°å­¦åˆ†æ-1"&gt;æ•°å­¦åˆ†æ&lt;/h4&gt;
&lt;p&gt;ä»ä¸Šè¿°æ¢¯åº¦è¡¨è¾¾å¼å¯ä»¥çœ‹å‡ºï¼Œå¦‚æœæƒé‡çŸ©é˜µçš„è°±èŒƒæ•° $|W| &amp;gt; 1$ï¼Œé‚£ä¹ˆè¿ä¹˜é¡¹ä¼šæŒ‡æ•°çº§å¢é•¿ï¼š&lt;/p&gt;
&lt;p&gt;$$|\delta^{(l)}| \propto \prod_{k=l}^{L-1} |W^{(k+1)}| \cdot |\sigma&amp;rsquo;(z^{(k)})|$$&lt;/p&gt;
&lt;p&gt;å½“ $|W| &amp;gt; 1$ æ—¶ï¼Œ$|W|^L$ ä¼šéšç€å±‚æ•° $L$ æŒ‡æ•°çº§å¢é•¿ã€‚&lt;/p&gt;
&lt;h4 id="å…¸å‹åœºæ™¯-1"&gt;å…¸å‹åœºæ™¯&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;RNN å¤„ç†é•¿åºåˆ—æ—¶ï¼Œæƒé‡çŸ©é˜µçš„ç‰¹å¾å€¼ &amp;gt; 1&lt;/li&gt;
&lt;li&gt;æƒé‡åˆå§‹åŒ–ä¸å½“ï¼Œåˆå§‹å€¼è¿‡å¤§&lt;/li&gt;
&lt;li&gt;æŸäº›ç‰¹æ®Šä»»åŠ¡å¯¼è‡´æ¢¯åº¦ç´¯ç§¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="åæœ-1"&gt;åæœ&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;å‚æ•°æ›´æ–°å¹…åº¦è¿‡å¤§ï¼š$|\Delta W^{(l)}| = \eta |\frac{\partial \mathcal{L}}{\partial W^{(l)}}|$ å¯èƒ½è¾¾åˆ° $1e10$ é‡çº§&lt;/li&gt;
&lt;li&gt;æ•°å€¼ä¸ç¨³å®šï¼Œå¯¼è‡´ $\text{NaN}$ å€¼å‡ºç°&lt;/li&gt;
&lt;li&gt;è®­ç»ƒè¿‡ç¨‹å‘æ•£ï¼ŒæŸå¤±å‡½æ•°æ€¥å‰§å¢å¤§&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="ä¸‰ä»£ç å®ç°ä¸å®éªŒéªŒè¯"&gt;ä¸‰ã€ä»£ç å®ç°ä¸å®éªŒéªŒè¯&lt;/h2&gt;
&lt;h3 id="31-æ¢¯åº¦æ¶ˆå¤±çš„å¯è§†åŒ–å®éªŒ"&gt;3.1 æ¢¯åº¦æ¶ˆå¤±çš„å¯è§†åŒ–å®éªŒ&lt;/h3&gt;
&lt;p&gt;è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„æ·±åº¦ç½‘ç»œæ¥å¯è§†åŒ–æ¢¯åº¦æ¶ˆå¤±ç°è±¡ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; torch
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; torch.nn &lt;span style="color:#66d9ef"&gt;as&lt;/span&gt; nn
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; matplotlib.pyplot &lt;span style="color:#66d9ef"&gt;as&lt;/span&gt; plt
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; numpy &lt;span style="color:#66d9ef"&gt;as&lt;/span&gt; np
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;visualize_vanishing_gradient&lt;/span&gt;():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;å¯è§†åŒ–æ·±åº¦ç½‘ç»œä¸­æ¢¯åº¦æ¶ˆå¤±çš„ç°è±¡&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; depths &lt;span style="color:#f92672"&gt;=&lt;/span&gt; [&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;30&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;50&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; avg_gradients &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; depth &lt;span style="color:#f92672"&gt;in&lt;/span&gt; depths:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åˆ›å»ºæ·±åº¦ç½‘ç»œ&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layers &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; i &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(depth):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layers&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear(&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layers&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Sigmoid()) &lt;span style="color:#75715e"&gt;# ä½¿ç”¨Sigmoidæ¿€æ´»å‡½æ•°&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Sequential(&lt;span style="color:#f92672"&gt;*&lt;/span&gt;layers)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# å‰å‘ä¼ æ’­&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;randn(&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; y &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; y&lt;span style="color:#f92672"&gt;.&lt;/span&gt;sum()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åå‘ä¼ æ’­å¹¶æ”¶é›†æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è®¡ç®—å„å±‚æ¢¯åº¦çš„å¹³å‡ç»å¯¹å€¼&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradients &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; name, param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;named_parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;weight&amp;#39;&lt;/span&gt; &lt;span style="color:#f92672"&gt;in&lt;/span&gt; name &lt;span style="color:#f92672"&gt;and&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradients&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;abs()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mean()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åªå–å‰5å±‚çš„æ¢¯åº¦ï¼ˆé¿å…å±‚æ•°ä¸åŒå¯¼è‡´çš„æ¯”è¾ƒé—®é¢˜ï¼‰&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradients &lt;span style="color:#f92672"&gt;=&lt;/span&gt; gradients[:&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; avg_gradients&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(np&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mean(gradients))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ç»˜åˆ¶ç»“æœ&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;figure(figsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;(&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;semilogy(depths, avg_gradients, &lt;span style="color:#e6db74"&gt;&amp;#39;b-o&amp;#39;&lt;/span&gt;, linewidth&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;, markersize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;8&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;xlabel(&lt;span style="color:#e6db74"&gt;&amp;#39;ç½‘ç»œå±‚æ•°&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;12&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ylabel(&lt;span style="color:#e6db74"&gt;&amp;#39;å¹³å‡æ¢¯åº¦ç»å¯¹å€¼ (log scale)&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;12&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;title(&lt;span style="color:#e6db74"&gt;&amp;#39;æ¢¯åº¦æ¶ˆå¤±ç°è±¡ï¼šç½‘ç»œå±‚æ•°å¯¹æ¢¯åº¦çš„å½±å“&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;14&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grid(&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;, alpha&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.3&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;show()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;visualize_vanishing_gradient()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒç»“æœåˆ†æ&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éšç€ç½‘ç»œå±‚æ•°å¢åŠ ï¼Œæ¢¯åº¦å‘ˆæŒ‡æ•°çº§è¡°å‡&lt;/li&gt;
&lt;li&gt;åœ¨100å±‚ç½‘ç»œä¸­ï¼Œå‰å‡ å±‚çš„æ¢¯åº¦å¯èƒ½è¡°å‡åˆ° $10^{-8}$ é‡çº§&lt;/li&gt;
&lt;li&gt;è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆæ·±å±‚ç½‘ç»œéš¾ä»¥è®­ç»ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="32-æ¢¯åº¦çˆ†ç‚¸çš„æ•°å€¼å®éªŒ"&gt;3.2 æ¢¯åº¦çˆ†ç‚¸çš„æ•°å€¼å®éªŒ&lt;/h3&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;demonstrate_exploding_gradient&lt;/span&gt;():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ¼”ç¤ºæ¢¯åº¦çˆ†ç‚¸ç°è±¡&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; sequence_lengths &lt;span style="color:#f92672"&gt;=&lt;/span&gt; [&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;20&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;50&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;200&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_gradients &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; seq_len &lt;span style="color:#f92672"&gt;in&lt;/span&gt; sequence_lengths:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åˆ›å»ºRNNå±‚&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; rnn &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;RNN(input_size&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;, hidden_size&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, num_layers&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, batch_first&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ•…æ„è®¾ç½®è¾ƒå¤§çš„æƒé‡æ¥è¯±å¯¼æ¢¯åº¦çˆ†ç‚¸&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;with&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;no_grad():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; rnn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;weight_hh_l0&lt;span style="color:#f92672"&gt;.&lt;/span&gt;fill_(&lt;span style="color:#ae81ff"&gt;2.0&lt;/span&gt;) &lt;span style="color:#75715e"&gt;# è®¾ç½®æƒé‡å€¼è¾ƒå¤§&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åˆ›å»ºé•¿åºåˆ—è¾“å…¥&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;randn(&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, seq_len, &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# å‰å‘ä¼ æ’­&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output, hidden &lt;span style="color:#f92672"&gt;=&lt;/span&gt; rnn(x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; output&lt;span style="color:#f92672"&gt;.&lt;/span&gt;sum()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åå‘ä¼ æ’­&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è®°å½•æœ€å¤§æ¢¯åº¦å€¼&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_grad &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; rnn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_grad &lt;span style="color:#f92672"&gt;=&lt;/span&gt; max(max_grad, param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;abs()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;max()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_gradients&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(max_grad)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# é‡ç½®æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; rnn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ç»˜åˆ¶ç»“æœ&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;figure(figsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;(&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;6&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;semilogy(sequence_lengths, max_gradients, &lt;span style="color:#e6db74"&gt;&amp;#39;r-s&amp;#39;&lt;/span&gt;, linewidth&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;, markersize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;8&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;xlabel(&lt;span style="color:#e6db74"&gt;&amp;#39;åºåˆ—é•¿åº¦&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;12&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ylabel(&lt;span style="color:#e6db74"&gt;&amp;#39;æœ€å¤§æ¢¯åº¦å€¼ (log scale)&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;12&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;title(&lt;span style="color:#e6db74"&gt;&amp;#39;æ¢¯åº¦çˆ†ç‚¸ç°è±¡ï¼šåºåˆ—é•¿åº¦å¯¹æ¢¯åº¦çš„å½±å“&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;14&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grid(&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;, alpha&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.3&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;show()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;demonstrate_exploding_gradient()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="33-å®é™…æ¡ˆä¾‹è¯­è¨€æ¨¡å‹è®­ç»ƒä¸­çš„æ¢¯åº¦ç›‘æ§"&gt;3.3 å®é™…æ¡ˆä¾‹ï¼šè¯­è¨€æ¨¡å‹è®­ç»ƒä¸­çš„æ¢¯åº¦ç›‘æ§&lt;/h3&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;GradientMonitor&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;è®­ç»ƒè¿‡ç¨‹ä¸­çš„æ¢¯åº¦ç›‘æ§å™¨&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;(self, model):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gradient_history &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layer_names &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è·å–æ‰€æœ‰éœ€è¦ç›‘æ§çš„å±‚&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; name, module &lt;span style="color:#f92672"&gt;in&lt;/span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;named_modules():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; isinstance(module, (nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear, nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;LSTM, nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;GRU)):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layer_names&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(name)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;log_gradients&lt;/span&gt;(self):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;è®°å½•å½“å‰æ—¶åˆ»å„å±‚çš„æ¢¯åº¦ç»Ÿè®¡ä¿¡æ¯&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; stats &lt;span style="color:#f92672"&gt;=&lt;/span&gt; {}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; name &lt;span style="color:#f92672"&gt;in&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layer_names:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param_name, param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;named_parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; name &lt;span style="color:#f92672"&gt;in&lt;/span&gt; param_name &lt;span style="color:#f92672"&gt;and&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; grad_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;norm()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; grad_mean &lt;span style="color:#f92672"&gt;=&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mean()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; grad_std &lt;span style="color:#f92672"&gt;=&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;std()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; stats[&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;name&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;_&lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;param_name&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;] &lt;span style="color:#f92672"&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;norm&amp;#39;&lt;/span&gt;: grad_norm,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;mean&amp;#39;&lt;/span&gt;: grad_mean,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;std&amp;#39;&lt;/span&gt;: grad_std
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gradient_history&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(stats)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; stats
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;detect_gradient_issues&lt;/span&gt;(self, threshold_vanish&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-8&lt;/span&gt;, threshold_explode&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10.0&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ£€æµ‹æ¢¯åº¦é—®é¢˜&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gradient_history:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; latest_stats &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gradient_history[&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param_name, stats &lt;span style="color:#f92672"&gt;in&lt;/span&gt; latest_stats&lt;span style="color:#f92672"&gt;.&lt;/span&gt;items():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; grad_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; stats[&lt;span style="color:#e6db74"&gt;&amp;#39;norm&amp;#39;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; grad_norm &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt; threshold_vanish:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;æ¢¯åº¦æ¶ˆå¤±è­¦å‘Š: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;param_name&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt; = &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;grad_norm&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.2e&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;elif&lt;/span&gt; grad_norm &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; threshold_explode:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;æ¢¯åº¦çˆ†ç‚¸è­¦å‘Š: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;param_name&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt; = &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;grad_norm&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.2f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; issues &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; issues &lt;span style="color:#66d9ef"&gt;else&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# ä½¿ç”¨ç¤ºä¾‹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;train_with_monitoring&lt;/span&gt;(model, train_loader, optimizer, criterion, epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; monitor &lt;span style="color:#f92672"&gt;=&lt;/span&gt; GradientMonitor(model)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; epoch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(epochs):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;train()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; batch_idx, (data, target) &lt;span style="color:#f92672"&gt;in&lt;/span&gt; enumerate(train_loader):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; criterion(output, target)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ç›‘æ§æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; grad_stats &lt;span style="color:#f92672"&gt;=&lt;/span&gt; monitor&lt;span style="color:#f92672"&gt;.&lt;/span&gt;log_gradients()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues &lt;span style="color:#f92672"&gt;=&lt;/span&gt; monitor&lt;span style="color:#f92672"&gt;.&lt;/span&gt;detect_gradient_issues()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; issues:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;Epoch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;epoch&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;, Batch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;batch_idx&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;:&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; issue &lt;span style="color:#f92672"&gt;in&lt;/span&gt; issues:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34; - &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;issue&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åº”ç”¨æ¢¯åº¦è£å‰ªæ¥å¤„ç†æ¢¯åº¦çˆ†ç‚¸&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_loss &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;Epoch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;epoch&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;, Average Loss: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;total_loss&lt;span style="color:#f92672"&gt;/&lt;/span&gt;len(train_loader)&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.4f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="34-ä¸åŒæ¿€æ´»å‡½æ•°çš„æ¢¯åº¦å¯¹æ¯”"&gt;3.4 ä¸åŒæ¿€æ´»å‡½æ•°çš„æ¢¯åº¦å¯¹æ¯”&lt;/h3&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;compare_activation_gradients&lt;/span&gt;():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ¯”è¾ƒä¸åŒæ¿€æ´»å‡½æ•°çš„æ¢¯åº¦ç‰¹æ€§&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; activations &lt;span style="color:#f92672"&gt;=&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;Sigmoid&amp;#39;&lt;/span&gt;: nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Sigmoid(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;Tanh&amp;#39;&lt;/span&gt;: nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Tanh(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;ReLU&amp;#39;&lt;/span&gt;: nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ReLU(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;LeakyReLU&amp;#39;&lt;/span&gt;: nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;LeakyReLU(&lt;span style="color:#ae81ff"&gt;0.01&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;ELU&amp;#39;&lt;/span&gt;: nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ELU()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åˆ›å»ºæµ‹è¯•è¾“å…¥&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;linspace(&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;1000&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;figure(figsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;(&lt;span style="color:#ae81ff"&gt;15&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; i, (name, act) &lt;span style="color:#f92672"&gt;in&lt;/span&gt; enumerate(activations&lt;span style="color:#f92672"&gt;.&lt;/span&gt;items()):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è®¡ç®—æ¿€æ´»å€¼å’Œæ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;requires_grad_(&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; y &lt;span style="color:#f92672"&gt;=&lt;/span&gt; act(x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; y&lt;span style="color:#f92672"&gt;.&lt;/span&gt;sum()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ç»˜åˆ¶æ¿€æ´»å‡½æ•°&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;subplot(&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt;, i&lt;span style="color:#f92672"&gt;+&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;plot(x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;detach()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;numpy(), y&lt;span style="color:#f92672"&gt;.&lt;/span&gt;detach()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;numpy(), &lt;span style="color:#e6db74"&gt;&amp;#39;b-&amp;#39;&lt;/span&gt;, linewidth&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;, label&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;æ¿€æ´»å‡½æ•°&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;plot(x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;detach()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;numpy(), x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;numpy(), &lt;span style="color:#e6db74"&gt;&amp;#39;r--&amp;#39;&lt;/span&gt;, linewidth&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;, label&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;æ¢¯åº¦&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;title(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;&lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;name&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt; å‡½æ•°åŠå…¶æ¢¯åº¦&amp;#39;&lt;/span&gt;, fontsize&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;12&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;xlabel(&lt;span style="color:#e6db74"&gt;&amp;#39;è¾“å…¥å€¼&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ylabel(&lt;span style="color:#e6db74"&gt;&amp;#39;è¾“å‡ºå€¼/æ¢¯åº¦å€¼&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;legend()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grid(&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;, alpha&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.3&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# é‡ç½®æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;tight_layout()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; plt&lt;span style="color:#f92672"&gt;.&lt;/span&gt;show()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;compare_activation_gradients()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®è§‚å¯Ÿ&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Sigmoid/Tanh&lt;/strong&gt;: æ¢¯åº¦åœ¨é¥±å’ŒåŒºåŸŸæ¥è¿‘0ï¼Œå®¹æ˜“å¯¼è‡´æ¢¯åº¦æ¶ˆå¤±&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ReLU&lt;/strong&gt;: å¯¹äºæ­£è¾“å…¥ï¼Œæ¢¯åº¦æ’ä¸º1ï¼Œæœ‰æ•ˆç¼“è§£æ¢¯åº¦æ¶ˆå¤±&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;LeakyReLU/ELU&lt;/strong&gt;: è´ŸåŒºåŸŸä¹Ÿæœ‰éé›¶æ¢¯åº¦ï¼Œè¿›ä¸€æ­¥æ”¹å–„æ¢¯åº¦æµåŠ¨&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="å››ç°ä»£è§£å†³æ–¹æ¡ˆä»æ¶æ„è®¾è®¡åˆ°ä¼˜åŒ–æŠ€æœ¯"&gt;å››ã€ç°ä»£è§£å†³æ–¹æ¡ˆï¼šä»æ¶æ„è®¾è®¡åˆ°ä¼˜åŒ–æŠ€æœ¯&lt;/h2&gt;
&lt;h3 id="41-æ¶æ„å±‚é¢çš„è§£å†³æ–¹æ¡ˆ"&gt;4.1 æ¶æ„å±‚é¢çš„è§£å†³æ–¹æ¡ˆ&lt;/h3&gt;
&lt;h4 id="411-æ®‹å·®è¿æ¥resnet"&gt;4.1.1 æ®‹å·®è¿æ¥ï¼ˆResNetï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒæ€æƒ³&lt;/strong&gt;ï¼šé€šè¿‡è·³è·ƒè¿æ¥è®©æ¢¯åº¦ç›´æ¥å›ä¼ åˆ°æµ…å±‚ï¼Œé¿å…è¿ä¹˜è¡°å‡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ•°å­¦åŸç†&lt;/strong&gt;ï¼š
å¯¹äºä¼ ç»Ÿç½‘ç»œå±‚ï¼š$y = \sigma(Wx + b)$&lt;/p&gt;
&lt;p&gt;å¯¹äºæ®‹å·®å—ï¼š$y = \sigma(Wx + b) + x$&lt;/p&gt;
&lt;p&gt;æ¢¯åº¦è®¡ç®—ï¼š
$$\frac{\partial \mathcal{L}}{\partial x} = \frac{\partial \mathcal{L}}{\partial y} \cdot \frac{\partial y}{\partial x} = \frac{\partial \mathcal{L}}{\partial y} \cdot (W^T \text{diag}(\sigma&amp;rsquo;(z)) + I)$$&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®ä¼˜åŠ¿&lt;/strong&gt;ï¼šå³ä½¿ $W^T \text{diag}(\sigma&amp;rsquo;(z))$ å¾ˆå°ï¼Œå•ä½çŸ©é˜µ $I$ ç¡®ä¿äº†æ¢¯åº¦è‡³å°‘ä¸º $\frac{\partial \mathcal{L}}{\partial y}$ã€‚&lt;/p&gt;
&lt;h4 id="412-é—¨æ§æœºåˆ¶lstmgru"&gt;4.1.2 é—¨æ§æœºåˆ¶ï¼ˆLSTM/GRUï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;LSTM çš„é—å¿˜é—¨&lt;/strong&gt;ï¼š
$$f_t = \sigma(W_f \cdot [h_{t-1}, x_t] + b_f)$$
$$i_t = \sigma(W_i \cdot [h_{t-1}, x_t] + b_i)$$
$$\tilde{C}&lt;em&gt;t = \tanh(W_C \cdot [h&lt;/em&gt;{t-1}, x_t] + b_C)$$
$$C_t = f_t \odot C_{t-1} + i_t \odot \tilde{C}_t$$&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¢¯åº¦åˆ†æ&lt;/strong&gt;ï¼š
LSTM é€šè¿‡åŠ æ³•è¿ç®—æ›¿ä»£ä¹˜æ³•è¿ç®—ï¼Œå¤§å¤§æ”¹å–„äº†æ¢¯åº¦æµåŠ¨ï¼š
$$\frac{\partial C_t}{\partial C_{t-1}} = f_t$$&lt;/p&gt;
&lt;p&gt;ç”±äº $f_t$ æ˜¯é—¨æ§å€¼ï¼ˆ0åˆ°1ä¹‹é—´ï¼‰ï¼Œæ¢¯åº¦è¦ä¹ˆå®Œå…¨ä¿ç•™ï¼Œè¦ä¹ˆå®Œå…¨è¡°å‡ï¼Œé¿å…äº†æŒ‡æ•°çº§è¡°å‡ã€‚&lt;/p&gt;
&lt;h4 id="413-transformer-æ¶æ„"&gt;4.1.3 Transformer æ¶æ„&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;è‡ªæ³¨æ„åŠ›æœºåˆ¶&lt;/strong&gt;ï¼š
$$\text{Attention}(Q, K, V) = \text{softmax}\left(\frac{QK^T}{\sqrt{d_k}}\right)V$$&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¢¯åº¦ä¼˜åŠ¿&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ²¡æœ‰é€’å½’è¿æ¥ï¼Œé¿å…äº†æ¢¯åº¦è¿ä¹˜é—®é¢˜&lt;/li&gt;
&lt;li&gt;æ®‹å·®è¿æ¥ç¡®ä¿æ¢¯åº¦æµåŠ¨&lt;/li&gt;
&lt;li&gt;å±‚å½’ä¸€åŒ–ç¨³å®šè®­ç»ƒè¿‡ç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="42-ä¼˜åŒ–ç®—æ³•å±‚é¢çš„è§£å†³æ–¹æ¡ˆ"&gt;4.2 ä¼˜åŒ–ç®—æ³•å±‚é¢çš„è§£å†³æ–¹æ¡ˆ&lt;/h3&gt;
&lt;h4 id="421-è‡ªé€‚åº”ä¼˜åŒ–å™¨"&gt;4.2.1 è‡ªé€‚åº”ä¼˜åŒ–å™¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Adam ä¼˜åŒ–å™¨&lt;/strong&gt;ï¼š
$$m_t = \beta_1 m_{t-1} + (1 - \beta_1) g_t$$
$$v_t = \beta_2 v_{t-1} + (1 - \beta_2) g_t^2$$
$$\hat{m}_t = \frac{m_t}{1 - \beta_1^t}$$
$$\hat{v}&lt;em&gt;t = \frac{v_t}{1 - \beta_2^t}$$
$$\theta&lt;/em&gt;{t+1} = \theta_t - \frac{\eta}{\sqrt{\hat{v}_t} + \epsilon} \hat{m}_t$$&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜åŠ¿&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªé€‚åº”å­¦ä¹ ç‡ç¼“è§£å°æ¢¯åº¦é—®é¢˜&lt;/li&gt;
&lt;li&gt;åŠ¨é‡é¡¹æœ‰åŠ©äºè·³å‡ºå±€éƒ¨æœ€ä¼˜&lt;/li&gt;
&lt;li&gt;å¯¹æ¢¯åº¦ç¼©æ”¾ä¸æ•æ„Ÿ&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id="422-æ¢¯åº¦è£å‰ªæŠ€æœ¯"&gt;4.2.2 æ¢¯åº¦è£å‰ªæŠ€æœ¯&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®ç°ä»£ç &lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;gradient_clipping&lt;/span&gt;(parameters, max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e6db74"&gt; æ¢¯åº¦è£å‰ªå®ç°
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e6db74"&gt; :param parameters: æ¨¡å‹å‚æ•°
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e6db74"&gt; :param max_norm: æœ€å¤§æ¢¯åº¦èŒƒæ•°
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#e6db74"&gt; &amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;norm(torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;stack([torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;norm(p&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad) &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; p &lt;span style="color:#f92672"&gt;in&lt;/span&gt; parameters &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; p&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;]))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; total_norm &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; max_norm:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scale_factor &lt;span style="color:#f92672"&gt;=&lt;/span&gt; max_norm &lt;span style="color:#f92672"&gt;/&lt;/span&gt; (total_norm &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1e-6&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; p &lt;span style="color:#f92672"&gt;in&lt;/span&gt; parameters:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; p&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; p&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mul_(scale_factor)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; total_norm
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# ä½¿ç”¨ç¤ºä¾‹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;current_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; gradient_clipping(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;Clipped gradient norm: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;current_norm&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.4f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="423-ç°ä»£å½’ä¸€åŒ–æŠ€æœ¯"&gt;4.2.3 ç°ä»£å½’ä¸€åŒ–æŠ€æœ¯&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Layer Normalization&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;LayerNorm&lt;/span&gt;(nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Module):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;(self, features, eps&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-6&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; super()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gamma &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Parameter(torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ones(features))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;beta &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Parameter(torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zeros(features))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;eps &lt;span style="color:#f92672"&gt;=&lt;/span&gt; eps
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;forward&lt;/span&gt;(self, x):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; mean &lt;span style="color:#f92672"&gt;=&lt;/span&gt; x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mean(&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, keepdim&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; std &lt;span style="color:#f92672"&gt;=&lt;/span&gt; x&lt;span style="color:#f92672"&gt;.&lt;/span&gt;std(&lt;span style="color:#f92672"&gt;-&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, keepdim&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;gamma &lt;span style="color:#f92672"&gt;*&lt;/span&gt; (x &lt;span style="color:#f92672"&gt;-&lt;/span&gt; mean) &lt;span style="color:#f92672"&gt;/&lt;/span&gt; (std &lt;span style="color:#f92672"&gt;+&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;eps) &lt;span style="color:#f92672"&gt;+&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;beta&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;æ¢¯åº¦ç¨³å®šæœºåˆ¶&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‡å°‘å†…éƒ¨åå˜é‡åç§»ï¼ˆInternal Covariate Shiftï¼‰&lt;/li&gt;
&lt;li&gt;ç¨³å®šæ¯å±‚çš„è¾“å…¥åˆ†å¸ƒ&lt;/li&gt;
&lt;li&gt;å…è®¸ä½¿ç”¨æ›´é«˜çš„å­¦ä¹ ç‡&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="43-åˆå§‹åŒ–ç­–ç•¥"&gt;4.3 åˆå§‹åŒ–ç­–ç•¥&lt;/h3&gt;
&lt;h4 id="431-xavierglorot-åˆå§‹åŒ–"&gt;4.3.1 Xavier/Glorot åˆå§‹åŒ–&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŸç†&lt;/strong&gt;ï¼šä¿æŒè¾“å…¥å’Œè¾“å‡ºçš„æ–¹å·®ä¸€è‡´ã€‚&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;xavier_init&lt;/span&gt;(layer):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; isinstance(layer, nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; fan_in &lt;span style="color:#f92672"&gt;=&lt;/span&gt; layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;weight&lt;span style="color:#f92672"&gt;.&lt;/span&gt;size(&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; fan_out &lt;span style="color:#f92672"&gt;=&lt;/span&gt; layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;weight&lt;span style="color:#f92672"&gt;.&lt;/span&gt;size(&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;init&lt;span style="color:#f92672"&gt;.&lt;/span&gt;xavier_uniform_(layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;weight, gain&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;init&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zeros_(layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;bias)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# ä½¿ç”¨ç¤ºä¾‹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Sequential(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear(&lt;span style="color:#ae81ff"&gt;784&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;512&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ReLU(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear(&lt;span style="color:#ae81ff"&gt;512&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;256&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ReLU(),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear(&lt;span style="color:#ae81ff"&gt;256&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;apply(xavier_init)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="432-he-åˆå§‹åŒ–"&gt;4.3.2 He åˆå§‹åŒ–&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é’ˆå¯¹ ReLU æ¿€æ´»å‡½æ•°çš„ä¼˜åŒ–&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;he_init&lt;/span&gt;(layer):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; isinstance(layer, nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Linear):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;init&lt;span style="color:#f92672"&gt;.&lt;/span&gt;kaiming_normal_(layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;weight, mode&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;fan_in&amp;#39;&lt;/span&gt;, nonlinearity&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;relu&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;init&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zeros_(layer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;bias)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# ReLU ç½‘ç»œæ¨èä½¿ç”¨ He åˆå§‹åŒ–&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;apply(he_init)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="44-å®è·µè°ƒä¼˜ç­–ç•¥"&gt;4.4 å®è·µè°ƒä¼˜ç­–ç•¥&lt;/h3&gt;
&lt;h4 id="441-å­¦ä¹ ç‡è°ƒåº¦"&gt;4.4.1 å­¦ä¹ ç‡è°ƒåº¦&lt;/h4&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;from&lt;/span&gt; torch.optim.lr_scheduler &lt;span style="color:#f92672"&gt;import&lt;/span&gt; OneCycleLR, CosineAnnealingLR
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;create_optimizer_and_scheduler&lt;/span&gt;(model, train_loader, epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;50&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;optim&lt;span style="color:#f92672"&gt;.&lt;/span&gt;AdamW(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), lr&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-3&lt;/span&gt;, weight_decay&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.01&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# OneCycle å­¦ä¹ ç‡è°ƒåº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scheduler &lt;span style="color:#f92672"&gt;=&lt;/span&gt; OneCycleLR(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_lr&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-3&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;epochs,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; steps_per_epoch&lt;span style="color:#f92672"&gt;=&lt;/span&gt;len(train_loader),
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pct_start&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.3&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; anneal_strategy&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#39;cos&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; )
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; optimizer, scheduler
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# è®­ç»ƒå¾ªç¯ä¸­ä½¿ç”¨&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;optimizer, scheduler &lt;span style="color:#f92672"&gt;=&lt;/span&gt; create_optimizer_and_scheduler(model, train_loader)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; epoch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(epochs):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; batch_idx, (data, target) &lt;span style="color:#f92672"&gt;in&lt;/span&gt; enumerate(train_loader):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; criterion(output, target)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ¢¯åº¦è£å‰ª&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scheduler&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="442-æ¢¯åº¦ç´¯ç§¯"&gt;4.4.2 æ¢¯åº¦ç´¯ç§¯&lt;/h4&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;train_with_gradient_accumulation&lt;/span&gt;(model, train_loader, optimizer, criterion,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; accumulation_steps&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4&lt;/span&gt;, epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;train()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; epoch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(epochs):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; batch_idx, (data, target) &lt;span style="color:#f92672"&gt;in&lt;/span&gt; enumerate(train_loader):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; criterion(output, target) &lt;span style="color:#f92672"&gt;/&lt;/span&gt; accumulation_steps
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; (batch_idx &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;) &lt;span style="color:#f92672"&gt;%&lt;/span&gt; accumulation_steps &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ¢¯åº¦è£å‰ª&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; batch_idx &lt;span style="color:#f92672"&gt;%&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100&lt;/span&gt; &lt;span style="color:#f92672"&gt;==&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;Epoch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;epoch&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;, Batch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;batch_idx&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;, Loss: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item() &lt;span style="color:#f92672"&gt;*&lt;/span&gt; accumulation_steps&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.4f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="45-ç°ä»£æ¡†æ¶çš„æ¢¯åº¦å¤„ç†"&gt;4.5 ç°ä»£æ¡†æ¶çš„æ¢¯åº¦å¤„ç†&lt;/h3&gt;
&lt;h4 id="451-æ··åˆç²¾åº¦è®­ç»ƒ"&gt;4.5.1 æ··åˆç²¾åº¦è®­ç»ƒ&lt;/h4&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;from&lt;/span&gt; torch.cuda.amp &lt;span style="color:#f92672"&gt;import&lt;/span&gt; autocast, GradScaler
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;mixed_precision_training&lt;/span&gt;(model, train_loader, optimizer, criterion, epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scaler &lt;span style="color:#f92672"&gt;=&lt;/span&gt; GradScaler()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; epoch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(epochs):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;train()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; data, target &lt;span style="color:#f92672"&gt;in&lt;/span&gt; train_loader:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è‡ªåŠ¨æ··åˆç²¾åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;with&lt;/span&gt; autocast():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; criterion(output, target)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ç¼©æ”¾æŸå¤±ä»¥é¿å…æ¢¯åº¦ä¸‹æº¢&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scaler&lt;span style="color:#f92672"&gt;.&lt;/span&gt;scale(loss)&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ¢¯åº¦è£å‰ª&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scaler&lt;span style="color:#f92672"&gt;.&lt;/span&gt;unscale_(optimizer)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ›´æ–°å‚æ•°&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scaler&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step(optimizer)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; scaler&lt;span style="color:#f92672"&gt;.&lt;/span&gt;update()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_loss &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; print(&lt;span style="color:#e6db74"&gt;f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;Epoch &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;epoch&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;, Average Loss: &lt;/span&gt;&lt;span style="color:#e6db74"&gt;{&lt;/span&gt;total_loss&lt;span style="color:#f92672"&gt;/&lt;/span&gt;len(train_loader)&lt;span style="color:#e6db74"&gt;:&lt;/span&gt;&lt;span style="color:#e6db74"&gt;.4f&lt;/span&gt;&lt;span style="color:#e6db74"&gt;}&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="452-åˆ†å¸ƒå¼è®­ç»ƒä¸­çš„æ¢¯åº¦å¤„ç†"&gt;4.5.2 åˆ†å¸ƒå¼è®­ç»ƒä¸­çš„æ¢¯åº¦å¤„ç†&lt;/h4&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; torch.distributed &lt;span style="color:#66d9ef"&gt;as&lt;/span&gt; dist
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;import&lt;/span&gt; torch.multiprocessing &lt;span style="color:#66d9ef"&gt;as&lt;/span&gt; mp
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;train_distributed&lt;/span&gt;(rank, world_size):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åˆå§‹åŒ–è¿›ç¨‹ç»„&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dist&lt;span style="color:#f92672"&gt;.&lt;/span&gt;init_process_group(&lt;span style="color:#e6db74"&gt;&amp;#34;nccl&amp;#34;&lt;/span&gt;, rank&lt;span style="color:#f92672"&gt;=&lt;/span&gt;rank, world_size&lt;span style="color:#f92672"&gt;=&lt;/span&gt;world_size)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è®¾ç½®æ¨¡å‹å’Œæ•°æ®åŠ è½½&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; create_model()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;to(rank)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parallel&lt;span style="color:#f92672"&gt;.&lt;/span&gt;DistributedDataParallel(model, device_ids&lt;span style="color:#f92672"&gt;=&lt;/span&gt;[rank])
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; train_loader &lt;span style="color:#f92672"&gt;=&lt;/span&gt; create_dataloader(rank, world_size)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;optim&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Adam(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), lr&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-3&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; epoch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(epochs):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;train()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; data, target &lt;span style="color:#f92672"&gt;in&lt;/span&gt; train_loader:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; data, target &lt;span style="color:#f92672"&gt;=&lt;/span&gt; data&lt;span style="color:#f92672"&gt;.&lt;/span&gt;to(rank), target&lt;span style="color:#f92672"&gt;.&lt;/span&gt;to(rank)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; criterion(output, target)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ¢¯åº¦è£å‰ª&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# åŒæ­¥æ‰€æœ‰è¿›ç¨‹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dist&lt;span style="color:#f92672"&gt;.&lt;/span&gt;barrier()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; dist&lt;span style="color:#f92672"&gt;.&lt;/span&gt;destroy_process_group()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id="äº”å‰æ²¿è¿›å±•ä¸æœªæ¥å±•æœ›"&gt;äº”ã€å‰æ²¿è¿›å±•ä¸æœªæ¥å±•æœ›&lt;/h2&gt;
&lt;h3 id="51-å¤§è¯­è¨€æ¨¡å‹ä¸­çš„æ¢¯åº¦æŒ‘æˆ˜"&gt;5.1 å¤§è¯­è¨€æ¨¡å‹ä¸­çš„æ¢¯åº¦æŒ‘æˆ˜&lt;/h3&gt;
&lt;p&gt;éšç€æ¨¡å‹è§„æ¨¡çš„å¿«é€Ÿå¢é•¿ï¼Œæ¢¯åº¦é—®é¢˜å‘ˆç°å‡ºæ–°çš„æŒ‘æˆ˜ï¼š&lt;/p&gt;
&lt;h4 id="511-è¶…å¤§è§„æ¨¡æ¨¡å‹çš„æ¢¯åº¦é—®é¢˜"&gt;5.1.1 è¶…å¤§è§„æ¨¡æ¨¡å‹çš„æ¢¯åº¦é—®é¢˜&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç°è±¡&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¢¯åº¦å™ªå£°å¢åŠ ï¼šæ¨¡å‹å‚æ•°é‡è¾¾åˆ°ç™¾äº¿çº§åˆ«æ—¶ï¼Œæ¢¯åº¦ä¼°è®¡çš„ä¸ç¡®å®šæ€§å¢åŠ &lt;/li&gt;
&lt;li&gt;æ¢¯åº¦æ–¹å‘ä¸ä¸€è‡´ï¼šä¸åŒå±‚çš„æ¢¯åº¦å¯èƒ½æŒ‡å‘ç›¸åçš„æ–¹å‘&lt;/li&gt;
&lt;li&gt;å†…å­˜é™åˆ¶ï¼šæ¢¯åº¦ç´¯ç§¯å’Œåå‘ä¼ æ’­çš„å†…å­˜æ¶ˆè€—å·¨å¤§&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;è§£å†³æ–¹æ¡ˆ&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# ZeRO ä¼˜åŒ–å™¨ç¤ºä¾‹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;from&lt;/span&gt; deepspeed &lt;span style="color:#f92672"&gt;import&lt;/span&gt; zero
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;configure_zero_optimizer&lt;/span&gt;(model, stage&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;é…ç½®ZeROä¼˜åŒ–å™¨&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;optim&lt;span style="color:#f92672"&gt;.&lt;/span&gt;AdamW(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), lr&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-3&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# Zero Redundancy Optimizer&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer &lt;span style="color:#f92672"&gt;=&lt;/span&gt; zero&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Init(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; optimizer,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; zero_stage&lt;span style="color:#f92672"&gt;=&lt;/span&gt;stage, &lt;span style="color:#75715e"&gt;# Stage 2: åˆ†åŒºä¼˜åŒ–å™¨çŠ¶æ€+æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; reduce_bucket_size&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5e7&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; allgather_bucket_size&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;5e7&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; )
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; optimizer&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="512-æ¢¯åº¦æ£€æŸ¥ç‚¹gradient-checkpointing"&gt;5.1.2 æ¢¯åº¦æ£€æŸ¥ç‚¹ï¼ˆGradient Checkpointingï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŸç†&lt;/strong&gt;ï¼šé€šè¿‡ç‰ºç‰²è®¡ç®—æ—¶é—´æ¢å–å†…å­˜ç©ºé—´ï¼Œåœ¨åå‘ä¼ æ’­æ—¶é‡æ–°è®¡ç®—å‰å‘ä¼ æ’­çš„ç»“æœã€‚&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;from&lt;/span&gt; torch.utils.checkpoint &lt;span style="color:#f92672"&gt;import&lt;/span&gt; checkpoint
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;CheckpointBlock&lt;/span&gt;(nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Module):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;(self, layers):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; super()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;&lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layers &lt;span style="color:#f92672"&gt;=&lt;/span&gt; layers
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;forward&lt;/span&gt;(self, x):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ä½¿ç”¨æ¢¯åº¦æ£€æŸ¥ç‚¹&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; checkpoint(self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;_forward_impl, x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;_forward_impl&lt;/span&gt;(self, x):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; layer &lt;span style="color:#f92672"&gt;in&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layers:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x &lt;span style="color:#f92672"&gt;=&lt;/span&gt; layer(x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; x
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# åœ¨å¤§æ¨¡å‹ä¸­çš„åº”ç”¨&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;create_large_model_with_checkpoint&lt;/span&gt;(num_layers&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;24&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layers &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; i &lt;span style="color:#f92672"&gt;in&lt;/span&gt; range(num_layers):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer &lt;span style="color:#f92672"&gt;=&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;TransformerEncoderLayer(
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; d_model&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;768&lt;/span&gt;, nhead&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;8&lt;/span&gt;, dim_feedforward&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;3072&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; )
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layers&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(CheckpointBlock(nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;ModuleList([layer])))
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;Sequential(&lt;span style="color:#f92672"&gt;*&lt;/span&gt;layers)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="52-è‡ªé€‚åº”æ¢¯åº¦æŠ€æœ¯"&gt;5.2 è‡ªé€‚åº”æ¢¯åº¦æŠ€æœ¯&lt;/h3&gt;
&lt;h4 id="521-å±‚è‡ªé€‚åº”å­¦ä¹ ç‡"&gt;5.2.1 å±‚è‡ªé€‚åº”å­¦ä¹ ç‡&lt;/h4&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;class&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;LayerAdaptiveOptimizer&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;__init__&lt;/span&gt;(self, model, base_lr&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1e-3&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;base_lr &lt;span style="color:#f92672"&gt;=&lt;/span&gt; base_lr
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layer_lrs &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;_compute_layer_lrs()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;_compute_layer_lrs&lt;/span&gt;(self):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;è®¡ç®—å„å±‚çš„è‡ªé€‚åº”å­¦ä¹ ç‡&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer_lrs &lt;span style="color:#f92672"&gt;=&lt;/span&gt; {}
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; name, param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;named_parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ ¹æ®å±‚çš„æ·±åº¦è°ƒæ•´å­¦ä¹ ç‡&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; &lt;span style="color:#e6db74"&gt;&amp;#39;transformer&amp;#39;&lt;/span&gt; &lt;span style="color:#f92672"&gt;in&lt;/span&gt; name:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer_num &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;_extract_layer_num(name)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ·±å±‚ä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; lr_factor &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt; &lt;span style="color:#f92672"&gt;/&lt;/span&gt; (layer_num &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;) &lt;span style="color:#f92672"&gt;**&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0.5&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer_lrs[name] &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;base_lr &lt;span style="color:#f92672"&gt;*&lt;/span&gt; lr_factor
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;else&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer_lrs[name] &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;base_lr
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; layer_lrs
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;step&lt;/span&gt;(self):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ‰§è¡Œå‚æ•°æ›´æ–°&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; name, param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;named_parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; lr &lt;span style="color:#f92672"&gt;=&lt;/span&gt; self&lt;span style="color:#f92672"&gt;.&lt;/span&gt;layer_lrs[name]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;data &lt;span style="color:#f92672"&gt;-=&lt;/span&gt; lr &lt;span style="color:#f92672"&gt;*&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;data&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="522-æ¢¯åº¦å™ªå£°æ³¨å…¥"&gt;5.2.2 æ¢¯åº¦å™ªå£°æ³¨å…¥&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç›®çš„&lt;/strong&gt;ï¼šæ”¹å–„æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ï¼Œé¿å…é™·å…¥å±€éƒ¨æœ€ä¼˜ã€‚&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;gradient_noise_injection&lt;/span&gt;(model, noise_scale&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.01&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;å‘æ¢¯åº¦ä¸­æ³¨å…¥å™ªå£°&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# é«˜æ–¯å™ªå£°&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; noise &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;randn_like(param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad) &lt;span style="color:#f92672"&gt;*&lt;/span&gt; noise_scale
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; noise
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# è®­ç»ƒä¸­ä½¿ç”¨&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# æ³¨å…¥æ¢¯åº¦å™ªå£°&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;gradient_noise_injection(model, noise_scale&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0.01&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# æ¢¯åº¦è£å‰ª&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;nn&lt;span style="color:#f92672"&gt;.&lt;/span&gt;utils&lt;span style="color:#f92672"&gt;.&lt;/span&gt;clip_grad_norm_(model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters(), max_norm&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;1.0&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;optimizer&lt;span style="color:#f92672"&gt;.&lt;/span&gt;step()&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h3 id="53-æ–°å…´ç ”ç©¶æ–¹å‘"&gt;5.3 æ–°å…´ç ”ç©¶æ–¹å‘&lt;/h3&gt;
&lt;h4 id="531-ç¥ç»æ¶æ„æœç´¢nasä¸­çš„æ¢¯åº¦ä¼˜åŒ–"&gt;5.3.1 ç¥ç»æ¶æ„æœç´¢ï¼ˆNASï¼‰ä¸­çš„æ¢¯åº¦ä¼˜åŒ–&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨æœç´¢æœ€ä½³æ¢¯åº¦æµæ¶æ„&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;search_gradient_friendly_architecture&lt;/span&gt;(search_space, eval_epochs&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æœç´¢å¯¹æ¢¯åº¦å‹å¥½çš„æ¶æ„&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; best_architecture &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; best_gradient_score &lt;span style="color:#f92672"&gt;=&lt;/span&gt; float(&lt;span style="color:#e6db74"&gt;&amp;#39;-inf&amp;#39;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; arch &lt;span style="color:#f92672"&gt;in&lt;/span&gt; search_space:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ„å»ºå€™é€‰æ¶æ„&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model &lt;span style="color:#f92672"&gt;=&lt;/span&gt; build_model(arch)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è¯„ä¼°æ¢¯åº¦æµåŠ¨æ€§&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient_score &lt;span style="color:#f92672"&gt;=&lt;/span&gt; evaluate_gradient_flow(model)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; gradient_score &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; best_gradient_score:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; best_gradient_score &lt;span style="color:#f92672"&gt;=&lt;/span&gt; gradient_score
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; best_architecture &lt;span style="color:#f92672"&gt;=&lt;/span&gt; arch
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; best_architecture
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;evaluate_gradient_flow&lt;/span&gt;(model):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;è¯„ä¼°æ¨¡å‹çš„æ¢¯åº¦æµåŠ¨æ€§èƒ½&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; x &lt;span style="color:#f92672"&gt;=&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;randn(&lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;, &lt;span style="color:#ae81ff"&gt;10&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; y &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(x)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; y&lt;span style="color:#f92672"&gt;.&lt;/span&gt;sum()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è®¡ç®—æ¢¯åº¦ç»Ÿè®¡é‡&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient_norms &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient_norms&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;norm()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item())
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ¢¯åº¦åˆ†æ•°ï¼šå¹³å‡æ¢¯åº¦èŒƒæ•° + æ¢¯åº¦ç¨³å®šæ€§&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; avg_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; np&lt;span style="color:#f92672"&gt;.&lt;/span&gt;mean(gradient_norms)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; std_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; np&lt;span style="color:#f92672"&gt;.&lt;/span&gt;std(gradient_norms)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æœŸæœ›ï¼šè¾ƒå¤§çš„å¹³å‡æ¢¯åº¦ + è¾ƒå°çš„æ ‡å‡†å·®&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient_score &lt;span style="color:#f92672"&gt;=&lt;/span&gt; avg_norm &lt;span style="color:#f92672"&gt;/&lt;/span&gt; (std_norm &lt;span style="color:#f92672"&gt;+&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1e-6&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; gradient_score&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="532-é‡å­æ¢¯åº¦ä¼˜åŒ–"&gt;5.3.2 é‡å­æ¢¯åº¦ä¼˜åŒ–&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‰æ²¿æ¢ç´¢&lt;/strong&gt;ï¼šåˆ©ç”¨é‡å­è®¡ç®—ä¼˜åŒ–æ¢¯åº¦è®¡ç®—è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#75715e"&gt;# æ¦‚å¿µæ€§ä»£ç ï¼ˆå®é™…å®ç°éœ€è¦é‡å­è®¡ç®—ç¡¬ä»¶ï¼‰&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;quantum_gradient_estimation&lt;/span&gt;(circuit, parameters):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;é‡å­æ¢¯åº¦ä¼°è®¡&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# å‚æ•°ç§»ä½è§„åˆ™è®¡ç®—æ¢¯åº¦&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradients &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; epsilon &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0.01&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; i, param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; enumerate(parameters):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# æ­£å‘ç§»ä½&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; parameters_plus &lt;span style="color:#f92672"&gt;=&lt;/span&gt; parameters&lt;span style="color:#f92672"&gt;.&lt;/span&gt;copy()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; parameters_plus[i] &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; epsilon
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; expectation_plus &lt;span style="color:#f92672"&gt;=&lt;/span&gt; quantum_expectation(circuit, parameters_plus)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# è´Ÿå‘ç§»ä½&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; parameters_minus &lt;span style="color:#f92672"&gt;=&lt;/span&gt; parameters&lt;span style="color:#f92672"&gt;.&lt;/span&gt;copy()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; parameters_minus[i] &lt;span style="color:#f92672"&gt;-=&lt;/span&gt; epsilon
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; expectation_minus &lt;span style="color:#f92672"&gt;=&lt;/span&gt; quantum_expectation(circuit, parameters_minus)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# ä¸­å¿ƒå·®åˆ†&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient &lt;span style="color:#f92672"&gt;=&lt;/span&gt; (expectation_plus &lt;span style="color:#f92672"&gt;-&lt;/span&gt; expectation_minus) &lt;span style="color:#f92672"&gt;/&lt;/span&gt; (&lt;span style="color:#ae81ff"&gt;2&lt;/span&gt; &lt;span style="color:#f92672"&gt;*&lt;/span&gt; epsilon)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradients&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(gradient)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; gradients&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h2 id="å…­æ€»ç»“ä¸æœ€ä½³å®è·µ"&gt;å…­ã€æ€»ç»“ä¸æœ€ä½³å®è·µ&lt;/h2&gt;
&lt;h3 id="61-æ ¸å¿ƒè¦ç‚¹å›é¡¾"&gt;6.1 æ ¸å¿ƒè¦ç‚¹å›é¡¾&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ•°å­¦æœ¬è´¨&lt;/strong&gt;ï¼šæ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸çš„æ ¹æºåœ¨äºåå‘ä¼ æ’­ä¸­æ¢¯åº¦çš„è¿ä¹˜æ“ä½œ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ¶æ„æ¼”è¿›&lt;/strong&gt;ï¼šä» RNN â†’ LSTM â†’ Transformer çš„æ¼”è¿›è¿‡ç¨‹å°±æ˜¯è§£å†³æ¢¯åº¦é—®é¢˜çš„è¿‡ç¨‹&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç°ä»£æ–¹æ¡ˆ&lt;/strong&gt;ï¼šæ®‹å·®è¿æ¥ã€å±‚å½’ä¸€åŒ–ã€è‡ªé€‚åº”ä¼˜åŒ–å™¨ã€æ¢¯åº¦è£å‰ªç­‰æŠ€æœ¯çš„ç»„åˆåº”ç”¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å·¥ç¨‹å®è·µ&lt;/strong&gt;ï¼šæ¢¯åº¦ç›‘æ§ã€å­¦ä¹ ç‡è°ƒåº¦ã€æ··åˆç²¾åº¦è®­ç»ƒç­‰å®ç”¨æŠ€å·§&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="62-å®è·µæŒ‡å—"&gt;6.2 å®è·µæŒ‡å—&lt;/h3&gt;
&lt;h4 id="621-é—®é¢˜è¯Šæ–­æ¸…å•"&gt;6.2.1 é—®é¢˜è¯Šæ–­æ¸…å•&lt;/h4&gt;
&lt;p&gt;åœ¨é‡åˆ°è®­ç»ƒå›°éš¾æ—¶ï¼ŒæŒ‰ç…§ä»¥ä¸‹é¡ºåºæ£€æŸ¥æ¢¯åº¦é—®é¢˜ï¼š&lt;/p&gt;
&lt;div class="highlight-container"&gt;
&lt;button class="copy-code-btn outline"&gt;Copy&lt;/button&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-python" data-lang="python"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;diagnose_gradient_issues&lt;/span&gt;(model, data_loader):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ¢¯åº¦é—®é¢˜è¯Šæ–­æ¸…å•&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues &lt;span style="color:#f92672"&gt;=&lt;/span&gt; []
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 1. æ£€æŸ¥æ¢¯åº¦æ˜¯å¦æ¥è¿‘é›¶&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; avg_gradient_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; check_gradient_magnitude(model, data_loader)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; avg_gradient_norm &lt;span style="color:#f92672"&gt;&amp;lt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1e-8&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;&amp;#34;ä¸¥é‡æ¢¯åº¦æ¶ˆå¤±&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 2. æ£€æŸ¥æ¢¯åº¦æ˜¯å¦è¿‡å¤§&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; max_gradient_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; check_gradient_explosion(model, data_loader)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; max_gradient_norm &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100.0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;&amp;#34;æ¢¯åº¦çˆ†ç‚¸é£é™©&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 3. æ£€æŸ¥æ¢¯åº¦åˆ†å¸ƒ&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; gradient_distribution &lt;span style="color:#f92672"&gt;=&lt;/span&gt; check_gradient_distribution(model, data_loader)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; gradient_distribution[&lt;span style="color:#e6db74"&gt;&amp;#39;std&amp;#39;&lt;/span&gt;] &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; gradient_distribution[&lt;span style="color:#e6db74"&gt;&amp;#39;mean&amp;#39;&lt;/span&gt;] &lt;span style="color:#f92672"&gt;*&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;5&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;&amp;#34;æ¢¯åº¦åˆ†å¸ƒä¸å‡åŒ€&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#75715e"&gt;# 4. æ£€æŸ¥ä¸åŒå±‚é—´çš„æ¢¯åº¦å·®å¼‚&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; layer_gradient_ratio &lt;span style="color:#f92672"&gt;=&lt;/span&gt; check_layer_gradient_ratio(model, data_loader)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; layer_gradient_ratio &lt;span style="color:#f92672"&gt;&amp;gt;&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;100.0&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; issues&lt;span style="color:#f92672"&gt;.&lt;/span&gt;append(&lt;span style="color:#e6db74"&gt;&amp;#34;å±‚é—´æ¢¯åº¦å·®å¼‚è¿‡å¤§&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; issues
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;def&lt;/span&gt; &lt;span style="color:#a6e22e"&gt;check_gradient_magnitude&lt;/span&gt;(model, data_loader):
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#e6db74"&gt;&amp;#34;&amp;#34;&amp;#34;æ£€æŸ¥æ¢¯åº¦å¤§å°&amp;#34;&amp;#34;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_norm &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; count &lt;span style="color:#f92672"&gt;=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;eval()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;with&lt;/span&gt; torch&lt;span style="color:#f92672"&gt;.&lt;/span&gt;no_grad():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; data, _ &lt;span style="color:#f92672"&gt;in&lt;/span&gt; data_loader:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; output &lt;span style="color:#f92672"&gt;=&lt;/span&gt; model(data)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss &lt;span style="color:#f92672"&gt;=&lt;/span&gt; output&lt;span style="color:#f92672"&gt;.&lt;/span&gt;sum()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; loss&lt;span style="color:#f92672"&gt;.&lt;/span&gt;backward(retain_graph&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;True&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;for&lt;/span&gt; param &lt;span style="color:#f92672"&gt;in&lt;/span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;parameters():
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;if&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad &lt;span style="color:#f92672"&gt;is&lt;/span&gt; &lt;span style="color:#f92672"&gt;not&lt;/span&gt; &lt;span style="color:#66d9ef"&gt;None&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; total_norm &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; param&lt;span style="color:#f92672"&gt;.&lt;/span&gt;grad&lt;span style="color:#f92672"&gt;.&lt;/span&gt;norm()&lt;span style="color:#f92672"&gt;.&lt;/span&gt;item()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; count &lt;span style="color:#f92672"&gt;+=&lt;/span&gt; &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; model&lt;span style="color:#f92672"&gt;.&lt;/span&gt;zero_grad()
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;break&lt;/span&gt; &lt;span style="color:#75715e"&gt;# åªæ£€æŸ¥ç¬¬ä¸€ä¸ªbatch&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#66d9ef"&gt;return&lt;/span&gt; total_norm &lt;span style="color:#f92672"&gt;/&lt;/span&gt; max(count, &lt;span style="color:#ae81ff"&gt;1&lt;/span&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;h4 id="622-è°ƒä¼˜ä¼˜å…ˆçº§"&gt;6.2.2 è°ƒä¼˜ä¼˜å…ˆçº§&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é«˜ä¼˜å…ˆçº§&lt;/strong&gt;ï¼ˆå¿…é¡»å¤„ç†ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®æ–½æ¢¯åº¦è£å‰ªï¼ˆé˜²æ­¢è®­ç»ƒå´©æºƒï¼‰&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨é€‚å½“çš„æ¿€æ´»å‡½æ•°ï¼ˆå¦‚ ReLU å˜ä½“ï¼‰&lt;/li&gt;
&lt;li&gt;é‡‡ç”¨æ®‹å·®è¿æ¥ï¼ˆResNet/Transformerï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä¸­ä¼˜å…ˆçº§&lt;/strong&gt;ï¼ˆå»ºè®®å®æ–½ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨è‡ªé€‚åº”ä¼˜åŒ–å™¨ï¼ˆAdam/AdamWï¼‰&lt;/li&gt;
&lt;li&gt;å®æ–½æ¢¯åº¦ç›‘æ§å’Œæ—¥å¿—è®°å½•&lt;/li&gt;
&lt;li&gt;é‡‡ç”¨åˆé€‚çš„å­¦ä¹ ç‡è°ƒåº¦&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½ä¼˜å…ˆçº§&lt;/strong&gt;ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ··åˆç²¾åº¦è®­ç»ƒ&lt;/li&gt;
&lt;li&gt;æ¢¯åº¦ç´¯ç§¯&lt;/li&gt;
&lt;li&gt;åˆ†å¸ƒå¼è®­ç»ƒä¼˜åŒ–&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="63-æœªæ¥å±•æœ›"&gt;6.3 æœªæ¥å±•æœ›&lt;/h3&gt;
&lt;p&gt;æ¢¯åº¦é—®é¢˜çš„ç ”ç©¶æ­£åœ¨å‘ä»¥ä¸‹æ–¹å‘å‘å±•ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;è‡ªåŠ¨åŒ–ä¼˜åŒ–&lt;/strong&gt;ï¼šé€šè¿‡å¼ºåŒ–å­¦ä¹ å’Œå…ƒå­¦ä¹ è‡ªåŠ¨è°ƒæ•´æ¢¯åº¦å¤„ç†ç­–ç•¥&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¯è§£é‡Šæ€§&lt;/strong&gt;ï¼šç†è§£æ¢¯åº¦æµä¸æ¨¡å‹æ€§èƒ½ä¹‹é—´çš„å…³ç³»&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¡¬ä»¶ååŒ&lt;/strong&gt;ï¼šè®¾è®¡ä¸“é—¨ç”¨äºæ¢¯åº¦è®¡ç®—çš„ç¡¬ä»¶åŠ é€Ÿå™¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç†è®ºçªç ´&lt;/strong&gt;ï¼šå»ºç«‹æ›´å®Œå–„çš„æ¢¯åº¦ä¼˜åŒ–ç†è®ºåŸºç¡€&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id="64-ç»“è¯­"&gt;6.4 ç»“è¯­&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;æ¢¯åº¦æ¶ˆå¤±å’Œçˆ†ç‚¸çš„æœ¬è´¨æ˜¯ï¼šæ·±åº¦æˆ–é•¿åºåˆ—å¯¼è‡´åå‘ä¼ æ’­ä¸­çš„æ¢¯åº¦è¿ä¹˜é¡¹è¿‡å¤§æˆ–è¿‡å°ï¼Œä½¿å¾—ç½‘ç»œéš¾ä»¥æœ‰æ•ˆè®­ç»ƒã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„é—®é¢˜ï¼Œæ¨åŠ¨äº†æ·±åº¦å­¦ä¹ ä»æµ…å±‚ç½‘ç»œåˆ°æ·±å±‚æ¶æ„ï¼Œä»ä¼ ç»ŸRNNåˆ°LSTM/GRUå†åˆ°Transformerçš„é©å‘½æ€§å‘å±•ã€‚ä»Šå¤©çš„å¤§è¯­è¨€æ¨¡å‹ã€å¤šæ¨¡æ€æ¨¡å‹ç­‰å¤æ‚ç³»ç»Ÿï¼Œå…¶æˆåŠŸçš„åŸºç¡€å¾ˆå¤§ç¨‹åº¦ä¸Šä¾èµ–äºå¯¹æ¢¯åº¦é—®é¢˜çš„æ·±åˆ»ç†è§£å’Œæœ‰æ•ˆè§£å†³æ–¹æ¡ˆã€‚&lt;/p&gt;
&lt;p&gt;éšç€æ¨¡å‹è§„æ¨¡çš„ä¸æ–­æ‰©å¤§å’Œåº”ç”¨åœºæ™¯çš„æ—¥ç›Šå¤æ‚ï¼Œæ¢¯åº¦ä¼˜åŒ–å°†ç»§ç»­æ˜¯æ·±åº¦å­¦ä¹ ç ”ç©¶çš„æ ¸å¿ƒè¯¾é¢˜ã€‚æŒæ¡æ¢¯åº¦é—®é¢˜çš„åŸç†å’Œè§£å†³æ–¹æ¡ˆï¼Œä¸ä»…æ˜¯è®­ç»ƒæˆåŠŸæ¨¡å‹çš„å…³é”®ï¼Œæ›´æ˜¯ç†è§£æ·±åº¦å­¦ä¹ æœ¬è´¨çš„é‡è¦é€”å¾„ã€‚&lt;/p&gt;
&lt;hr&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ·±åº¦å­¦ä¹ çš„è‰ºæœ¯ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå°±æ˜¯ç†è§£å¹¶é©¾é©­æ¢¯åº¦çš„è‰ºæœ¯ã€‚&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;</description></item></channel></rss>