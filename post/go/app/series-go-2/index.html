<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Go application, 分布式系统设计 - ✌yesplease's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.152.2"><link rel=canonical href=http://localhost:1313/post/go/app/series-go-2/><meta name=author content="yesplease"><meta name=description content="Go应用与分布式系统设计实战 在现代分布式系统架构中，Go语言凭借其出色的并发性能和简洁的语法设计，成为了构建高可用、高性能分布式系统的首选语言之一。本文将深入探讨如何使用Go语言实现分布式系统中的核心组件，包括一致性协议、高并发架构设计和分布式锁机制。
"><meta name=keywords content="go,distributed-system,raft,paxos,concurrency,distributed-lock"><meta property="og:url" content="http://localhost:1313/post/go/app/series-go-2/"><meta property="og:site_name" content="✌yesplease's blog"><meta property="og:title" content="Go application, 分布式系统设计"><meta property="og:description" content="Go应用与分布式系统设计实战 在现代分布式系统架构中，Go语言凭借其出色的并发性能和简洁的语法设计，成为了构建高可用、高性能分布式系统的首选语言之一。本文将深入探讨如何使用Go语言实现分布式系统中的核心组件，包括一致性协议、高并发架构设计和分布式锁机制。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-01-02T16:01:23+08:00"><meta property="article:modified_time" content="2024-01-02T16:01:23+08:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Distributed-System"><meta property="article:tag" content="Raft"><meta property="article:tag" content="Paxos"><meta property="article:tag" content="Concurrency"><meta property="article:tag" content="Distributed-Lock"><meta itemprop=name content="Go application, 分布式系统设计"><meta itemprop=description content="Go应用与分布式系统设计实战 在现代分布式系统架构中，Go语言凭借其出色的并发性能和简洁的语法设计，成为了构建高可用、高性能分布式系统的首选语言之一。本文将深入探讨如何使用Go语言实现分布式系统中的核心组件，包括一致性协议、高并发架构设计和分布式锁机制。"><meta itemprop=datePublished content="2024-01-02T16:01:23+08:00"><meta itemprop=dateModified content="2024-01-02T16:01:23+08:00"><meta itemprop=wordCount content="5068"><meta itemprop=keywords content="Go,Distributed-System,Raft,Paxos,Concurrency,Distributed-Lock"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go application, 分布式系统设计"><meta name=twitter:description content="Go应用与分布式系统设计实战 在现代分布式系统架构中，Go语言凭借其出色的并发性能和简洁的语法设计，成为了构建高可用、高性能分布式系统的首选语言之一。本文将深入探讨如何使用Go语言实现分布式系统中的核心组件，包括一致性协议、高并发架构设计和分布式锁机制。"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.e7c52960f769ac11bea62d460dc48cd995591740192e6c6f8c0f5585fb135c9d.css integrity="sha256-58UpYPdprBG+pi1GDcSM2ZVZF0AZLmxvjA9VhfsTXJ0=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>✌yesplease</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>✌yesplease</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=left-sidebar><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#一致性协议>一致性协议</a><ul><li><a href=#raft算法实现>Raft算法实现</a></li><li><a href=#paxos算法实现>Paxos算法实现</a></li></ul></li><li><a href=#高并发架构>高并发架构</a><ul><li><a href=#令牌桶限流算法>令牌桶限流算法</a></li><li><a href=#滑动窗口限流>滑动窗口限流</a></li><li><a href=#熔断器模式>熔断器模式</a></li><li><a href=#降级策略>降级策略</a></li><li><a href=#并发控制模式>并发控制模式</a></li></ul></li><li><a href=#分布式锁>分布式锁</a><ul><li><a href=#基于redis的分布式锁>基于Redis的分布式锁</a></li><li><a href=#基于etcd的分布式锁>基于Etcd的分布式锁</a></li><li><a href=#分布式锁使用示例>分布式锁使用示例</a></li></ul></li><li><a href=#总结>总结</a><ul><li><a href=#关键技术要点>关键技术要点</a></li><li><a href=#最佳实践建议>最佳实践建议</a></li></ul></li></ul></nav></div></nav></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Go application, 分布式系统设计</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>yesplease</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2024-01-02>2024-01-02</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=http://localhost:1313/categories/go/>go</a></div></div></div></header><div class=post-content><h1 id=go应用与分布式系统设计实战>Go应用与分布式系统设计实战</h1><p>在现代分布式系统架构中，Go语言凭借其出色的并发性能和简洁的语法设计，成为了构建高可用、高性能分布式系统的首选语言之一。本文将深入探讨如何使用Go语言实现分布式系统中的核心组件，包括一致性协议、高并发架构设计和分布式锁机制。</p><h2 id=一致性协议>一致性协议</h2><h3 id=raft算法实现>Raft算法实现</h3><p>Raft是一种易于理解的一致性算法，相比于Paxos更加直观。在分布式存储系统中，Raft通过领导者选举、日志复制和安全性三个核心机制来保证数据的一致性。</p><h4 id=核心数据结构>核心数据结构</h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Raft</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>peers</span>     []<span style=color:#66d9ef>string</span>          <span style=color:#75715e>// 集群中的其他节点</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>persister</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Persister</span>        <span style=color:#75715e>// 持久化存储</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>me</span>        <span style=color:#66d9ef>int</span>               <span style=color:#75715e>// 本节点在peers中的索引</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentTerm</span> <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// 当前任期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votedFor</span>    <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// 当前任期投票给谁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>         []<span style=color:#a6e22e>LogEntry</span>      <span style=color:#75715e>// 日志条目</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>commitIndex</span> <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// 已提交的日志索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastApplied</span> <span style=color:#66d9ef>int</span>             <span style=color:#75715e>// 已应用到状态机的日志索引</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>leaderId</span>   <span style=color:#66d9ef>int</span>              <span style=color:#75715e>// 当前领导者的ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 领导者状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIndex</span>  []<span style=color:#66d9ef>int</span>           <span style=color:#75715e>// 每个节点的下一个日志索引</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchIndex</span> []<span style=color:#66d9ef>int</span>           <span style=color:#75715e>// 每个节点的已匹配日志索引</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 选举相关</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>electionTimeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>heartbeatInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resetElectionTimer</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RPC服务</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rpcServer</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RPCServer</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rpcClient</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>RPCClient</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 应用层回调</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applyCh</span>    <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>ApplyMsg</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>snapshotCh</span> <span style=color:#66d9ef>chan</span> []<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stopCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LogEntry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Command</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Term</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Index</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ApplyMsg</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommandValid</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Command</span>      <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CommandIndex</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=领导者选举>领导者选举</h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>startElection</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 转换为候选人状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>Candidate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 发送请求投票RPC</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLogIndex</span>, <span style=color:#a6e22e>lastLogTerm</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>getLastLogInfo</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteArgs</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Term</span>:        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>CandidateId</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LastLogIndex</span>: <span style=color:#a6e22e>lastLogIndex</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LastLogTerm</span>:  <span style=color:#a6e22e>lastLogTerm</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>votes</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span> <span style=color:#75715e>// 自己投自己一票</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>voteCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>, len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>RequestVoteReply</span>{}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendRequestVote</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>voteCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>VoteGranted</span>
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>voteCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 统计投票结果</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>granted</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>voteCh</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>granted</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>granted</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>Candidate</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>becomeLeader</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 重置选举定时器</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTimer</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>becomeLeader</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>Leader</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>leaderId</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 初始化领导者状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>getLastLogIndex</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>lastLogIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 开始发送心跳</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendHeartbeats</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Node %d became leader for term %d&#34;</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>, <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendHeartbeats</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Leader</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendAppendEntries</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>heartbeatInterval</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=日志复制>日志复制</h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>sendAppendEntries</span>(<span style=color:#a6e22e>server</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>Leader</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prevLogTerm</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nextIdx</span> &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>prevLogTerm</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>nextIdx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>].<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>entries</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>LogEntry</span>, <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>getLastLogIndex</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entries</span> = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>nextIdx</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>args</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesArgs</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Term</span>:         <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LeaderId</span>:     <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PrevLogIndex</span>: <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PrevLogTerm</span>:  <span style=color:#a6e22e>prevLogTerm</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Entries</span>:      <span style=color:#a6e22e>entries</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LeaderCommit</span>: <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>AppendEntriesReply</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>sendAppendEntriesRPC</span>(<span style=color:#a6e22e>server</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>args</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Term</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>Follower</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>votedFor</span> = <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>persist</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>resetElectionTimer</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>Success</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 更新匹配索引和下一个索引</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> len(<span style=color:#a6e22e>entries</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>server</span>] <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查是否可以提交新的日志条目</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>updateCommitIndex</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 递减nextIndex重试</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>nextIndex</span>[<span style=color:#a6e22e>server</span>] = <span style=color:#a6e22e>nextIdx</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rf</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Raft</span>) <span style=color:#a6e22e>updateCommitIndex</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>getLastLogIndex</span>(); <span style=color:#a6e22e>i</span> &gt; <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span> <span style=color:#75715e>// 领导者自己</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>!=</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>me</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>matchIndex</span>[<span style=color:#a6e22e>j</span>] <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>i</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>count</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> &gt; len(<span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>peers</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>log</span>[<span style=color:#a6e22e>i</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Term</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>currentTerm</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>commitIndex</span> = <span style=color:#a6e22e>i</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 应用已提交的日志</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rf</span>.<span style=color:#a6e22e>applyCommittedEntries</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=paxos算法实现>Paxos算法实现</h3><p>Paxos是另一种经典的一致性算法，虽然在理解上比Raft复杂，但在某些场景下具有更好的性能特性。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Paxos</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>        <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodes</span>     <span style=color:#66d9ef>int</span>              <span style=color:#75715e>// 节点数量</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeID</span>    <span style=color:#66d9ef>int</span>              <span style=color:#75715e>// 当前节点ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提议者状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>proposalNumber</span> <span style=color:#66d9ef>int</span>          <span style=color:#75715e>// 提议编号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptedNumber</span> <span style=color:#66d9ef>int</span>          <span style=color:#75715e>// 已接受的提议编号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptedValue</span>  <span style=color:#66d9ef>interface</span>{}  <span style=color:#75715e>// 已接受的值</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 接受者状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minProposal</span> <span style=color:#66d9ef>int</span>            <span style=color:#75715e>// 最小提议编号</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>accepted</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>Proposal</span>      <span style=color:#75715e>// 已接受的提议</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 学习者状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>learned</span>    []<span style=color:#66d9ef>bool</span>          <span style=color:#75715e>// 学习状态</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>learnedCh</span>  <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>interface</span>{} <span style=color:#75715e>// 学习通道</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Network</span>          <span style=color:#75715e>// 网络层</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stopCh</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Proposal</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Number</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>  <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>px</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Paxos</span>) <span style=color:#a6e22e>propose</span>(<span style=color:#a6e22e>value</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Phase 1: Prepare</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>proposalNumber</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>getNewProposalNumber</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prepareCount</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>prepareCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PrepareReply</span>, <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodeID</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>PrepareReply</span>{}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>sendPrepare</span>(<span style=color:#a6e22e>nodeID</span>, <span style=color:#a6e22e>proposalNumber</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>prepareCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>reply</span>
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 等待大多数响应</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptedNumber</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptedValue</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>prepareCh</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>prepareCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>AcceptedNumber</span> &gt; <span style=color:#a6e22e>acceptedNumber</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acceptedNumber</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>AcceptedNumber</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acceptedValue</span> = <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>AcceptedValue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>prepareCount</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Phase 2: Accept</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptCount</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acceptCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AcceptReply</span>, <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodeID</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AcceptReply</span>{}
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>network</span>.<span style=color:#a6e22e>sendAccept</span>(<span style=color:#a6e22e>nodeID</span>, <span style=color:#a6e22e>proposalNumber</span>, <span style=color:#a6e22e>acceptedValue</span>, <span style=color:#a6e22e>reply</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>acceptCh</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>reply</span>
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reply</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>acceptCh</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>reply</span>.<span style=color:#a6e22e>OK</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>acceptCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>acceptCount</span> &gt; <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>nodes</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Phase 3: Learn</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>px</span>.<span style=color:#a6e22e>broadcastLearn</span>(<span style=color:#a6e22e>proposalNumber</span>, <span style=color:#a6e22e>acceptedValue</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h2 id=高并发架构>高并发架构</h2><p>在分布式系统中，高并发架构设计是保证系统稳定性和可用性的关键。Go语言的并发特性为我们提供了强大的工具来构建高性能的并发系统。</p><h3 id=令牌桶限流算法>令牌桶限流算法</h3><p>令牌桶算法是一种常用的限流算法，它通过以固定速率向桶中添加令牌，每个请求需要消耗一个令牌来处理，从而实现对请求速率的控制。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>TokenBucket</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>capacity</span>    <span style=color:#66d9ef>int64</span>         <span style=color:#75715e>// 桶的容量</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tokens</span>      <span style=color:#66d9ef>int64</span>         <span style=color:#75715e>// 当前令牌数量</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>refillRate</span>  <span style=color:#66d9ef>int64</span>         <span style=color:#75715e>// 填充速率 (tokens/second)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastRefill</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>     <span style=color:#75715e>// 上次填充时间</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>    <span style=color:#75715e>// 互斥锁</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewTokenBucket</span>(<span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>refillRate</span> <span style=color:#66d9ef>int64</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>TokenBucket</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>TokenBucket</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>capacity</span>:   <span style=color:#a6e22e>capacity</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokens</span>:     <span style=color:#a6e22e>capacity</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>refillRate</span>: <span style=color:#a6e22e>refillRate</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lastRefill</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>tb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TokenBucket</span>) <span style=color:#a6e22e>Allow</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 计算需要补充的令牌</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>lastRefill</span>).<span style=color:#a6e22e>Seconds</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tokensToAdd</span> <span style=color:#f92672>:=</span> int64(<span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>*</span> float64(<span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>refillRate</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 补充令牌</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tokensToAdd</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>tokens</span> = min(<span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>capacity</span>, <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>tokens</span><span style=color:#f92672>+</span><span style=color:#a6e22e>tokensToAdd</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>lastRefill</span> = <span style=color:#a6e22e>now</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否有足够的令牌</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>tokens</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>tokens</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>tb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>TokenBucket</span>) <span style=color:#a6e22e>Wait</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>tb</span>.<span style=color:#a6e22e>Allow</span>() {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>):
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> min(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span> <span style=color:#66d9ef>int64</span>) <span style=color:#66d9ef>int64</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>a</span> &lt; <span style=color:#a6e22e>b</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>rateLimitedHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bucket</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewTokenBucket</span>(<span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>10</span>) <span style=color:#75715e>// 容量100，每秒10个令牌</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>bucket</span>.<span style=color:#a6e22e>Allow</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Rate limit exceeded&#34;</span>, <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusTooManyRequests</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 处理请求</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>w</span>, <span style=color:#e6db74>&#34;Request processed&#34;</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=滑动窗口限流>滑动窗口限流</h3><p>滑动窗口限流可以更精确地控制时间窗口内的请求量。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SlidingWindowRateLimiter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windowSize</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#75715e>// 窗口大小</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxRequests</span> <span style=color:#66d9ef>int</span>          <span style=color:#75715e>// 最大请求数</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requests</span>    []<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>  <span style=color:#75715e>// 请求时间戳</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewSlidingWindowRateLimiter</span>(<span style=color:#a6e22e>windowSize</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>maxRequests</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>SlidingWindowRateLimiter</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SlidingWindowRateLimiter</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>windowSize</span>:  <span style=color:#a6e22e>windowSize</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxRequests</span>: <span style=color:#a6e22e>maxRequests</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requests</span>:    make([]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SlidingWindowRateLimiter</span>) <span style=color:#a6e22e>Allow</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cutoff</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#f92672>-</span><span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>windowSize</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 移除窗口外的请求</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> len(<span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span>) &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Before</span>(<span style=color:#a6e22e>cutoff</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span> = <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否超过限制</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span>) <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>maxRequests</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 添加当前请求</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span> = append(<span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>requests</span>, <span style=color:#a6e22e>now</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=熔断器模式>熔断器模式</h3><p>熔断器模式用于防止系统在依赖服务故障时继续请求，从而避免级联故障。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CircuitBreakerState</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateClosed</span> <span style=color:#a6e22e>CircuitBreakerState</span> = <span style=color:#66d9ef>iota</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateOpen</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StateHalfOpen</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CircuitBreaker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>             <span style=color:#a6e22e>CircuitBreakerState</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>failureCount</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>successCount</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxFailures</span>       <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resetTimeout</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastFailureTime</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>halfOpenMaxCalls</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>halfOpenCalls</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>               <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewCircuitBreaker</span>(<span style=color:#a6e22e>maxFailures</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>resetTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CircuitBreaker</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>:            <span style=color:#a6e22e>StateClosed</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxFailures</span>:      <span style=color:#a6e22e>maxFailures</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resetTimeout</span>:     <span style=color:#a6e22e>resetTimeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>halfOpenMaxCalls</span>: <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span>) <span style=color:#a6e22e>Allow</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateClosed</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateOpen</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Sub</span>(<span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>lastFailureTime</span>) &gt; <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>resetTimeout</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateHalfOpen</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>halfOpenCalls</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateHalfOpen</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>halfOpenCalls</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>halfOpenMaxCalls</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>halfOpenCalls</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span>) <span style=color:#a6e22e>RecordSuccess</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateHalfOpen</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>successCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>successCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>halfOpenMaxCalls</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateClosed</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>failureCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>successCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateClosed</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>failureCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span>) <span style=color:#a6e22e>RecordFailure</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>failureCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>lastFailureTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateClosed</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>failureCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>maxFailures</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateOpen</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>StateHalfOpen</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>state</span> = <span style=color:#a6e22e>StateOpen</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>successCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>circuitBreakerHandler</span>(<span style=color:#a6e22e>cb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span>, <span style=color:#a6e22e>handler</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>Allow</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;circuit breaker is open&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>handler</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>RecordFailure</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cb</span>.<span style=color:#a6e22e>RecordSuccess</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=降级策略>降级策略</h3><p>降级策略在系统负载过高或依赖服务不可用时，提供简化的功能或默认值。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DegradationStrategy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>enabled</span>         <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fallbackEnabled</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fallbackData</span>    <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>customFallback</span>  <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>Metrics</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Metrics</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestCount</span>     <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fallbackCount</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorCount</span>       <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>avgResponseTime</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>               <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDegradationStrategy</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>DegradationStrategy</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DegradationStrategy</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>enabled</span>:        <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fallbackEnabled</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>:        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>Metrics</span>{},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ds</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DegradationStrategy</span>) <span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>primary</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>)) (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>requestCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>enabled</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>executeFallback</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 检查是否需要降级</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>shouldDegrade</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>executeFallback</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 执行主逻辑</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>primary</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>duration</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>start</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>errorCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>executeFallback</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 更新平均响应时间</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>avgResponseTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(
</span></span><span style=display:flex><span>        (int64(<span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>avgResponseTime</span>) <span style=color:#f92672>+</span> int64(<span style=color:#a6e22e>duration</span>)) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ds</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DegradationStrategy</span>) <span style=color:#a6e22e>shouldDegrade</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 错误率过高</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>requestCount</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorRate</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>errorCount</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>requestCount</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errorRate</span> &gt; <span style=color:#ae81ff>0.5</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 响应时间过长</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>avgResponseTime</span> &gt; <span style=color:#ae81ff>2</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ds</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DegradationStrategy</span>) <span style=color:#a6e22e>executeFallback</span>() (<span style=color:#66d9ef>interface</span>{}, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>fallbackCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>fallbackEnabled</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;degradation strategy enabled but fallback not available&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>customFallback</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>customFallback</span>(), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ds</span>.<span style=color:#a6e22e>fallbackData</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>degradedDataService</span>(<span style=color:#a6e22e>dataFetcher</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>error</span>)) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewDegradationStrategy</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>fallbackEnabled</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>fallbackData</span> = <span style=color:#e6db74>&#34;fallback data&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>customFallback</span> = <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>interface</span>{} {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;custom fallback data&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>Execute</span>(<span style=color:#a6e22e>dataFetcher</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Data service failed: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;service unavailable&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>.(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=并发控制模式>并发控制模式</h3><p>使用Go的Channel和Context实现高级并发控制模式。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WorkerPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tasks</span>       <span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>Task</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>workers</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>         <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cancel</span>      <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>CancelFunc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorHandler</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Task</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Execute</span> <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewWorkerPool</span>(<span style=color:#a6e22e>workers</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>queueSize</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>errorHandler</span> <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>WorkerPool</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tasks</span>:       make(<span style=color:#66d9ef>chan</span> <span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>queueSize</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>workers</span>:     <span style=color:#a6e22e>workers</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>:         <span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cancel</span>:      <span style=color:#a6e22e>cancel</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorHandler</span>: <span style=color:#a6e22e>errorHandler</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>wp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>workers</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>worker</span>(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>wp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span>) <span style=color:#a6e22e>worker</span>(<span style=color:#a6e22e>id</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>task</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>tasks</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>handleTask</span>(<span style=color:#a6e22e>task</span>, <span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>wp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span>) <span style=color:#a6e22e>handleTask</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>Task</span>, <span style=color:#a6e22e>workerID</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> recover(); <span style=color:#a6e22e>r</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;worker %d panic: %v&#34;</span>, <span style=color:#a6e22e>workerID</span>, <span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>errorHandler</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>Execute</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;worker %d task %d failed: %v&#34;</span>, <span style=color:#a6e22e>workerID</span>, <span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>ID</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>errorHandler</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>wp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span>) <span style=color:#a6e22e>Submit</span>(<span style=color:#a6e22e>task</span> <span style=color:#a6e22e>Task</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>tasks</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>task</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;worker pool is shutting down&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>wp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WorkerPool</span>) <span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wp</span>.<span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>workerPoolExample</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pool</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewWorkerPool</span>(<span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>100</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Error: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Start</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 提交任务</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>50</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>taskID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>i</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>task</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Task</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ID</span>: <span style=color:#a6e22e>taskID</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Execute</span>: <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Processing task %d&#34;</span>, <span style=color:#a6e22e>taskID</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>100</span>)) <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>Submit</span>(<span style=color:#a6e22e>task</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h2 id=分布式锁>分布式锁</h2><p>在分布式系统中，由于多个节点可能同时访问共享资源，因此需要分布式锁来保证数据的一致性和避免竞态条件。我们将介绍基于Redis和Etcd的分布式锁实现。</p><h3 id=基于redis的分布式锁>基于Redis的分布式锁</h3><p>Redis的原子操作和过期时间机制使其成为实现分布式锁的理想选择。</p><h4 id=基础redis锁实现>基础Redis锁实现</h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RedisLock</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>       <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>value</span>     <span style=color:#66d9ef>string</span> <span style=color:#75715e>// 唯一标识，用于识别锁的持有者</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ttl</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stopRenew</span> <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRedisLock</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ttl</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>RedisLock</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>:    <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>key</span>:       <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value</span>:     <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ttl</span>:       <span style=color:#a6e22e>ttl</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>stopRenew</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>) <span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用SET命令的NX选项实现原子性获取锁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>SetNX</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>ttl</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>result</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 启动续期goroutine</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>renewLock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>) <span style=color:#a6e22e>renewLock</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>ttl</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// 使用Lua脚本确保原子性续期</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>script</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    return redis.call(&#34;EXPIRE&#34;, KEYS[1], ARGV[2])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                    return 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            `</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Eval</span>(
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>script</span>,
</span></span><span style=display:flex><span>                []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>key</span>},
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>                int(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>ttl</span>.<span style=color:#a6e22e>Seconds</span>()),
</span></span><span style=display:flex><span>            ).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to renew lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>stopRenew</span>:
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>) <span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 停止续期</span>
</span></span><span style=display:flex><span>    close(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>stopRenew</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用Lua脚本确保只有锁的持有者才能释放锁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>script</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        if redis.call(&#34;GET&#34;, KEYS[1]) == ARGV[1] then
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            return redis.call(&#34;DEL&#34;, KEYS[1])
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        else
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            return 0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        end
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    `</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Eval</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>script</span>, []<span style=color:#66d9ef>string</span>{<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>key</span>}, <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>value</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to release lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>==</span> int64(<span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lock not held by this instance&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=redis-redlock算法>Redis RedLock算法</h4><p>RedLock算法在多个Redis实例上获取锁，提供了更高的可靠性。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RedLock</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>locks</span>    []<span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>quorum</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retry</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retryDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRedLock</span>(<span style=color:#a6e22e>clients</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ttl</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>RedLock</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>locks</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>, len(<span style=color:#a6e22e>clients</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>clients</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>locks</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>NewRedisLock</span>(<span style=color:#a6e22e>client</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>ttl</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>RedLock</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>locks</span>:      <span style=color:#a6e22e>locks</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>quorum</span>:     len(<span style=color:#a6e22e>clients</span>)<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retry</span>:      <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryDelay</span>: <span style=color:#ae81ff>100</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedLock</span>) <span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>successCount</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>attempt</span> &lt; <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>retry</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>successCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>bool</span>, len(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>locks</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errors</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, len(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>locks</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 并发获取所有锁</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>lock</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>locks</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>errors</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>success</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }(<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>        close(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>        close(<span style=color:#a6e22e>errors</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 统计成功数量</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>success</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>results</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>successCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 收集错误</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>errors</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>lastErr</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 检查是否达到法定数量</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>successCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>quorum</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 释放已获取的锁</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 等待重试</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>retryDelay</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire quorum: %v&#34;</span>, <span style=color:#a6e22e>lastErr</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>rl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedLock</span>) <span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errors</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, len(<span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>locks</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>lock</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rl</span>.<span style=color:#a6e22e>locks</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisLock</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>errors</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>lock</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>    close(<span style=color:#a6e22e>errors</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errorsList</span> []<span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>errors</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorsList</span> = append(<span style=color:#a6e22e>errorsList</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>errorsList</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;errors while unlocking: %v&#34;</span>, <span style=color:#a6e22e>errorsList</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=基于etcd的分布式锁>基于Etcd的分布式锁</h3><p>Etcd提供了更强一致性的分布式锁实现，适合对一致性要求更高的场景。</p><h4 id=etcd锁实现>Etcd锁实现</h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EtcdLock</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>session</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>Session</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutex</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>        <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ttl</span>        <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewEtcdLock</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ttl</span> <span style=color:#66d9ef>int64</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdLock</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>EtcdLock</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>: <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>key</span>:    <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ttl</span>:    <span style=color:#a6e22e>ttl</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdLock</span>) <span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建session，用于自动续期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>NewSession</span>(<span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>WithTTL</span>(int(<span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>ttl</span>)),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create session: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>session</span> = <span style=color:#a6e22e>session</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>NewMutex</span>(<span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>mutex</span> = <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 获取锁</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdLock</span>) <span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>mutex</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lock not acquired&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>session</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>el</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdLock</span>) <span style=color:#a6e22e>TryLock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建session</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>NewSession</span>(<span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>WithTTL</span>(int(<span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>ttl</span>)),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>WithContext</span>(<span style=color:#a6e22e>ctx</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create session: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>session</span> = <span style=color:#a6e22e>session</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建mutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mutex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>concurrency</span>.<span style=color:#a6e22e>NewMutex</span>(<span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>el</span>.<span style=color:#a6e22e>mutex</span> = <span style=color:#a6e22e>mutex</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 尝试获取锁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lockCh</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            close(<span style=color:#a6e22e>lockCh</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>lockCh</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire lock&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>mutex</span>.<span style=color:#a6e22e>Locked</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=etcd事务锁>Etcd事务锁</h4><p>使用Etcd的事务功能实现更复杂的锁逻辑。</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EtcdTransactionLock</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>value</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ttl</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lease</span>  <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>LeaseID</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewEtcdTransactionLock</span>(<span style=color:#a6e22e>client</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Client</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ttl</span> <span style=color:#66d9ef>int64</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdTransactionLock</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>EtcdTransactionLock</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>: <span style=color:#a6e22e>client</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>key</span>:    <span style=color:#a6e22e>key</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value</span>:  <span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ttl</span>:    <span style=color:#a6e22e>ttl</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>etl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdTransactionLock</span>) <span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 创建lease</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>leaseResp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Grant</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>ttl</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create lease: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span> = <span style=color:#a6e22e>leaseResp</span>.<span style=color:#a6e22e>ID</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 启动lease续期</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>leaseCh</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>KeepAlive</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Revoke</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to keep lease alive: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>ka</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>leaseCh</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ka</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用事务获取锁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>txn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Txn</span>(<span style=color:#a6e22e>ctx</span>).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>If</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Version</span>(<span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>key</span>), <span style=color:#e6db74>&#34;=&#34;</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>        ).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Then</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>OpPut</span>(<span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>value</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>WithLease</span>(<span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>)),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>txn</span>.<span style=color:#a6e22e>Commit</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Revoke</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to commit transaction: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Succeeded</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Revoke</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lock already held&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>etl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EtcdTransactionLock</span>) <span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lock not acquired&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 使用事务释放锁</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>txn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Txn</span>(<span style=color:#a6e22e>ctx</span>).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>If</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Compare</span>(<span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>key</span>), <span style=color:#e6db74>&#34;=&#34;</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span>        ).
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Then</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>OpDelete</span>(<span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>key</span>),
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>txn</span>.<span style=color:#a6e22e>Commit</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to commit unlock transaction: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Succeeded</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;lock not held by this instance&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 释放lease</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Revoke</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>etl</span>.<span style=color:#a6e22e>lease</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to revoke lease: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=分布式锁使用示例>分布式锁使用示例</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 分布式锁使用示例</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>distributedLockExample</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Redis锁示例</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>redisClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>NewClient</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>redis</span>.<span style=color:#a6e22e>Options</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Addr</span>: <span style=color:#e6db74>&#34;localhost:6379&#34;</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>redisLock</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRedisLock</span>(<span style=color:#a6e22e>redisClient</span>, <span style=color:#e6db74>&#34;my_lock&#34;</span>, <span style=color:#e6db74>&#34;unique_value&#34;</span>, <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>redisLock</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to acquire Redis lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>redisLock</span>.<span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Redis lock acquired, doing work...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Etcd锁示例</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>etcdClient</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>clientv3</span>.<span style=color:#a6e22e>Config</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Endpoints</span>:   []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;localhost:2379&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>DialTimeout</span>: <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to create etcd client: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>etcdClient</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>etcdLock</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewEtcdLock</span>(<span style=color:#a6e22e>etcdClient</span>, <span style=color:#e6db74>&#34;my_etcd_lock&#34;</span>, <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>etcdLock</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Failed to acquire etcd lock: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>etcdLock</span>.<span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Etcd lock acquired, doing work...&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 带重试的分布式锁</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>lockWithRetry</span>(<span style=color:#a6e22e>lock</span> <span style=color:#a6e22e>Acquirer</span>, <span style=color:#a6e22e>maxRetries</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>retryDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>maxRetries</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>5</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lock</span>.<span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>lastErr</span> = <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>retryDelay</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>success</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>retryDelay</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to acquire lock after %d retries: %v&#34;</span>, <span style=color:#a6e22e>maxRetries</span>, <span style=color:#a6e22e>lastErr</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Acquirer</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Lock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Unlock</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h2 id=总结>总结</h2><p>本文深入探讨了使用Go语言构建分布式系统的核心技术，包括一致性协议、高并发架构设计和分布式锁机制。通过对这些关键组件的详细实现和分析，我们可以看到Go语言在分布式系统开发中的优势。</p><h3 id=关键技术要点>关键技术要点</h3><p><strong>一致性协议</strong>：</p><ul><li>Raft算法通过领导者选举、日志复制和安全性机制保证了分布式系统的一致性</li><li>Paxos算法虽然理解起来较复杂，但在某些场景下具有更好的性能特性</li><li>两种算法都需要处理网络分区、节点故障等分布式系统中的典型问题</li></ul><p><strong>高并发架构</strong>：</p><ul><li>令牌桶和滑动窗口限流算法有效控制系统请求流量</li><li>熔断器模式防止级联故障，提高系统可用性</li><li>降级策略在系统压力过大时提供基本功能保障</li><li>WorkerPool模式利用Go的并发特性高效处理任务</li></ul><p><strong>分布式锁</strong>：</p><ul><li>Redis锁利用原子操作和过期时间机制实现简单高效的分布式锁</li><li>RedLock算法通过多实例锁提供更高的可靠性</li><li>Etcd锁基于强一致性协议，适合对一致性要求严格的场景</li><li>所有锁实现都需要考虑续期、重试和异常处理机制</li></ul><h3 id=最佳实践建议>最佳实践建议</h3><ol><li><strong>选择合适的算法</strong>：根据系统对一致性和性能的需求选择合适的一致性算法</li><li><strong>合理配置参数</strong>：限流、熔断、降级的阈值需要根据实际业务场景调整</li><li><strong>完善的错误处理</strong>：分布式系统中网络故障和节点故障是常态，需要完善的错误处理和重试机制</li><li><strong>监控和调优</strong>：持续监控系统性能指标，根据实际运行情况进行调优</li><li><strong>测试覆盖</strong>：分布式系统中的边界情况复杂，需要全面的测试覆盖</li></ol><p>通过掌握这些核心技术和最佳实践，开发者能够构建出高可用、高性能、可扩展的分布式系统，满足现代互联网应用对可靠性和性能的苛刻要求。</p><p>Go语言的简洁语法、强大的并发模型和丰富的标准库，使其成为构建分布式系统的理想选择。本文提供的实现代码可以作为基础框架，根据具体业务需求进行扩展和优化。</p><p>在未来的分布式系统开发中，这些技术将继续发挥重要作用，随着云原生和微服务架构的普及，对这些核心组件的深入理解将变得愈发重要。</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>yesplease</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2024-01-02</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=http://localhost:1313/tags/go/>go</a>
<a href=http://localhost:1313/tags/distributed-system/>distributed-system</a>
<a href=http://localhost:1313/tags/raft/>raft</a>
<a href=http://localhost:1313/tags/paxos/>paxos</a>
<a href=http://localhost:1313/tags/concurrency/>concurrency</a>
<a href=http://localhost:1313/tags/distributed-lock/>distributed-lock</a></div><nav class=post-nav><a class=prev href=/post/go/app/series-go-1/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">Go application, 云原生开发</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/go/base/series-go-1/><span class="next-text nav-default">Go fundamentals, how to play?</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><aside class=right-sidebar></aside></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:cugbtang@sina.com rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/cugbtang rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2017 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>yesplease</span></span></div></footer><script type=text/javascript src=/js/main.002d1a80e7bd914cb4592a8c6486c23920f3d9827531bd1c79b3b5716dcf0bd5.js integrity="sha256-AC0agOe9kUy0WSqMZIbCOSDz2YJ1Mb0cebO1cW3PC9U=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>