<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>flannel vxlan, check sum - ✌yesplease's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.152.2"><link rel=canonical href=http://localhost:1313/post/kubernetes/series-kubernetes-7/><meta name=author content="yesplease"><meta name=description content="集群内pod无法dig mysql.middleware 修改主机dns nameserver为集群core dns地址，主机上可以dig mysql.middleware
一、问题分析 从pod内发出的请求数据包到flannel网卡时出现问题
"><meta name=keywords content="kubernetes,FAQ"><meta property="og:url" content="http://localhost:1313/post/kubernetes/series-kubernetes-7/"><meta property="og:site_name" content="✌yesplease's blog"><meta property="og:title" content="flannel vxlan, check sum"><meta property="og:description" content="集群内pod无法dig mysql.middleware 修改主机dns nameserver为集群core dns地址，主机上可以dig mysql.middleware
一、问题分析 从pod内发出的请求数据包到flannel网卡时出现问题"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-12-07T16:01:23+08:00"><meta property="article:modified_time" content="2022-12-07T16:01:23+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="FAQ"><meta itemprop=name content="flannel vxlan, check sum"><meta itemprop=description content="集群内pod无法dig mysql.middleware 修改主机dns nameserver为集群core dns地址，主机上可以dig mysql.middleware
一、问题分析 从pod内发出的请求数据包到flannel网卡时出现问题"><meta itemprop=datePublished content="2022-12-07T16:01:23+08:00"><meta itemprop=dateModified content="2022-12-07T16:01:23+08:00"><meta itemprop=wordCount content="2301"><meta itemprop=keywords content="Kubernetes,FAQ"><meta name=twitter:card content="summary"><meta name=twitter:title content="flannel vxlan, check sum"><meta name=twitter:description content="集群内pod无法dig mysql.middleware 修改主机dns nameserver为集群core dns地址，主机上可以dig mysql.middleware
一、问题分析 从pod内发出的请求数据包到flannel网卡时出现问题"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.e7c52960f769ac11bea62d460dc48cd995591740192e6c6f8c0f5585fb135c9d.css integrity="sha256-58UpYPdprBG+pi1GDcSM2ZVZF0AZLmxvjA9VhfsTXJ0=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>✌yesplease</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>✌yesplease</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=left-sidebar><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#一问题分析>一、问题分析</a></li><li><a href=#二抓包分析>二、抓包分析</a></li><li><a href=#三解决方案关闭外层udp数据包检测>三、解决方案，关闭外层udp数据包检测</a><ul><li><a href=#21使用ethtool工具推荐>2.1、使用ethtool工具（推荐）</a></li><li><a href=#22使用sysctl设置内核参数测试了这种方式似乎不生效>2.2、使用sysctl设置内核参数（测试了这种方式似乎不生效）</a></li></ul></li></ul></nav></div></nav></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>flannel vxlan, check sum</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>yesplease</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2022-12-07>2022-12-07</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=http://localhost:1313/categories/kubernetes/>kubernetes</a>
<a href=http://localhost:1313/categories/cloudnative/>cloudnative</a></div></div></div></header><div class=post-content><p>集群内pod无法dig mysql.middleware
修改主机dns nameserver为集群core dns地址，主机上可以dig mysql.middleware</p><h2 id=一问题分析>一、问题分析</h2><p>从pod内发出的请求数据包到flannel网卡时出现问题</p><h2 id=二抓包分析>二、抓包分析</h2><ul><li><p>环境</p><table><thead><tr><th>类型</th><th>地址</th><th>网卡</th><th>flannel地址</th><th>docker0地址</th></tr></thead><tbody><tr><td>宿主机</td><td>192.168.189.5</td><td>eth0</td><td>172.30.17.0/32</td><td>172.30.17.0/24</td></tr><tr><td>宿主机</td><td>192.168.189.3</td><td>eth0</td><td>172.30.44.0/32</td><td>172.30.44.0/24</td></tr></tbody></table></li><li><p>修改192.168.189.5主机的nameserver，主机上，dig mysql.middleware.svc.cluster.local</p><ul><li><p>在192.168.189.3的eth0上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i eth0 -nnvvS  udp and   host 192.168.189.5 and  host 192.168.189.3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:00:45.171729 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 25021, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 153<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.37578 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 56488, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 103<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.6570 &gt; 172.30.44.4.53: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> 30379+ <span style=color:#f92672>[</span>1au<span style=color:#f92672>]</span> A? mysql.middleware.svc.cluster.local. ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span> <span style=color:#f92672>[</span>COOKIE 8dd7b1a036b9e96b<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>75<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:00:45.172148 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 11850, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 203<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.3.39446 &gt; 192.168.189.5.8472: <span style=color:#f92672>[</span>bad udp cksum 0x7427 -&gt; 0x6287!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 61091, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 153<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.6570: <span style=color:#f92672>[</span>bad udp cksum 0x95d7 -&gt; 0x8437!<span style=color:#f92672>]</span> 30379*- q: A? mysql.middleware.svc.cluster.local. 1/0/1 mysql.middleware.svc.cluster.local. A 10.254.83.174 ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>2048</span> DO <span style=color:#f92672>[</span>COOKIE 8dd7b1a036b9e96b<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>125<span style=color:#f92672>)</span></span></span></code></pre></div></div></li><li><p>在192.168.189.3的flannel.1上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i flannel.1 -nnvvS  host 172.30.44.4  or  172.30.44.0 and  host 172.30.17.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>172.30.17.0.28706 &gt; 172.30.44.4.53: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> 20554+ <span style=color:#f92672>[</span>1au<span style=color:#f92672>]</span> A? mysql.middleware.svc.cluster.local. ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span> <span style=color:#f92672>[</span>COOKIE 02885f0fcec139cb<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>75<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>10:14:09.100234 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 25272, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 153<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.28706: <span style=color:#f92672>[</span>bad udp cksum 0x95d7 -&gt; 0xcda2!<span style=color:#f92672>]</span> 20554*- q: A? mysql.middleware.svc.cluster.local. 1/0/1 mysql.middleware.svc.cluster.local. A 10.254.83.174 ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>4096</span> <span style=color:#f92672>[</span>COOKIE 02885f0fcec139cb<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>125<span style=color:#f92672>)</span></span></span></code></pre></div></div></li><li><p>注意：请求来的时候sum ok，回的时候 bad</p></li></ul></li><li><p>在192.168.189.5的一个pod内，dig mysql.middleware.svc.cluster.local</p><ul><li><p>在192.168.189.3的eth0上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i eth0 -nnvvS  udp and   host 192.168.189.5 and  host 192.168.189.3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:11.021851 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 18100, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 153<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.54947 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>bad udp cksum 0x694b -&gt; 0x37cc!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 29991, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 103<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.42230 &gt; 172.30.44.4.53: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> 38007+ <span style=color:#f92672>[</span>1au<span style=color:#f92672>]</span> A? mysql.middleware.svc.cluster.local. ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>1232</span> <span style=color:#f92672>[</span>COOKIE 8313fa6ef3e826cf<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>75<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:16.026185 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 22564, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 153<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.29594 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>bad udp cksum 0x3c0a -&gt; 0x9ad5!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 1772, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 103<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.60334 &gt; 172.30.44.4.53: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> 38007+ <span style=color:#f92672>[</span>1au<span style=color:#f92672>]</span> A? mysql.middleware.svc.cluster.local. ar: . OPT UDPsize<span style=color:#f92672>=</span><span style=color:#ae81ff>1232</span> <span style=color:#f92672>[</span>COOKIE 8313fa6ef3e826cf<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>75<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:16.115807 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 22619, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 78<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.58541 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:17.139797 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 22876, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 78<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.58541 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:18.163773 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 23179, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 78<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.58541 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span></span></span></code></pre></div></div></li><li><p>在192.168.189.3的flannel.1上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i flannel.1 -nnvvS  host 172.30.44.4  or  172.30.44.0 and  host 172.30.17.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:20:16.115829 ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span>
</span></span><span style=display:flex><span>10:20:17.139812 ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span>
</span></span><span style=display:flex><span>10:20:18.163795 ARP, Ethernet <span style=color:#f92672>(</span>len 6<span style=color:#f92672>)</span>, IPv4 <span style=color:#f92672>(</span>len 4<span style=color:#f92672>)</span>, Request who-has 172.30.44.4 tell 172.30.17.0, length <span style=color:#ae81ff>28</span></span></span></code></pre></div></div></li><li><p>注意：dig的udp请求来的时候sum bad了，似乎被内核网络丢弃了
pod内发送的udp数据包不能正常到达</p></li></ul></li><li><p>在192.168.189.5的一个pod内，curl 172.30.44.4:53</p><ul><li><p>在192.168.189.3的eth0上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i eth0 -nnvvS  udp and   host 192.168.189.5 and  host 192.168.189.3</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.561653 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 27101, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 110<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.60121 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57662, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 60<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>S<span style=color:#f92672>]</span>, cksum 0x3e44 <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049522, win 64860, options <span style=color:#f92672>[</span>mss 1410,sackOK,TS val <span style=color:#ae81ff>115443102</span> ecr 0,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.561757 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 10781, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 110<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.3.50170 &gt; 192.168.189.5.8472: <span style=color:#f92672>[</span>bad udp cksum 0x4a95 -&gt; 0x80d1!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 0, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 60<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>S.<span style=color:#f92672>]</span>, cksum 0x956f <span style=color:#f92672>(</span>incorrect -&gt; 0xcbab<span style=color:#f92672>)</span>, seq 2031558188, ack 1333049523, win 64308, options <span style=color:#f92672>[</span>mss 1410,sackOK,TS val <span style=color:#ae81ff>3396801268</span> ecr 115443102,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.561993 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 27102, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 102<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.60121 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57663, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0xf37e <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049523, ack 2031558189, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115443103</span> ecr 3396801268<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.562083 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 27103, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 179<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.60121 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57664, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 129<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, cksum 0x9dd2 <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049523:1333049600, ack 2031558189, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115443103</span> ecr 3396801268<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>77</span> <span style=color:#f92672>[</span>prefix length<span style=color:#f92672>(</span>18245<span style=color:#f92672>)</span> !<span style=color:#f92672>=</span> length<span style=color:#f92672>(</span>75<span style=color:#f92672>)]</span> <span style=color:#f92672>(</span>invalid<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.562109 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 10782, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 102<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.3.50170 &gt; 192.168.189.5.8472: <span style=color:#f92672>[</span>bad udp cksum 0x4a9d -&gt; 0xa86b!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4244, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xf335<span style=color:#f92672>)</span>, seq 2031558189, ack 1333049600, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396801269</span> ecr 115443103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:38.562312 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 12090, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 102<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.3.50170 &gt; 192.168.189.5.8472: <span style=color:#f92672>[</span>bad udp cksum 0x4a9d -&gt; 0xa09a!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4245, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>F.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xeb64<span style=color:#f92672>)</span>, seq 2031558189, ack 1333049600, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396803269</span> ecr 115443103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:38.562435 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 28447, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 102<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.5.60121 &gt; 192.168.189.3.8472: <span style=color:#f92672>[</span>udp sum ok<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57665, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>F.<span style=color:#f92672>]</span>, cksum 0xe38e <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049600, ack 2031558190, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115445103</span> ecr 3396803269<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:38.562519 IP <span style=color:#f92672>(</span>tos 0x0, ttl 64, id 12091, offset 0, flags <span style=color:#f92672>[</span>none<span style=color:#f92672>]</span>, proto UDP <span style=color:#f92672>(</span>17<span style=color:#f92672>)</span>, length 102<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    192.168.189.3.50170 &gt; 192.168.189.5.8472: <span style=color:#f92672>[</span>bad udp cksum 0x4a9d -&gt; 0x98c9!<span style=color:#f92672>]</span> OTV, flags <span style=color:#f92672>[</span>I<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>0x08<span style=color:#f92672>)</span>, overlay 0, instance <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4246, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xe393<span style=color:#f92672>)</span>, seq 2031558190, ack 1333049601, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396803269</span> ecr 115445103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span></span></span></code></pre></div></div></li><li><p>在192.168.189.3的flannel.1上抓包</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># tcpdump -i flannel.1 -nnvvS  host 172.30.44.4  or  172.30.44.0 and  host 172.30.17.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>三次握手
</span></span><span style=display:flex><span>10:25:36.561678 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57662, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 60<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>S<span style=color:#f92672>]</span>, cksum 0x3e44 <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049522, win 64860, options <span style=color:#f92672>[</span>mss 1410,sackOK,TS val <span style=color:#ae81ff>115443102</span> ecr 0,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>10:25:36.561744 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 0, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 60<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>S.<span style=color:#f92672>]</span>, cksum 0x956f <span style=color:#f92672>(</span>incorrect -&gt; 0xcbab<span style=color:#f92672>)</span>, seq 2031558188, ack 1333049523, win 64308, options <span style=color:#f92672>[</span>mss 1410,sackOK,TS val <span style=color:#ae81ff>3396801268</span> ecr 115443102,nop,wscale 7<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>10:25:36.561998 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57663, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0xf37e <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049523, ack 2031558189, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115443103</span> ecr 3396801268<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>四次挥手
</span></span><span style=display:flex><span>10:25:36.562088 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57664, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 129<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, cksum 0x9dd2 <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049523:1333049600, ack 2031558189, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115443103</span> ecr 3396801268<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>77</span> <span style=color:#f92672>[</span>prefix length<span style=color:#f92672>(</span>18245<span style=color:#f92672>)</span> !<span style=color:#f92672>=</span> length<span style=color:#f92672>(</span>75<span style=color:#f92672>)]</span> <span style=color:#f92672>(</span>invalid<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:36.562105 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4244, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xf335<span style=color:#f92672>)</span>, seq 2031558189, ack 1333049600, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396801269</span> ecr 115443103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>10:25:38.562279 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4245, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>F.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xeb64<span style=color:#f92672>)</span>, seq 2031558189, ack 1333049600, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396803269</span> ecr 115443103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>10:25:38.562447 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 57665, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.17.0.57972 &gt; 172.30.44.4.53: Flags <span style=color:#f92672>[</span>F.<span style=color:#f92672>]</span>, cksum 0xe38e <span style=color:#f92672>(</span>correct<span style=color:#f92672>)</span>, seq 1333049600, ack 2031558190, win 507, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>115445103</span> ecr 3396803269<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>10:25:38.562512 IP <span style=color:#f92672>(</span>tos 0x0, ttl 63, id 4246, offset 0, flags <span style=color:#f92672>[</span>DF<span style=color:#f92672>]</span>, proto TCP <span style=color:#f92672>(</span>6<span style=color:#f92672>)</span>, length 52<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    172.30.44.4.53 &gt; 172.30.17.0.57972: Flags <span style=color:#f92672>[</span>.<span style=color:#f92672>]</span>, cksum 0x9567 <span style=color:#f92672>(</span>incorrect -&gt; 0xe393<span style=color:#f92672>)</span>, seq 2031558190, ack 1333049601, win 502, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>3396803269</span> ecr 115445103<span style=color:#f92672>]</span>, length <span style=color:#ae81ff>0</span></span></span></code></pre></div></div></li><li><p>pod内发送的tcp数据包可以正常发送</p></li></ul></li></ul><h2 id=三解决方案关闭外层udp数据包检测>三、解决方案，关闭外层udp数据包检测</h2><p>要在Linux中设置网卡或内核参数以允许数据包不进行校验和计算，可以使用ethtool工具或sysctl进行配置。</p><h3 id=21使用ethtool工具推荐>2.1、使用ethtool工具（推荐）</h3><ol><li><p>首先，确保你已经安装了ethtool工具。如果没有安装，可以通过包管理器进行安装，比如在Ubuntu上可以使用以下命令：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt-get install ethtool</span></span></code></pre></div></div></li><li><p>然后，使用ethtool来设置网卡参数。例如，要禁用网卡的校验和计算，可以使用以下命令：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ethtool -K eth0 tx off rx off</span></span></code></pre></div></div><p>这将禁用eth0网卡的发送和接收校验和计算。</p></li></ol><h3 id=22使用sysctl设置内核参数测试了这种方式似乎不生效>2.2、使用sysctl设置内核参数（测试了这种方式似乎不生效）</h3><ol><li><p>打开文件<code>/etc/sysctl.conf</code>：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo nano /etc/sysctl.conf</span></span></code></pre></div></div></li><li><p>在文件末尾添加以下行以禁用校验和：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>net.ipv4.tcp_checksum <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span></span></span></code></pre></div></div></li><li><p>保存并关闭文件后，执行以下命令使更改生效：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo sysctl -p</span></span></code></pre></div></div></li></ol></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>yesplease</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2022-12-07</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=http://localhost:1313/tags/kubernetes/>kubernetes</a>
<a href=http://localhost:1313/tags/faq/>FAQ</a></div><nav class=post-nav><a class=prev href=/post/devops/series-git-1/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">git 部分功能需要先上线，怎么办？</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/container/series-container-1/><span class="next-text nav-default">Container, how to play?</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><aside class=right-sidebar></aside></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:cugbtang@sina.com rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/cugbtang rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2017 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>yesplease</span></span></div></footer><script type=text/javascript src=/js/main.002d1a80e7bd914cb4592a8c6486c23920f3d9827531bd1c79b3b5716dcf0bd5.js integrity="sha256-AC0agOe9kUy0WSqMZIbCOSDz2YJ1Mb0cebO1cW3PC9U=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>