<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>etcd authentication, how to deploy? - ✌yesplease's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.152.2"><link rel=canonical href=http://localhost:1313/post/kubernetes/series-kubernetes-11/><meta name=author content="yesplease"><meta name=description content="一、加载启动参数 1. 配置文件（Configuration file） 如果您提供了一个配置文件，那么配置文件中的设置将具有最高优先级。这意味着配置文件中的配置项将覆盖通过命令行标志和环境变量设置的所有配置。
"><meta name=keywords content="kubernetes,etcd"><meta property="og:url" content="http://localhost:1313/post/kubernetes/series-kubernetes-11/"><meta property="og:site_name" content="✌yesplease's blog"><meta property="og:title" content="etcd authentication, how to deploy?"><meta property="og:description" content="一、加载启动参数 1. 配置文件（Configuration file） 如果您提供了一个配置文件，那么配置文件中的设置将具有最高优先级。这意味着配置文件中的配置项将覆盖通过命令行标志和环境变量设置的所有配置。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2024-03-28T15:28:23+08:00"><meta property="article:modified_time" content="2024-03-28T15:28:23+08:00"><meta property="article:tag" content="Kubernetes"><meta property="article:tag" content="Etcd"><meta itemprop=name content="etcd authentication, how to deploy?"><meta itemprop=description content="一、加载启动参数 1. 配置文件（Configuration file） 如果您提供了一个配置文件，那么配置文件中的设置将具有最高优先级。这意味着配置文件中的配置项将覆盖通过命令行标志和环境变量设置的所有配置。"><meta itemprop=datePublished content="2024-03-28T15:28:23+08:00"><meta itemprop=dateModified content="2024-03-28T15:28:23+08:00"><meta itemprop=wordCount content="2208"><meta itemprop=keywords content="Kubernetes,Etcd"><meta name=twitter:card content="summary"><meta name=twitter:title content="etcd authentication, how to deploy?"><meta name=twitter:description content="一、加载启动参数 1. 配置文件（Configuration file） 如果您提供了一个配置文件，那么配置文件中的设置将具有最高优先级。这意味着配置文件中的配置项将覆盖通过命令行标志和环境变量设置的所有配置。"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.a0ae63bb9404f735c1a2045deae9e97f06e10118e5ad7befa80df30c5cd7fabc.css integrity="sha256-oK5ju5QE9zXBogRd6unpfwbhARjlrXvvqA3zDFzX+rw=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>✌yesplease</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>✌yesplease</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=left-sidebar><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#一加载启动参数>一、加载启动参数</a><ul><li><a href=#1-配置文件configuration-file>1. 配置文件（Configuration file）</a></li><li><a href=#2-命令行标志command-line-flags>2. 命令行标志（Command-line flags）</a></li><li><a href=#3-环境变量environment-variables>3. 环境变量（Environment variables）</a></li><li><a href=#优先级规则>优先级规则</a></li></ul></li><li><a href=#二加密传输>二、加密传输</a><ul><li><a href=#已有证书>已有证书</a></li><li><a href=#自动生成证书>自动生成证书</a></li></ul></li><li><a href=#三rbac>三、RBAC</a><ul><li><a href=#特殊用户和角色>特殊用户和角色</a></li><li><a href=#管理用户>管理用户</a></li><li><a href=#管理角色>管理角色</a></li><li><a href=#启用身份验证>启用身份验证</a></li><li><a href=#使用etcdctl进行身份验证>使用<code>etcdctl</code>进行身份验证</a></li><li><a href=#使用tls通用名称>使用TLS通用名称</a></li><li><a href=#关于密码强度的注意事项>关于密码强度的注意事项</a></li></ul></li><li><a href=#四加认证>四、加认证</a><ul><li><a href=#配置证书认证启动>配置证书认证启动</a></li><li><a href=#配置账号密码启动即只开启rbac>配置账号密码启动,即只开启RBAC</a></li><li><a href=#配置证书认证开启rbac>配置证书认证+开启RBAC</a></li></ul></li><li><a href=#五引用>五、引用</a></li></ul></nav></div></nav></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>etcd authentication, how to deploy?</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>yesplease</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2024-03-28>2024-03-28</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=http://localhost:1313/categories/kubernetes/>kubernetes</a>
<a href=http://localhost:1313/categories/cloudnative/>cloudnative</a></div></div></div></header><div class=post-content><h2 id=一加载启动参数>一、加载启动参数</h2><h3 id=1-配置文件configuration-file>1. 配置文件（Configuration file）</h3><p>如果您提供了一个配置文件，那么配置文件中的设置将具有最高优先级。这意味着配置文件中的配置项将覆盖通过命令行标志和环境变量设置的所有配置。</p><h3 id=2-命令行标志command-line-flags>2. 命令行标志（Command-line flags）</h3><p>当启动etcd时，通过命令行传递的标志具有较高的优先级。如果命令行标志被设置，它们将覆盖环境变量中的相应配置。</p><h3 id=3-环境变量environment-variables>3. 环境变量（Environment variables）</h3><p>每个命令行标志都有一个对应的环境变量。如果命令行中没有提供相应的标志，环境变量中的设置将被应用。环境变量的名称以<code>ETCD_</code>为前缀，并使用全大写字母和蛇形命名法。</p><h3 id=优先级规则>优先级规则</h3><ul><li>如果提供了配置文件，配置文件中的配置项将覆盖命令行标志和环境变量中的设置。</li><li>如果没有提供配置文件，命令行标志的设置将覆盖环境变量中的设置。</li><li>如果命令行标志和环境变量都没有设置，etcd将使用默认值。</li></ul><p>原文描述：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Caution</span>: <span style=color:#ae81ff>If you mix-and-match configuration options, then the following rules apply.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span><span style=color:#ae81ff>、Command-line flags take precedence over environment variables.</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span><span style=color:#ae81ff>、If you provide a configuration file all command-line flags and environment variables are ignored.</span></span></span></code></pre></div></div><h2 id=二加密传输>二、加密传输</h2><h3 id=已有证书>已有证书</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd --name infra0 --data-dir infra0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --cert-file<span style=color:#f92672>=</span>/path/to/server.crt --key-file<span style=color:#f92672>=</span>/path/to/server.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --advertise-client-urls<span style=color:#f92672>=</span>https://127.0.0.1:2379 --listen-client-urls<span style=color:#f92672>=</span>https://127.0.0.1:2379
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl --cacert /path/to/ca.crt https://127.0.0.1:2379/v2/keys/foo -XPUT -d value<span style=color:#f92672>=</span>bar -v</span></span></code></pre></div></div><h3 id=自动生成证书>自动生成证书</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>DISCOVERY_URL<span style=color:#f92672>=</span>... <span style=color:#75715e># from https://discovery.etcd.io/new</span>
</span></span><span style=display:flex><span><span style=color:#75715e># member1</span>
</span></span><span style=display:flex><span>$ etcd --name infra1 --data-dir infra1 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --auto-tls --peer-auto-tls <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --initial-advertise-peer-urls<span style=color:#f92672>=</span>https://10.0.1.10:2380 --listen-peer-urls<span style=color:#f92672>=</span>https://10.0.1.10:2380 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --discovery <span style=color:#e6db74>${</span>DISCOVERY_URL<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># member2</span>
</span></span><span style=display:flex><span>$ etcd --name infra2 --data-dir infra2 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --auto-tls --peer-auto-tls <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --initial-advertise-peer-urls<span style=color:#f92672>=</span>https://10.0.1.11:2380 --listen-peer-urls<span style=color:#f92672>=</span>https://10.0.1.11:2380 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --discovery <span style=color:#e6db74>${</span>DISCOVERY_URL<span style=color:#e6db74>}</span></span></span></code></pre></div></div><h2 id=三rbac>三、RBAC</h2><h3 id=特殊用户和角色>特殊用户和角色</h3><ul><li>存在一个特殊用户<code>root</code>和特殊角色<code>root</code>。</li><li><code>root</code>用户拥有对etcd的完全访问权限，必须在激活身份验证之前创建。</li><li><code>root</code>角色可以授予任何用户，包括root用户本身。拥有<code>root</code>角色的用户具有全局读写访问权限，并且可以更新集群的身份验证配置。</li></ul><h3 id=管理用户>管理用户</h3><ul><li><code>etcdctl</code>的<code>user</code>子命令用于处理与用户账户相关的所有操作。</li><li>列出用户、创建用户、删除用户、更改用户密码等操作都可以通过<code>etcdctl</code>命令完成。</li><li>创建用户时，可以设置密码或不设置密码。没有密码的用户可以通过TLS通用名称（Common Name, CN）进行身份验证。</li></ul><h3 id=管理角色>管理角色</h3><ul><li><code>etcdctl</code>的<code>role</code>子命令用于处理特定角色的访问控制。</li><li>列出角色、创建新角色、删除角色等操作都可以通过<code>etcdctl</code>命令完成。</li><li>角色可以被授予对单个键或键范围的访问权限，权限可以是只读、只写或读写。</li><li>角色的权限可以通过<code>etcdctl</code>命令授予和撤销。</li></ul><h3 id=启用身份验证>启用身份验证</h3><ul><li>启用身份验证的最小步骤包括创建root用户和启用身份验证。</li><li>启用身份验证后，etcd将运行在启用身份验证的状态下。如果需要禁用身份验证，可以使用相应的命令。</li></ul><h3 id=使用etcdctl进行身份验证>使用<code>etcdctl</code>进行身份验证</h3><ul><li><code>etcdctl</code>支持类似于<code>curl</code>的身份验证标志。</li><li>用户可以使用用户名和密码进行身份验证，也可以从提示中获取密码或从命令行标志中提供密码。</li></ul><h3 id=使用tls通用名称>使用TLS通用名称</h3><ul><li>从etcd v3.2版本开始，如果etcd服务器以<code>--client-cert-auth=true</code>选项启动，客户端TLS证书中的通用名称（CN）字段将被用作etcd用户。</li><li>在这种情况下，通用名称用于身份验证用户，客户端不需要密码。</li><li>如果客户端同时提供了<code>--client-cert-auth=true</code>和CN，以及用户名和密码，那么基于用户名和密码的身份验证将被优先考虑。</li><li>此功能不能与gRPC-proxy和gRPC-gateway一起使用，因为这些工具在处理TLS连接时存在限制。</li></ul><h3 id=关于密码强度的注意事项>关于密码强度的注意事项</h3><ul><li><code>etcdctl</code>和etcd API在创建用户或更新用户密码时不会强制执行特定密码长度。</li><li>管理员有责任执行这些要求。</li><li>为了避免与密码强度相关的安全风险，可以使用基于TLS通用名称的身份验证，以及使用<code>--no-password</code>选项创建的用户。</li></ul><h2 id=四加认证>四、加认证</h2><h3 id=配置证书认证启动>配置证书认证启动</h3><p>单纯的证书认证模式，默认有所有权限，其实是没有开启认证（即没有执行etcdtl auth enable）
看下原文描述：</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ae81ff>As of version v3.2 if an etcd server is launched with the option --client-cert-auth=true, the field of Common Name (CN) in the client’s TLS cert will be used as an etcd user. In this case, the common name authenticates the user and the client does not need a password. Note that if both of 1. --client-cert-auth=true is passed and CN is provided by the client, and 2. username and password are provided by the client, the username and password based authentication is prioritized. Note that this feature cannot be used with gRPC-proxy and gRPC-gateway. This is because gRPC-proxy terminates TLS from its client so all the clients share a cert of the proxy. gRPC-gateway uses a TLS connection internally for transforming HTTP request to gRPC request so it shares the same limitation. Therefore the clients cannot provide their CN to the server correctly. gRPC-proxy will cause an error and stop if a given cert has non empty CN. gRPC-proxy returns an error which indicates that the client has an non empty CN in its cert.</span></span></span></code></pre></div></div><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd --name infra0 --data-dir infra0 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --client-cert-auth --trusted-ca-file<span style=color:#f92672>=</span>/path/to/ca.crt --cert-file<span style=color:#f92672>=</span>/path/to/server.crt --key-file<span style=color:#f92672>=</span>/path/to/server.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --advertise-client-urls https://127.0.0.1:2379 --listen-client-urls https://127.0.0.1:2379
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl --cacert /path/to/ca.crt --cert /path/to/client.crt --key /path/to/client.key <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  -L https://127.0.0.1:2379/v2/keys/foo -XPUT -d value<span style=color:#f92672>=</span>bar -v</span></span></code></pre></div></div><p>根据证书设置RBAC</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>export ETCDCTL_API<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>ENDPOINTS<span style=color:#f92672>=</span>localhost:2379
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> role add root
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> role get root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> user add root
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> user grant-role root root
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> user get root
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> role add role0
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> role grant-permission role0 readwrite foo
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> user add user0
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> user grant-role user0 role0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> auth enable
</span></span><span style=display:flex><span><span style=color:#75715e># now all client requests go through auth</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> --user<span style=color:#f92672>=</span>user0:123 put foo bar
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> get foo
</span></span><span style=display:flex><span><span style=color:#75715e># permission denied, user name is empty because the request does not issue an authentication request</span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> --user<span style=color:#f92672>=</span>user0:123 get foo
</span></span><span style=display:flex><span><span style=color:#75715e># user0 can read the key foo</span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>ENDPOINTS<span style=color:#e6db74>}</span> --user<span style=color:#f92672>=</span>user0:123 get foo1</span></span></code></pre></div></div><h3 id=配置账号密码启动即只开启rbac>配置账号密码启动,即只开启RBAC</h3><p>使用 <code>bitnami/etcd:3.5.4</code> 的镜像</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: StatefulSet
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: etcd
</span></span><span style=display:flex><span>  name: etcd
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  revisionHistoryLimit: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: etcd
</span></span><span style=display:flex><span>  serviceName: etcd-headless
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: etcd
</span></span><span style=display:flex><span>      name: etcd
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - env:
</span></span><span style=display:flex><span>        - name: ETCD_AUTO_COMPACTION_MODE
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;revision&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_AUTO_COMPACTION_RETENTION
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;1000&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_QUOTA_BACKEND_BYTES
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;10240000000&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_ROOT_PASSWORD
</span></span><span style=display:flex><span>          value: xxx
</span></span><span style=display:flex><span>        - name: MY_POD_NAME
</span></span><span style=display:flex><span>          valueFrom:
</span></span><span style=display:flex><span>            fieldRef:
</span></span><span style=display:flex><span>              apiVersion: v1
</span></span><span style=display:flex><span>              fieldPath: metadata.name
</span></span><span style=display:flex><span>        - name: CLUSTER_NAMESPACE
</span></span><span style=display:flex><span>          valueFrom:
</span></span><span style=display:flex><span>            fieldRef:
</span></span><span style=display:flex><span>              apiVersion: v1
</span></span><span style=display:flex><span>              fieldPath: metadata.namespace
</span></span><span style=display:flex><span>        - name: SERVICE_NAME
</span></span><span style=display:flex><span>          value: etcd-headless
</span></span><span style=display:flex><span>        image: bitnami/etcd:3.5.4
</span></span><span style=display:flex><span>        imagePullPolicy: IfNotPresent
</span></span><span style=display:flex><span>        name: etcd
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>2380</span>
</span></span><span style=display:flex><span>          name: peer
</span></span><span style=display:flex><span>          protocol: TCP
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>2379</span>
</span></span><span style=display:flex><span>          name: client
</span></span><span style=display:flex><span>          protocol: TCP
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          limits:
</span></span><span style=display:flex><span>            cpu: 500m
</span></span><span style=display:flex><span>            memory: 1Gi
</span></span><span style=display:flex><span>          requests:
</span></span><span style=display:flex><span>            cpu: 500m
</span></span><span style=display:flex><span>            memory: 1Gi
</span></span><span style=display:flex><span>        terminationMessagePath: /dev/termination-log
</span></span><span style=display:flex><span>        terminationMessagePolicy: File
</span></span><span style=display:flex><span>        volumeMounts:
</span></span><span style=display:flex><span>        - mountPath: /etc/certs
</span></span><span style=display:flex><span>          name: etcd-tls
</span></span><span style=display:flex><span>        - mountPath: /bitnami/etcd/data
</span></span><span style=display:flex><span>          name: etcd-pvc
</span></span><span style=display:flex><span>      dnsPolicy: ClusterFirst
</span></span><span style=display:flex><span>      restartPolicy: Always
</span></span><span style=display:flex><span>      schedulerName: default-scheduler
</span></span><span style=display:flex><span>      securityContext: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>      terminationGracePeriodSeconds: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>      volumes:
</span></span><span style=display:flex><span>      - name: etcd-tls
</span></span><span style=display:flex><span>        secret:
</span></span><span style=display:flex><span>          secretName: etcd-secret
</span></span><span style=display:flex><span>      - name: etcd-pvc
</span></span><span style=display:flex><span>        emptyDir: <span style=color:#f92672>{}</span></span></span></code></pre></div></div><h3 id=配置证书认证开启rbac>配置证书认证+开启RBAC</h3><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>apiVersion: apps/v1
</span></span><span style=display:flex><span>kind: StatefulSet
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app: etcd
</span></span><span style=display:flex><span>  name: etcd
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  replicas: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  revisionHistoryLimit: <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>  selector:
</span></span><span style=display:flex><span>    matchLabels:
</span></span><span style=display:flex><span>      app: etcd
</span></span><span style=display:flex><span>  serviceName: etcd-headless
</span></span><span style=display:flex><span>  template:
</span></span><span style=display:flex><span>    metadata:
</span></span><span style=display:flex><span>      labels:
</span></span><span style=display:flex><span>        app: etcd
</span></span><span style=display:flex><span>      name: etcd
</span></span><span style=display:flex><span>    spec:
</span></span><span style=display:flex><span>      containers:
</span></span><span style=display:flex><span>      - env:
</span></span><span style=display:flex><span>        - name: ETCD_CLIENT_CERT_AUTH
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_TRUSTED_CA_FILE
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;/etc/certs/ca.pem&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_CERT_FILE
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;/etc/certs/etcd.pem&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_KEY_FILE
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;/etc/certs/etcd-key.pem&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_AUTO_COMPACTION_MODE
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;revision&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_AUTO_COMPACTION_RETENTION
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;1000&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_QUOTA_BACKEND_BYTES
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;10240000000&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_ROOT_PASSWORD
</span></span><span style=display:flex><span>          value: xxx
</span></span><span style=display:flex><span>        - name: ETCD_LISTEN_CLIENT_URLS
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;https://0.0.0.0:2379&#34;</span>
</span></span><span style=display:flex><span>        - name: ETCD_ADVERTISE_CLIENT_URLS
</span></span><span style=display:flex><span>          value: <span style=color:#e6db74>&#34;https://0.0.0.0:2379&#34;</span>
</span></span><span style=display:flex><span>        - name: MY_POD_NAME
</span></span><span style=display:flex><span>          valueFrom:
</span></span><span style=display:flex><span>            fieldRef:
</span></span><span style=display:flex><span>              apiVersion: v1
</span></span><span style=display:flex><span>              fieldPath: metadata.name
</span></span><span style=display:flex><span>        - name: CLUSTER_NAMESPACE
</span></span><span style=display:flex><span>          valueFrom:
</span></span><span style=display:flex><span>            fieldRef:
</span></span><span style=display:flex><span>              apiVersion: v1
</span></span><span style=display:flex><span>              fieldPath: metadata.namespace
</span></span><span style=display:flex><span>        - name: SERVICE_NAME
</span></span><span style=display:flex><span>          value: etcd-headless
</span></span><span style=display:flex><span>        image: bitnami/etcd:3.5.4
</span></span><span style=display:flex><span>        imagePullPolicy: IfNotPresent
</span></span><span style=display:flex><span>        name: etcd
</span></span><span style=display:flex><span>        ports:
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>2380</span>
</span></span><span style=display:flex><span>          name: peer
</span></span><span style=display:flex><span>          protocol: TCP
</span></span><span style=display:flex><span>        - containerPort: <span style=color:#ae81ff>2379</span>
</span></span><span style=display:flex><span>          name: client
</span></span><span style=display:flex><span>          protocol: TCP
</span></span><span style=display:flex><span>        resources:
</span></span><span style=display:flex><span>          limits:
</span></span><span style=display:flex><span>            cpu: 500m
</span></span><span style=display:flex><span>            memory: 1Gi
</span></span><span style=display:flex><span>          requests:
</span></span><span style=display:flex><span>            cpu: 500m
</span></span><span style=display:flex><span>            memory: 1Gi
</span></span><span style=display:flex><span>        terminationMessagePath: /dev/termination-log
</span></span><span style=display:flex><span>        terminationMessagePolicy: File
</span></span><span style=display:flex><span>        volumeMounts:
</span></span><span style=display:flex><span>        - mountPath: /etc/certs
</span></span><span style=display:flex><span>          name: etcd-tls
</span></span><span style=display:flex><span>        - mountPath: /bitnami/etcd/data
</span></span><span style=display:flex><span>          name: etcd-pvc
</span></span><span style=display:flex><span>      dnsPolicy: ClusterFirst
</span></span><span style=display:flex><span>      restartPolicy: Always
</span></span><span style=display:flex><span>      schedulerName: default-scheduler
</span></span><span style=display:flex><span>      securityContext: <span style=color:#f92672>{}</span>
</span></span><span style=display:flex><span>      terminationGracePeriodSeconds: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>      volumes:
</span></span><span style=display:flex><span>      - name: etcd-tls
</span></span><span style=display:flex><span>        secret:
</span></span><span style=display:flex><span>          secretName: etcd-secret
</span></span><span style=display:flex><span>      - name: etcd-pvc
</span></span><span style=display:flex><span>        emptyDir: <span style=color:#f92672>{}</span></span></span></code></pre></div></div><h2 id=五引用>五、引用</h2><p><a href=https://etcd.io/docs/v3.6/op-guide/configuration/>etcd</a></p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>yesplease</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2024-03-28</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=http://localhost:1313/tags/kubernetes/>kubernetes</a>
<a href=http://localhost:1313/tags/etcd/>etcd</a></div><nav class=post-nav><a class=next href=/post/devops/series-cfssh-1/><span class="next-text nav-default">cfssh, Q&amp;A</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><aside class=right-sidebar></aside></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:cugbtang@sina.com rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/cugbtang rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2017 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>yesplease</span></span></div></footer><script type=text/javascript src=/js/main.002d1a80e7bd914cb4592a8c6486c23920f3d9827531bd1c79b3b5716dcf0bd5.js integrity="sha256-AC0agOe9kUy0WSqMZIbCOSDz2YJ1Mb0cebO1cW3PC9U=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>