<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Container, how to play? - ✌yesplease's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.152.2"><link rel=canonical href=http://localhost:1313/post/container/series-container-1/><meta name=author content="yesplease"><meta name=description content="container technology become a necessary for developer during operating the linux system."><meta name=keywords content="docker,namespace"><meta property="og:url" content="http://localhost:1313/post/container/series-container-1/"><meta property="og:site_name" content="✌yesplease's blog"><meta property="og:title" content="Container, how to play?"><meta property="og:description" content="container technology become a necessary for developer during operating the linux system."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-06-01T16:01:23+08:00"><meta property="article:modified_time" content="2022-06-01T16:01:23+08:00"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Namespace"><meta itemprop=name content="Container, how to play?"><meta itemprop=description content="container technology become a necessary for developer during operating the linux system."><meta itemprop=datePublished content="2022-06-01T16:01:23+08:00"><meta itemprop=dateModified content="2022-06-01T16:01:23+08:00"><meta itemprop=wordCount content="2738"><meta itemprop=keywords content="Docker,Namespace"><meta name=twitter:card content="summary"><meta name=twitter:title content="Container, how to play?"><meta name=twitter:description content="container technology become a necessary for developer during operating the linux system."><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.e7c52960f769ac11bea62d460dc48cd995591740192e6c6f8c0f5585fb135c9d.css integrity="sha256-58UpYPdprBG+pi1GDcSM2ZVZF0AZLmxvjA9VhfsTXJ0=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>✌yesplease</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>✌yesplease</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=left-sidebar><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#一namespace>一、namespace</a><ul><li><a href=#11mount-namespace>1.1、Mount Namespace</a></li><li><a href=#12pid-namespace>1.2、PID Namespace</a></li><li><a href=#13uts-namespace>1.3、UTS Namespace</a></li><li><a href=#14ipc-namespace>1.4、IPC Namespace</a></li><li><a href=#15user-namespace>1.5、User Namespace</a></li><li><a href=#16net-namespace>1.6、Net Namespace</a></li><li><a href=#17为什么-docker-需要-namespace>1.7、为什么 docker 需要 namespace?</a></li></ul></li><li><a href=#二cgroups>二、Cgroups</a><ul><li><a href=#21subsystem>2.1、subsystem</a></li></ul></li><li><a href=#三联合文件系统>三、联合文件系统</a></li></ul></nav></div></nav></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Container, how to play?</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>yesplease</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2022-06-01>2022-06-01</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=http://localhost:1313/categories/container/>container</a>
<a href=http://localhost:1313/categories/linux/>linux</a></div></div></div></header><div class=post-content><h1 id=container-technology-become-a-necessary-for-developer-during-operating-the-linux-system>container technology become a necessary for developer during operating the linux system.</h1><h2 id=一namespace>一、namespace</h2><ul><li><p>定义</p><p>namespace是 Linux 内核的一项功能，该功能对内核资源进行分区，以使一组进程看到一组资源，而另一组进程看到另一组资源。namespace 的工作方式通过为一组资源和进程设置相同的 namespace 而起作用，但是这些 namespace 引用了不同的资源。资源可能存在于多个 namespace 中。这些资源可以是进程ID、主机名、用户ID、文件名、与网络访问相关的名称和进程间通信。</p></li><li><p>特征</p><p>可以实现在同一主机系统中对进程ID、主机名、用户名ID、文件名、网络和进程间通信等资源的隔离。</p></li><li><p>类型</p></li></ul><table><thead><tr><th style=text-align:center>namespace</th><th style=text-align:center>summary</th><th style=text-align:center>kernel</th><th>describe</th></tr></thead><tbody><tr><td style=text-align:center>Mount(mnt)</td><td style=text-align:center>隔离挂载点</td><td style=text-align:center>2.4.19</td><td>隔离不同的进程或进程组看到的挂载点，实现容器内只能看到自己的挂在信息，在容器内的挂载操作不会影响主机的挂载目录</td></tr><tr><td style=text-align:center>Process ID(pid)</td><td style=text-align:center>隔离进程 ID</td><td style=text-align:center>2.6.24</td><td></td></tr><tr><td style=text-align:center>Network(net)</td><td style=text-align:center>隔离网络设备，端口号等</td><td style=text-align:center>2.6.29</td><td></td></tr><tr><td style=text-align:center>Interprocess Communication(ipc)</td><td style=text-align:center>隔离 System VIPC 和 POSIX message queues</td><td style=text-align:center>2.6.19</td><td></td></tr><tr><td style=text-align:center>UTS Namespace(uts)</td><td style=text-align:center>隔离主机名和域名</td><td style=text-align:center>2.6.19</td><td></td></tr><tr><td style=text-align:center>User Namespace(user)</td><td style=text-align:center>隔离用户和用户组</td><td style=text-align:center>3.8</td><td></td></tr><tr><td style=text-align:center>Control group(cgroup) Namespce</td><td style=text-align:center>隔离 Cgroups 根目录</td><td style=text-align:center>4.6</td><td></td></tr><tr><td style=text-align:center>Time Namespace</td><td style=text-align:center>隔离系统时间</td><td style=text-align:center>5.6</td><td></td></tr></tbody></table><h3 id=11mount-namespace>1.1、Mount Namespace</h3><p>使用 unshare 命令可以新建 Mount Namespace，并且在新建的 Mount Namespace 内 mount 是和外部完全隔离的。</p><ul><li><p>创建一个bash 进程并且新建一个 Mount Namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@localhost ~<span style=color:#f92672>]</span>$ sudo unshare --mount --fork /bin/bash
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>验证在独立的 namespce 内挂载文件，不影响别的</p><p>在 /tmp 目录下创建一个目录</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /tmp/tmpfs</span></span></span></code></pre></div></div></li><li><p>使用 mount 命令挂载一个 tmpfs 类型的目录</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># mount -t tmpfs -o size=20m tmpfs /tmp/tmpfs</span></span></span></code></pre></div></div></li><li><p>使用 df 命令查看已经挂载的目录信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># df -h</span>
</span></span><span style=display:flex><span>Filesystem                                                                          Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>/dev/sda1                                                                            40G  3.8G   37G  10% /
</span></span><span style=display:flex><span>devtmpfs                                                                            457M     <span style=color:#ae81ff>0</span>  457M   0% /dev
</span></span><span style=display:flex><span>tmpfs                                                                               464M     <span style=color:#ae81ff>0</span>  464M   0% /dev/shm
</span></span><span style=display:flex><span>tmpfs                                                                               464M     <span style=color:#ae81ff>0</span>  464M   0% /sys/fs/cgroup
</span></span><span style=display:flex><span>tmpfs                                                                               464M   13M  451M   3% /run
</span></span><span style=display:flex><span>tmpfs                                                                                93M     <span style=color:#ae81ff>0</span>   93M   0% /run/user/1000
</span></span><span style=display:flex><span>//172.29.0.1/vgt-2469b42ebff188de622646551002b263-6ad5fdbcbf2eaa93bd62f92333a2e6e5  466G  171G  295G  37% /vagrant
</span></span><span style=display:flex><span>tmpfs                                                                                20M     <span style=color:#ae81ff>0</span>   20M   0% /tmp/tmpfs</span></span></code></pre></div></div></li><li><p>新打开一个命令窗口，执行 df 命令查看主机的挂载信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@localhost ~<span style=color:#f92672>]</span>$ df -h
</span></span><span style=display:flex><span>Filesystem                                                                          Size  Used Avail Use% Mounted on
</span></span><span style=display:flex><span>devtmpfs                                                                            457M     <span style=color:#ae81ff>0</span>  457M   0% /dev
</span></span><span style=display:flex><span>tmpfs                                                                               464M     <span style=color:#ae81ff>0</span>  464M   0% /dev/shm
</span></span><span style=display:flex><span>tmpfs                                                                               464M   13M  451M   3% /run
</span></span><span style=display:flex><span>tmpfs                                                                               464M     <span style=color:#ae81ff>0</span>  464M   0% /sys/fs/cgroup
</span></span><span style=display:flex><span>/dev/sda1                                                                            40G  3.8G   37G  10% /
</span></span><span style=display:flex><span>//172.29.0.1/vgt-2469b42ebff188de622646551002b263-6ad5fdbcbf2eaa93bd62f92333a2e6e5  466G  171G  295G  37% /vagrant
</span></span><span style=display:flex><span>tmpfs                                                                                93M     <span style=color:#ae81ff>0</span>   93M   0% /run/user/1000</span></span></code></pre></div></div></li><li><p>基本验证完毕。接着我们查看新的mount namespace 信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ls -l /proc/self/ns/</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 ipc -&gt; ipc:<span style=color:#f92672>[</span>4026531839<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 mnt -&gt; mnt:<span style=color:#f92672>[</span>4026532117<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 net -&gt; net:<span style=color:#f92672>[</span>4026531956<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 pid -&gt; pid:<span style=color:#f92672>[</span>4026531836<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 user -&gt; user:<span style=color:#f92672>[</span>4026531837<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:56 uts -&gt; uts:<span style=color:#f92672>[</span>4026531838<span style=color:#f92672>]</span></span></span></code></pre></div></div></li><li><p>新打开一个命令窗口，使用相同的命令查看主机上的 namespace 信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@localhost ~<span style=color:#f92672>]</span>$ ls -l /proc/self/ns/
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 ipc -&gt; ipc:<span style=color:#f92672>[</span>4026531839<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 mnt -&gt; mnt:<span style=color:#f92672>[</span>4026531840<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 net -&gt; net:<span style=color:#f92672>[</span>4026531956<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 pid -&gt; pid:<span style=color:#f92672>[</span>4026531836<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 user -&gt; user:<span style=color:#f92672>[</span>4026531837<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>lrwxrwxrwx. <span style=color:#ae81ff>1</span> vagrant vagrant <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 09:57 uts -&gt; uts:<span style=color:#f92672>[</span>4026531838<span style=color:#f92672>]</span></span></span></code></pre></div></div></li></ul><h3 id=12pid-namespace>1.2、PID Namespace</h3><blockquote><p>用来隔离进程，在不同的namespace内可以拥有相同的进程号</p></blockquote><ul><li><p>创建一个 bash 进程，并且新建一个 PID Namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@localhost ~<span style=color:#f92672>]</span>$ sudo unshare --pid --fork --mount-proc /bin/bash
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>在当前的命令行窗口使用 ps aux 命令查看进程信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ps aux</span>
</span></span><span style=display:flex><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style=display:flex><span>root         <span style=color:#ae81ff>1</span>  0.0  0.2  <span style=color:#ae81ff>15792</span>  <span style=color:#ae81ff>2616</span> pts/3    S    13:59   0:00 /bin/bash
</span></span><span style=display:flex><span>root        <span style=color:#ae81ff>16</span>  0.0  0.1  <span style=color:#ae81ff>55192</span>  <span style=color:#ae81ff>1844</span> pts/3    R+   14:02   0:00 ps aux</span></span></code></pre></div></div></li></ul><h3 id=13uts-namespace>1.3、UTS Namespace</h3><blockquote><p>它允许每个UTS Namespace 拥有一个独立的主机名</p></blockquote><ul><li><p>使用 unshare 命令创建一个 UTS Namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@localhost ~<span style=color:#f92672>]</span>$ sudo unshare --uts --fork /bin/bash
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>使用 hostname 命令设置主机</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># hostname -b docker</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># hostname</span>
</span></span><span style=display:flex><span>docker</span></span></code></pre></div></div></li><li><p>新打开一个命令行窗口，使用相同的命令查看主机的hostname</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@localhost vagrant<span style=color:#f92672>]</span><span style=color:#75715e># localhost</span></span></span></code></pre></div></div></li></ul><h3 id=14ipc-namespace>1.4、IPC Namespace</h3><blockquote><p>主要用来隔离进程间通信的。PID Namespace 和 IPC Namespace一起使用可以实现同一 IPC Namespace 内的进程彼此可以通信，不同 IPC Namespace 的进程却不能通信。</p></blockquote><ul><li><p>使用 unshare 命令创建一个 IPC Namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ sudo unshare --ipc --fork /bin/bash</span></span></code></pre></div></div></li><li><p>另起一个窗口，查看系统的通信进程</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ ipcs -q
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ Message Queues --------
</span></span><span style=display:flex><span>key        msqid      owner      perms      used-bytes   messages</span></span></code></pre></div></div></li><li><p>在新的ipc namespace下新建一个进程通信队列</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@docker vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ipcmk -Q</span>
</span></span><span style=display:flex><span>Message queue id: <span style=color:#ae81ff>0</span></span></span></code></pre></div></div></li><li><p>查看当前ipc namespace 下的系统通信队列列表</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@docker vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ipcs -q</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ Message Queues --------
</span></span><span style=display:flex><span>key        msqid      owner      perms      used-bytes   messages
</span></span><span style=display:flex><span>0x2ae315e9 <span style=color:#ae81ff>0</span>          root       <span style=color:#ae81ff>644</span>        <span style=color:#ae81ff>0</span>            <span style=color:#ae81ff>0</span></span></span></code></pre></div></div></li><li><p>再次查看主机的系统通信队列</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ ipcs -q
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>------ Message Queues --------
</span></span><span style=display:flex><span>key        msqid      owner      perms      used-bytes   messages</span></span></code></pre></div></div></li></ul><h3 id=15user-namespace>1.5、User Namespace</h3><blockquote><p>主要用来隔离用户和用户组。可以实现进程在容器内拥有 root 权限， 而在主机上却只是普通用户。</p></blockquote><ul><li><p>以普通用户的身份创建一个 User Namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ unshare --user --fork /bin/bash
</span></span><span style=display:flex><span>unshare: unshare failed: Invalid argument
</span></span><span style=display:flex><span><span style=color:#75715e># 查看内核版本</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ uname -a
</span></span><span style=display:flex><span>Linux docker 3.10.0-1127.el7.x86_64 <span style=color:#75715e>#1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查阅资料</span>
</span></span><span style=display:flex><span><span style=color:#75715e># max_user_namespaces文件记录了允许创建的user namespace数量，我的CentOS 7.5默认是0，修改之</span>
</span></span><span style=display:flex><span>echo <span style=color:#ae81ff>2147483647</span> &gt; /proc/sys/user/max_user_namespaces
</span></span><span style=display:flex><span><span style=color:#75715e># 再次运行</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ unshare --user -r /bin/bash
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker ~<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>执行 id 命令查看当前的用户信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@docker ~<span style=color:#f92672>]</span><span style=color:#75715e># id</span>
</span></span><span style=display:flex><span>uid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> gid<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span> groups<span style=color:#f92672>=</span>0<span style=color:#f92672>(</span>root<span style=color:#f92672>)</span>,65534<span style=color:#f92672>(</span>nfsnobody<span style=color:#f92672>)</span> context<span style=color:#f92672>=</span>unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023</span></span></code></pre></div></div></li><li><p>在当前窗口执行 reboot 命令</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@docker ~<span style=color:#f92672>]</span><span style=color:#75715e># reboot</span>
</span></span><span style=display:flex><span>Failed to open /dev/initctl: Permission denied
</span></span><span style=display:flex><span>Failed to talk to init daemon.</span></span></code></pre></div></div></li></ul><h3 id=16net-namespace>1.6、Net Namespace</h3><blockquote><p>用来隔离网络设备、IP地址和端口等信息。</p><p>可以让每个进程拥有自己独立的IP地址，端口和网卡信息</p></blockquote><ul><li><p>首先查看主机上的ip 信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ ip a
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noqueue state UNKNOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style=display:flex><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>    inet6 ::1/128 scope host
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc mq state UP group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/ether 00:15:5d:25:01:09 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.29.5.132/20 brd 172.29.15.255 scope global noprefixroute dynamic eth0
</span></span><span style=display:flex><span>       valid_lft 82979sec preferred_lft 82979sec
</span></span><span style=display:flex><span>    inet6 fe80::215:5dff:fe25:109/64 scope link
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever
</span></span><span style=display:flex><span>3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu <span style=color:#ae81ff>1500</span> qdisc noqueue state DOWN group default
</span></span><span style=display:flex><span>    link/ether 02:42:f0:82:11:e0 brd ff:ff:ff:ff:ff:ff
</span></span><span style=display:flex><span>    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0
</span></span><span style=display:flex><span>       valid_lft forever preferred_lft forever</span></span></code></pre></div></div></li><li><p>创建 net namespace</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ sudo unshare --net --fork /bin/bash
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker vagrant<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>使用 ip a命令查看当前namespace的网络信息</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>root@docker vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ip a</span>
</span></span><span style=display:flex><span>1: lo: &lt;LOOPBACK&gt; mtu <span style=color:#ae81ff>65536</span> qdisc noop state DOWN group default qlen <span style=color:#ae81ff>1000</span>
</span></span><span style=display:flex><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span></code></pre></div></div></li></ul><h3 id=17为什么-docker-需要-namespace>1.7、为什么 docker 需要 namespace?</h3><p>Linux 内核从2002年2.4.19版本开始加入了 Mount Namspace</p><p>内核3.8版本加入了 User Namespace 为容器提供了足够的支持功能</p><p>当 docker 新建一个容器时</p><p>会创建这六种 namespace， 然后将容器中的进程加入这些 namespace之中</p><h2 id=二cgroups>二、Cgroups</h2><ul><li><p>定义</p><p>全程是 control groups， 是Linux 内核的一个功能。可以实现限制进程或者进程组的资源（cpu、mem、磁盘IO等）</p></li><li><p>特征</p><p>资源限制：限制资源的使用量</p><p>优先级控制： 不同的组可以有不用的资源使用优先级</p><p>审计：计算控制组的资源使用情况</p><p>控制： 控制进程的挂起或恢复</p></li><li><p>核心</p><p>subsystem: 一个内核的组件，代表一类资源调度控制器</p><p>cgroup： 表示一组进程和一组带有参数的子系统的关联关系</p><p>hierarchy：由一些列的控制组按照树状结构排列组成的子控制组默认拥有父控制组的属性</p></li></ul><h3 id=21subsystem>2.1、subsystem</h3><ul><li><p>查看当前主机使用了哪些子系统</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#f92672>[</span>vagrant@docker ~<span style=color:#f92672>]</span>$ sudo mount -t cgroup
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/systemd type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,xattr,release_agent<span style=color:#f92672>=</span>/usr/lib/systemd/systemd-cgroups-agent,name<span style=color:#f92672>=</span>systemd<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/cpuset type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,cpuset<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/cpu,cpuacct type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,cpuacct,cpu<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/perf_event type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,perf_event<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/blkio type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,blkio<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/memory type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,memory<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/hugetlb type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,hugetlb<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/freezer type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,freezer<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/net_cls,net_prio type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,net_prio,net_cls<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/devices type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,devices<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>cgroup on /sys/fs/cgroup/pids type cgroup <span style=color:#f92672>(</span>rw,nosuid,nodev,noexec,relatime,seclabel,pids<span style=color:#f92672>)</span></span></span></code></pre></div></div></li><li><p>以 cpu 子系统为例，演示 cgroups 如何限制进程的 cpu使用时间</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#在cpu子系统下创建测试文件夹</span>
</span></span><span style=display:flex><span>mkdir /sys/fs/cgroup/cpu/mydocker
</span></span><span style=display:flex><span><span style=color:#75715e>#查看</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker vagrant<span style=color:#f92672>]</span><span style=color:#75715e># ls /sys/fs/cgroup/cpu/mydocker -l</span>
</span></span><span style=display:flex><span>total <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cgroup.clone_children
</span></span><span style=display:flex><span>--w--w--w-. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cgroup.event_control
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cgroup.procs
</span></span><span style=display:flex><span>-r--r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpuacct.stat
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpuacct.usage
</span></span><span style=display:flex><span>-r--r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpuacct.usage_percpu
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.cfs_period_us
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.cfs_quota_us
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.rt_period_us
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.rt_runtime_us
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.shares
</span></span><span style=display:flex><span>-r--r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 cpu.stat
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 notify_on_release
</span></span><span style=display:flex><span>-rw-r--r--. <span style=color:#ae81ff>1</span> root root <span style=color:#ae81ff>0</span> Feb <span style=color:#ae81ff>26</span> 15:15 tasks
</span></span><span style=display:flex><span><span style=color:#75715e># 将当前shell进程加入cgroup</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># echo $$&gt; tasks</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看tasks文件内容</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e>#</span></span></span></code></pre></div></div></li><li><p>mem</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># 在memory子系统下创建cgroup</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># mkdir /sys/fs/cgroup/memory/mydocker</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 查看新建目录中的内容</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># ls</span>
</span></span><span style=display:flex><span>cgroup.clone_children
</span></span><span style=display:flex><span>cgroup.event_control
</span></span><span style=display:flex><span>cgroup.procs
</span></span><span style=display:flex><span>memory.failcnt
</span></span><span style=display:flex><span>memory.force_empty
</span></span><span style=display:flex><span>memory.kmem.failcnt
</span></span><span style=display:flex><span>memory.kmem.limit_in_bytes
</span></span><span style=display:flex><span>memory.kmem.max_usage_in_bytes
</span></span><span style=display:flex><span>memory.kmem.slabinfo
</span></span><span style=display:flex><span>memory.kmem.tcp.failcnt
</span></span><span style=display:flex><span>memory.kmem.tcp.limit_in_bytes
</span></span><span style=display:flex><span>memory.kmem.tcp.max_usage_in_bytes
</span></span><span style=display:flex><span>memory.kmem.tcp.usage_in_bytes
</span></span><span style=display:flex><span>memory.kmem.usage_in_bytes
</span></span><span style=display:flex><span>memory.limit_in_bytes
</span></span><span style=display:flex><span>memory.max_usage_in_bytes
</span></span><span style=display:flex><span>memory.memsw.failcnt
</span></span><span style=display:flex><span>memory.memsw.limit_in_bytes
</span></span><span style=display:flex><span>memory.memsw.max_usage_in_bytes
</span></span><span style=display:flex><span>memory.memsw.usage_in_bytes
</span></span><span style=display:flex><span>memory.move_charge_at_immigrate
</span></span><span style=display:flex><span>memory.numa_stat
</span></span><span style=display:flex><span>memory.oom_control
</span></span><span style=display:flex><span>memory.pressure_level
</span></span><span style=display:flex><span>memory.soft_limit_in_bytes
</span></span><span style=display:flex><span>memory.stat
</span></span><span style=display:flex><span>memory.swappiness
</span></span><span style=display:flex><span>memory.usage_in_bytes
</span></span><span style=display:flex><span>memory.use_hierarchy
</span></span><span style=display:flex><span>notify_on_release
</span></span><span style=display:flex><span>tasks
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 限制内存使用</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># echo 1073741824 &gt; memory.limit_in_bytes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 将当前shell写入tasks内</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># echo $$&gt;tasks</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># cat tasks</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3356</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>3484</span>
</span></span><span style=display:flex><span><span style=color:#75715e># 申请内存，当达到1G时 被杀死</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># memtester 1500M 1</span>
</span></span><span style=display:flex><span>memtester version 4.3.0 <span style=color:#f92672>(</span>64-bit<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> 2001-2012 Charles Cazabon.
</span></span><span style=display:flex><span>Licensed under the GNU General Public License version <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>only<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pagesize is <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>pagesizemask is 0xfffffffffffff000
</span></span><span style=display:flex><span>want 1500MB <span style=color:#f92672>(</span><span style=color:#ae81ff>1572864000</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>got  1500MB <span style=color:#f92672>(</span><span style=color:#ae81ff>1572864000</span> bytes<span style=color:#f92672>)</span>, trying mlock ...Killed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 修改申请大小，完美</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>root@docker mydocker<span style=color:#f92672>]</span><span style=color:#75715e># memtester 500M 1</span>
</span></span><span style=display:flex><span>memtester version 4.3.0 <span style=color:#f92672>(</span>64-bit<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Copyright <span style=color:#f92672>(</span>C<span style=color:#f92672>)</span> 2001-2012 Charles Cazabon.
</span></span><span style=display:flex><span>Licensed under the GNU General Public License version <span style=color:#ae81ff>2</span> <span style=color:#f92672>(</span>only<span style=color:#f92672>)</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pagesize is <span style=color:#ae81ff>4096</span>
</span></span><span style=display:flex><span>pagesizemask is 0xfffffffffffff000
</span></span><span style=display:flex><span>want 500MB <span style=color:#f92672>(</span><span style=color:#ae81ff>524288000</span> bytes<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>got  500MB <span style=color:#f92672>(</span><span style=color:#ae81ff>524288000</span> bytes<span style=color:#f92672>)</span>, trying mlock ...locked.
</span></span><span style=display:flex><span>Loop 1/1:
</span></span><span style=display:flex><span>  Stuck Address       : ok
</span></span><span style=display:flex><span>  Random Value        : ok
</span></span><span style=display:flex><span>  Compare XOR         : ok
</span></span><span style=display:flex><span>  Compare SUB         : ok
</span></span><span style=display:flex><span>  Compare MUL         : ok
</span></span><span style=display:flex><span>  Compare DIV         : ok
</span></span><span style=display:flex><span>  Compare OR          : ok
</span></span><span style=display:flex><span>  Compare AND         : ok
</span></span><span style=display:flex><span>  Sequential Increment: ok
</span></span><span style=display:flex><span>  Solid Bits          : ok
</span></span><span style=display:flex><span>  Block Sequential    : ok
</span></span><span style=display:flex><span>  Checkerboard        : ok
</span></span><span style=display:flex><span>  Bit Spread          : ok</span></span></code></pre></div></div></li><li><p>docker 是如何使用cgroups的？</p><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>docker run -ti -m<span style=color:#f92672>=</span>1g nginx</span></span></code></pre></div></div></li></ul><h2 id=三联合文件系统>三、联合文件系统</h2></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>yesplease</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2022-06-01</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=http://localhost:1313/tags/docker/>docker</a>
<a href=http://localhost:1313/tags/namespace/>namespace</a></div><nav class=post-nav><a class=prev href=/post/kubernetes/series-kubernetes-7/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">flannel vxlan, check sum</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/kubernetes/series-kubernetes-2/><span class="next-text nav-default">kubeadm startup Kubernetes less than v1.20.0 (centos+docker+ipvs+calico)</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><aside class=right-sidebar></aside></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:cugbtang@sina.com rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/cugbtang rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2017 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>yesplease</span></span></div></footer><script type=text/javascript src=/js/main.002d1a80e7bd914cb4592a8c6486c23920f3d9827531bd1c79b3b5716dcf0bd5.js integrity="sha256-AC0agOe9kUy0WSqMZIbCOSDz2YJ1Mb0cebO1cW3PC9U=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>