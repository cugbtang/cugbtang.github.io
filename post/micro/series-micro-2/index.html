<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage data-theme=light><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Go-micro advance, how to play? - âœŒyesplease's blog</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=MobileOptimized content="width"><meta name=HandheldFriendly content="true"><meta name=applicable-device content="pc,mobile"><meta name=color-scheme content="light dark"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=mobile-web-app-capable content="yes"><meta name=generator content="Hugo 0.152.2"><link rel=canonical href=http://localhost:1313/post/micro/series-micro-2/><meta name=author content="yesplease"><meta name=description content="Go Micro é«˜çº§ç‰¹æ€§æ·±åº¦è§£æï¼šä»ç†è®ºåˆ°å®è·µ ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ– åŸç†æ·±åº¦è§£æ Go Micro çš„æœåŠ¡å‘ç°æœºåˆ¶åŸºäºæ³¨å†Œä¸­å¿ƒçš„è®¢é˜…-é€šçŸ¥æ¨¡å¼ï¼Œå®¢æˆ·ç«¯é€šè¿‡ Watcher æœºåˆ¶å®æ—¶æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„å˜åŒ–ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æœåŠ¡å‘ç°çš„åŠ¨æ€æ€§å’Œå®æ—¶æ€§ã€‚
"><meta name=keywords content="go,micro,go-micro"><meta property="og:url" content="http://localhost:1313/post/micro/series-micro-2/"><meta property="og:site_name" content="âœŒyesplease's blog"><meta property="og:title" content="Go-micro advance, how to play?"><meta property="og:description" content="Go Micro é«˜çº§ç‰¹æ€§æ·±åº¦è§£æï¼šä»ç†è®ºåˆ°å®è·µ ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ– åŸç†æ·±åº¦è§£æ Go Micro çš„æœåŠ¡å‘ç°æœºåˆ¶åŸºäºæ³¨å†Œä¸­å¿ƒçš„è®¢é˜…-é€šçŸ¥æ¨¡å¼ï¼Œå®¢æˆ·ç«¯é€šè¿‡ Watcher æœºåˆ¶å®æ—¶æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„å˜åŒ–ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æœåŠ¡å‘ç°çš„åŠ¨æ€æ€§å’Œå®æ—¶æ€§ã€‚"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-09-15T15:44:23+08:00"><meta property="article:modified_time" content="2023-09-15T16:44:23+08:00"><meta property="article:tag" content="Go"><meta property="article:tag" content="Micro"><meta property="article:tag" content="Go-Micro"><meta itemprop=name content="Go-micro advance, how to play?"><meta itemprop=description content="Go Micro é«˜çº§ç‰¹æ€§æ·±åº¦è§£æï¼šä»ç†è®ºåˆ°å®è·µ ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ– åŸç†æ·±åº¦è§£æ Go Micro çš„æœåŠ¡å‘ç°æœºåˆ¶åŸºäºæ³¨å†Œä¸­å¿ƒçš„è®¢é˜…-é€šçŸ¥æ¨¡å¼ï¼Œå®¢æˆ·ç«¯é€šè¿‡ Watcher æœºåˆ¶å®æ—¶æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„å˜åŒ–ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æœåŠ¡å‘ç°çš„åŠ¨æ€æ€§å’Œå®æ—¶æ€§ã€‚"><meta itemprop=datePublished content="2023-09-15T15:44:23+08:00"><meta itemprop=dateModified content="2023-09-15T16:44:23+08:00"><meta itemprop=wordCount content="16514"><meta itemprop=keywords content="Go,Micro,Go-Micro"><meta name=twitter:card content="summary"><meta name=twitter:title content="Go-micro advance, how to play?"><meta name=twitter:description content="Go Micro é«˜çº§ç‰¹æ€§æ·±åº¦è§£æï¼šä»ç†è®ºåˆ°å®è·µ ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ– åŸç†æ·±åº¦è§£æ Go Micro çš„æœåŠ¡å‘ç°æœºåˆ¶åŸºäºæ³¨å†Œä¸­å¿ƒçš„è®¢é˜…-é€šçŸ¥æ¨¡å¼ï¼Œå®¢æˆ·ç«¯é€šè¿‡ Watcher æœºåˆ¶å®æ—¶æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„å˜åŒ–ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æœåŠ¡å‘ç°çš„åŠ¨æ€æ€§å’Œå®æ—¶æ€§ã€‚"><link rel=icon href=/favicon.ico><link rel=stylesheet href=/css/style.min.a0ae63bb9404f735c1a2045deae9e97f06e10118e5ad7befa80df30c5cd7fabc.css integrity="sha256-oK5ju5QE9zXBogRd6unpfwbhARjlrXvvqA3zDFzX+rw=" media=screen crossorigin=anonymous><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><script>(function(){var e=localStorage.getItem("theme")||"light";document.documentElement.setAttribute("data-theme",e)})()</script></head><body><div id=back-to-top></div><header class=site-header><div class=desktop-header><div class=desktop-header-logo><a href=/ class=logo>âœŒyesplease</a></div><nav class=desktop-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div><div class=mobile-header><div id=mobile-navbar class=mobile-navbar><div id=mobile-navbar-icon class=mobile-navbar-icon><svg aria-hidden="true" class="lucide lucide-menu hi-svg-inline icon--menu" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg></div><div class=mobile-navbar-logo><a href=/ class=logo>âœŒyesplease</a></div></div><div id=mobile-menu-close-modal class=mobile-menu-close-modal></div><nav id=mobile-menu class=mobile-menu><ul class=mobile-menu-list><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/>This is Home</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/post/>Archives</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/tags/>Tags</a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/about/>About</a></li><li class=mobile-menu-item><a class="theme-toggle menu-item-link" href=javascript:void(0);><svg aria-hidden="true" class="lucide lucide-sun hi-svg-inline theme-icon-light" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
<svg aria-hidden="true" class="lucide lucide-moon hi-svg-inline theme-icon-dark" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M12 3a6 6 0 009 9 9 9 0 11-9-9z"/></svg></a></li><li class=mobile-menu-item><a class=menu-item-link href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline icon--rss" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></li></ul></nav></div></header><main id=main class="main pico container"><div class=content-wrapper><aside class=left-sidebar><nav class=toc id=toc><div class=toc-title>Table of Contents</div><div class="toc-content custom-scrollbar"><nav id=TableOfContents><ul><li><a href=#-æœåŠ¡å‘ç°å®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ–>ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ–</a><ul><li><a href=#åŸç†æ·±åº¦è§£æ>åŸç†æ·±åº¦è§£æ</a></li><li><a href=#æ ¸å¿ƒå®ç°æœºåˆ¶>æ ¸å¿ƒå®ç°æœºåˆ¶</a></li><li><a href=#é«˜çº§ç‰¹æ€§>é«˜çº§ç‰¹æ€§</a></li><li><a href=#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</a></li></ul></li><li><a href=#-æ³¨å†Œä¸­å¿ƒå¥åº·æ£€æŸ¥æœºåˆ¶æ·±åº¦è§£æ>ğŸ” æ³¨å†Œä¸­å¿ƒå¥åº·æ£€æŸ¥æœºåˆ¶æ·±åº¦è§£æ</a><ul><li><a href=#consul-å¥åº·æ£€æŸ¥æ¶æ„>Consul å¥åº·æ£€æŸ¥æ¶æ„</a></li><li><a href=#é»˜è®¤å¥åº·æ£€æŸ¥æœºåˆ¶è¯¦è§£>é»˜è®¤å¥åº·æ£€æŸ¥æœºåˆ¶è¯¦è§£</a></li><li><a href=#é«˜çº§å¥åº·æ£€æŸ¥ç­–ç•¥>é«˜çº§å¥åº·æ£€æŸ¥ç­–ç•¥</a></li><li><a href=#å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ>å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ</a></li></ul></li><li><a href=#-å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æ·±åº¦è§£æ>âš–ï¸ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æ·±åº¦è§£æ</a><ul><li><a href=#è´Ÿè½½å‡è¡¡æ¶æ„æ¦‚è¿°>è´Ÿè½½å‡è¡¡æ¶æ„æ¦‚è¿°</a></li><li><a href=#æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç­–ç•¥>æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç­–ç•¥</a></li><li><a href=#é«˜çº§è´Ÿè½½å‡è¡¡ç‰¹æ€§>é«˜çº§è´Ÿè½½å‡è¡¡ç‰¹æ€§</a></li><li><a href=#å®¢æˆ·ç«¯é›†æˆç¤ºä¾‹>å®¢æˆ·ç«¯é›†æˆç¤ºä¾‹</a></li></ul></li><li><a href=#-ç›´æ¥è¿æ¥æ¨¡å¼ç»•è¿‡æœåŠ¡å‘ç°çš„ipportç›´è¿>ğŸ¯ ç›´æ¥è¿æ¥æ¨¡å¼ï¼šç»•è¿‡æœåŠ¡å‘ç°çš„IP+Portç›´è¿</a><ul><li><a href=#åœºæ™¯è¯´æ˜>åœºæ™¯è¯´æ˜</a></li><li><a href=#å®ç°æ–¹æ¡ˆ>å®ç°æ–¹æ¡ˆ</a></li><li><a href=#é«˜çº§åº”ç”¨åœºæ™¯>é«˜çº§åº”ç”¨åœºæ™¯</a></li></ul></li><li><a href=#-è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶>âš ï¸ è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶</a><ul><li><a href=#é”™è¯¯å¤„ç†çš„é‡è¦æ€§>é”™è¯¯å¤„ç†çš„é‡è¦æ€§</a></li><li><a href=#è‡ªå®šä¹‰é”™è¯¯ç±»å‹>è‡ªå®šä¹‰é”™è¯¯ç±»å‹</a></li><li><a href=#é«˜çº§é”™è¯¯å¤„ç†ç‰¹æ€§>é«˜çº§é”™è¯¯å¤„ç†ç‰¹æ€§</a></li><li><a href=#æœ€ä½³å®è·µå»ºè®®>æœ€ä½³å®è·µå»ºè®®</a></li></ul></li><li><a href=#æ‰©å±•æ€§>æ‰©å±•æ€§</a></li></ul></nav></div></nav></aside><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Go-micro advance, how to play?</h1><div class=post-meta-list><div class="post-meta-item post-meta-author"><svg aria-hidden="true" class="lucide lucide-user-round-pen hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M2 21a8 8 0 0110.821-7.487"/><path d="M21.378 16.626a1 1 0 00-3.004-3.004l-4.01 4.012a2 2 0 00-.506.854l-.837 2.87a.5.5.0 00.62.62l2.87-.837a2 2 0 00.854-.506z"/><circle cx="10" cy="8" r="5"/></svg>
<a href=/about><span class=post-meta-author-name>yesplease</span></a></div><div class="post-meta-item post-meta-time"><svg aria-hidden="true" class="lucide lucide-calendar-days hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>
<time datetime=2023-09-15>2023-09-15</time></div><div class=post-meta__right><div class="post-meta-item post-meta-category"><a href=http://localhost:1313/categories/go/>go</a>
<a href=http://localhost:1313/categories/micro/>micro</a>
<a href=http://localhost:1313/categories/go-micro/>go-micro</a></div></div></div></header><div class=post-content><h1 id=go-micro-é«˜çº§ç‰¹æ€§æ·±åº¦è§£æä»ç†è®ºåˆ°å®è·µ>Go Micro é«˜çº§ç‰¹æ€§æ·±åº¦è§£æï¼šä»ç†è®ºåˆ°å®è·µ</h1><h2 id=-æœåŠ¡å‘ç°å®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ–>ğŸŒ æœåŠ¡å‘ç°ï¼šå®¢æˆ·ç«¯å¦‚ä½•æ„ŸçŸ¥æœåŠ¡æ³¨å†Œå˜åŒ–</h2><h3 id=åŸç†æ·±åº¦è§£æ>åŸç†æ·±åº¦è§£æ</h3><p>Go Micro çš„æœåŠ¡å‘ç°æœºåˆ¶åŸºäºæ³¨å†Œä¸­å¿ƒçš„<strong>è®¢é˜…-é€šçŸ¥æ¨¡å¼</strong>ï¼Œå®¢æˆ·ç«¯é€šè¿‡ Watcher æœºåˆ¶å®æ—¶æ„ŸçŸ¥æœåŠ¡å®ä¾‹çš„å˜åŒ–ã€‚è¿™ç§æœºåˆ¶ç¡®ä¿äº†æœåŠ¡å‘ç°çš„åŠ¨æ€æ€§å’Œå®æ—¶æ€§ã€‚</p><h3 id=æ ¸å¿ƒå®ç°æœºåˆ¶>æ ¸å¿ƒå®ç°æœºåˆ¶</h3><h4 id=1-watcher-æ¥å£è®¾è®¡>1. <strong>Watcher æ¥å£è®¾è®¡</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Watcher</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¸‹ä¸€ä¸ªæœåŠ¡å˜æ›´äº‹ä»¶</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Next</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åœæ­¢ç›‘å¬</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Result</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æœåŠ¡å®ä¾‹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Service</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ“ä½œç±»å‹ï¼šregister, deregister, update</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Action</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ—¶é—´æˆ³</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timestamp</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=2-æœåŠ¡è®¢é˜…å®Œæ•´å®ç°>2. <strong>æœåŠ¡è®¢é˜…å®Œæ•´å®ç°</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/registry&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/plugins/v4/registry/consul&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceWatcher</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewServiceWatcher</span>(<span style=color:#a6e22e>reg</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ServiceWatcher</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>: <span style=color:#a6e22e>reg</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>services</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç›‘å¬æœåŠ¡å˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>) <span style=color:#a6e22e>WatchService</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»º watcher</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Watch</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>WatchService</span>(<span style=color:#a6e22e>serviceName</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to create watcher: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å¼€å§‹ç›‘å¬æœåŠ¡ %s çš„å˜åŒ–...&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;åœæ­¢ç›‘å¬æœåŠ¡å˜åŒ–&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è·å–ä¸‹ä¸€ä¸ªäº‹ä»¶</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è·å–æœåŠ¡å˜åŒ–äº‹ä»¶å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>2</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å¤„ç†æœåŠ¡å˜åŒ–</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>handleServiceChange</span>(<span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¤„ç†æœåŠ¡å˜åŒ–</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>) <span style=color:#a6e22e>handleServiceChange</span>(<span style=color:#a6e22e>result</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Result</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serviceName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>action</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Action</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>action</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;register&#34;</span>, <span style=color:#e6db74>&#34;update&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœåŠ¡ %s æ³¨å†Œ/æ›´æ–°: %+v&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Nodes</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>serviceName</span>] = []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>{<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Service</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;deregister&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœåŠ¡ %s æ³¨é”€: %+v&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Service</span>.<span style=color:#a6e22e>Nodes</span>)
</span></span><span style=display:flex><span>        delete(<span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœªçŸ¥çš„æœåŠ¡å˜åŒ–åŠ¨ä½œ: %s&#34;</span>, <span style=color:#a6e22e>action</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è·å–å¯ç”¨æœåŠ¡å®ä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>) <span style=color:#a6e22e>GetServiceInstances</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>serviceName</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>services</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodes</span> = append(<span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Nodes</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodes</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»º Consul æ³¨å†Œä¸­å¿ƒ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>consul</span>.<span style=color:#a6e22e>NewRegistry</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Addrs</span>(<span style=color:#e6db74>&#34;127.0.0.1:8500&#34;</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewServiceWatcher</span>(<span style=color:#a6e22e>reg</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºä¸Šä¸‹æ–‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithCancel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¯åŠ¨å¤šä¸ªæœåŠ¡çš„ç›‘å¬</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>string</span>{<span style=color:#e6db74>&#34;user-service&#34;</span>, <span style=color:#e6db74>&#34;order-service&#34;</span>, <span style=color:#e6db74>&#34;payment-service&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>WatchService</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>name</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç›‘å¬æœåŠ¡ %s å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿå®¢æˆ·ç«¯è·å–æœåŠ¡å®ä¾‹</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>instances</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>GetServiceInstances</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœåŠ¡ %s çš„å¯ç”¨å®ä¾‹: %d&#34;</span>, <span style=color:#a6e22e>serviceName</span>, len(<span style=color:#a6e22e>instances</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>instance</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>instances</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;  å®ä¾‹ %d: %s:%d&#34;</span>, <span style=color:#a6e22e>i</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Address</span>, <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Port</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç­‰å¾…ç¨‹åºé€€å‡º</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {}
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=3-äº‹ä»¶é©±åŠ¨ç¼“å­˜æœºåˆ¶>3. <strong>äº‹ä»¶é©±åŠ¨ç¼“å­˜æœºåˆ¶</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceCache</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cache</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watchers</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Watcher</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceCache</span>) <span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>name</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>exists</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>services</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å–</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>services</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¯åŠ¨ç›‘å¬</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>startWatching</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceCache</span>) <span style=color:#a6e22e>startWatching</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>name</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>WatchService</span>(<span style=color:#a6e22e>name</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;åˆ›å»º watcher å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>watchers</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>watcher</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è·å–æœåŠ¡å˜åŒ–äº‹ä»¶å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>result</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceCache</span>) <span style=color:#a6e22e>updateCache</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>result</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Result</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Action</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;register&#34;</span>, <span style=color:#e6db74>&#34;update&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>cache</span>[<span style=color:#a6e22e>name</span>] = []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>{<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Service</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;deregister&#34;</span>:
</span></span><span style=display:flex><span>        delete(<span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>cache</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=é«˜çº§ç‰¹æ€§>é«˜çº§ç‰¹æ€§</h3><h4 id=å¤šçº§ç¼“å­˜ç­–ç•¥><strong>å¤šçº§ç¼“å­˜ç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MultiLevelCache</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>l1Cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LocalCache</span>    <span style=color:#75715e>// æœ¬åœ°å†…å­˜ç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>l2Cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RedisCache</span>    <span style=color:#75715e>// åˆ†å¸ƒå¼Redisç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>l3Cache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RegistryCache</span>  <span style=color:#75715e>// æ³¨å†Œä¸­å¿ƒç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stats</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>CacheStats</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>      <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LocalCache</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>items</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>CacheItem</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ttl</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CacheItem</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>      <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Expiration</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Hits</span>       <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Misses</span>     <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelCache</span>) <span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L1: æœ¬åœ°å†…å­˜ç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l1Cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>serviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL1Hit</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;L1 Cache hit for service: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL1Miss</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L2: Redisç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l2Cache</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å›å¡«L1ç¼“å­˜</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l1Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL2Hit</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;L2 Cache hit for service: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL2Miss</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// L3: æ³¨å†Œä¸­å¿ƒç¼“å­˜</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l3Cache</span>.<span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>serviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å›å¡«L1å’ŒL2ç¼“å­˜</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l1Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l2Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL3Hit</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;L3 Cache hit for service: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>stats</span>.<span style=color:#a6e22e>IncL3Miss</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ErrNotFound</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelCache</span>) <span style=color:#a6e22e>UpdateService</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>services</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŒæ­¥æ›´æ–°æ‰€æœ‰ç¼“å­˜çº§åˆ«</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l1Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l2Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l3Cache</span>.<span style=color:#a6e22e>UpdateService</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Service cache updated: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç¼“å­˜é¢„çƒ­æœºåˆ¶</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelCache</span>) <span style=color:#a6e22e>WarmUp</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceNames</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, len(<span style=color:#a6e22e>serviceNames</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sem</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}, <span style=color:#ae81ff>10</span>) <span style=color:#75715e>// é™åˆ¶å¹¶å‘æ•°</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>serviceNames</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sem</span> <span style=color:#f92672>&lt;-</span> <span style=color:#66d9ef>struct</span>{}{}
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#66d9ef>func</span>() { <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>sem</span> }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l3Cache</span>.<span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;é¢„çƒ­æœåŠ¡ %s å¤±è´¥: %w&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l1Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>5</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>mlc</span>.<span style=color:#a6e22e>l2Cache</span>.<span style=color:#a6e22e>Set</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœåŠ¡ %s é¢„çƒ­å®Œæˆ&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>    close(<span style=color:#a6e22e>errChan</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>errChan</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=æ™ºèƒ½æœåŠ¡è·¯ç”±><strong>æ™ºèƒ½æœåŠ¡è·¯ç”±</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SmartRouter</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span>       <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>loadBalancer</span>   <span style=color:#a6e22e>LoadBalancer</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span> <span style=color:#a6e22e>HealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>router</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>RouterEngine</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>       <span style=color:#f92672>*</span><span style=color:#a6e22e>RouterMetrics</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RouteRule</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ServiceName</span>   <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;service_name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Weight</span>       <span style=color:#66d9ef>int</span>               <span style=color:#e6db74>`json:&#34;weight&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Conditions</span>   []<span style=color:#a6e22e>RouteCondition</span>  <span style=color:#e6db74>`json:&#34;conditions&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Priority</span>     <span style=color:#66d9ef>int</span>               <span style=color:#e6db74>`json:&#34;priority&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>     <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;metadata&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RouteCondition</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Field</span>    <span style=color:#66d9ef>string</span>      <span style=color:#e6db74>`json:&#34;field&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Operator</span> <span style=color:#66d9ef>string</span>      <span style=color:#e6db74>`json:&#34;operator&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Value</span>    <span style=color:#66d9ef>interface</span>{} <span style=color:#e6db74>`json:&#34;value&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartRouter</span>) <span style=color:#a6e22e>SelectService</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>request</span> <span style=color:#66d9ef>interface</span>{}) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–è·¯ç”±è§„åˆ™</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rules</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GetRules</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;è·å–è·¯ç”±è§„åˆ™å¤±è´¥: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¯„ä¼°è·¯ç”±æ¡ä»¶</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>matchedRules</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>evaluateRules</span>(<span style=color:#a6e22e>rules</span>, <span style=color:#a6e22e>request</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>matchedRules</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ²¡æœ‰åŒ¹é…è§„åˆ™ï¼Œä½¿ç”¨é»˜è®¤è´Ÿè½½å‡è¡¡</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>defaultSelect</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¹æ®æƒé‡é€‰æ‹©è§„åˆ™</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selectedRule</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>selectRuleByWeight</span>(<span style=color:#a6e22e>matchedRules</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selectedRule</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>defaultSelect</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åº”ç”¨è·¯ç”±ç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>applyRouteStrategy</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>selectedRule</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartRouter</span>) <span style=color:#a6e22e>evaluateRules</span>(<span style=color:#a6e22e>rules</span> []<span style=color:#a6e22e>RouteRule</span>, <span style=color:#a6e22e>request</span> <span style=color:#66d9ef>interface</span>{}) []<span style=color:#a6e22e>RouteRule</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>matched</span> []<span style=color:#a6e22e>RouteRule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rule</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>rules</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>matchConditions</span>(<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Conditions</span>, <span style=color:#a6e22e>request</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>matched</span> = append(<span style=color:#a6e22e>matched</span>, <span style=color:#a6e22e>rule</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‰ä¼˜å…ˆçº§æ’åº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>matched</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>matched</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Priority</span> &gt; <span style=color:#a6e22e>matched</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>Priority</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>matched</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartRouter</span>) <span style=color:#a6e22e>matchConditions</span>(<span style=color:#a6e22e>conditions</span> []<span style=color:#a6e22e>RouteCondition</span>, <span style=color:#a6e22e>request</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestMap</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>request</span>.(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{})
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>condition</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>conditions</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>requestMap</span>[<span style=color:#a6e22e>condition</span>.<span style=color:#a6e22e>Field</span>]
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>compareValues</span>(<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>condition</span>.<span style=color:#a6e22e>Operator</span>, <span style=color:#a6e22e>condition</span>.<span style=color:#a6e22e>Value</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartRouter</span>) <span style=color:#a6e22e>compareValues</span>(<span style=color:#a6e22e>actual</span>, <span style=color:#a6e22e>operator</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>expected</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>operator</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;equals&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>actual</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>expected</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;not_equals&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>actual</span>) <span style=color:#f92672>!=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>expected</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;contains&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Contains</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>actual</span>), <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>expected</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;in&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expectedList</span>, <span style=color:#a6e22e>ok</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>expected</span>.([]<span style=color:#66d9ef>interface</span>{})
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>ok</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>item</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>expectedList</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>actual</span>) <span style=color:#f92672>==</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%v&#34;</span>, <span style=color:#a6e22e>item</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç°åº¦å‘å¸ƒè·¯ç”±</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartRouter</span>) <span style=color:#a6e22e>CanaryRouting</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>userID</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŸºäºç”¨æˆ·IDçš„ç°åº¦è·¯ç”±</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hash</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fnv</span>.<span style=color:#a6e22e>New32a</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>Write</span>([]byte(<span style=color:#a6e22e>userID</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userHash</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hash</span>.<span style=color:#a6e22e>Sum32</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–ç°åº¦é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>canaryConfig</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>GetCanaryConfig</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>defaultSelect</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—ç°åº¦æ¯”ä¾‹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>:=</span> uint32(<span style=color:#a6e22e>canaryConfig</span>.<span style=color:#a6e22e>Percentage</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>userHash</span><span style=color:#f92672>%</span><span style=color:#ae81ff>100</span> &lt; <span style=color:#a6e22e>threshold</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// èµ°ç°åº¦æœåŠ¡</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>selectServiceByVersion</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>canaryConfig</span>.<span style=color:#a6e22e>CanaryVersion</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// èµ°ç¨³å®šæœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sr</span>.<span style=color:#a6e22e>selectServiceByVersion</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>canaryConfig</span>.<span style=color:#a6e22e>StableVersion</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=æœåŠ¡å¥åº·çŠ¶æ€è¿‡æ»¤><strong>æœåŠ¡å¥åº·çŠ¶æ€è¿‡æ»¤</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>) <span style=color:#a6e22e>GetHealthyInstances</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>serviceName</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>healthyNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Nodes</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>sw</span>.<span style=color:#a6e22e>isNodeHealthy</span>(<span style=color:#a6e22e>node</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>healthyNodes</span> = append(<span style=color:#a6e22e>healthyNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>healthyNodes</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>) <span style=color:#a6e22e>isNodeHealthy</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥èŠ‚ç‚¹å…ƒæ•°æ®ä¸­çš„å¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>health</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Metadata</span>[<span style=color:#e6db74>&#34;health&#34;</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>health</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æœ€è¿‘çš„å¿ƒè·³æ—¶é—´</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastHeartbeat</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Metadata</span>[<span style=color:#e6db74>&#34;last_heartbeat&#34;</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>heartbeatTime</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Parse</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>RFC3339</span>, <span style=color:#a6e22e>lastHeartbeat</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>heartbeatTime</span>) &gt; <span style=color:#ae81ff>30</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤è®¤ä¸ºèŠ‚ç‚¹å¥åº·</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŠ¨æ€å¥åº·æ£€æŸ¥è°ƒåº¦å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthScheduler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>interval</span>     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stopChan</span>     <span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecks</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>HealthCheckFunc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthCheckFunc</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewHealthScheduler</span>(<span style=color:#a6e22e>watcher</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>, <span style=color:#a6e22e>interval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthScheduler</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HealthScheduler</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>watcher</span>:      <span style=color:#a6e22e>watcher</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>interval</span>:     <span style=color:#a6e22e>interval</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>stopChan</span>:     make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{}),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthChecks</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>HealthCheckFunc</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthScheduler</span>) <span style=color:#a6e22e>RegisterHealthCheck</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>checkFunc</span> <span style=color:#a6e22e>HealthCheckFunc</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>healthChecks</span>[<span style=color:#a6e22e>serviceName</span>] = <span style=color:#a6e22e>checkFunc</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthScheduler</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>interval</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span>:
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>performHealthChecks</span>()
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>stopChan</span>:
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthScheduler</span>) <span style=color:#a6e22e>performHealthChecks</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>checkFunc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>healthChecks</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>check</span> <span style=color:#a6e22e>HealthCheckFunc</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>10</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>instances</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>GetServiceInstances</span>(<span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>instance</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>instances</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>healthy</span>, <span style=color:#a6e22e>reason</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>checkFunc</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>instance</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>UpdateHealthStatus</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>healthy</span>, <span style=color:#a6e22e>reason</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>checkFunc</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hs</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthScheduler</span>) <span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>    close(<span style=color:#a6e22e>hs</span>.<span style=color:#a6e22e>stopChan</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ•…éšœèŠ‚ç‚¹è‡ªåŠ¨æ¢å¤æœºåˆ¶</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FailureRecovery</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>watcher</span>          <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>recoveryTimeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxRetries</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>recoveryAttempts</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>              <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFailureRecovery</span>(<span style=color:#a6e22e>watcher</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceWatcher</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#a6e22e>maxRetries</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>FailureRecovery</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>FailureRecovery</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>watcher</span>:          <span style=color:#a6e22e>watcher</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recoveryTimeout</span>:  <span style=color:#a6e22e>timeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxRetries</span>:      <span style=color:#a6e22e>maxRetries</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recoveryAttempts</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>fr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FailureRecovery</span>) <span style=color:#a6e22e>MonitorRecovery</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>attempts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>recoveryAttempts</span>[<span style=color:#a6e22e>serviceName</span><span style=color:#f92672>+</span><span style=color:#a6e22e>nodeID</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>attempts</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>maxRetries</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;èŠ‚ç‚¹ %s-%s å·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œåœæ­¢æ¢å¤å°è¯•&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodeID</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç­‰å¾…æ¢å¤è¶…æ—¶</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>recoveryTimeout</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ¢å¤</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>watcher</span>.<span style=color:#a6e22e>CheckNodeRecovery</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodeID</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>            delete(<span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>recoveryAttempts</span>, <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>+</span><span style=color:#a6e22e>nodeID</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;èŠ‚ç‚¹ %s-%s å·²è‡ªåŠ¨æ¢å¤&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodeID</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®°å½•æ¢å¤å¤±è´¥</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>recoveryAttempts</span>[<span style=color:#a6e22e>serviceName</span><span style=color:#f92672>+</span><span style=color:#a6e22e>nodeID</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç»§ç»­ä¸‹ä¸€æ¬¡æ¢å¤å°è¯•</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fr</span>.<span style=color:#a6e22e>MonitorRecovery</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>nodeID</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=æ€§èƒ½ä¼˜åŒ–ç­–ç•¥>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3><h4 id=è¿æ¥æ± ç®¡ç†><strong>è¿æ¥æ± ç®¡ç†</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ConnectionPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pools</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>connPool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>     <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxConns</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>connPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conns</span>    <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createFn</span> <span style=color:#66d9ef>func</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>, <span style=color:#66d9ef>error</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span>) <span style=color:#a6e22e>GetConnection</span>(<span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pool</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>pools</span>[<span style=color:#a6e22e>address</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pool</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>connPool</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>conns</span>:    make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>, <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>maxConns</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>createFn</span>: <span style=color:#66d9ef>func</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>ClientConn</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>pools</span>[<span style=color:#a6e22e>address</span>] = <span style=color:#a6e22e>pool</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>conn</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>conns</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>conn</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>pool</span>.<span style=color:#a6e22e>createFn</span>()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h2 id=-æ³¨å†Œä¸­å¿ƒå¥åº·æ£€æŸ¥æœºåˆ¶æ·±åº¦è§£æ>ğŸ” æ³¨å†Œä¸­å¿ƒå¥åº·æ£€æŸ¥æœºåˆ¶æ·±åº¦è§£æ</h2><h3 id=consul-å¥åº·æ£€æŸ¥æ¶æ„>Consul å¥åº·æ£€æŸ¥æ¶æ„</h3><p>Consul çš„å¥åº·æ£€æŸ¥æœºåˆ¶æ˜¯å…¶æœåŠ¡å‘ç°ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡ä¸»åŠ¨å’Œè¢«åŠ¨ç›¸ç»“åˆçš„æ–¹å¼ï¼Œç¡®ä¿æœåŠ¡å®ä¾‹çš„å¯ç”¨æ€§èƒ½å¤Ÿè¢«åŠæ—¶å‘ç°ã€‚</p><h3 id=é»˜è®¤å¥åº·æ£€æŸ¥æœºåˆ¶è¯¦è§£>é»˜è®¤å¥åº·æ£€æŸ¥æœºåˆ¶è¯¦è§£</h3><h4 id=http-å¥åº·æ£€æŸ¥é…ç½®><strong>HTTP å¥åº·æ£€æŸ¥é…ç½®</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/registry&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/plugins/v4/registry/consul&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthCheckConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HTTP</span>     <span style=color:#66d9ef>string</span>        <span style=color:#e6db74>`json:&#34;http&#34;`</span>      <span style=color:#75715e>// HTTP æ£€æŸ¥åœ°å€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Interval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;interval&#34;`</span> <span style=color:#75715e>// æ£€æŸ¥é—´éš”</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;timeout&#34;`</span>  <span style=color:#75715e>// è¶…æ—¶æ—¶é—´</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DeregisterCriticalServiceAfter</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;deregister_critical_service_after&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»º Consul æ³¨å†Œä¸­å¿ƒ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>consul</span>.<span style=color:#a6e22e>NewRegistry</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Addrs</span>(<span style=color:#e6db74>&#34;127.0.0.1:8500&#34;</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºæœåŠ¡é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;user-service&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Registry</span>(<span style=color:#a6e22e>reg</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>RegisterTTL</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span><span style=color:#f92672>*</span><span style=color:#ae81ff>30</span>), <span style=color:#75715e>// æœåŠ¡æ³¨å†ŒTTL</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>RegisterInterval</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span><span style=color:#f92672>*</span><span style=color:#ae81ff>15</span>), <span style=color:#75715e>// é‡æ–°æ³¨å†Œé—´éš”</span>
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æœåŠ¡èŠ‚ç‚¹ä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#960050;background-color:#1e0010>Â®</span><span style=color:#a6e22e>istry</span>.<span style=color:#a6e22e>Node</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Id</span>:      <span style=color:#e6db74>&#34;user-service-1&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>: <span style=color:#e6db74>&#34;192.168.1.100&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Port</span>:    <span style=color:#ae81ff>8080</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Metadata</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;health_check_url&#34;</span>: <span style=color:#e6db74>&#34;http://192.168.1.100:8080/health&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;health_check_method&#34;</span>: <span style=color:#e6db74>&#34;GET&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;health_check_interval&#34;</span>: <span style=color:#e6db74>&#34;10s&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;health_check_timeout&#34;</span>: <span style=color:#e6db74>&#34;1s&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œå¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>registerHealthCheck</span>(<span style=color:#a6e22e>reg</span>, <span style=color:#a6e22e>node</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;æ³¨å†Œå¥åº·æ£€æŸ¥å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;æœåŠ¡å·²å¯åŠ¨ï¼Œå¥åº·æ£€æŸ¥å·²æ³¨å†Œ&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ³¨å†Œå¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>registerHealthCheck</span>(<span style=color:#a6e22e>reg</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¥åº·æ£€æŸ¥é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthCheck</span> <span style=color:#f92672>:=</span> <span style=color:#960050;background-color:#1e0010>Â®</span><span style=color:#a6e22e>istry</span>.<span style=color:#a6e22e>HealthCheck</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ID</span>:                            <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-health&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:                          <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-health&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Interval</span>:                       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timeout</span>:                        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>DeregisterCriticalServiceAfter</span>:    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HTTP</span>:                          <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Metadata</span>[<span style=color:#e6db74>&#34;health_check_url&#34;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Method</span>:                         <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Metadata</span>[<span style=color:#e6db74>&#34;health_check_method&#34;</span>],
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†ŒæœåŠ¡æ—¶åŒ…å«å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#960050;background-color:#1e0010>Â®</span><span style=color:#a6e22e>istry</span>.<span style=color:#a6e22e>Service</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:  <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Nodes</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>{<span style=color:#a6e22e>node</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>reg</span>.<span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>RegisterHealthCheck</span>(<span style=color:#a6e22e>healthCheck</span>))
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=å¥åº·æ£€æŸ¥ç«¯ç‚¹å®ç°><strong>å¥åº·æ£€æŸ¥ç«¯ç‚¹å®ç°</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/gorilla/mux&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthStatus</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>    <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;status&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timestamp</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;timestamp&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Version</span>   <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;version&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Uptime</span>    <span style=color:#66d9ef>int64</span>     <span style=color:#e6db74>`json:&#34;uptime&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Memory</span>    <span style=color:#a6e22e>Memory</span>    <span style=color:#e6db74>`json:&#34;memory&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Database</span>  <span style=color:#a6e22e>Database</span>  <span style=color:#e6db74>`json:&#34;database&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Cache</span>     <span style=color:#a6e22e>Cache</span>     <span style=color:#e6db74>`json:&#34;cache&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Memory</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Alloc</span>      <span style=color:#66d9ef>uint64</span> <span style=color:#e6db74>`json:&#34;alloc&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TotalAlloc</span> <span style=color:#66d9ef>uint64</span> <span style=color:#e6db74>`json:&#34;total_alloc&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Sys</span>        <span style=color:#66d9ef>uint64</span> <span style=color:#e6db74>`json:&#34;sys&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>NumGC</span>      <span style=color:#66d9ef>uint32</span> <span style=color:#e6db74>`json:&#34;num_gc&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Database</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;status&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Latency</span>  <span style=color:#66d9ef>int64</span>  <span style=color:#e6db74>`json:&#34;latency_ms&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Cache</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;status&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HitRate</span>  <span style=color:#66d9ef>float64</span> <span style=color:#e6db74>`json:&#34;hit_rate&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>startTime</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mux</span>.<span style=color:#a6e22e>NewRouter</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¥åº·æ£€æŸ¥ç«¯ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/health&#34;</span>, <span style=color:#a6e22e>healthCheckHandler</span>).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/health/ready&#34;</span>, <span style=color:#a6e22e>readinessCheckHandler</span>).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/health/live&#34;</span>, <span style=color:#a6e22e>livenessCheckHandler</span>).<span style=color:#a6e22e>Methods</span>(<span style=color:#e6db74>&#34;GET&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>srv</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Server</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Addr</span>:    <span style=color:#e6db74>&#34;:8080&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Handler</span>: <span style=color:#a6e22e>r</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;æœåŠ¡å¯åŠ¨ï¼Œç›‘å¬ç«¯å£ 8080&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>srv</span>.<span style=color:#a6e22e>ListenAndServe</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŸºç¡€å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>healthCheckHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>m</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>MemStats</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>ReadMemStats</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>HealthStatus</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Status</span>:    <span style=color:#e6db74>&#34;healthy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Version</span>:   <span style=color:#e6db74>&#34;1.0.0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Uptime</span>:    int64(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>).<span style=color:#a6e22e>Seconds</span>()),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Memory</span>: <span style=color:#a6e22e>Memory</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Alloc</span>:      <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Alloc</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>TotalAlloc</span>: <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>TotalAlloc</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Sys</span>:        <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>Sys</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>NumGC</span>:      <span style=color:#a6e22e>m</span>.<span style=color:#a6e22e>NumGC</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Database</span>: <span style=color:#a6e22e>checkDatabase</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Cache</span>:    <span style=color:#a6e22e>checkCache</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¹æ®ç»„ä»¶çŠ¶æ€åˆ¤æ–­æ•´ä½“å¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Database</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;healthy&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Cache</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;healthy&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>status</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å°±ç»ªæ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>readinessCheckHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ä¾èµ–æœåŠ¡æ˜¯å¦å°±ç»ª</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>isDatabaseReady</span>() <span style=color:#f92672>||</span> !<span style=color:#a6e22e>isCacheReady</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;status&#34;</span>:  <span style=color:#e6db74>&#34;not_ready&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#e6db74>&#34;ä¾èµ–æœåŠ¡æœªå°±ç»ª&#34;</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;ready&#34;</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å­˜æ´»æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>livenessCheckHandler</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç®€å•çš„å­˜æ´»æ£€æŸ¥ï¼Œè¿”å›200è¡¨ç¤ºæœåŠ¡å­˜æ´»</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusOK</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;alive&#34;</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkDatabase</span>() <span style=color:#a6e22e>Database</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>start</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿæ•°æ®åº“è¿æ¥æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// err := db.Ping()</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// if err != nil {</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//     return Database{Status: &#34;unhealthy&#34;}</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// }</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latency</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>start</span>).<span style=color:#a6e22e>Milliseconds</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Database</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Status</span>:  <span style=color:#e6db74>&#34;healthy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Latency</span>: <span style=color:#a6e22e>latency</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkCache</span>() <span style=color:#a6e22e>Cache</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿç¼“å­˜è¿æ¥æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Cache</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Status</span>:  <span style=color:#e6db74>&#34;healthy&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>HitRate</span>: <span style=color:#ae81ff>0.95</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>isDatabaseReady</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å°±ç»ª</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>isCacheReady</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ç¼“å­˜æ˜¯å¦å°±ç»ª</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=é«˜çº§å¥åº·æ£€æŸ¥ç­–ç•¥>é«˜çº§å¥åº·æ£€æŸ¥ç­–ç•¥</h3><h4 id=å¤šçº§å¥åº·æ£€æŸ¥><strong>å¤šçº§å¥åº·æ£€æŸ¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthChecker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checks</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>CheckFunc</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>     <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CheckFunc</span> <span style=color:#66d9ef>func</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewHealthChecker</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthChecker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HealthChecker</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>checks</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>CheckFunc</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ³¨å†Œæ£€æŸ¥é¡¹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthChecker</span>) <span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>check</span> <span style=color:#a6e22e>CheckFunc</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>checks</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#a6e22e>check</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthChecker</span>) <span style=color:#a6e22e>RunChecks</span>() <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>check</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>checks</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>healthy</span>, <span style=color:#a6e22e>reason</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>check</span>(); <span style=color:#a6e22e>healthy</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>status</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>status</span>[<span style=color:#a6e22e>name</span>] = <span style=color:#e6db74>&#34;unhealthy: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>reason</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>status</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è·å–æ•´ä½“çŠ¶æ€</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthChecker</span>) <span style=color:#a6e22e>GetOverallStatus</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>status</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;healthy&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewHealthChecker</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ³¨å†Œå„ç§æ£€æŸ¥é¡¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#e6db74>&#34;database&#34;</span>, <span style=color:#a6e22e>checkDatabaseConnection</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#e6db74>&#34;cache&#34;</span>, <span style=color:#a6e22e>checkCacheConnection</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#e6db74>&#34;external_api&#34;</span>, <span style=color:#a6e22e>checkExternalAPI</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#e6db74>&#34;disk_space&#34;</span>, <span style=color:#a6e22e>checkDiskSpace</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RegisterCheck</span>(<span style=color:#e6db74>&#34;memory_usage&#34;</span>, <span style=color:#a6e22e>checkMemoryUsage</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RunChecks</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>GetOverallStatus</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å¥åº·æ£€æŸ¥ç»“æœ: %+v&#34;</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ•´ä½“çŠ¶æ€: %s&#34;</span>, <span style=color:#a6e22e>overallStatus</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// å¦‚æœçŠ¶æ€ä¸å¥åº·ï¼Œå¯ä»¥è§¦å‘å‘Šè­¦</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;unhealthy&#34;</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>triggerAlert</span>(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkDatabaseConnection</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®ç°æ•°æ®åº“è¿æ¥æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkCacheConnection</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®ç°ç¼“å­˜è¿æ¥æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkExternalAPI</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®ç°å¤–éƒ¨APIæ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkDiskSpace</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®ç°ç£ç›˜ç©ºé—´æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>checkMemoryUsage</span>() (<span style=color:#66d9ef>bool</span>, <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å®ç°å†…å­˜ä½¿ç”¨æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>triggerAlert</span>(<span style=color:#a6e22e>results</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è§¦å‘å‘Šè­¦é€»è¾‘</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç³»ç»Ÿå‘Šè­¦: %+v&#34;</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=å¥åº·æ£€æŸ¥ä¸è´Ÿè½½å‡è¡¡é›†æˆ><strong>å¥åº·æ£€æŸ¥ä¸è´Ÿè½½å‡è¡¡é›†æˆ</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthAwareBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registry</span>    <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span>    <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Selector</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthCache</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthCache</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthCache</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewHealthAwareBalancer</span>(<span style=color:#a6e22e>reg</span> <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Registry</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthAwareBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HealthAwareBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registry</span>:    <span style=color:#a6e22e>reg</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>:    <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>NewSelector</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthCache</span>: <span style=color:#a6e22e>NewHealthCache</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hab</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthAwareBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>SelectOption</span>) (<span style=color:#a6e22e>next</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Next</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æœåŠ¡èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hab</span>.<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿‡æ»¤å¥åº·èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>healthyNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>svc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>svc</span>.<span style=color:#a6e22e>Nodes</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>hab</span>.<span style=color:#a6e22e>healthCache</span>.<span style=color:#a6e22e>IsHealthy</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>healthyNodes</span> = append(<span style=color:#a6e22e>healthyNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>healthyNodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;no healthy nodes available for service %s&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä½¿ç”¨é€‰æ‹©å™¨é€‰æ‹©èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>hab</span>.<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hab</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthAwareBalancer</span>) <span style=color:#a6e22e>UpdateHealth</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>healthy</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hab</span>.<span style=color:#a6e22e>healthCache</span>.<span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span>, <span style=color:#a6e22e>healthy</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewHealthCache</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthCache</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HealthCache</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>services</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthCache</span>) <span style=color:#a6e22e>IsHealthy</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>nodes</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>healthy</span>, <span style=color:#a6e22e>nodeExists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#a6e22e>nodeID</span>]; <span style=color:#a6e22e>nodeExists</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>healthy</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤è¿”å›trueï¼Œè®¤ä¸ºæ˜¯å¥åº·çš„</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>hc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthCache</span>) <span style=color:#a6e22e>Update</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>healthy</span> <span style=color:#66d9ef>bool</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>service</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>service</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>hc</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>] = <span style=color:#a6e22e>healthy</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ>å¥åº·æ£€æŸ¥æœ€ä½³å®è·µ</h3><h4 id=æ™ºèƒ½å¥åº·æ£€æŸ¥ç­–ç•¥><strong>æ™ºèƒ½å¥åº·æ£€æŸ¥ç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AdaptiveHealthChecker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checkers</span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>HealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>thresholds</span>      <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>HealthThreshold</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adaptivePolicy</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptivePolicy</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>              <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthThreshold</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SuccessRate</span>    <span style=color:#66d9ef>float64</span> <span style=color:#e6db74>`json:&#34;success_rate&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Latency</span>        <span style=color:#66d9ef>int64</span>   <span style=color:#e6db74>`json:&#34;latency_ms&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorRate</span>      <span style=color:#66d9ef>float64</span> <span style=color:#e6db74>`json:&#34;error_rate&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConsecutiveFail</span> <span style=color:#66d9ef>int</span>     <span style=color:#e6db74>`json:&#34;consecutive_failures&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AdaptivePolicy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SampleSize</span>       <span style=color:#66d9ef>int</span>           <span style=color:#e6db74>`json:&#34;sample_size&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WindowSize</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;window_size&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GracePeriod</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;grace_period&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RampUpPeriod</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;ramp_up_period&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ahc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveHealthChecker</span>) <span style=color:#a6e22e>EvaluateServiceHealth</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#a6e22e>HealthStatus</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>checker</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>checkers</span>[<span style=color:#a6e22e>serviceName</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>thresholds</span>[<span style=color:#a6e22e>serviceName</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;unknown&#34;</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>GetServiceMetrics</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŸºäºå¤šç»´åº¦æŒ‡æ ‡è¯„ä¼°å¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>status</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>calculateHealthScore</span>(<span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>threshold</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åº”ç”¨è‡ªé€‚åº”ç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adjustedStatus</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>applyAdaptivePolicy</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>status</span>, <span style=color:#a6e22e>metrics</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>adjustedStatus</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ahc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveHealthChecker</span>) <span style=color:#a6e22e>calculateHealthScore</span>(<span style=color:#a6e22e>metrics</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceMetrics</span>, <span style=color:#a6e22e>threshold</span> <span style=color:#a6e22e>HealthThreshold</span>) <span style=color:#a6e22e>HealthStatus</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>100.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æˆåŠŸç‡è¯„åˆ†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SuccessRate</span> &lt; <span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>SuccessRate</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>score</span> <span style=color:#f92672>-=</span> (<span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>SuccessRate</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SuccessRate</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å»¶è¿Ÿè¯„åˆ†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>AvgLatency</span> &gt; <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>Latency</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>latencyRatio</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>AvgLatency</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>Latency</span><span style=color:#f92672>*</span><span style=color:#ae81ff>1000000</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>score</span> <span style=color:#f92672>-=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Min</span>(<span style=color:#a6e22e>latencyRatio</span><span style=color:#f92672>*</span><span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>30</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é”™è¯¯ç‡è¯„åˆ†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ErrorRate</span> &gt; <span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>ErrorRate</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>score</span> <span style=color:#f92672>-=</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ErrorRate</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>ErrorRate</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>50</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿ç»­å¤±è´¥æƒ©ç½š</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ConsecutiveFailures</span> &gt; <span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>ConsecutiveFail</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>score</span> <span style=color:#f92672>-=</span> float64(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ConsecutiveFailures</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>threshold</span>.<span style=color:#a6e22e>ConsecutiveFail</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç¡®å®šå¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>score</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>90</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;healthy&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>score</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>score</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>70</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;degraded&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>score</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>score</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>50</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;warning&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>score</span>}
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;critical&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>score</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ahc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveHealthChecker</span>) <span style=color:#a6e22e>applyAdaptivePolicy</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>status</span> <span style=color:#a6e22e>HealthStatus</span>, <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceMetrics</span>) <span style=color:#a6e22e>HealthStatus</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>policy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ahc</span>.<span style=color:#a6e22e>adaptivePolicy</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡‡æ ·æœŸåˆ¤æ–­</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>TotalRequests</span> &lt; <span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>SampleSize</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;sampling&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Score</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç¼“å­˜æœŸç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>Uptime</span> &lt; <span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>GracePeriod</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;warming&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Score</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æµé‡çªå¢å¤„ç†</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RequestGrowth</span> &gt; <span style=color:#ae81ff>2.0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;critical&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>HealthStatus</span>{<span style=color:#a6e22e>Status</span>: <span style=color:#e6db74>&#34;scaling&#34;</span>, <span style=color:#a6e22e>Score</span>: <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Score</span>}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>status</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥æ¶æ„><strong>å¤šå±‚æ¬¡å¥åº·æ£€æŸ¥æ¶æ„</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>MultiLevelHealthChecker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>networkChecker</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>NetworkHealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>applicationChecker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ApplicationHealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dependencyChecker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DependencyHealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resourceChecker</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>ResourceHealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>coordinator</span>     <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthCoordinator</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthCoordinator</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>levels</span>          <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>HealthLevel</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weights</span>         <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>combinationRule</span>  <span style=color:#66d9ef>string</span> <span style=color:#75715e>// &#34;weighted&#34;, &#34;strict&#34;, &#34;majority&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cascadePolicy</span>   <span style=color:#a6e22e>CascadePolicy</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CascadePolicy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CriticalLevel</span>  <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;critical_level&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Affects</span>        []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;affects&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TriggerTimeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;trigger_timeout&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlhc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelHealthChecker</span>) <span style=color:#a6e22e>GetCompositeHealth</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>CompositeHealthResult</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#ae81ff>15</span><span style=color:#f92672>*</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>wg</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>, <span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¹¶è¡Œæ‰§è¡Œå„å±‚çº§å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Add</span>(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>checkNetworkLevel</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>checkApplicationLevel</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>checkDependencyLevel</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>checkResourceLevel</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>wg</span>, <span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Wait</span>()
</span></span><span style=display:flex><span>        close(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ”¶é›†ç»“æœ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>levelResults</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>results</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>levelResults</span>[<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Level</span>] = <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åè°ƒå„å±‚çº§ç»“æœ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>coordinator</span>.<span style=color:#a6e22e>CoordinateResults</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>levelResults</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ç½‘ç»œå±‚å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlhc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelHealthChecker</span>) <span style=color:#a6e22e>checkNetworkLevel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>results</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LevelHealthResult</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Level</span>:     <span style=color:#e6db74>&#34;network&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TCPè¿æ¥æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>networkChecker</span>.<span style=color:#a6e22e>TCPConnectivity</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;TCPè¿æ¥å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// DNSè§£ææ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>networkChecker</span>.<span style=color:#a6e22e>DNSResolution</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;degraded&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;DNSè§£æå¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¸¦å®½æµ‹è¯•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bandwidth</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>networkChecker</span>.<span style=color:#a6e22e>BandwidthTest</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;bandwidth_mbps&#34;</span>: <span style=color:#a6e22e>bandwidth</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åº”ç”¨å±‚å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlhc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelHealthChecker</span>) <span style=color:#a6e22e>checkApplicationLevel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>results</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LevelHealthResult</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Level</span>:     <span style=color:#e6db74>&#34;application&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// HTTPå¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>httpStatus</span>, <span style=color:#a6e22e>latency</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>applicationChecker</span>.<span style=color:#a6e22e>HTTPHealthCheck</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;HTTPå¥åº·æ£€æŸ¥å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åº”ç”¨æŒ‡æ ‡æ”¶é›†</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>applicationChecker</span>.<span style=color:#a6e22e>GetApplicationMetrics</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;degraded&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;åº”ç”¨æŒ‡æ ‡æ”¶é›†å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>evaluateApplicationHealth</span>(<span style=color:#a6e22e>httpStatus</span>, <span style=color:#a6e22e>metrics</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span> = <span style=color:#a6e22e>metrics</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span>[<span style=color:#e6db74>&#34;http_status&#34;</span>] = <span style=color:#a6e22e>httpStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span>[<span style=color:#e6db74>&#34;latency_ms&#34;</span>] = <span style=color:#a6e22e>latency</span>.<span style=color:#a6e22e>Milliseconds</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¾èµ–å±‚å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlhc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelHealthChecker</span>) <span style=color:#a6e22e>checkDependencyLevel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>results</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LevelHealthResult</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Level</span>:     <span style=color:#e6db74>&#34;dependency&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dependencies</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>dependencyChecker</span>.<span style=color:#a6e22e>GetDependencies</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;è·å–ä¾èµ–åˆ—è¡¨å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>healthyCount</span>, <span style=color:#a6e22e>totalCount</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dependencyStatus</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>dep</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>dependencies</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>depHealth</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>dependencyChecker</span>.<span style=color:#a6e22e>CheckDependencyHealth</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dep</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dependencyStatus</span>[<span style=color:#a6e22e>dep</span>.<span style=color:#a6e22e>Name</span>] = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;status&#34;</span>: <span style=color:#e6db74>&#34;unhealthy&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;error&#34;</span>:  <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(),
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>dependencyStatus</span>[<span style=color:#a6e22e>dep</span>.<span style=color:#a6e22e>Name</span>] = <span style=color:#a6e22e>depHealth</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>depHealth</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>healthyCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>totalCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>totalCount</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthRatio</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>healthyCount</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>totalCount</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>healthRatio</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0.9</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>healthRatio</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0.7</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;degraded&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>healthRatio</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0.5</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;warning&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;dependencies&#34;</span>: <span style=color:#a6e22e>dependencyStatus</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;healthy_ratio&#34;</span>:  float64(<span style=color:#a6e22e>healthyCount</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>totalCount</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// èµ„æºå±‚å¥åº·æ£€æŸ¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>mlhc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>MultiLevelHealthChecker</span>) <span style=color:#a6e22e>checkResourceLevel</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>wg</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>WaitGroup</span>, <span style=color:#a6e22e>results</span> <span style=color:#66d9ef>chan</span><span style=color:#f92672>&lt;-</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LevelHealthResult</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>wg</span>.<span style=color:#a6e22e>Done</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LevelHealthResult</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Level</span>:     <span style=color:#e6db74>&#34;resource&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// CPUä½¿ç”¨ç‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cpuUsage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>resourceChecker</span>.<span style=color:#a6e22e>GetCPUUsage</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;CPUä½¿ç”¨ç‡è·å–å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å†…å­˜ä½¿ç”¨ç‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memUsage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>resourceChecker</span>.<span style=color:#a6e22e>GetMemoryUsage</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;å†…å­˜ä½¿ç”¨ç‡è·å–å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç£ç›˜ä½¿ç”¨ç‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>diskUsage</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>resourceChecker</span>.<span style=color:#a6e22e>GetDiskUsage</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#e6db74>&#34;unknown&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span> = append(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;ç£ç›˜ä½¿ç”¨ç‡è·å–å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;unknown&#34;</span> <span style=color:#f92672>&amp;&amp;</span> len(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Details</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Status</span> = <span style=color:#a6e22e>mlhc</span>.<span style=color:#a6e22e>evaluateResourceHealth</span>(<span style=color:#a6e22e>cpuUsage</span>, <span style=color:#a6e22e>memUsage</span>, <span style=color:#a6e22e>diskUsage</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Metrics</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cpu_usage_percent&#34;</span>:    <span style=color:#a6e22e>cpuUsage</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;memory_usage_percent&#34;</span>: <span style=color:#a6e22e>memUsage</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;disk_usage_percent&#34;</span>:   <span style=color:#a6e22e>diskUsage</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>result</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=ä¼˜é›…é™çº§ç­–ç•¥><strong>ä¼˜é›…é™çº§ç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>GracefulDegradation</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthChecker</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthChecker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>degradedMode</span>    <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>             <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>degradationRules</span> []<span style=color:#a6e22e>DegradationRule</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rollbackPlan</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>RollbackPlan</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>DegradationMetrics</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DegradationRule</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>           <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CheckFunc</span>      <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DegradationFunc</span> <span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Priority</span>       <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RollbackFunc</span>   <span style=color:#66d9ef>func</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RollbackPlan</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Steps</span>         []<span style=color:#a6e22e>RollbackStep</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CheckInterval</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxRetries</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RollbackStep</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>          <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ExecuteFunc</span>   <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ValidateFunc</span>  <span style=color:#66d9ef>func</span>() <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>Start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ticker</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>NewTicker</span>(<span style=color:#ae81ff>10</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>Stop</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ticker</span>.<span style=color:#a6e22e>C</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>checkAndDegrade</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>checkAndDegrade</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>results</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>RunChecks</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>healthChecker</span>.<span style=color:#a6e22e>GetOverallStatus</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¢å¤æ­£å¸¸æ¨¡å¼</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>recoverFromDegradation</span>()
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;unhealthy&#34;</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿›å…¥é™çº§æ¨¡å¼</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>enterDegradationMode</span>(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>overallStatus</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;degraded&#34;</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// éƒ¨åˆ†é™çº§</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>enterPartialDegradation</span>(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>enterDegradationMode</span>(<span style=color:#a6e22e>results</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;è¿›å…¥é™çº§æ¨¡å¼&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œé™çº§è§„åˆ™</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradationRules</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradationRules</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Priority</span> &gt; <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradationRules</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>Priority</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rule</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradationRules</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>CheckFunc</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ‰§è¡Œé™çº§è§„åˆ™: %s&#34;</span>, <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// è¶…æ—¶æ§åˆ¶</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutCtx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Timeout</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>DegradationFunc</span>()
</span></span><span style=display:flex><span>                close(<span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>            }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>:
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é™çº§è§„åˆ™ %s æ‰§è¡Œå®Œæˆ&#34;</span>, <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordDegradation</span>(<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;success&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timeoutCtx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é™çº§è§„åˆ™ %s æ‰§è¡Œè¶…æ—¶&#34;</span>, <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordDegradation</span>(<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;timeout&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ‰§è¡Œå›æ»š</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>RollbackFunc</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>go</span> <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>RollbackFunc</span>()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å‘é€å‘Šè­¦</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>sendAlert</span>(<span style=color:#a6e22e>results</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>enterPartialDegradation</span>(<span style=color:#a6e22e>results</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;è¿›å…¥éƒ¨åˆ†é™çº§æ¨¡å¼&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»…æ‰§è¡Œå…³é”®é™çº§è§„åˆ™</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rule</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradationRules</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Priority</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>&amp;&amp;</span> !<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>CheckFunc</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ‰§è¡Œå…³é”®é™çº§è§„åˆ™: %s&#34;</span>, <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>DegradationFunc</span>()
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordDegradation</span>(<span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#e6db74>&#34;partial&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>recoverFromDegradation</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;ä»é™çº§æ¨¡å¼æ¢å¤&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> = <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰§è¡Œå›æ»šè®¡åˆ’</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>rollbackPlan</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>executeRollbackPlan</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>success</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;å›æ»šè®¡åˆ’æ‰§è¡Œå¤±è´¥ï¼Œä¿æŒé™çº§æ¨¡å¼&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>degradedMode</span> = <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¢å¤æœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>recoverServices</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>sendRecoveryNotification</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordRecovery</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>gd</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>GracefulDegradation</span>) <span style=color:#a6e22e>executeRollbackPlan</span>() <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>step</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>rollbackPlan</span>.<span style=color:#a6e22e>Steps</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>attempt</span> &lt; <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>rollbackPlan</span>.<span style=color:#a6e22e>MaxRetries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutCtx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>Timeout</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>done</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>struct</span>{})
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>:=</span> make(<span style=color:#66d9ef>chan</span> <span style=color:#66d9ef>error</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>ExecuteFunc</span>(); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>errChan</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                    close(<span style=color:#a6e22e>done</span>)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>done</span>:
</span></span><span style=display:flex><span>                <span style=color:#75715e>// éªŒè¯å›æ»šç»“æœ</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>ValidateFunc</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å›æ»šæ­¥éª¤ %s æ‰§è¡ŒæˆåŠŸ&#34;</span>, <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å›æ»šæ­¥éª¤ %s éªŒè¯å¤±è´¥ï¼Œé‡è¯•ä¸­...&#34;</span>, <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>timeoutCtx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å›æ»šæ­¥éª¤ %s æ‰§è¡Œè¶…æ—¶&#34;</span>, <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>Name</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>errChan</span>:
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;å›æ»šæ­¥éª¤ %s æ‰§è¡Œå¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>rollbackPlan</span>.<span style=color:#a6e22e>MaxRetries</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Sleep</span>(<span style=color:#a6e22e>gd</span>.<span style=color:#a6e22e>rollbackPlan</span>.<span style=color:#a6e22e>CheckInterval</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>è¿™äº›å¥åº·æ£€æŸ¥æœºåˆ¶ç¡®ä¿äº† Go Micro æœåŠ¡çš„å¯ç”¨æ€§å’Œç¨³å®šæ€§ï¼Œé€šè¿‡å¤šå±‚æ¬¡ã€å¤šè§’åº¦çš„å¥åº·ç›‘æ§ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†æœåŠ¡å¼‚å¸¸ï¼Œä¸ºç”Ÿäº§ç¯å¢ƒæä¾›äº†å¼ºå¤§çš„ä¿éšœã€‚</p><h2 id=-å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æ·±åº¦è§£æ>âš–ï¸ å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡ç­–ç•¥æ·±åº¦è§£æ</h2><h3 id=è´Ÿè½½å‡è¡¡æ¶æ„æ¦‚è¿°>è´Ÿè½½å‡è¡¡æ¶æ„æ¦‚è¿°</h3><p>Go Micro çš„å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡é‡‡ç”¨<strong>é€‰æ‹©å™¨æ¨¡å¼</strong>ï¼ˆSelector Patternï¼‰ï¼Œå®ƒä½äºå®¢æˆ·ç«¯å’ŒæœåŠ¡å‘ç°å±‚ä¹‹é—´ï¼Œè´Ÿè´£ä»å¤šä¸ªå¯ç”¨æœåŠ¡å®ä¾‹ä¸­é€‰æ‹©æœ€ä¼˜çš„ä¸€ä¸ªè¿›è¡Œè¯·æ±‚åˆ†å‘ã€‚</p><h3 id=æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç­–ç•¥>æ ¸å¿ƒè´Ÿè½½å‡è¡¡ç­–ç•¥</h3><h4 id=1-round-robin-è½®è¯¢ç­–ç•¥><strong>1. Round-Robin è½®è¯¢ç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>balancer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/selector&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/registry&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RoundRobinBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>    <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRoundRobinBalancer</span>() <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Balancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>RoundRobinBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>index</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RoundRobinBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–å½“å‰æœåŠ¡çš„ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>index</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selectedIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>currentIndex</span> <span style=color:#f92672>%</span> len(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°ç´¢å¼•</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>index</span>[<span style=color:#a6e22e>service</span>] = <span style=color:#a6e22e>currentIndex</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#a6e22e>selectedIndex</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RoundRobinBalancer</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;roundrobin&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºé€‰æ‹©å™¨å¹¶è®¾ç½®è½®è¯¢å‡è¡¡å™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>NewSelector</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>SetBalancer</span>(<span style=color:#a6e22e>NewRoundRobinBalancer</span>()),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;client-service&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Selector</span>(<span style=color:#a6e22e>selector</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿›è¡ŒæœåŠ¡è°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>UserResponse</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GetUser&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>proto</span>.<span style=color:#a6e22e>UserRequest</span>{<span style=color:#a6e22e>UserId</span>: <span style=color:#e6db74>&#34;123&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>response</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=2-random-éšæœºç­–ç•¥><strong>2. Random éšæœºç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RandomBalancer</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewRandomBalancer</span>() <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Balancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>RandomBalancer</span>{}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RandomBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// éšæœºé€‰æ‹©èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>randomIndex</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#a6e22e>randomIndex</span>], <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RandomBalancer</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;random&#34;</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=3-least-connection-æœ€å°‘è¿æ¥ç­–ç•¥><strong>3. Least Connection æœ€å°‘è¿æ¥ç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ConnectionTracker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connections</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span> <span style=color:#75715e>// service -&gt; nodeID -&gt; connectionCount</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>           <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LeastConnectionBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tracker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewLeastConnectionBalancer</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>LeastConnectionBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LeastConnectionBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tracker</span>: <span style=color:#a6e22e>NewConnectionTracker</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LeastConnectionBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æ¯ä¸ªèŠ‚ç‚¹çš„è¿æ¥æ•°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>nodeStats</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeStats</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>connections</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>tracker</span>.<span style=color:#a6e22e>GetConnectionCount</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodeStats</span> = append(<span style=color:#a6e22e>nodeStats</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NodeStats</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Node</span>:        <span style=color:#a6e22e>node</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Connections</span>: <span style=color:#a6e22e>connections</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‰è¿æ¥æ•°æ’åº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>nodeStats</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodeStats</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Connections</span> &lt; <span style=color:#a6e22e>nodeStats</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>Connections</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodeStats</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LeastConnectionBalancer</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;least-connection&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeStats</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Node</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Connections</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ConnectionTracker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connections</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span> <span style=color:#75715e>// service -&gt; nodeID -&gt; connectionCount</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>           <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewConnectionTracker</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ConnectionTracker</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>connections</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ct</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span>) <span style=color:#a6e22e>Increment</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>]<span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ct</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span>) <span style=color:#a6e22e>Decrement</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span>, <span style=color:#a6e22e>nodeExists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>]; <span style=color:#a6e22e>nodeExists</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>count</span> &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>]<span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ct</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span>) <span style=color:#a6e22e>GetConnectionCount</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ct</span>.<span style=color:#a6e22e>connections</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=4-weighted-åŠ æƒç­–ç•¥><strong>4. Weighted åŠ æƒç­–ç•¥</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WeightedBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weightCalculator</span> <span style=color:#a6e22e>WeightCalculator</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WeightCalculator</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CalculateWeight</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeWeightCalculator</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeWeightCalculator</span>) <span style=color:#a6e22e>CalculateWeight</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»èŠ‚ç‚¹å…ƒæ•°æ®ä¸­è·å–æƒé‡</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>weightStr</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Metadata</span>[<span style=color:#e6db74>&#34;weight&#34;</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>weight</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>Atoi</span>(<span style=color:#a6e22e>weightStr</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤æƒé‡</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewWeightedBalancer</span>(<span style=color:#a6e22e>calculator</span> <span style=color:#a6e22e>WeightCalculator</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>WeightedBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>calculator</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>calculator</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NodeWeightCalculator</span>{}
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>WeightedBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weightCalculator</span>: <span style=color:#a6e22e>calculator</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WeightedBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—æ€»æƒé‡</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>totalWeight</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>weightedNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>WeightedNode</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>weightCalculator</span>.<span style=color:#a6e22e>CalculateWeight</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>totalWeight</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>weight</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weightedNodes</span> = append(<span style=color:#a6e22e>weightedNodes</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>WeightedNode</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Node</span>:   <span style=color:#a6e22e>node</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Weight</span>: <span style=color:#a6e22e>weight</span>,
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>totalWeight</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç”Ÿæˆéšæœºæ•°é€‰æ‹©èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>randomWeight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>totalWeight</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentWeight</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>weightedNode</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>weightedNodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currentWeight</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>weightedNode</span>.<span style=color:#a6e22e>Weight</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>randomWeight</span> &lt; <span style=color:#a6e22e>currentWeight</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>weightedNode</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>weightedNodes</span>[len(<span style=color:#a6e22e>weightedNodes</span>)<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>].<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>w</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>WeightedBalancer</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;weighted&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WeightedNode</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Node</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Weight</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=é«˜çº§è´Ÿè½½å‡è¡¡ç‰¹æ€§>é«˜çº§è´Ÿè½½å‡è¡¡ç‰¹æ€§</h3><h4 id=è‡ªé€‚åº”å»¶è¿Ÿæ„ŸçŸ¥è´Ÿè½½å‡è¡¡><strong>è‡ªé€‚åº”å»¶è¿Ÿæ„ŸçŸ¥è´Ÿè½½å‡è¡¡</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AdaptiveLatencyBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latencyTracker</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>regionAwareness</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>RegionAwareness</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>congestionControl</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CongestionControl</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>trendAnalyzer</span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>TrendAnalyzer</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>         <span style=color:#f92672>*</span><span style=color:#a6e22e>BalancerMetrics</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AdaptiveLatencyTracker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latencies</span>       <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>LatencyWindow</span> <span style=color:#75715e>// service -&gt; nodeID -&gt; latency window</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>weights</span>         <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>float64</span>        <span style=color:#75715e>// service -&gt; nodeID -&gt; dynamic weight</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>regionLatencies</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#75715e>// region -&gt; service -&gt; avg latency</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>              <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windowSize</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sampleInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LatencyWindow</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>samples</span> []<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mean</span>     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stdDev</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>trend</span>    <span style=color:#66d9ef>string</span> <span style=color:#75715e>// &#34;improving&#34;, &#34;stable&#34;, &#34;degrading&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>updated</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CongestionControl</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>thresholds</span>      <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int64</span> <span style=color:#75715e>// nodeID -&gt; current threshold</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>backpressure</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>bool</span> <span style=color:#75715e>// nodeID -&gt; under backpressure</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>recoveryTime</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adaptiveWindow</span>  <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>minThreshold</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxThreshold</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewAdaptiveLatencyBalancer</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>latencyTracker</span>:    <span style=color:#a6e22e>NewAdaptiveLatencyTracker</span>(<span style=color:#ae81ff>20</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span><span style=color:#f92672>*</span><span style=color:#ae81ff>30</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>regionAwareness</span>:  <span style=color:#a6e22e>NewRegionAwareness</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>congestionControl</span>: <span style=color:#a6e22e>NewCongestionControl</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>trendAnalyzer</span>:    <span style=color:#a6e22e>NewTrendAnalyzer</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>:         <span style=color:#a6e22e>NewBalancerMetrics</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>nodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–èŠ‚ç‚¹æ€§èƒ½æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeScores</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>, <span style=color:#ae81ff>0</span>, len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>score</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>calculateNodeScore</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodeScores</span> = append(<span style=color:#a6e22e>nodeScores</span>, <span style=color:#a6e22e>score</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‰ç»¼åˆè¯„åˆ†æ’åº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>nodeScores</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodeScores</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>TotalScore</span> &gt; <span style=color:#a6e22e>nodeScores</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>TotalScore</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åº”ç”¨æ‹¥å¡æ§åˆ¶</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selected</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>applyCongestionControl</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeScores</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>selected</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>ErrNoneAvailable</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹: %s (è¯„åˆ†: %.2f, å»¶è¿Ÿ: %v, æ‹¥å¡åº¦: %.2f)&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selected</span>.<span style=color:#a6e22e>Node</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>selected</span>.<span style=color:#a6e22e>TotalScore</span>, <span style=color:#a6e22e>selected</span>.<span style=color:#a6e22e>Latency</span>, <span style=color:#a6e22e>selected</span>.<span style=color:#a6e22e>CongestionScore</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>selected</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>) <span style=color:#a6e22e>calculateNodeScore</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>NodeScore</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Node</span>:     <span style=color:#a6e22e>node</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Latency</span>:  <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>latencyTracker</span>.<span style=color:#a6e22e>GetAverageLatency</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å»¶è¿Ÿè¯„åˆ† (æƒé‡ 40%)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latencyScore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>calculateLatencyScore</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‹¥å¡æ§åˆ¶è¯„åˆ† (æƒé‡ 30%)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>congestionScore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>calculateCongestionScore</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŒºåŸŸæ„ŸçŸ¥è¯„åˆ† (æƒé‡ 20%)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>regionScore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>regionAwareness</span>.<span style=color:#a6e22e>CalculateRegionScore</span>(<span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¶‹åŠ¿è¯„åˆ† (æƒé‡ 10%)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>trendScore</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>trendAnalyzer</span>.<span style=color:#a6e22e>CalculateTrendScore</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç»¼åˆè¯„åˆ†è®¡ç®—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>TotalScore</span> = <span style=color:#a6e22e>latencyScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0.4</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>congestionScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0.3</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>regionScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0.2</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>trendScore</span><span style=color:#f92672>*</span><span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>LatencyScore</span> = <span style=color:#a6e22e>latencyScore</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>CongestionScore</span> = <span style=color:#a6e22e>congestionScore</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>RegionScore</span> = <span style=color:#a6e22e>regionScore</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>TrendScore</span> = <span style=color:#a6e22e>trendScore</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>score</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>) <span style=color:#a6e22e>calculateLatencyScore</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>float64</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latency</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>latencyTracker</span>.<span style=color:#a6e22e>GetAverageLatency</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>latency</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä½¿ç”¨å¯¹æ•°å‡½æ•°å°†å»¶è¿Ÿæ˜ å°„åˆ°0-1åˆ†ï¼Œå»¶è¿Ÿè¶Šä½åˆ†æ•°è¶Šé«˜</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxLatency</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>latency</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>maxLatency</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Log</span>(float64(<span style=color:#a6e22e>maxLatency</span><span style=color:#f92672>/</span><span style=color:#a6e22e>latency</span>)) <span style=color:#f92672>/</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Log</span>(float64(<span style=color:#a6e22e>maxLatency</span><span style=color:#f92672>/</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Millisecond</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>) <span style=color:#a6e22e>calculateCongestionScore</span>(<span style=color:#a6e22e>node</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) <span style=color:#66d9ef>float64</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>congestionLevel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>congestionControl</span>.<span style=color:#a6e22e>GetCongestionLevel</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‹¥å¡ç¨‹åº¦è¶Šé«˜ï¼Œåˆ†æ•°è¶Šä½</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>congestionLevel</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;low&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1.0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;medium&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.6</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;high&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.3</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;critical&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.8</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>) <span style=color:#a6e22e>applyCongestionControl</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>congestionControl</span>.<span style=color:#a6e22e>UpdateThresholds</span>(<span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿‡æ»¤æ‰å¤„äºä¸¥é‡æ‹¥å¡çŠ¶æ€çš„èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>availableNodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>congestionControl</span>.<span style=color:#a6e22e>IsUnderBackpressure</span>(<span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Node</span>.<span style=color:#a6e22e>Id</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>availableNodes</span> = append(<span style=color:#a6e22e>availableNodes</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>availableNodes</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœæ‰€æœ‰èŠ‚ç‚¹éƒ½æ‹¥å¡ï¼Œé€‰æ‹©æ‹¥å¡ç¨‹åº¦æœ€è½»çš„</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>nodes</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>availableNodes</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewAdaptiveLatencyTracker</span>(<span style=color:#a6e22e>windowSize</span> <span style=color:#66d9ef>int</span>, <span style=color:#a6e22e>sampleInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>latencies</span>:       make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>LatencyWindow</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>weights</span>:         make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>float64</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>regionLatencies</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>windowSize</span>:      <span style=color:#a6e22e>windowSize</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sampleInterval</span>:  <span style=color:#a6e22e>sampleInterval</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span>) <span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodeID</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>latency</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;:&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>nodeID</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>latencies</span>[<span style=color:#a6e22e>service</span>]; !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>latencies</span>[<span style=color:#a6e22e>service</span>] = make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>LatencyWindow</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>window</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>latencies</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>window</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LatencyWindow</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>samples</span>: make([]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>windowSize</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>updated</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>latencies</span>[<span style=color:#a6e22e>service</span>][<span style=color:#a6e22e>nodeID</span>] = <span style=color:#a6e22e>window</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·»åŠ æ–°æ ·æœ¬</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span> = append(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä¿æŒçª—å£å¤§å°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>) &gt; <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>windowSize</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span> = <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>[<span style=color:#ae81ff>1</span>:]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>updateWindowStatistics</span>(<span style=color:#a6e22e>window</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°åŒºåŸŸå»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>region</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>getNodeRegion</span>(<span style=color:#a6e22e>nodeID</span>); <span style=color:#a6e22e>region</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>updateRegionLatency</span>(<span style=color:#a6e22e>region</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span>) <span style=color:#a6e22e>updateWindowStatistics</span>(<span style=color:#a6e22e>window</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LatencyWindow</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—å¹³å‡å€¼</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>total</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sample</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>sample</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>mean</span> = <span style=color:#a6e22e>total</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(len(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—æ ‡å‡†å·®</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>) &gt; <span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>variance</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sample</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>diff</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>sample</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>mean</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>variance</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>diff</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>diff</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>variance</span> <span style=color:#f92672>/=</span> float64(len(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>))
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>stdDev</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Sqrt</span>(<span style=color:#a6e22e>variance</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ†æè¶‹åŠ¿</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>trend</span> = <span style=color:#a6e22e>alt</span>.<span style=color:#a6e22e>analyzeTrend</span>(<span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>samples</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>window</span>.<span style=color:#a6e22e>updated</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>alt</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyTracker</span>) <span style=color:#a6e22e>analyzeTrend</span>(<span style=color:#a6e22e>samples</span> []<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>samples</span>) &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;stable&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç®€å•çš„çº¿æ€§å›å½’åˆ†æè¶‹åŠ¿</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> len(<span style=color:#a6e22e>samples</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sumX</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span> (<span style=color:#a6e22e>n</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sumY</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0.0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sumXY</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0.0</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sumXX</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0.0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>sample</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>samples</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>i</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>y</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>sample</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sumY</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sumXY</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>y</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sumXX</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>x</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>slope</span> <span style=color:#f92672>:=</span> (float64(<span style=color:#a6e22e>n</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>sumXY</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>sumX</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sumY</span>) <span style=color:#f92672>/</span> (float64(<span style=color:#a6e22e>n</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>sumXX</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>sumX</span><span style=color:#f92672>*</span><span style=color:#a6e22e>sumX</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¹æ®æ–œç‡åˆ¤æ–­è¶‹åŠ¿</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slope</span> &gt; <span style=color:#f92672>-</span><span style=color:#ae81ff>1000000</span> { <span style=color:#75715e>// ä¸‹é™è¶‹åŠ¿</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;improving&#34;</span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>slope</span> &lt; <span style=color:#ae81ff>1000000</span> { <span style=color:#75715e>// ä¸Šå‡è¶‹åŠ¿</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;degrading&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;stable&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NodeScore</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Node</span>            <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TotalScore</span>      <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LatencyScore</span>    <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CongestionScore</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RegionScore</span>     <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TrendScore</span>      <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Latency</span>         <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŠ¨æ€æƒé‡è°ƒæ•´ç®—æ³•</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DynamicWeightAdjuster</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>balancer</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveLatencyBalancer</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adjustmentRules</span> []<span style=color:#a6e22e>WeightAdjustmentRule</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>WeightMetrics</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adjustmentLock</span> <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>WeightAdjustmentRule</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Condition</span>     <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Adjustment</span>    <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>) <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Priority</span>      <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Description</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dwa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DynamicWeightAdjuster</span>) <span style=color:#a6e22e>AdjustWeights</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentLock</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentLock</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—å½“å‰èŠ‚ç‚¹è¯„åˆ†</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nodeScores</span> <span style=color:#f92672>:=</span> make([]<span style=color:#f92672>*</span><span style=color:#a6e22e>NodeScore</span>, len(<span style=color:#a6e22e>nodes</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodes</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nodeScores</span>[<span style=color:#a6e22e>i</span>] = <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>calculateNodeScore</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åº”ç”¨æƒé‡è°ƒæ•´è§„åˆ™</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>score</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>nodeScores</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>rule</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Condition</span>(<span style=color:#a6e22e>score</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>newWeight</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Adjustment</span>(<span style=color:#a6e22e>score</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>balancer</span>.<span style=color:#a6e22e>latencyTracker</span>.<span style=color:#a6e22e>UpdateWeight</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>Node</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>newWeight</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æƒé‡è°ƒæ•´: %s -&gt; %.2f (è§„åˆ™: %s)&#34;</span>, <span style=color:#a6e22e>score</span>.<span style=color:#a6e22e>Node</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>newWeight</span>, <span style=color:#a6e22e>rule</span>.<span style=color:#a6e22e>Description</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dwa</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DynamicWeightAdjuster</span>) <span style=color:#a6e22e>AddRule</span>(<span style=color:#a6e22e>rule</span> <span style=color:#a6e22e>WeightAdjustmentRule</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span> = append(<span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span>, <span style=color:#a6e22e>rule</span>)
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‰ä¼˜å…ˆçº§æ’åº</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>Priority</span> &gt; <span style=color:#a6e22e>dwa</span>.<span style=color:#a6e22e>adjustmentRules</span>[<span style=color:#a6e22e>j</span>].<span style=color:#a6e22e>Priority</span>
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=æ™ºèƒ½ç†”æ–­å™¨é›†æˆ><strong>æ™ºèƒ½ç†”æ–­å™¨é›†æˆ</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SmartCircuitBreakerBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>breaker</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>childBalancer</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Balancer</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreakerMetrics</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>policy</span>       <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreakerPolicy</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>AdaptiveCircuitBreaker</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>states</span>           <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>      <span style=color:#75715e>// service -&gt; state</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthMetrics</span>    <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span>    <span style=color:#75715e>// service -&gt; metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>recoveryStrategies</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>RecoveryStrategy</span> <span style=color:#75715e>// service -&gt; recovery strategy</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>               <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>config</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreakerConfig</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BreakerState</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>State</span>           <span style=color:#66d9ef>string</span>    <span style=color:#75715e>// &#34;open&#34;, &#34;closed&#34;, &#34;half-open&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Failures</span>        <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastFailure</span>     <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RecoveryCount</span>   <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SuccessRate</span>     <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LatencyPercentile</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>CircuitBreakerConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxFailures</span>          <span style=color:#66d9ef>int</span>           <span style=color:#e6db74>`json:&#34;max_failures&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>              <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;timeout&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HalfOpenRequests</span>    <span style=color:#66d9ef>int</span>           <span style=color:#e6db74>`json:&#34;half_open_requests&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SuccessThreshold</span>    <span style=color:#66d9ef>float64</span>       <span style=color:#e6db74>`json:&#34;success_threshold&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RecoveryDelay</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;recovery_delay&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LatencyThreshold</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;latency_threshold&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HealthMetrics</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TotalRequests</span>     <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SuccessRequests</span>   <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FailedRequests</span>    <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LatencySamples</span>    []<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorRate</span>        <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastUpdated</span>      <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewSmartCircuitBreakerBalancer</span>(<span style=color:#a6e22e>balancer</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Balancer</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>childBalancer</span>: <span style=color:#a6e22e>balancer</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>breaker</span>:      <span style=color:#a6e22e>NewAdaptiveCircuitBreaker</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>CircuitBreakerConfig</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxFailures</span>:       <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Timeout</span>:           <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>HalfOpenRequests</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SuccessThreshold</span>: <span style=color:#ae81ff>0.6</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>RecoveryDelay</span>:    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>LatencyThreshold</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>        }),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>: <span style=color:#a6e22e>NewCircuitBreakerMetrics</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>policy</span>:  <span style=color:#a6e22e>NewCircuitBreakerPolicy</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>scb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>GetState</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;open&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;circuit breaker open for service %s&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;half-open&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// åŠå¼€çŠ¶æ€ä¸‹åªå…è®¸å°‘é‡è¯·æ±‚</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>shouldAllowHalfOpenRequest</span>(<span style=color:#a6e22e>service</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;circuit breaker half-open, rejecting request for service %s&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä½¿ç”¨å­å‡è¡¡å™¨é€‰æ‹©èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>childBalancer</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>nodes</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>node</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>scb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span>) <span style=color:#a6e22e>RecordSuccess</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>latency</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>RecordSuccess</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>scb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span>) <span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>scb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartCircuitBreakerBalancer</span>) <span style=color:#a6e22e>shouldAllowHalfOpenRequest</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;half-open&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦è¶…è¿‡åŠå¼€çŠ¶æ€çš„æœ€å¤§è¯·æ±‚æ•°</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>scb</span>.<span style=color:#a6e22e>breaker</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>HalfOpenRequests</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewAdaptiveCircuitBreaker</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreakerConfig</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>states</span>:           make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthMetrics</span>:    make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recoveryStrategies</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>RecoveryStrategy</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>config</span>:           <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>RecordSuccess</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>latency</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>getOrCreateState</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>getOrCreateMetrics</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>TotalRequests</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>SuccessRequests</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span> = append(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LastUpdated</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;half-open&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®¡ç®—æˆåŠŸç‡</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>successRate</span> <span style=color:#f92672>:=</span> float64(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>HalfOpenRequests</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>SuccessRate</span> = <span style=color:#a6e22e>successRate</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>successRate</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>SuccessThreshold</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æ¢å¤åˆ°å…³é—­çŠ¶æ€</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> = <span style=color:#e6db74>&#34;closed&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç†”æ–­å™¨æ¢å¤åˆ°å…³é—­çŠ¶æ€ for service %s&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> = <span style=color:#e6db74>&#34;closed&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°å»¶è¿Ÿç™¾åˆ†ä½</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>updateLatencyPercentile</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>getOrCreateState</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>getOrCreateMetrics</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>TotalRequests</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>FailedRequests</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LastUpdated</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ErrorRate</span> = float64(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>FailedRequests</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>TotalRequests</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>LastFailure</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxFailures</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªé€‚åº”è°ƒæ•´é˜ˆå€¼</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>shouldAdaptThreshold</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>metrics</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>adaptThreshold</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>metrics</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> = <span style=color:#e6db74>&#34;open&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç†”æ–­å™¨å¼€å¯ for service %s (å¤±è´¥æ¬¡æ•°: %d)&#34;</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>shouldAdaptThreshold</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŸºäºé”™è¯¯ç‡å’Œå»¶è¿Ÿè¶‹åŠ¿åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒæ•´é˜ˆå€¼</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>TotalRequests</span> &lt; <span style=color:#ae81ff>100</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span> <span style=color:#75715e>// æ ·æœ¬ä¸è¶³ï¼Œä¸è°ƒæ•´</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorRate</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>ErrorRate</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errorRate</span> &gt; <span style=color:#ae81ff>0.8</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span> <span style=color:#75715e>// é”™è¯¯ç‡è¿‡é«˜ï¼Œéœ€è¦è°ƒæ•´</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>avgLatency</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>calculateAverageLatency</span>(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>avgLatency</span> &gt; <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>LatencyThreshold</span><span style=color:#f92672>*</span><span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span> <span style=color:#75715e>// å»¶è¿Ÿè¿‡é«˜ï¼Œéœ€è¦è°ƒæ•´</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>adaptThreshold</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é™ä½æœ€å¤§å¤±è´¥æ¬¡æ•°é˜ˆå€¼ï¼Œé¿å…é¢‘ç¹ç†”æ–­</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newMaxFailures</span> <span style=color:#f92672>:=</span> max(<span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxFailures</span><span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è‡ªé€‚åº”è°ƒæ•´ç†”æ–­å™¨é˜ˆå€¼: %s -&gt; %d&#34;</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>newMaxFailures</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxFailures</span> = <span style=color:#a6e22e>newMaxFailures</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span> = <span style=color:#ae81ff>0</span> <span style=color:#75715e>// é‡ç½®å¤±è´¥æ¬¡æ•°</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>GetState</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦éœ€è¦ä»å¼€å¯çŠ¶æ€è½¬ä¸ºåŠå¼€</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;open&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>recoveryStrategy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>recoveryStrategies</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>recoveryStrategy</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>recoveryStrategy</span> = <span style=color:#a6e22e>ExponentialBackoffRecovery</span>{}
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>recoveryStrategy</span>.<span style=color:#a6e22e>ShouldRecover</span>(<span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Timeout</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> = <span style=color:#e6db74>&#34;half-open&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>RecoveryCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€ for service %s&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>getOrCreateState</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>updateLatencyPercentile</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>healthMetrics</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> len(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®¡ç®—P95å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sortedLatencies</span> <span style=color:#f92672>:=</span> make([]<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>, len(<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span>))
</span></span><span style=display:flex><span>    copy(<span style=color:#a6e22e>sortedLatencies</span>, <span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>LatencySamples</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sort</span>.<span style=color:#a6e22e>Slice</span>(<span style=color:#a6e22e>sortedLatencies</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>j</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sortedLatencies</span>[<span style=color:#a6e22e>i</span>] &lt; <span style=color:#a6e22e>sortedLatencies</span>[<span style=color:#a6e22e>j</span>]
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>index</span> <span style=color:#f92672>:=</span> int(float64(len(<span style=color:#a6e22e>sortedLatencies</span>)) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.95</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>index</span> <span style=color:#f92672>&gt;=</span> len(<span style=color:#a6e22e>sortedLatencies</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>index</span> = len(<span style=color:#a6e22e>sortedLatencies</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>LatencyPercentile</span> = <span style=color:#a6e22e>sortedLatencies</span>[<span style=color:#a6e22e>index</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>calculateAverageLatency</span>(<span style=color:#a6e22e>samples</span> []<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>samples</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>total</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>sample</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>samples</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>total</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>sample</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>total</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(len(<span style=color:#a6e22e>samples</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>getOrCreateState</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>BreakerState</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>State</span>:    <span style=color:#e6db74>&#34;closed&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Failures</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>states</span>[<span style=color:#a6e22e>service</span>] = <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>acb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>AdaptiveCircuitBreaker</span>) <span style=color:#a6e22e>getOrCreateMetrics</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>HealthMetrics</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>healthMetrics</span>[<span style=color:#a6e22e>service</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>metrics</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>HealthMetrics</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LastUpdated</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>acb</span>.<span style=color:#a6e22e>healthMetrics</span>[<span style=color:#a6e22e>service</span>] = <span style=color:#a6e22e>metrics</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>metrics</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ¢å¤ç­–ç•¥æ¥å£</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RecoveryStrategy</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ShouldRecover</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>GetDelay</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŒ‡æ•°é€€é¿æ¢å¤ç­–ç•¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExponentialBackoffRecovery</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ebr</span> <span style=color:#a6e22e>ExponentialBackoffRecovery</span>) <span style=color:#a6e22e>ShouldRecover</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>LastFailure</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ebr</span>.<span style=color:#a6e22e>GetDelay</span>(<span style=color:#a6e22e>state</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>delay</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ebr</span> <span style=color:#a6e22e>ExponentialBackoffRecovery</span>) <span style=color:#a6e22e>GetDelay</span>() <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#75715e>// å›ºå®šå»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ebr</span> <span style=color:#a6e22e>ExponentialBackoffRecovery</span>) <span style=color:#a6e22e>GetDelay</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>multiplier</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(<span style=color:#ae81ff>2</span>, float64(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>multiplier</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// çº¿æ€§é€€é¿æ¢å¤ç­–ç•¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LinearBackoffRecovery</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lbr</span> <span style=color:#a6e22e>LinearBackoffRecovery</span>) <span style=color:#a6e22e>ShouldRecover</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>, <span style=color:#a6e22e>timeout</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>LastFailure</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>lbr</span>.<span style=color:#a6e22e>GetDelay</span>(<span style=color:#a6e22e>state</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>elapsed</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>delay</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>lbr</span> <span style=color:#a6e22e>LinearBackoffRecovery</span>) <span style=color:#a6e22e>GetDelay</span>(<span style=color:#a6e22e>state</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BreakerState</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>increment</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>Failures</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>increment</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=å®¢æˆ·ç«¯é›†æˆç¤ºä¾‹>å®¢æˆ·ç«¯é›†æˆç¤ºä¾‹</h3><h4 id=æ™ºèƒ½å®¢æˆ·ç«¯å®ç°><strong>æ™ºèƒ½å®¢æˆ·ç«¯å®ç°</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SmartClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>   <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span>  <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Selector</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latencyTracker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LatencyTracker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>circuitBreaker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CircuitBreaker</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connectionTracker</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionTracker</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewSmartClient</span>(<span style=color:#a6e22e>service</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºå¤åˆè´Ÿè½½å‡è¡¡å™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>primaryBalancer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewLatencyBasedBalancer</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secondaryBalancer</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewRoundRobinBalancer</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºé€‰æ‹©å™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>NewSelector</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>SetBalancer</span>(<span style=color:#a6e22e>primaryBalancer</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>SetFallback</span>(<span style=color:#a6e22e>secondaryBalancer</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SmartClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>service</span>:          <span style=color:#a6e22e>service</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>:         <span style=color:#a6e22e>selector</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>latencyTracker</span>:    <span style=color:#a6e22e>NewLatencyTracker</span>(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>circuitBreaker</span>:   <span style=color:#a6e22e>NewCircuitBreaker</span>(<span style=color:#ae81ff>5</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>connectionTracker</span>: <span style=color:#a6e22e>NewConnectionTracker</span>(),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartClient</span>) <span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>method</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>rsp</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æœåŠ¡èŠ‚ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>next</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to select service node: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>next</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;failed to get service node: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•è¿æ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>connectionTracker</span>.<span style=color:#a6e22e>Increment</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>connectionTracker</span>.<span style=color:#a6e22e>Decrement</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>circuitBreaker</span>.<span style=color:#a6e22e>GetState</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>state</span>.<span style=color:#a6e22e>State</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;open&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;service %s circuit breaker is open&#34;</span>, <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰§è¡Œè°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•å»¶è¿Ÿå’ŒæˆåŠŸç‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latency</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>latencyTracker</span>.<span style=color:#a6e22e>Record</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>node</span>.<span style=color:#a6e22e>Id</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>circuitBreaker</span>.<span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sc</span>.<span style=color:#a6e22e>circuitBreaker</span>.<span style=color:#a6e22e>RecordSuccess</span>(<span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>è¿™äº›è´Ÿè½½å‡è¡¡ç­–ç•¥æä¾›äº†çµæ´»çš„æœåŠ¡è°ƒç”¨åˆ†å‘æœºåˆ¶ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„ä¸šåŠ¡åœºæ™¯å’Œæ€§èƒ½éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç­–ç•¥ï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œæ€§èƒ½ä¼˜åŒ–ã€‚</p><h2 id=-ç›´æ¥è¿æ¥æ¨¡å¼ç»•è¿‡æœåŠ¡å‘ç°çš„ipportç›´è¿>ğŸ¯ ç›´æ¥è¿æ¥æ¨¡å¼ï¼šç»•è¿‡æœåŠ¡å‘ç°çš„IP+Portç›´è¿</h2><h3 id=åœºæ™¯è¯´æ˜>åœºæ™¯è¯´æ˜</h3><p>åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›ç»•è¿‡æœåŠ¡å‘ç°æœºåˆ¶ï¼Œç›´æ¥é€šè¿‡ IP:Port æ–¹å¼è¿æ¥åˆ°æœåŠ¡å®ä¾‹ã€‚è¿™ç§æ¨¡å¼é€‚ç”¨äºï¼š</p><ul><li><strong>å¼€å‘è°ƒè¯•</strong>ï¼šå¿«é€Ÿè¿æ¥åˆ°ç‰¹å®šæœåŠ¡å®ä¾‹è¿›è¡Œè°ƒè¯•</li><li><strong>æµ‹è¯•ç¯å¢ƒ</strong>ï¼šåœ¨æµ‹è¯•ç¯å¢ƒä¸­éœ€è¦ç²¾ç¡®æ§åˆ¶æœåŠ¡è¿æ¥</li><li><strong>å°å‹åº”ç”¨</strong>ï¼šä¸éœ€è¦å¤æ‚çš„æœåŠ¡å‘ç°æœºåˆ¶</li><li><strong>æ··åˆéƒ¨ç½²</strong>ï¼šéƒ¨åˆ†æœåŠ¡ä½¿ç”¨æœåŠ¡å‘ç°ï¼Œéƒ¨åˆ†æœåŠ¡ç›´æ¥è¿æ¥</li></ul><h3 id=å®ç°æ–¹æ¡ˆ>å®ç°æ–¹æ¡ˆ</h3><h4 id=1-ç›´æ¥ä½¿ç”¨-rpc-å®¢æˆ·ç«¯><strong>1. ç›´æ¥ä½¿ç”¨ RPC å®¢æˆ·ç«¯</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;google.golang.org/grpc/credentials/insecure&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pb</span> <span style=color:#e6db74>&#34;github.com/yourproject/user/proto&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç›´æ¥åˆ›å»º gRPC è¿æ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>Dial</span>(<span style=color:#e6db74>&#34;192.168.1.100:8080&#34;</span>, <span style=color:#a6e22e>grpc</span>.<span style=color:#a6e22e>WithInsecure</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;æ— æ³•è¿æ¥åˆ°æœåŠ¡: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºå®¢æˆ·ç«¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>NewUserServiceClient</span>(<span style=color:#a6e22e>conn</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç›´æ¥è°ƒç”¨æœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>response</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>GetUser</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>pb</span>.<span style=color:#a6e22e>GetUserRequest</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>UserId</span>: <span style=color:#e6db74>&#34;12345&#34;</span>,
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è°ƒç”¨æœåŠ¡å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç”¨æˆ·ä¿¡æ¯: %+v&#34;</span>, <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>User</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=2-è‡ªå®šä¹‰æœåŠ¡æ³¨å†Œå™¨><strong>2. è‡ªå®šä¹‰æœåŠ¡æ³¨å†Œå™¨</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;sync&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/client&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/registry&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/selector&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DirectRegistry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>       <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDirectRegistry</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DirectRegistry</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>services</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>][]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æ·»åŠ é™æ€æœåŠ¡</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>AddService</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>node</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Id</span>:      <span style=color:#a6e22e>name</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-static&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>: <span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Port</span>:    <span style=color:#a6e22e>port</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:  <span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Nodes</span>: []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>{<span style=color:#a6e22e>node</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>] = append(<span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>], <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ·»åŠ é™æ€æœåŠ¡: %s -&gt; %s:%d&#34;</span>, <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å®ç°æ³¨å†Œä¸­å¿ƒæ¥å£</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>GetService</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ErrNotFound</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>services</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>Register</span>(<span style=color:#a6e22e>service</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>RegisterOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>] = append(<span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>], <span style=color:#a6e22e>service</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ³¨å†ŒæœåŠ¡: %s&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>Deregister</span>(<span style=color:#a6e22e>service</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>DeregisterOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Name</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>[<span style=color:#a6e22e>name</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        delete(<span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ³¨é”€æœåŠ¡: %s&#34;</span>, <span style=color:#a6e22e>name</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>ListServices</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ListOption</span>) ([]<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>allServices</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Service</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>services</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>allServices</span> = append(<span style=color:#a6e22e>allServices</span>, <span style=color:#a6e22e>services</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>allServices</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>Watch</span>(<span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>WatchOption</span>) (<span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Watcher</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›ç©ºçš„ watcherï¼Œä¸æ”¯æŒç›‘å¬</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>EmptyWatcher</span>{}, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRegistry</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;direct-registry&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EmptyWatcher</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EmptyWatcher</span>) <span style=color:#a6e22e>Next</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Result</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>ErrWatcherStopped</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EmptyWatcher</span>) <span style=color:#a6e22e>Stop</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç©ºå®ç°</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºç›´æ¥è¿æ¥çš„æ³¨å†Œå™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>directReg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewDirectRegistry</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·»åŠ é™æ€æœåŠ¡é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>services</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>:     <span style=color:#e6db74>&#34;192.168.1.100:8080&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;order-service&#34;</span>:    <span style=color:#e6db74>&#34;192.168.1.101:8081&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;payment-service&#34;</span>: <span style=color:#e6db74>&#34;192.168.1.102:8082&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>addr</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>services</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseAddress</span>(<span style=color:#a6e22e>addr</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>directReg</span>.<span style=color:#a6e22e>AddService</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºæœåŠ¡ï¼Œä½¿ç”¨ç›´æ¥æ³¨å†Œå™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;client-service&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Registry</span>(<span style=color:#a6e22e>directReg</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Selector</span>(<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>NewSelector</span>()),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Init</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿›è¡ŒæœåŠ¡è°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨ç”¨æˆ·æœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userResponse</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Email</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>    }{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GetUser&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{<span style=color:#e6db74>&#34;user_id&#34;</span>: <span style=color:#e6db74>&#34;123&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>userResponse</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è°ƒç”¨ç”¨æˆ·æœåŠ¡å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç”¨æˆ·ä¿¡æ¯: %+v&#34;</span>, <span style=color:#a6e22e>userResponse</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parseAddress</span>(<span style=color:#a6e22e>addr</span> <span style=color:#66d9ef>string</span>) (<span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ç®€å•çš„åœ°å€è§£æ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>host</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>port</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sscanf</span>(<span style=color:#a6e22e>addr</span>, <span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>host</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;localhost&#34;</span>, <span style=color:#ae81ff>8080</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=3-è‡ªå®šä¹‰å®¢æˆ·ç«¯åŒ…è£…å™¨><strong>3. è‡ªå®šä¹‰å®¢æˆ·ç«¯åŒ…è£…å™¨</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/client&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/selector&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DirectClientWrapper</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoints</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#75715e>// service name -&gt; address</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewDirectClientWrapper</span>(<span style=color:#a6e22e>endpoints</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectClientWrapper</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DirectClientWrapper</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoints</span>: <span style=color:#a6e22e>endpoints</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dcw</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectClientWrapper</span>) <span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CallOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦æœ‰ç›´æ¥é…ç½®çš„ç«¯ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dcw</span>.<span style=color:#a6e22e>endpoints</span>[<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Service</span>()]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ä½¿ç”¨ç›´æ¥è¿æ¥è°ƒç”¨æœåŠ¡ %s -&gt; %s&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Service</span>(), <span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ›¿æ¢æœåŠ¡åç§°ä¸ºå…·ä½“åœ°å€</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>originalService</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Service</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>modifiedReq</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DirectRequest</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Request</span>: <span style=color:#a6e22e>req</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>service</span>: <span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dcw</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>modifiedReq</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦åˆ™ä½¿ç”¨åŸæœ‰çš„å®¢æˆ·ç«¯é€»è¾‘</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dcw</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DirectRequest</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>dr</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>DirectRequest</span>) <span style=color:#a6e22e>Service</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dr</span>.<span style=color:#a6e22e>service</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½®ç›´æ¥è¿æ¥çš„ç«¯ç‚¹</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoints</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>:     <span style=color:#e6db74>&#34;192.168.1.100:8080&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;order-service&#34;</span>:    <span style=color:#e6db74>&#34;192.168.1.101:8081&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;payment-service&#34;</span>: <span style=color:#e6db74>&#34;192.168.1.102:8082&#34;</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºæœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;client-service&#34;</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŒ…è£…å®¢æˆ·ç«¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wrappedClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewDirectClientWrapper</span>(<span style=color:#a6e22e>endpoints</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>().<span style=color:#a6e22e>Init</span>(<span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>WithWrapper</span>(<span style=color:#a6e22e>wrappedClient</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Init</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æµ‹è¯•è°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨ç”¨æˆ·æœåŠ¡ï¼ˆå°†ä½¿ç”¨ç›´æ¥è¿æ¥ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userResponse</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Email</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>    }{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GetUser&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{<span style=color:#e6db74>&#34;user_id&#34;</span>: <span style=color:#e6db74>&#34;123&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>userResponse</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è°ƒç”¨ç”¨æˆ·æœåŠ¡å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç”¨æˆ·ä¿¡æ¯: %+v&#34;</span>, <span style=color:#a6e22e>userResponse</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨å…¶ä»–æœåŠ¡ï¼ˆå°†ä½¿ç”¨æœåŠ¡å‘ç°ï¼‰</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>orderResponse</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>OrderId</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;order_id&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Amount</span>  <span style=color:#66d9ef>int64</span>  <span style=color:#e6db74>`json:&#34;amount&#34;`</span>
</span></span><span style=display:flex><span>    }{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;inventory-service&#34;</span>, <span style=color:#75715e>// æ²¡æœ‰åœ¨endpointsä¸­é…ç½®</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GetInventory&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{<span style=color:#e6db74>&#34;product_id&#34;</span>: <span style=color:#e6db74>&#34;456&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>orderResponse</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è°ƒç”¨åº“å­˜æœåŠ¡å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;åº“å­˜ä¿¡æ¯: %+v&#34;</span>, <span style=color:#a6e22e>orderResponse</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=4-é…ç½®é©±åŠ¨çš„è¿æ¥æ–¹å¼><strong>4. é…ç½®é©±åŠ¨çš„è¿æ¥æ–¹å¼</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ServiceConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DirectMode</span>  <span style=color:#66d9ef>bool</span>              <span style=color:#e6db74>`json:&#34;direct_mode&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Services</span>   <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;services&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Registry</span>   <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Type</span>    <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;type&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span> <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;address&#34;`</span>
</span></span><span style=display:flex><span>    } <span style=color:#e6db74>`json:&#34;registry&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>loadConfig</span>(<span style=color:#a6e22e>configPath</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceConfig</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>ReadFile</span>(<span style=color:#a6e22e>configPath</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>config</span> <span style=color:#a6e22e>ServiceConfig</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>data</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>config</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>config</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createService</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceConfig</span>) <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>DirectMode</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>createDirectService</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>createRegistryService</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createDirectService</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceConfig</span>) <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;ä½¿ç”¨ç›´æ¥è¿æ¥æ¨¡å¼&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºç›´æ¥æ³¨å†Œå™¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>directReg</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewDirectRegistry</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>address</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Services</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseAddress</span>(<span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>directReg</span>.<span style=color:#a6e22e>AddService</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;client-service&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Registry</span>(<span style=color:#a6e22e>directReg</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>createRegistryService</span>(<span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ServiceConfig</span>) <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;ä½¿ç”¨æœåŠ¡å‘ç°æ¨¡å¼&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>opts</span> []<span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Option</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Registry</span>.<span style=color:#a6e22e>Type</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;consul&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Registry</span>(<span style=color:#a6e22e>consul</span>.<span style=color:#a6e22e>NewRegistry</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Addrs</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Registry</span>.<span style=color:#a6e22e>Address</span>),
</span></span><span style=display:flex><span>        )))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;etcd&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>opts</span> = append(<span style=color:#a6e22e>opts</span>, <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Registry</span>(<span style=color:#a6e22e>etcd</span>.<span style=color:#a6e22e>NewRegistry</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Addrs</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Registry</span>.<span style=color:#a6e22e>Address</span>),
</span></span><span style=display:flex><span>        )))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æœªçŸ¥çš„æ³¨å†Œä¸­å¿ƒç±»å‹: %s, ä½¿ç”¨é»˜è®¤&#34;</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Registry</span>.<span style=color:#a6e22e>Type</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>NewService</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Name</span>(<span style=color:#e6db74>&#34;client-service&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åŠ è½½é…ç½®</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>loadConfig</span>(<span style=color:#e6db74>&#34;service-config.json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatalf</span>(<span style=color:#e6db74>&#34;åŠ è½½é…ç½®å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¹æ®é…ç½®åˆ›å»ºæœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>createService</span>(<span style=color:#a6e22e>config</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Init</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æœåŠ¡è°ƒç”¨é€»è¾‘</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è°ƒç”¨ç”¨æˆ·æœåŠ¡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userResponse</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>  <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Email</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;email&#34;`</span>
</span></span><span style=display:flex><span>    }{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(),
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;user-service&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;GetUser&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{<span style=color:#e6db74>&#34;user_id&#34;</span>: <span style=color:#e6db74>&#34;123&#34;</span>},
</span></span><span style=display:flex><span>        <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>userResponse</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;è°ƒç”¨æœåŠ¡å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç”¨æˆ·ä¿¡æ¯: %+v&#34;</span>, <span style=color:#a6e22e>userResponse</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é…ç½®æ–‡ä»¶ç¤ºä¾‹ (service-config.json)</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*
</span></span></span><span style=display:flex><span><span style=color:#75715e>{
</span></span></span><span style=display:flex><span><span style=color:#75715e>    &#34;direct_mode&#34;: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e>    &#34;services&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>        &#34;user-service&#34;: &#34;192.168.1.100:8080&#34;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>        &#34;order-service&#34;: &#34;192.168.1.101:8081&#34;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>        &#34;payment-service&#34;: &#34;192.168.1.102:8082&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>    },
</span></span></span><span style=display:flex><span><span style=color:#75715e>    &#34;registry&#34;: {
</span></span></span><span style=display:flex><span><span style=color:#75715e>        &#34;type&#34;: &#34;consul&#34;,
</span></span></span><span style=display:flex><span><span style=color:#75715e>        &#34;address&#34;: &#34;127.0.0.1:8500&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e>    }
</span></span></span><span style=display:flex><span><span style=color:#75715e>}
</span></span></span><span style=display:flex><span><span style=color:#75715e>*/</span></span></span></code></pre></div></div><h3 id=é«˜çº§åº”ç”¨åœºæ™¯>é«˜çº§åº”ç”¨åœºæ™¯</h3><h4 id=ç”Ÿäº§çº§æ··åˆè¿æ¥ç®¡ç†å™¨><strong>ç”Ÿäº§çº§æ··åˆè¿æ¥ç®¡ç†å™¨</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ProductionHybridConnectionManager</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>directEndpoints</span>      <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>DirectEndpoint</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>registryClient</span>     <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Client</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>selector</span>          <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Selector</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>healthMonitor</span>      <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealthMonitor</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>failoverManager</span>   <span style=color:#f92672>*</span><span style=color:#a6e22e>FailoverManager</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>           <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionMetrics</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>config</span>            <span style=color:#f92672>*</span><span style=color:#a6e22e>HybridConnectionConfig</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>                <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>DirectEndpoint</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Address</span>           <span style=color:#66d9ef>string</span>            <span style=color:#e6db74>`json:&#34;address&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Client</span>            <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Client</span>     <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Health</span>            <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealth</span>  <span style=color:#e6db74>`json:&#34;health&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ActiveConnections</span>  <span style=color:#66d9ef>int</span>              <span style=color:#e6db74>`json:&#34;active_connections&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TotalConnections</span>   <span style=color:#66d9ef>int64</span>            <span style=color:#e6db74>`json:&#34;total_connections&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Latency</span>           <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>    <span style=color:#e6db74>`json:&#34;latency&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorRate</span>         <span style=color:#66d9ef>float64</span>          <span style=color:#e6db74>`json:&#34;error_rate&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>          <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;metadata&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>EndpointHealth</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Status</span>           <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;status&#34;`</span> <span style=color:#75715e>// &#34;healthy&#34;, &#34;degraded&#34;, &#34;unhealthy&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastCheck</span>        <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;last_check&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConsecutiveFail</span>   <span style=color:#66d9ef>int</span>       <span style=color:#e6db74>`json:&#34;consecutive_fail&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RecoveryCount</span>     <span style=color:#66d9ef>int</span>       <span style=color:#e6db74>`json:&#34;recovery_count&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Uptime</span>           <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;uptime&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>HybridConnectionConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DirectMode</span>           <span style=color:#66d9ef>bool</span>              <span style=color:#e6db74>`json:&#34;direct_mode&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RegistryFallback</span>    <span style=color:#66d9ef>bool</span>              <span style=color:#e6db74>`json:&#34;registry_fallback&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HealthCheckInterval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>     <span style=color:#e6db74>`json:&#34;health_check_interval&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FailoverTimeout</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>     <span style=color:#e6db74>`json:&#34;failover_timeout&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxRetries</span>          <span style=color:#66d9ef>int</span>               <span style=color:#e6db74>`json:&#34;max_retries&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConnectionPoolSize</span>  <span style=color:#66d9ef>int</span>               <span style=color:#e6db74>`json:&#34;connection_pool_size&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CircuitBreaker</span>      <span style=color:#66d9ef>bool</span>              <span style=color:#e6db74>`json:&#34;circuit_breaker&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FailoverManager</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategies</span>        <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>FailoverStrategy</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentStrategy</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>failoverHistory</span>   []<span style=color:#a6e22e>FailoverEvent</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>                <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FailoverStrategy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>              <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Priority</span>          <span style=color:#66d9ef>int</span>                    <span style=color:#e6db74>`json:&#34;priority&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Condition</span>         <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealth</span>) <span style=color:#66d9ef>bool</span> <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Action</span>           <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>     <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Rollback</span>         <span style=color:#66d9ef>func</span>(<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span>     <span style=color:#e6db74>`json:&#34;-&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FailoverEvent</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timestamp</span>       <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;timestamp&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ServiceName</span>    <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;service_name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FromMode</span>       <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;from_mode&#34;`</span>  <span style=color:#75715e>// &#34;direct&#34;, &#34;registry&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ToMode</span>         <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;to_mode&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Reason</span>         <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;reason&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Success</span>        <span style=color:#66d9ef>bool</span>      <span style=color:#e6db74>`json:&#34;success&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewProductionHybridConnectionManager</span>(<span style=color:#a6e22e>service</span> <span style=color:#a6e22e>micro</span>.<span style=color:#a6e22e>Service</span>, <span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>HybridConnectionConfig</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>directEndpoints</span>:     make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>DirectEndpoint</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>registryClient</span>:    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Client</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>selector</span>:          <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>Options</span>().<span style=color:#a6e22e>Selector</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>healthMonitor</span>:      <span style=color:#a6e22e>NewEndpointHealthMonitor</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>HealthCheckInterval</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>failoverManager</span>:   <span style=color:#a6e22e>NewFailoverManager</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metrics</span>:           <span style=color:#a6e22e>NewConnectionMetrics</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>config</span>:            <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>AddDirectEndpoint</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>metadata</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºè¿æ¥æ± </span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connectionPool</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewConnectionPool</span>(<span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>ConnectionPoolSize</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// åˆ›å»ºä¸“ç”¨å®¢æˆ·ç«¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>directClient</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>NewClient</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Selector</span>(<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>NewSelector</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>SetBalancer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>SmartDirectBalancer</span>{
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>Address</span>:       <span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>ConnectionPool</span>: <span style=color:#a6e22e>connectionPool</span>,
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>HealthMonitor</span>:  <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>,
</span></span><span style=display:flex><span>            }),
</span></span><span style=display:flex><span>        )),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoint</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>DirectEndpoint</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>:    <span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Client</span>:     <span style=color:#a6e22e>directClient</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Metadata</span>:   <span style=color:#a6e22e>metadata</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Health</span>: <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>EndpointHealth</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Status</span>:     <span style=color:#e6db74>&#34;healthy&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>LastCheck</span>:  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>directEndpoints</span>[<span style=color:#a6e22e>serviceName</span>] = <span style=color:#a6e22e>endpoint</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RegisterEndpoint</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#e6db74>&#34;direct&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¯åŠ¨å¥åº·ç›‘æ§</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>.<span style=color:#a6e22e>RegisterEndpoint</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ·»åŠ ç›´æ¥ç«¯ç‚¹: %s -&gt; %s (å…ƒæ•°æ®: %+v)&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>address</span>, <span style=color:#a6e22e>metadata</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CallOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serviceName</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Service</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é€‰æ‹©è¿æ¥ç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>selectConnectionStrategy</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>mode</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>strategy</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;direct&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mode</span> = <span style=color:#e6db74>&#34;direct&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>callDirectEndpoint</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;registry&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mode</span> = <span style=color:#e6db74>&#34;registry&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>callRegistryEndpoint</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;failover&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>mode</span> = <span style=color:#e6db74>&#34;failover&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>callWithFailover</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;æœªçŸ¥çš„è¿æ¥ç­–ç•¥: %s&#34;</span>, <span style=color:#a6e22e>strategy</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•è°ƒç”¨æŒ‡æ ‡</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latency</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>startTime</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordCall</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>mode</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>latency</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>selectConnectionStrategy</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ç›´æ¥ç«¯ç‚¹æ˜¯å¦å¯ç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>directEndpoints</span>[<span style=color:#a6e22e>serviceName</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>health</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>.<span style=color:#a6e22e>GetEndpointHealth</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>Address</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>DirectMode</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;direct&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;degraded&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>RegistryFallback</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;registry&#34;</span> <span style=color:#75715e>// é™çº§åˆ°æ³¨å†Œä¸­å¿ƒ</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦éœ€è¦æ•…éšœè½¬ç§»</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>failoverManager</span>.<span style=color:#a6e22e>ShouldFailover</span>(<span style=color:#a6e22e>serviceName</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;failover&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é»˜è®¤ä½¿ç”¨æ³¨å†Œä¸­å¿ƒ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;registry&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>callDirectEndpoint</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CallOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>directEndpoints</span>[<span style=color:#a6e22e>serviceName</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;ç›´æ¥ç«¯ç‚¹ä¸å­˜åœ¨: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥ç«¯ç‚¹å¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>health</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>.<span style=color:#a6e22e>GetEndpointHealth</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>Address</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#34;healthy&#34;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;ç›´æ¥ç«¯ç‚¹ä¸å¥åº·: %s (çŠ¶æ€: %s)&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>Status</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰§è¡Œè°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ActiveConnections</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>TotalConnections</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>Client</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ActiveConnections</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ›´æ–°å¥åº·çŠ¶æ€</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>.<span style=color:#a6e22e>RecordFailure</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>Address</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ErrorRate</span> = (<span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ErrorRate</span><span style=color:#f92672>*</span>float64(<span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>TotalConnections</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1.0</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>TotalConnections</span>)
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>healthMonitor</span>.<span style=color:#a6e22e>RecordSuccess</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>Address</span>)
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ErrorRate</span> = <span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>ErrorRate</span> <span style=color:#f92672>*</span> float64(<span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>TotalConnections</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>/</span> float64(<span style=color:#a6e22e>endpoint</span>.<span style=color:#a6e22e>TotalConnections</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>callRegistryEndpoint</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CallOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é€šè¿‡æ³¨å†Œä¸­å¿ƒè°ƒç”¨æœåŠ¡: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>registryClient</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è®°å½•æ³¨å†Œä¸­å¿ƒè°ƒç”¨å¤±è´¥</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>RecordRegistryFailure</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœé…ç½®äº†æ•…éšœè½¬ç§»ï¼Œå°è¯•ç›´æ¥ç«¯ç‚¹</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>RegistryFallback</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>endpoint</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>directEndpoints</span>[<span style=color:#a6e22e>serviceName</span>]; <span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ³¨å†Œä¸­å¿ƒè°ƒç”¨å¤±è´¥ï¼Œå°è¯•ç›´æ¥ç«¯ç‚¹: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>callDirectEndpoint</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>phcm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ProductionHybridConnectionManager</span>) <span style=color:#a6e22e>callWithFailover</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>CallOption</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–æ•…éšœè½¬ç§»ç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>failoverManager</span>.<span style=color:#a6e22e>GetCurrentStrategy</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>strategy</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;æ— å¯ç”¨çš„æ•…éšœè½¬ç§»ç­–ç•¥: %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ‰§è¡Œæ•…éšœè½¬ç§»ç­–ç•¥: %s for service %s&#34;</span>, <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>Name</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ‰§è¡Œæ•…éšœè½¬ç§»æ“ä½œ</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strategy</span>.<span style=color:#a6e22e>Action</span>(<span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>event</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>FailoverEvent</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>:    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ServiceName</span>: <span style=color:#a6e22e>serviceName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>FromMode</span>:     <span style=color:#e6db74>&#34;unknown&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ToMode</span>:       <span style=color:#e6db74>&#34;failover&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Reason</span>:       <span style=color:#e6db74>&#34;æ•…éšœè½¬ç§»æ¿€æ´»&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Success</span>:      <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>failoverManager</span>.<span style=color:#a6e22e>RecordEvent</span>(<span style=color:#a6e22e>event</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;æ•…éšœè½¬ç§»å¤±è´¥: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é‡è¯•è°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>phcm</span>.<span style=color:#a6e22e>Call</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>opts</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>SmartDirectBalancer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Address</span>         <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ConnectionPool</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>HealthMonitor</span>  <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealthMonitor</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartDirectBalancer</span>) <span style=color:#a6e22e>Select</span>(<span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>nodes</span> []<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>) (<span style=color:#a6e22e>selector</span>.<span style=color:#a6e22e>Next</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ä»è¿æ¥æ± è·å–è¿æ¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sdb</span>.<span style=color:#a6e22e>ConnectionPool</span>.<span style=color:#a6e22e>GetConnection</span>(<span style=color:#a6e22e>sdb</span>.<span style=color:#a6e22e>Address</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;è·å–è¿æ¥å¤±è´¥: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>host</span>, <span style=color:#a6e22e>port</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseAddress</span>(<span style=color:#a6e22e>sdb</span>.<span style=color:#a6e22e>Address</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>() (<span style=color:#f92672>*</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>registry</span>.<span style=color:#a6e22e>Node</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Id</span>:      <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s-%d&#34;</span>, <span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>10000</span>)),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Address</span>: <span style=color:#a6e22e>host</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Port</span>:    <span style=color:#a6e22e>port</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Metadata</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;connection_id&#34;</span>: <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>ID</span>(),
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;created_at&#34;</span>:    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>Format</span>(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>RFC3339</span>),
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>sdb</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>SmartDirectBalancer</span>) <span style=color:#a6e22e>String</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;smart-direct-balancer&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ConnectionPool</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connections</span> <span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PooledConnection</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxSize</span>     <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>currentSize</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>          <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>Mutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>PooledConnection</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ID</span>         <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Connection</span> <span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Created</span>    <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastUsed</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Healthy</span>    <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewConnectionPool</span>(<span style=color:#a6e22e>maxSize</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ConnectionPool</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>connections</span>: make(<span style=color:#66d9ef>chan</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PooledConnection</span>, <span style=color:#a6e22e>maxSize</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxSize</span>:     <span style=color:#a6e22e>maxSize</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span>) <span style=color:#a6e22e>GetConnection</span>(<span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PooledConnection</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>conn</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>connections</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>LastUsed</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>currentSize</span><span style=color:#f92672>--</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>conn</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è¿æ¥æ± ä¸ºç©ºï¼Œåˆ›å»ºæ–°è¿æ¥</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>createNewConnection</span>(<span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span>) <span style=color:#a6e22e>ReturnConnection</span>(<span style=color:#a6e22e>conn</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>PooledConnection</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>Healthy</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#75715e>// ä¸å¥åº·çš„è¿æ¥ä¸è¿”å›åˆ°æ± ä¸­</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>currentSize</span> &lt; <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>maxSize</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>LastUsed</span> = <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>connections</span> <span style=color:#f92672>&lt;-</span> <span style=color:#a6e22e>conn</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>cp</span>.<span style=color:#a6e22e>currentSize</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>cp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ConnectionPool</span>) <span style=color:#a6e22e>createNewConnection</span>(<span style=color:#a6e22e>address</span> <span style=color:#66d9ef>string</span>) (<span style=color:#f92672>*</span><span style=color:#a6e22e>PooledConnection</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;conn-%d-%d&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>().<span style=color:#a6e22e>UnixNano</span>(), <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(<span style=color:#ae81ff>10000</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>PooledConnection</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ID</span>:        <span style=color:#a6e22e>connID</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Connection</span>: <span style=color:#66d9ef>nil</span>, <span style=color:#75715e>// å®é™…è¿æ¥æ ¹æ®åè®®ç±»å‹åˆ›å»º</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Created</span>:   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LastUsed</span>:  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Healthy</span>:   <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewFailoverManager</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>FailoverManager</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>strategies</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#a6e22e>FailoverStrategy</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;retry&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;é‡è¯•ç­–ç•¥&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Priority</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Condition</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>health</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealth</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>ConsecutiveFail</span> &lt; <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Action</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ‰§è¡Œé‡è¯•ç­–ç•¥ for service %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span> <span style=color:#75715e>// é‡è¯•é€»è¾‘ç”±è°ƒç”¨è€…å¤„ç†</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Rollback</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;direct_only&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;ä»…ç›´æ¥æ¨¡å¼&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Priority</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Condition</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>health</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealth</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>Status</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;healthy&#34;</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Action</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;åˆ‡æ¢åˆ°ä»…ç›´æ¥æ¨¡å¼ for service %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Rollback</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;cache_fallback&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Name</span>:     <span style=color:#e6db74>&#34;ç¼“å­˜å›é€€&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Priority</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Condition</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>health</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>EndpointHealth</span>) <span style=color:#66d9ef>bool</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>health</span>.<span style=color:#a6e22e>ConsecutiveFail</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Action</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;åˆ‡æ¢åˆ°ç¼“å­˜å›é€€æ¨¡å¼ for service %s&#34;</span>, <span style=color:#a6e22e>serviceName</span>)
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Rollback</span>: <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>FailoverManager</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>strategies</span>:      <span style=color:#a6e22e>strategies</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currentStrategy</span>: <span style=color:#e6db74>&#34;retry&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>failoverHistory</span>: make([]<span style=color:#a6e22e>FailoverEvent</span>, <span style=color:#ae81ff>0</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><p>è¿™ç§ç›´æ¥è¿æ¥æ¨¡å¼æä¾›äº†çµæ´»çš„éƒ¨ç½²é€‰é¡¹ï¼Œè®©å¼€å‘è€…å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æœ€é€‚åˆçš„æœåŠ¡è¿æ¥æ–¹å¼ã€‚ the command line interface for developing Go Micro projects.</p><h2 id=-è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶>âš ï¸ è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶</h2><h3 id=é”™è¯¯å¤„ç†çš„é‡è¦æ€§>é”™è¯¯å¤„ç†çš„é‡è¦æ€§</h3><p>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œé”™è¯¯å¤„ç†ä¸ä»…å…³ç³»åˆ°ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œè¿˜ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒå’Œé—®é¢˜æ’æŸ¥æ•ˆç‡ã€‚Go Micro æä¾›äº†å¼ºå¤§çš„è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶ï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡å’Œå®ç°ç»Ÿä¸€çš„é”™è¯¯å¤„ç†è§„èŒƒã€‚</p><h3 id=è‡ªå®šä¹‰é”™è¯¯ç±»å‹>è‡ªå®šä¹‰é”™è¯¯ç±»å‹</h3><h4 id=1-å®šä¹‰ä¸šåŠ¡é”™è¯¯ç ><strong>1. å®šä¹‰ä¸šåŠ¡é”™è¯¯ç </strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>errors</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;google.golang.org/grpc/codes&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;google.golang.org/grpc/status&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å®šä¹‰é”™è¯¯ç å¸¸é‡</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserNotFound</span>     = <span style=color:#ae81ff>10001</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidPassword</span>   = <span style=color:#ae81ff>10002</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserAlreadyExists</span> = <span style=color:#ae81ff>10003</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInsufficientBalance</span> = <span style=color:#ae81ff>10004</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeOrderNotFound</span>     = <span style=color:#ae81ff>20001</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodePaymentFailed</span>     = <span style=color:#ae81ff>20002</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidOrderStatus</span> = <span style=color:#ae81ff>20003</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯ç æ˜ å°„</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errorCodeToGRPC</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int32</span>]<span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Code</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserNotFound</span>:      <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>NotFound</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidPassword</span>:   <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>InvalidArgument</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserAlreadyExists</span>: <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>AlreadyExists</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInsufficientBalance</span>: <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>ResourceExhausted</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeOrderNotFound</span>:      <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>NotFound</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodePaymentFailed</span>:      <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Internal</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidOrderStatus</span>: <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>FailedPrecondition</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>errorCodeToMessage</span> = <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>int32</span>]<span style=color:#66d9ef>string</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserNotFound</span>:      <span style=color:#e6db74>&#34;ç”¨æˆ·ä¸å­˜åœ¨&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidPassword</span>:   <span style=color:#e6db74>&#34;å¯†ç æ— æ•ˆ&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeUserAlreadyExists</span>: <span style=color:#e6db74>&#34;ç”¨æˆ·å·²å­˜åœ¨&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInsufficientBalance</span>: <span style=color:#e6db74>&#34;ä½™é¢ä¸è¶³&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeOrderNotFound</span>:      <span style=color:#e6db74>&#34;è®¢å•ä¸å­˜åœ¨&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodePaymentFailed</span>:      <span style=color:#e6db74>&#34;æ”¯ä»˜å¤±è´¥&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrorCodeInvalidOrderStatus</span>: <span style=color:#e6db74>&#34;è®¢å•çŠ¶æ€æ— æ•ˆ&#34;</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä¸šåŠ¡é”™è¯¯ç±»å‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>BusinessError</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Code</span>        <span style=color:#66d9ef>int32</span>                  <span style=color:#e6db74>`json:&#34;code&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Message</span>     <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;message&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Details</span>     <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;details,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>StackTrace</span>  <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;stack_trace,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Context</span>     <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{} <span style=color:#e6db74>`json:&#34;context,omitempty&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timestamp</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>              <span style=color:#e6db74>`json:&#34;timestamp&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RequestID</span>   <span style=color:#66d9ef>string</span>                 <span style=color:#e6db74>`json:&#34;request_id,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>be</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BusinessError</span>) <span style=color:#a6e22e>Error</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;ä¸šåŠ¡é”™è¯¯ [%d]: %s&#34;</span>, <span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>Code</span>, <span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>Message</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>be</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BusinessError</span>) <span style=color:#a6e22e>GRPCStatus</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>Status</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpcCode</span>, <span style=color:#a6e22e>exists</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errorCodeToGRPC</span>[<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>Code</span>]
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>exists</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>grpcCode</span> = <span style=color:#a6e22e>codes</span>.<span style=color:#a6e22e>Unknown</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>status</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>grpcCode</span>, <span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>Message</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ErrorContext</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>RequestID</span>   <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>UserID</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ServiceName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Method</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>TraceID</span>     <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>SpanID</span>      <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Metadata</span>     <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timestamp</span>   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ErrorContextManager</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>contextMap</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>mu</span>         <span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>RWMutex</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewErrorContextManager</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContextManager</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ErrorContextManager</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>contextMap</span>: make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ecm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContextManager</span>) <span style=color:#a6e22e>SetContext</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Lock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>Unlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>contextMap</span>[<span style=color:#a6e22e>key</span>] = <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ecm</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContextManager</span>) <span style=color:#a6e22e>GetContext</span>(<span style=color:#a6e22e>key</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RLock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>mu</span>.<span style=color:#a6e22e>RUnlock</span>()
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ecm</span>.<span style=color:#a6e22e>contextMap</span>[<span style=color:#a6e22e>key</span>]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºå¢å¼ºçš„ä¸šåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>code</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>message</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span>, <span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>BusinessError</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>BusinessError</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Code</span>:      <span style=color:#a6e22e>code</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Message</span>:   <span style=color:#a6e22e>message</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Timestamp</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Context</span>:   make(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>RequestID</span> = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>RequestID</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#e6db74>&#34;user_id&#34;</span>] = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>UserID</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#e6db74>&#34;service_name&#34;</span>] = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>ServiceName</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#e6db74>&#34;method&#34;</span>] = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Method</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#e6db74>&#34;trace_id&#34;</span>] = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>TraceID</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#e6db74>&#34;span_id&#34;</span>] = <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>SpanID</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Metadata</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span>, <span style=color:#a6e22e>v</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Metadata</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Context</span>[<span style=color:#a6e22e>k</span>] = <span style=color:#a6e22e>v</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>details</span>) &gt; <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Details</span> = <span style=color:#a6e22e>details</span>[<span style=color:#ae81ff>0</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ·»åŠ å †æ ˆä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>StackTrace</span> = <span style=color:#a6e22e>captureStackTrace</span>(<span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åˆ›å»ºä¸šåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewBusinessError</span>(<span style=color:#a6e22e>code</span> <span style=color:#66d9ef>int32</span>, <span style=color:#a6e22e>message</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>BusinessError</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>message</span>, <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é¢„å®šä¹‰é”™è¯¯åˆ›å»ºå‡½æ•°</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> (
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrUserNotFound</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodeUserNotFound</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodeUserNotFound</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrInvalidPassword</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodeInvalidPassword</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodeInvalidPassword</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrUserAlreadyExists</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodeUserAlreadyExists</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodeUserAlreadyExists</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrInsufficientBalance</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodeInsufficientBalance</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodeInsufficientBalance</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrOrderNotFound</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodeOrderNotFound</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodeOrderNotFound</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ErrPaymentFailed</span> = <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>details</span> <span style=color:#f92672>...</span><span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getCurrentErrorContext</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewBusinessErrorWithContext</span>(<span style=color:#a6e22e>ErrorCodePaymentFailed</span>, <span style=color:#a6e22e>errorCodeToMessage</span>[<span style=color:#a6e22e>ErrorCodePaymentFailed</span>], <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>details</span><span style=color:#f92672>...</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å…¨å±€é”™è¯¯ä¸Šä¸‹æ–‡ç®¡ç†</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>globalErrorContextManager</span> = <span style=color:#a6e22e>NewErrorContextManager</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>currentErrorContext</span> <span style=color:#a6e22e>atomic</span>.<span style=color:#a6e22e>Value</span> <span style=color:#75715e>// stores *ErrorContext</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithErrorContext</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>requestID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;request_id&#34;</span>); <span style=color:#a6e22e>requestID</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorCtx</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ErrorContext</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>RequestID</span>:   <span style=color:#a6e22e>requestID</span>.(<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ServiceName</span>: <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;service_name&#34;</span>).(<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Method</span>:      <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;method&#34;</span>).(<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>TraceID</span>:     <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;trace_id&#34;</span>).(<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>SpanID</span>:      <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;span_id&#34;</span>).(<span style=color:#66d9ef>string</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Timestamp</span>:   <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>userID</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;user_id&#34;</span>); <span style=color:#a6e22e>userID</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errorCtx</span>.<span style=color:#a6e22e>UserID</span> = <span style=color:#a6e22e>userID</span>.(<span style=color:#66d9ef>string</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>currentErrorContext</span>.<span style=color:#a6e22e>Store</span>(<span style=color:#a6e22e>errorCtx</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getCurrentErrorContext</span>() <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>currentErrorContext</span>.<span style=color:#a6e22e>Load</span>(); <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.(<span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorContext</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>captureStackTrace</span>(<span style=color:#a6e22e>skip</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>uintptr</span>, <span style=color:#ae81ff>32</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Callers</span>(<span style=color:#a6e22e>skip</span><span style=color:#f92672>+</span><span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>pc</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>pc</span> = <span style=color:#a6e22e>pc</span>[:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>frames</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>CallersFrames</span>(<span style=color:#a6e22e>pc</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>builder</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>frame</span>, <span style=color:#a6e22e>more</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>frames</span>.<span style=color:#a6e22e>Next</span>()
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>more</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>funcInfo</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>FuncForPC</span>(<span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>funcInfo</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>line</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>funcInfo</span>.<span style=color:#a6e22e>FileLine</span>(<span style=color:#a6e22e>frame</span>.<span style=color:#a6e22e>PC</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>builder</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d - %s\n&#34;</span>, <span style=color:#a6e22e>file</span>, <span style=color:#a6e22e>line</span>, <span style=color:#a6e22e>funcInfo</span>.<span style=color:#a6e22e>Name</span>()))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>builder</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=2-é”™è¯¯åŒ…è£…å™¨><strong>2. é”™è¯¯åŒ…è£…å™¨</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>errors</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;errors&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;log&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;runtime/debug&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/errors&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯åŒ…è£…å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ErrorWrapper</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>service</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>method</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewErrorWrapper</span>(<span style=color:#a6e22e>service</span>, <span style=color:#a6e22e>method</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ErrorWrapper</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>service</span>: <span style=color:#a6e22e>service</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span>:  <span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒ…è£…ä¸šåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>WrapBusinessError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>BusinessError</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•é”™è¯¯æ—¥å¿—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;business&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è½¬æ¢ä¸º gRPC é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>GRPCStatus</span>().<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒ…è£…ç³»ç»Ÿé”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>WrapSystemError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•é”™è¯¯æ—¥å¿—</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;system&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›åŸå§‹é”™è¯¯æˆ–åŒ…è£…ä¸ºå†…éƒ¨é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Canceled</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InternalServer</span>(<span style=color:#e6db74>&#34;internal server error&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒ…è£…æ•°æ®åº“é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>WrapDatabaseError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;database&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InternalServer</span>(<span style=color:#e6db74>&#34;database operation failed&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒ…è£…éªŒè¯é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>WrapValidationError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;validation&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InvalidArgument</span>(<span style=color:#e6db74>&#34;validation failed&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// åŒ…è£…å¤–éƒ¨æœåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>WrapExternalServiceError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>method</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;external_service&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ServiceUnavailable</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;external service %s method %s failed&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>method</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯æ—¥å¿—è®°å½•</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>ew</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorWrapper</span>) <span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>, <span style=color:#a6e22e>errorType</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>now</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è·å–è°ƒç”¨æ ˆä¿¡æ¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stack</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>debug</span>.<span style=color:#a6e22e>Stack</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;[%s] [%s] %s - %s\n%s&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#e6db74>&#34;2006-01-02 15:04:05&#34;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorType</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>service</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ew</span>.<span style=color:#a6e22e>method</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>stack</span>,
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleUsage</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>wrapper</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewErrorWrapper</span>(<span style=color:#e6db74>&#34;user-service&#34;</span>, <span style=color:#e6db74>&#34;CreateUser&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿä¸šåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>businessErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ErrUserNotFound</span>(<span style=color:#e6db74>&#34;user_id: 12345&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpcErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>wrapper</span>.<span style=color:#a6e22e>WrapBusinessError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>businessErr</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ä¸šåŠ¡é”™è¯¯: %v&#34;</span>, <span style=color:#a6e22e>grpcErr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿç³»ç»Ÿé”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>systemErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;database connection timeout&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpcErr</span> = <span style=color:#a6e22e>wrapper</span>.<span style=color:#a6e22e>WrapSystemError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>systemErr</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç³»ç»Ÿé”™è¯¯: %v&#34;</span>, <span style=color:#a6e22e>grpcErr</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹ŸéªŒè¯é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>validationErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;email format invalid&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grpcErr</span> = <span style=color:#a6e22e>wrapper</span>.<span style=color:#a6e22e>WrapValidationError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>validationErr</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;éªŒè¯é”™è¯¯: %v&#34;</span>, <span style=color:#a6e22e>grpcErr</span>)
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h4 id=3-é”™è¯¯å¤„ç†å™¨ä¸­é—´ä»¶><strong>3. é”™è¯¯å¤„ç†å™¨ä¸­é—´ä»¶</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>middleware</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/client&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/selector&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/yourproject/errors&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯å¤„ç†å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ErrorHandler</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorWrapper</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrorWrapper</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewErrorHandler</span>(<span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorHandler</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ErrorHandler</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorWrapper</span>: <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NewErrorWrapper</span>(<span style=color:#a6e22e>serviceName</span>, <span style=color:#e6db74>&#34;*&#34;</span>),
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// gRPC è°ƒç”¨é”™è¯¯å¤„ç†åŒ…è£…å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>eh</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorHandler</span>) <span style=color:#a6e22e>WrapCall</span>(<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>rsp</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span>) <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>rsp</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>rsp</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>eh</span>.<span style=color:#a6e22e>errorWrapper</span>.<span style=color:#a6e22e>WrapSystemError</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// HTTP é”™è¯¯å¤„ç†å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>eh</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorHandler</span>) <span style=color:#a6e22e>HandleHTTPError</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>, <span style=color:#a6e22e>err</span> <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è®°å½•é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>eh</span>.<span style=color:#a6e22e>errorWrapper</span>.<span style=color:#a6e22e>WrapSystemError</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Context</span>(), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ ¹æ® error ç±»å‹è¿”å›ç›¸åº”çš„ HTTP çŠ¶æ€ç </span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>statusCode</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>message</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>NotFound</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusNotFound</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Resource not found&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InvalidArgument</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Invalid request&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>AlreadyExists</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusConflict</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Resource already exists&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ResourceExhausted</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusTooManyRequests</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Rate limit exceeded&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InternalServer</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Internal server error&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ServiceUnavailable</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusServiceUnavailable</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Service unavailable&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusInternalServerError</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span> = <span style=color:#e6db74>&#34;Unknown error&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// è¿”å›é”™è¯¯å“åº”</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>Header</span>().<span style=color:#a6e22e>Set</span>(<span style=color:#e6db74>&#34;Content-Type&#34;</span>, <span style=color:#e6db74>&#34;application/json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>statusCode</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;error&#34;</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>interface</span>{}{
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;code&#34;</span>:    <span style=color:#a6e22e>statusCode</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;message&#34;</span>: <span style=color:#a6e22e>message</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;details&#34;</span>:  <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>(),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;timestamp&#34;</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>(),
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleUsage</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorHandler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewErrorHandler</span>(<span style=color:#e6db74>&#34;user-service&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// gRPC æœåŠ¡ä¸­ä½¿ç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span> <span style=color:#a6e22e>UserService</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>UserService</span>) <span style=color:#a6e22e>CreateUser</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateUserRequest</span>, <span style=color:#a6e22e>rsp</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>CreateUserResponse</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ä¸šåŠ¡é€»è¾‘</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Email</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InvalidArgument</span>(<span style=color:#e6db74>&#34;email is required&#34;</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// è°ƒç”¨ä»“å‚¨å±‚ï¼Œå¹¶åŒ…è£…é”™è¯¯</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>userRepository</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errorHandler</span>.<span style=color:#a6e22e>WrapCall</span>(<span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>, <span style=color:#a6e22e>req</span> <span style=color:#66d9ef>interface</span>{}, <span style=color:#a6e22e>rsp</span> <span style=color:#66d9ef>interface</span>{}) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>userRepository</span>.<span style=color:#a6e22e>Create</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>)
</span></span><span style=display:flex><span>            })(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// HTTP æœåŠ¡ä¸­ä½¿ç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>HandleFunc</span>(<span style=color:#e6db74>&#34;/users&#34;</span>, <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>w</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>ResponseWriter</span>, <span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Request</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>req</span> <span style=color:#a6e22e>CreateUserRequest</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Body</span>).<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>req</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errorHandler</span>.<span style=color:#a6e22e>HandleHTTPError</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InvalidArgument</span>(<span style=color:#e6db74>&#34;invalid request body&#34;</span>))
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rsp</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>CreateUserResponse</span>{}
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ¨¡æ‹Ÿä¸šåŠ¡é”™è¯¯</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>Email</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;existing@example.com&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ErrUserAlreadyExists</span>(<span style=color:#e6db74>&#34;email already exists&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errorHandler</span>.<span style=color:#a6e22e>HandleHTTPError</span>(<span style=color:#a6e22e>w</span>, <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ­£å¸¸å¤„ç†</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>w</span>).<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>rsp</span>)
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><h3 id=é«˜çº§é”™è¯¯å¤„ç†ç‰¹æ€§>é«˜çº§é”™è¯¯å¤„ç†ç‰¹æ€§</h3><h4 id=é”™è¯¯æ¢å¤æœºåˆ¶><strong>é”™è¯¯æ¢å¤æœºåˆ¶</strong></h4><div class=highlight-container><button class="copy-code-btn outline">Copy</button><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>errors</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;context&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;github.com/go-micro/go-micro/v4/errors&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é”™è¯¯æ¢å¤å™¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ErrorRecoverer</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retryCount</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxRetries</span>    <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retryableErrors</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>error</span>]<span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewErrorRecoverer</span>(<span style=color:#a6e22e>maxRetries</span> <span style=color:#66d9ef>int</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorRecoverer</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ErrorRecoverer</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxRetries</span>: <span style=color:#a6e22e>maxRetries</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryableErrors</span>: <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>error</span>]<span style=color:#66d9ef>bool</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ServiceUnavailable</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ResourceExhausted</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>InternalServer</span>:     <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¸¦é‡è¯•çš„è°ƒç”¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>er</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorRecoverer</span>) <span style=color:#a6e22e>CallWithRetry</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>methodName</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>retryDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> = <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> &lt; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>maxRetries</span>; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lastErr</span> = <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦æ˜¯å¯é‡è¯•çš„é”™è¯¯</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>isRetryableError</span>(<span style=color:#a6e22e>lastErr</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastErr</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> &lt; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>maxRetries</span> {
</span></span><span style=display:flex><span>            <span style=color:#75715e>// æŒ‡æ•°é€€é¿ç­–ç•¥è®¡ç®—å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retryDelay</span> = <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>calculateRetryDelay</span>(<span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>retryDelay</span>):
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é‡è¯•è°ƒç”¨ %s.%s (ç¬¬%dæ¬¡, ç­‰å¾… %v)&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>methodName</span>, <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>retryDelay</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastErr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// è®¡ç®—é‡è¯•å»¶è¿Ÿ</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>er</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorRecoverer</span>) <span style=color:#a6e22e>calculateRetryDelay</span>(<span style=color:#a6e22e>attempt</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxDelay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æŒ‡æ•°é€€é¿ï¼šdelay = baseDelay * 2^(attempt-1)</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(<span style=color:#ae81ff>2</span>, float64(<span style=color:#a6e22e>attempt</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>delay</span> &gt; <span style=color:#a6e22e>maxDelay</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>maxDelay</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>delay</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¸¦ç†”æ–­çš„è°ƒç”¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>er</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorRecoverer</span>) <span style=color:#a6e22e>CallWithCircuitBreaker</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>serviceName</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>methodName</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>maxFailures</span> <span style=color:#66d9ef>int</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>lastErr</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡ä¸å¯ç”¨é”™è¯¯</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>isRetryableError</span>(<span style=color:#a6e22e>lastErr</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ç†”æ–­å™¨é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;service %s method %s failed after circuit breaker: %w&#34;</span>, <span style=color:#a6e22e>serviceName</span>, <span style=color:#a6e22e>methodName</span>, <span style=color:#a6e22e>lastErr</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastErr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å¸¦æ–­è·¯å™¨çš„é«˜çº§è°ƒç”¨</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>er</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ErrorRecoverer</span>) <span style=color:#a6e22e>CallWithAdvancedRetry</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>config</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RetryConfig</span>,
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>consecutiveFailures</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>backoffDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> = <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> &lt; <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetries</span>; <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lastErr</span> = <span style=color:#a6e22e>fn</span>(<span style=color:#a6e22e>ctx</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>lastErr</span> <span style=color:#f92672>==</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦æ˜¯å¯é‡è¯•çš„é”™è¯¯</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> !<span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>isRetryableError</span>(<span style=color:#a6e22e>lastErr</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastErr</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>consecutiveFailures</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>backoffDelay</span> = <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Strategy</span>.<span style=color:#a6e22e>CalculateDelay</span>(<span style=color:#a6e22e>consecutiveFailures</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§é‡è¯•æ—¶é—´</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetryTime</span> &gt; <span style=color:#ae81ff>0</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Since</span>(<span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Value</span>(<span style=color:#e6db74>&#34;retry_start_time&#34;</span>).(<span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span>)) &gt; <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetryTime</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;è¶…è¿‡æœ€å¤§é‡è¯•æ—¶é—´é™åˆ¶: %v&#34;</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetryTime</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span> &lt; <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetries</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>select</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>After</span>(<span style=color:#a6e22e>backoffDelay</span>):
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;é‡è¯•è°ƒç”¨ (ç¬¬%dæ¬¡, å»¶è¿Ÿ: %v, ç­–ç•¥: %s)&#34;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#a6e22e>er</span>.<span style=color:#a6e22e>retryCount</span><span style=color:#f92672>+</span><span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>backoffDelay</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>Strategy</span>.<span style=color:#a6e22e>Name</span>())
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>():
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Err</span>()
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>lastErr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡è¯•ç­–ç•¥æ¥å£</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RetryStrategy</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>CalculateDelay</span>(<span style=color:#a6e22e>attempt</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// æŒ‡æ•°é€€é¿ç­–ç•¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>ExponentialBackoffStrategy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BaseDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxDelay</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Multiplier</span> <span style=color:#66d9ef>float64</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExponentialBackoffStrategy</span>) <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;exponential_backoff&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>ExponentialBackoffStrategy</span>) <span style=color:#a6e22e>CalculateDelay</span>(<span style=color:#a6e22e>attempt</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>BaseDelay</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>math</span>.<span style=color:#a6e22e>Pow</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Multiplier</span>, float64(<span style=color:#a6e22e>attempt</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>delay</span> &gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>MaxDelay</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>MaxDelay</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>delay</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// çº¿æ€§é€€é¿ç­–ç•¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>LinearBackoffStrategy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BaseDelay</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxDelay</span>  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Increment</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LinearBackoffStrategy</span>) <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;linear_backoff&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>l</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>LinearBackoffStrategy</span>) <span style=color:#a6e22e>CalculateDelay</span>(<span style=color:#a6e22e>attempt</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>delay</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>BaseDelay</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>(<span style=color:#a6e22e>attempt</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>)<span style=color:#f92672>*</span><span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>Increment</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>delay</span> &gt; <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>MaxDelay</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>l</span>.<span style=color:#a6e22e>MaxDelay</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>delay</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// å›ºå®šé—´éš”ç­–ç•¥</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>FixedIntervalStrategy</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Interval</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FixedIntervalStrategy</span>) <span style=color:#a6e22e>Name</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;fixed_interval&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>FixedIntervalStrategy</span>) <span style=color:#a6e22e>CalculateDelay</span>(<span style=color:#a6e22e>attempt</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>Interval</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// é‡è¯•é…ç½®</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RetryConfig</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxRetries</span>   <span style=color:#66d9ef>int</span>           <span style=color:#e6db74>`json:&#34;max_retries&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>MaxRetryTime</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Duration</span> <span style=color:#e6db74>`json:&#34;max_retry_time&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Strategy</span>     <span style=color:#a6e22e>RetryStrategy</span> <span style=color:#e6db74>`json:&#34;strategy&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Jitter</span>       <span style=color:#66d9ef>bool</span>          <span style=color:#e6db74>`json:&#34;jitter&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ä½¿ç”¨ç¤ºä¾‹</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>ExampleUsage</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// é…ç½®ä¸åŒçš„é‡è¯•ç­–ç•¥</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exponentialStrategy</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>ExponentialBackoffStrategy</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>BaseDelay</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MaxDelay</span>:  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>30</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Multiplier</span>: <span style=color:#ae81ff>2.0</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>linearStrategy</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>LinearBackoffStrategy</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>BaseDelay</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>MaxDelay</span>:  <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Increment</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fixedStrategy</span> <span style=color:#f92672>:=</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>FixedIntervalStrategy</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Interval</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Second</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>configs</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#f92672>*</span><span style=color:#a6e22e>RetryConfig</span>{
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;exponential&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetries</span>:   <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetryTime</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Strategy</span>:     <span style=color:#a6e22e>exponentialStrategy</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Jitter</span>:       <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;linear&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetries</span>:   <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetryTime</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Strategy</span>:     <span style=color:#a6e22e>linearStrategy</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Jitter</span>:       <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;fixed&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetries</span>:   <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>MaxRetryTime</span>: <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Strategy</span>:     <span style=color:#a6e22e>fixedStrategy</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Jitter</span>:       <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>cancel</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>(), <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Minute</span><span style=color:#f92672>*</span><span style=color:#ae81ff>2</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>cancel</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½å¤±è´¥çš„æœåŠ¡è°ƒç”¨</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>attemptCount</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>strategyName</span>, <span style=color:#a6e22e>config</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>configs</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ctx</span> = <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>WithValue</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;retry_start_time&#34;</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Now</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewErrorRecoverer</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>MaxRetries</span>).<span style=color:#a6e22e>CallWithAdvancedRetry</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>ctx</span>,
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>ctx</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Context</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>attemptCount</span><span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>                <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;æ‰§è¡ŒæœåŠ¡è°ƒç”¨ (ç­–ç•¥: %s, å°è¯•: %d)&#34;</span>, <span style=color:#a6e22e>strategyName</span>, <span style=color:#a6e22e>attemptCount</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                <span style=color:#75715e>// æ¨¡æ‹Ÿå‰å‡ æ¬¡å¤±è´¥ï¼Œæœ€åä¸€æ¬¡æˆåŠŸ</span>
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>attemptCount</span> &lt; <span style=color:#ae81ff>4</span> {
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>ServiceUnavailable</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;service temporarily unavailable (attempt %d)&#34;</span>, <span style=color:#a6e22e>attemptCount</span>))
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç­–ç•¥ %s æœ€ç»ˆè°ƒç”¨å¤±è´¥: %v&#34;</span>, <span style=color:#a6e22e>strategyName</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;ç­–ç•¥ %s è°ƒç”¨æˆåŠŸ&#34;</span>, <span style=color:#a6e22e>strategyName</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// é‡ç½®è®¡æ•°å™¨</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attemptCount</span> = <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class=highlight-container><button class="copy-code-btn outline">Copy</button><pre tabindex=0><code>
#### **é”™è¯¯ç›‘æ§å’Œå‘Šè­¦**
```go
package monitoring

import (
    &#34;context&#34;
    &#34;log&#34;
    &#34;sync&#34;
    &#34;time&#34;

    &#34;github.com/go-micro/go-micro/v4/errors&#34;
)

// é”™è¯¯ç›‘æ§å™¨
type ErrorMonitor struct {
    errorCounts map[string]int64 // error type -&gt; count
    alerts      map[string]*AlertConfig
    mu           sync.RWMutex
}

type AlertConfig struct {
    Threshold   int           `json:&#34;threshold&#34;`
    Interval    time.Duration `json:&#34;interval&#34;`
    WebhookURL string         `json:&#34;webhook_url&#34;`
}

func NewErrorMonitor() *ErrorMonitor {
    return &amp;ErrorMonitor{
        errorCounts: make(map[string]int64),
        alerts:      make(map[string]*AlertConfig),
    }
}

// è®°å½•é”™è¯¯
func (em *ErrorMonitor) RecordError(err error, service, method string) {
    em.mu.Lock()
    defer em.mu.Unlock()

    errorType := em.classifyError(err)
    em.errorCounts[errorType]++

    log.Printf(&#34;é”™è¯¯ç›‘æ§: %s.%s - %s (%s)&#34;, service, method, errorType, err.Error())

    // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘å‘Šè­¦
    if alert, exists := em.alerts[errorType]; exists {
        if em.errorCounts[errorType] &gt;= int64(alert.Threshold) {
            em.triggerAlert(errorType, alert, service, method)
        }
    }
}

// åˆ†ç±»é”™è¯¯ç±»å‹
func (em *ErrorMonitor) classifyError(err error) string {
    switch {
    case errors.Is(err, errors.NotFound):
        return &#34;not_found&#34;
    case errors.Is(err, errors.InvalidArgument):
        return &#34;invalid_argument&#34;
    case errors.Is(err, errors.AlreadyExists):
        return &#34;already_exists&#34;
    case errors.Is(err, errors.ResourceExhausted):
        return &#34;resource_exhausted&#34;
    case errors.Is(err, errors.ServiceUnavailable):
        return &#34;service_unavailable&#34;
    case errors.Is(err, errors.InternalServer):
        return &#34;internal_server&#34;
    default:
        return &#34;unknown&#34;
    }
}

// è§¦å‘å‘Šè­¦
func (em *ErrorMonitor) triggerAlert(errorType string, alert *AlertConfig, service, method string) {
    alertData := map[string]interface{}{
        &#34;timestamp&#34;:    time.Now(),
        &#34;error_type&#34;:   errorType,
        &#34;service&#34;:      service,
        &#34;method&#34;:       method,
        &#34;count&#34;:        em.errorCounts[errorType],
        &#34;threshold&#34;:    alert.Threshold,
        &#34;message&#34;:      fmt.Sprintf(&#34;%s errors exceeded threshold&#34;, errorType),
    }

    log.Printf(&#34;è§¦å‘å‘Šè­¦: %+v&#34;, alertData)

    // è¿™é‡Œå¯ä»¥å‘é€åˆ°å¤–éƒ¨ç›‘æ§ç³»ç»Ÿ
    // em.sendToWebhook(alert.WebhookURL, alertData)
    // em.sendToSlack(alertData)
    // em.sendToEmail(alertData)
}

// æ·»åŠ å‘Šè­¦é…ç½®
func (em *ErrorMonitor) AddAlert(errorType string, threshold int, interval time.Duration, webhookURL string) {
    em.mu.Lock()
    defer em.mu.Unlock()

    em.alerts[errorType] = &amp;AlertConfig{
        Threshold:   threshold,
        Interval:    interval,
        WebhookURL: webhookURL,
    }

    log.Printf(&#34;æ·»åŠ å‘Šè­¦é…ç½®: %s -&gt; threshold: %d&#34;, errorType, threshold)
}

// å®šæœŸé‡ç½®è®¡æ•°å™¨
func (em *ErrorMonitor) StartPeriodicReset(interval time.Duration) {
    go func() {
        ticker := time.NewTicker(interval)
        defer ticker.Stop()

        for range ticker.C {
            em.resetCounts()
            log.Println(&#34;é”™è¯¯è®¡æ•°å™¨å·²é‡ç½®&#34;)
        }
    }()
}

func (em *ErrorMonitor) resetCounts() {
    em.mu.Lock()
    defer em.mu.Unlock()

    for key := range em.errorCounts {
        em.errorCounts[key] = 0
    }
}

// é«˜çº§é”™è¯¯èšåˆå™¨
type ErrorAggregator struct {
    windowSize     time.Duration
    errorBuffer    []ErrorEvent
    patternMatcher *ErrorPatternMatcher
    mu             sync.RWMutex
}

type ErrorEvent struct {
    Timestamp   time.Time              `json:&#34;timestamp&#34;`
    ServiceName string                 `json:&#34;service_name&#34;`
    Method      string                 `json:&#34;method&#34;`
    ErrorType   string                 `json:&#34;error_type&#34;`
    Message     string                 `json:&#34;message&#34;`
    TraceID     string                 `json:&#34;trace_id&#34;`
    UserID      string                 `json:&#34;user_id,omitempty&#34;`
    Metadata    map[string]interface{} `json:&#34;metadata&#34;`
}

type ErrorPattern struct {
    Pattern    string   `json:&#34;pattern&#34;`
    Type       string   `json:&#34;type&#34;`
    Priority   int      `json:&#34;priority&#34;`
    Action      string   `json:&#34;action&#34;` // &#34;alert&#34;, &#34;log&#34;, &#34;ignore&#34;
}

func NewErrorAggregator(windowSize time.Duration) *ErrorAggregator {
    return &amp;ErrorAggregator{
        windowSize:     windowSize,
        errorBuffer:    make([]ErrorEvent, 0),
        patternMatcher: NewErrorPatternMatcher(),
    }
}

func (ea *ErrorAggregator) RecordError(event ErrorEvent) {
    ea.mu.Lock()
    defer ea.mu.Unlock()

    // æ·»åŠ åˆ°ç¼“å†²åŒº
    ea.errorBuffer = append(ea.errorBuffer, event)

    // ä¿æŒçª—å£å¤§å°
    cutoff := time.Now().Add(-ea.windowSize)
    for i := 0; i &lt; len(ea.errorBuffer); i++ {
        if ea.errorBuffer[i].Timestamp.Before(cutoff) {
            ea.errorBuffer = ea.errorBuffer[i:]
            break
        }
    }

    // æ£€æŸ¥é”™è¯¯æ¨¡å¼
    patterns := ea.patternMatcher.MatchPatterns(event)
    for _, pattern := range patterns {
        ea.handlePatternMatch(event, pattern)
    }
}

func (ea *ErrorAggregator) handlePatternMatch(event ErrorEvent, pattern ErrorPattern) {
    switch pattern.Action {
    case &#34;alert&#34;:
        log.Printf(&#34;é”™è¯¯æ¨¡å¼åŒ¹é…å‘Šè­¦: %s - %s (æ¨¡å¼: %s)&#34;, event.ErrorType, event.Message, pattern.Pattern)
    case &#34;log&#34;:
        log.Printf(&#34;é”™è¯¯æ¨¡å¼è®°å½•: %s - %s (æ¨¡å¼: %s)&#34;, event.ErrorType, event.Message, pattern.Pattern)
    case &#34;ignore&#34;:
        // å¿½ç•¥æ­¤é”™è¯¯
    }
}

func (ea *ErrorAggregator) GetErrorReport(startTime, endTime time.Time) *ErrorReport {
    ea.mu.RLock()
    defer ea.mu.RUnlock()

    var events []ErrorEvent
    errorStats := make(map[string]int)
    serviceStats := make(map[string]int)

    for _, event := range ea.errorBuffer {
        if event.Timestamp.After(startTime) &amp;&amp; event.Timestamp.Before(endTime) {
            events = append(events, event)
            errorStats[event.ErrorType]++
            serviceStats[event.ServiceName]++
        }
    }

    return &amp;ErrorReport{
        StartTime:    startTime,
        EndTime:      endTime,
        TotalEvents:   len(events),
        Events:       events,
        ErrorStats:   errorStats,
        ServiceStats:  serviceStats,
    }
}

type ErrorReport struct {
    StartTime    time.Time              `json:&#34;start_time&#34;`
    EndTime      time.Time              `json:&#34;end_time&#34;`
    TotalEvents  int                   `json:&#34;total_events&#34;`
    Events       []ErrorEvent          `json:&#34;events&#34;`
    ErrorStats   map[string]int         `json:&#34;error_stats&#34;`
    ServiceStats  map[string]int         `json:&#34;service_stats&#34;`
}

type ErrorPatternMatcher struct {
    patterns []ErrorPattern
    mu       sync.RWMutex
}

func NewErrorPatternMatcher() *ErrorPatternMatcher {
    return &amp;ErrorPatternMatcher{
        patterns: []ErrorPattern{
            {
                Pattern:  &#34;timeout|deadline&#34;,
                Type:     &#34;timeout_error&#34;,
                Priority: 1,
                Action:   &#34;alert&#34;,
            },
            {
                Pattern:  &#34;connection.*fail&#34;,
                Type:     &#34;connection_error&#34;,
                Priority: 2,
                Action:   &#34;alert&#34;,
            },
            {
                Pattern:  &#34;permission.*denied&#34;,
                Type:     &#34;authorization_error&#34;,
                Priority: 3,
                Action:   &#34;log&#34;,
            },
        },
    }
}

func (epm *ErrorPatternMatcher) AddPattern(pattern ErrorPattern) {
    epm.mu.Lock()
    defer epm.mu.Unlock()

    epm.patterns = append(epm.patterns, pattern)
    // æŒ‰ä¼˜å…ˆçº§æ’åº
    sort.Slice(epm.patterns, func(i, j int) bool {
        return epm.patterns[i].Priority &lt; epm.patterns[j].Priority
    })
}

func (epm *ErrorPatternMatcher) MatchPatterns(event ErrorEvent) []ErrorPattern {
    epm.mu.RLock()
    defer epm.mu.RUnlock()

    var matchedPatterns []ErrorPattern

    for _, pattern := range epm.patterns {
        matched, _ := regexp.MatchString(pattern.Pattern, event.Message)
        if matched {
            matchedPatterns = append(matchedPatterns, pattern)
        }
    }

    return matchedPatterns
}

// ä½¿ç”¨ç¤ºä¾‹
func ExampleUsage() {
    monitor := NewErrorMonitor()
    aggregator := NewErrorAggregator(time.Hour)

    // é…ç½®å‘Šè­¦è§„åˆ™
    monitor.AddAlert(&#34;service_unavailable&#34;, 10, time.Minute, &#34;https://hooks.slack.com/services/xxx&#34;)
    monitor.AddAlert(&#34;internal_server&#34;, 5, time.Minute*5, &#34;https://hooks.slack.com/services/xxx&#34;)

    // å¯åŠ¨å®šæœŸé‡ç½®
    monitor.StartPeriodicReset(time.Hour)

    // é…ç½®è‡ªå®šä¹‰é”™è¯¯æ¨¡å¼
    aggregator.patternMatcher.AddPattern(ErrorPattern{
        Pattern:  &#34;payment.*failed&#34;,
        Type:     &#34;payment_error&#34;,
        Priority: 1,
        Action:   &#34;alert&#34;,
    })

    // æ¨¡æ‹Ÿé”™è¯¯è®°å½•
    err := errors.ServiceUnavailable(&#34;service down&#34;)
    monitor.RecordError(err, &#34;user-service&#34;, &#34;GetUser&#34;)
    aggregator.RecordError(ErrorEvent{
        Timestamp:   time.Now(),
        ServiceName: &#34;user-service&#34;,
        Method:      &#34;GetUser&#34;,
        ErrorType:   &#34;service_unavailable&#34;,
        Message:     &#34;service down&#34;,
        TraceID:     &#34;trace-123&#34;,
    })

    err = errors.InternalServer(&#34;database connection failed&#34;)
    monitor.RecordError(err, &#34;order-service&#34;, &#34;CreateOrder&#34;)
    aggregator.RecordError(ErrorEvent{
        Timestamp:   time.Now(),
        ServiceName: &#34;order-service&#34;,
        Method:      &#34;CreateOrder&#34;,
        ErrorType:   &#34;internal_server&#34;,
        Message:     &#34;database connection failed&#34;,
        TraceID:     &#34;trace-456&#34;,
    })

    // ç”Ÿæˆé”™è¯¯æŠ¥å‘Š
    report := aggregator.GetErrorReport(time.Now().Add(-time.Hour), time.Now())
    log.Printf(&#34;é”™è¯¯æŠ¥å‘Š: æ€»äº‹ä»¶=%d, é”™è¯¯ç»Ÿè®¡=%+v&#34;, report.TotalEvents, report.ErrorStats)
}</code></pre></div><h3 id=æœ€ä½³å®è·µå»ºè®®>æœ€ä½³å®è·µå»ºè®®</h3><h4 id=é”™è¯¯å¤„ç†ç­–ç•¥><strong>é”™è¯¯å¤„ç†ç­–ç•¥</strong></h4><ol><li><p><strong>åˆ†å±‚é”™è¯¯å¤„ç†</strong></p><ul><li><strong>æ•°æ®å±‚é”™è¯¯</strong>ï¼šæ•°æ®åº“æ“ä½œé”™è¯¯</li><li><strong>ä¸šåŠ¡å±‚é”™è¯¯</strong>ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯</li><li><strong>æ¥å£å±‚é”™è¯¯</strong>ï¼šAPI è°ƒç”¨é”™è¯¯</li><li><strong>ç³»ç»Ÿå±‚é”™è¯¯</strong>ï¼šåŸºç¡€è®¾æ–½é”™è¯¯</li></ul></li><li><p><strong>é”™è¯¯ä¿¡æ¯è§„èŒƒåŒ–</strong></p><ul><li>ä½¿ç”¨æ ‡å‡†çš„é”™è¯¯ç </li><li>æä¾›æ¸…æ™°çš„é”™è¯¯æè¿°</li><li>åŒ…å«è¶³å¤Ÿçš„è°ƒè¯•ä¿¡æ¯</li><li>é¿å…æ•æ„Ÿä¿¡æ¯æ³„éœ²</li></ul></li><li><p><strong>é”™è¯¯æ¢å¤æœºåˆ¶</strong></p><ul><li>å®ç°è‡ªåŠ¨é‡è¯•ç­–ç•¥</li><li>ä½¿ç”¨ç†”æ–­å™¨ä¿æŠ¤</li><li>æä¾›é™çº§æ–¹æ¡ˆ</li><li>ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§</li></ul></li><li><p><strong>é”™è¯¯ç›‘æ§å’Œåˆ†æ</strong></p><ul><li>å®æ—¶é”™è¯¯æ”¶é›†</li><li>é”™è¯¯ç‡ç»Ÿè®¡</li><li>å‘Šè­¦æœºåˆ¶</li><li>é”™è¯¯è¶‹åŠ¿åˆ†æ</li></ul></li></ol><p>è¿™äº›è‡ªå®šä¹‰é”™è¯¯è¿”å›æœºåˆ¶æä¾›äº†å®Œæ•´çš„é”™è¯¯å¤„ç†è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©å¼€å‘è€…æ„å»ºæ›´åŠ å¥å£®å’Œå¯é çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚</p><h2 id=æ‰©å±•æ€§>æ‰©å±•æ€§</h2><p>åŸºäºWrapperï¼ˆä¸­é—´ä»¶ï¼‰</p></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>yesplease</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2023-09-15</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=http://localhost:1313/tags/go/>go</a>
<a href=http://localhost:1313/tags/micro/>micro</a>
<a href=http://localhost:1313/tags/go-micro/>go-micro</a></div><nav class=post-nav><a class=prev href=/post/engineer/series-api-1/><i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-left hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m15 18-6-6 6-6"/></svg>
</i><span class="prev-text nav-default">micro, how to play select engineer mode?</span>
<span class="prev-text nav-mobile">Prev</span>
</a><a class=next href=/post/micro/series-micro-1/><span class="next-text nav-default">Go-micro, how to play introduction?</span>
<span class="prev-text nav-mobile">Next</span>
<i class=iconfont><svg aria-hidden="true" class="lucide lucide-chevron-right hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="m9 18 6-6-6-6"/></svg></i></a></nav></footer></article></div><aside class=right-sidebar></aside></div></main><footer id=footer class=site-footer><div class=social-icon-links><a href=mailto:cugbtang@sina.com rel="me noopener" class=social-icon-link title=email><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1451 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M664.781909 681.472759.0 97.881301C0 3.997201 71.046997.0 71.046997.0H474.477909 961.649408h399.992405s71.046998 3.997201 71.046998 97.881301L771.345323 681.472759S764.482731 685.154773 753.594283 688.65053V688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858V688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759zm53.281707 130.131124C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633.0 212.052267.0 212.052267V942.809523S0 1024 83.726336 1024H682.532949 753.579947h595.368192C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523V212.052267S893.138176 701.759633 817.019477 767.734955c-39.771477 34.470494-74.671786 43.295855-98.955861 43.868928z"/></svg>
</a><a href=https://github.com/cugbtang rel="me noopener" class=social-icon-link title=github target=_blank><svg aria-hidden="true" class="icon hi-svg-inline" fill="currentColor" height="1em" viewBox="0 0 1024 1024" width="1em" xlink="http://www.w3.org/1999/xlink"><path d="M512 12.672c-282.88.0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667.0-12.16-.426667-44.373333-.64-87.04C242.005334 929.664 211.968 830.08 211.968 830.08 188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333.0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333.0.0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667.0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72.0 68.522667-.64 123.562667-.64 140.202666.0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"/></svg>
</a><a href=http://localhost:1313/index.xml rel="noopener alternate" type=application/rss+xml class=social-icon-link title=rss target=_blank><svg aria-hidden="true" class="lucide lucide-rss hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a>
</span><span class=division>|</span>
<span class=theme-info>Theme - <a class=theme-link href=https://github.com/xianmin/hugo-theme-jane>Jane</a>
</span><span class=copyright-year>&copy;
2017 -
2025
<span class=heart><i class=iconfont><svg aria-hidden="true" class="lucide lucide-heart hi-svg-inline" fill="none" height="1em" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="1em"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5.0 0016.5 3c-1.76.0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5.0 002 8.5c0 2.3 1.5 4.05 3 5.5l7 7z"/></svg>
</i></span><span class=author>yesplease</span></span></div></footer><script type=text/javascript src=/js/main.002d1a80e7bd914cb4592a8c6486c23920f3d9827531bd1c79b3b5716dcf0bd5.js integrity="sha256-AC0agOe9kUy0WSqMZIbCOSDz2YJ1Mb0cebO1cW3PC9U=" crossorigin=anonymous></script><script type=text/javascript src=/lib/photoswipe/photoswipe.min.js></script><script type=text/javascript src=/lib/photoswipe/photoswipe-ui-default.min.js></script></body></html>